---
title: Direct3D9 和 WPF 互通性的效能考量
ms.date: 03/30/2017
helpviewer_keywords:
- WPF [WPF], Direct3D9 interop performance
- Direct3D9 [WPF interoperability], performance
ms.assetid: ea8baf91-12fe-4b44-ac4d-477110ab14dd
ms.openlocfilehash: 1371fa901bebc503a0091f3229a8fd7e6ccc2c86
ms.sourcegitcommit: 5b6d778ebb269ee6684fb57ad69a8c28b06235b9
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 04/08/2019
ms.locfileid: "59162629"
---
# <a name="performance-considerations-for-direct3d9-and-wpf-interoperability"></a><span data-ttu-id="0d060-102">Direct3D9 和 WPF 互通性的效能考量</span><span class="sxs-lookup"><span data-stu-id="0d060-102">Performance Considerations for Direct3D9 and WPF Interoperability</span></span>
<span data-ttu-id="0d060-103">您可以使用來裝載 Direct3D9 內容<xref:System.Windows.Interop.D3DImage>類別。</span><span class="sxs-lookup"><span data-stu-id="0d060-103">You can host Direct3D9 content by using the <xref:System.Windows.Interop.D3DImage> class.</span></span> <span data-ttu-id="0d060-104">裝載 Direct3D9 內容可能會影響您的應用程式的效能。</span><span class="sxs-lookup"><span data-stu-id="0d060-104">Hosting Direct3D9 content can affect the performance of your application.</span></span> <span data-ttu-id="0d060-105">本主題說明裝載在 Windows Presentation Foundation (WPF) 應用程式中的 Direct3D9 內容時將效能最佳化的最佳作法。</span><span class="sxs-lookup"><span data-stu-id="0d060-105">This topic describes best practices to optimize performance when hosting Direct3D9 content in a Windows Presentation Foundation (WPF) application.</span></span> <span data-ttu-id="0d060-106">這些最佳作法包括如何使用<xref:System.Windows.Interop.D3DImage>和最佳作法，當您使用 Windows Vista、 Windows XP 和多重監視器 」 會顯示。</span><span class="sxs-lookup"><span data-stu-id="0d060-106">These best practices include how to use <xref:System.Windows.Interop.D3DImage> and best practices when you are using Windows Vista, Windows XP, and multi-monitor displays.</span></span>  
  
> [!NOTE]
>  <span data-ttu-id="0d060-107">如需程式碼範例示範這些最佳作法，請參閱[WPF 和 Direct3D9 互通](wpf-and-direct3d9-interoperation.md)。</span><span class="sxs-lookup"><span data-stu-id="0d060-107">For code examples that demonstrate these best practices, see [WPF and Direct3D9 Interoperation](wpf-and-direct3d9-interoperation.md).</span></span>  
  
## <a name="use-d3dimage-sparingly"></a><span data-ttu-id="0d060-108">盡量不要使用 D3DImage</span><span class="sxs-lookup"><span data-stu-id="0d060-108">Use D3DImage Sparingly</span></span>  
 <span data-ttu-id="0d060-109">在中裝載 Direct3D9 內容<xref:System.Windows.Interop.D3DImage>執行個體不會轉譯為純虛擬的 Direct3D 應用程式那樣快。</span><span class="sxs-lookup"><span data-stu-id="0d060-109">Direct3D9 content hosted in a <xref:System.Windows.Interop.D3DImage> instance does not render as fast as in a pure Direct3D application.</span></span> <span data-ttu-id="0d060-110">複製在介面和排清命令緩衝區可耗費資源的作業。</span><span class="sxs-lookup"><span data-stu-id="0d060-110">Copying the surface and flushing the command buffer can be costly operations.</span></span> <span data-ttu-id="0d060-111">為數個<xref:System.Windows.Interop.D3DImage>執行個體增加更多的排清會進行，而且效能降低。</span><span class="sxs-lookup"><span data-stu-id="0d060-111">As the number of <xref:System.Windows.Interop.D3DImage> instances increases, more flushing occurs, and performance degrades.</span></span> <span data-ttu-id="0d060-112">因此，您應該使用<xref:System.Windows.Interop.D3DImage>謹慎使用。</span><span class="sxs-lookup"><span data-stu-id="0d060-112">Therefore, you should use <xref:System.Windows.Interop.D3DImage> sparingly.</span></span>  
  
## <a name="best-practices-on-windows-vista"></a><span data-ttu-id="0d060-113">在 Windows Vista 上的最佳作法</span><span class="sxs-lookup"><span data-stu-id="0d060-113">Best Practices on Windows Vista</span></span>  
 <span data-ttu-id="0d060-114">與顯示設定為使用 Windows 顯示驅動程式模型 (WDDM) 在 Windows Vista 上達到最佳效能，請建立 Direct3D9 介面上`IDirect3DDevice9Ex`裝置。</span><span class="sxs-lookup"><span data-stu-id="0d060-114">For best performance on Windows Vista with a display that is configured to use the Windows Display Driver Model (WDDM), create your Direct3D9 surface on an `IDirect3DDevice9Ex` device.</span></span> <span data-ttu-id="0d060-115">這可讓設定共用的介面。</span><span class="sxs-lookup"><span data-stu-id="0d060-115">This enables surface sharing.</span></span> <span data-ttu-id="0d060-116">視訊卡必須支援`D3DDEVCAPS2_CAN_STRETCHRECT_FROM_TEXTURES`和`D3DCAPS2_CANSHARERESOURCE`在 Windows Vista 上的驅動程式功能。</span><span class="sxs-lookup"><span data-stu-id="0d060-116">The video card must support the `D3DDEVCAPS2_CAN_STRETCHRECT_FROM_TEXTURES` and `D3DCAPS2_CANSHARERESOURCE` driver capabilities on Windows Vista.</span></span> <span data-ttu-id="0d060-117">任何其他設定會導致透過大幅降低效能的軟體要複製的介面。</span><span class="sxs-lookup"><span data-stu-id="0d060-117">Any other settings cause the surface to be copied through software, which reduces performance significantly.</span></span>  
  
> [!NOTE]
>  <span data-ttu-id="0d060-118">如果 Windows Vista 具有顯示設定為使用 Windows XP 顯示驅動程式模型 (XDDM)，在介面一定會複製透過軟體，不論設定為何。</span><span class="sxs-lookup"><span data-stu-id="0d060-118">If Windows Vista has a display that is configured to use the Windows XP Display Driver Model (XDDM), the surface is always copied through software, regardless of settings.</span></span> <span data-ttu-id="0d060-119">設定適當的設定和視訊卡，您會在 Windows Vista 上看到更佳的效能，當您使用 WDDM，因為介面的複本會在硬體中執行。</span><span class="sxs-lookup"><span data-stu-id="0d060-119">With the proper settings and video card, you will see better performance on Windows Vista when you use the WDDM because surface copies are performed in hardware.</span></span>  
  
## <a name="best-practices-on-windows-xp"></a><span data-ttu-id="0d060-120">在 Windows XP 上的最佳作法</span><span class="sxs-lookup"><span data-stu-id="0d060-120">Best Practices on Windows XP</span></span>  
 <span data-ttu-id="0d060-121">為了達到最佳效能，在 Windows XP 中，它會使用 Windows XP 顯示驅動程式模型 (XDDM)，建立一個可鎖定的介面，會正確運作時`IDirect3DSurface9::GetDC`呼叫方法。</span><span class="sxs-lookup"><span data-stu-id="0d060-121">For best performance on Windows XP, which uses the Windows XP Display Driver Model (XDDM), create a lockable surface that behaves correctly when the `IDirect3DSurface9::GetDC` method is called.</span></span> <span data-ttu-id="0d060-122">就內部而言，`BitBlt`在硬體裝置間傳輸介面的方法。</span><span class="sxs-lookup"><span data-stu-id="0d060-122">Internally, the `BitBlt` method transfers the surface across devices in hardware.</span></span> <span data-ttu-id="0d060-123">`GetDC`方法永遠都可運作 XRGB 介面上。</span><span class="sxs-lookup"><span data-stu-id="0d060-123">The `GetDC` method always works on XRGB surfaces.</span></span> <span data-ttu-id="0d060-124">不過，如果用戶端電腦執行 Windows XP SP3 或 SP2，而且用戶端也會有分層視窗功能的 hotfix，則這個方法僅適用於 ARGB 表面。</span><span class="sxs-lookup"><span data-stu-id="0d060-124">However, if the client computer is running Windows XP with SP3 or SP2, and if the client also has the hotfix for the layered-window feature, this method only works on ARGB surfaces.</span></span> <span data-ttu-id="0d060-125">視訊卡必須支援`D3DDEVCAPS2_CAN_STRETCHRECT_FROM_TEXTURES`驅動程式功能。</span><span class="sxs-lookup"><span data-stu-id="0d060-125">The video card must support the `D3DDEVCAPS2_CAN_STRETCHRECT_FROM_TEXTURES` driver capability.</span></span>  
  
 <span data-ttu-id="0d060-126">16 位元桌面顯示深度可以大幅降低效能。</span><span class="sxs-lookup"><span data-stu-id="0d060-126">A 16-bit desktop display depth can significantly reduce performance.</span></span> <span data-ttu-id="0d060-127">建議使用 32 位元桌面。</span><span class="sxs-lookup"><span data-stu-id="0d060-127">A 32-bit desktop is recommended.</span></span>  
  
 <span data-ttu-id="0d060-128">如果您正在開發適用於 Windows Vista 和 Windows XP，測試 Windows XP 上的效能。</span><span class="sxs-lookup"><span data-stu-id="0d060-128">If you are developing for Windows Vista and Windows XP, test the performance on Windows XP.</span></span> <span data-ttu-id="0d060-129">在 Windows XP 上的 mimo rozsah video paměti 執行是一項考量。</span><span class="sxs-lookup"><span data-stu-id="0d060-129">Running out of video memory on Windows XP is a concern.</span></span> <span data-ttu-id="0d060-130">颾魤 ㄛ<xref:System.Windows.Interop.D3DImage>在 Windows XP 上使用更多視訊記憶體和頻寬也比 Windows Vista WDDM，因為需要額外的視訊記憶體複本。</span><span class="sxs-lookup"><span data-stu-id="0d060-130">In addition, <xref:System.Windows.Interop.D3DImage> on Windows XP uses more video memory and bandwidth than Windows Vista WDDM, due to a necessary extra video memory copy.</span></span> <span data-ttu-id="0d060-131">因此，您可以預期會比在 Windows Vista 上的 Windows xp 更糟的是相同的視訊硬體的效能。</span><span class="sxs-lookup"><span data-stu-id="0d060-131">Therefore, you can expect performance to be worse on Windows XP than on Windows Vista for the same video hardware.</span></span>  
  
> [!NOTE]
>  <span data-ttu-id="0d060-132">XDDM 是適用於 Windows XP 和 Windows Vista;不過，WDDM 是僅適用於 Windows Vista。</span><span class="sxs-lookup"><span data-stu-id="0d060-132">XDDM is available on both Windows XP and Windows Vista; however, WDDM is available only on Windows Vista.</span></span>  
  
## <a name="general-best-practices"></a><span data-ttu-id="0d060-133">一般最佳作法</span><span class="sxs-lookup"><span data-stu-id="0d060-133">General Best Practices</span></span>  
 <span data-ttu-id="0d060-134">當您建立裝置時，使用`D3DCREATE_MULTITHREADED`建立旗標。</span><span class="sxs-lookup"><span data-stu-id="0d060-134">When you create the device, use the `D3DCREATE_MULTITHREADED` creation flag.</span></span> <span data-ttu-id="0d060-135">這會降低效能，但 WPF 呈現系統此裝置上呼叫方法，從另一個執行緒。</span><span class="sxs-lookup"><span data-stu-id="0d060-135">This reduces performance, but the WPF rendering system calls methods on this device from another thread.</span></span> <span data-ttu-id="0d060-136">請務必正確地遵循鎖定的通訊協定，讓任何兩個執行緒同時存取裝置。</span><span class="sxs-lookup"><span data-stu-id="0d060-136">Be sure to follow the locking protocol correctly, so that no two threads access the device at the same time.</span></span>  
  
 <span data-ttu-id="0d060-137">如果 WPF managed 執行緒上執行您的轉譯，則強烈建議您建立與裝置`D3DCREATE_FPU_PRESERVE`建立旗標。</span><span class="sxs-lookup"><span data-stu-id="0d060-137">If your rendering is performed on a WPF managed thread, it is strongly recommended that you create the device with the `D3DCREATE_FPU_PRESERVE` creation flag.</span></span> <span data-ttu-id="0d060-138">如果沒有此設定，D3D 轉譯可以減少 WPF 雙精確度運算的精確度，並造成轉譯問題。</span><span class="sxs-lookup"><span data-stu-id="0d060-138">Without this setting, the D3D rendering can reduce the accuracy of WPF double-precision operations and introduce rendering issues.</span></span>  
  
 <span data-ttu-id="0d060-139">並排<xref:System.Windows.Interop.D3DImage>很快速，除非您圖格的非 pow2 介面，而不需要硬體支援，或您並排<xref:System.Windows.Media.DrawingBrush>或是<xref:System.Windows.Media.VisualBrush>包含<xref:System.Windows.Interop.D3DImage>。</span><span class="sxs-lookup"><span data-stu-id="0d060-139">Tiling a <xref:System.Windows.Interop.D3DImage> is fast, unless you tile a non-pow2 surface without hardware support, or if you tile a <xref:System.Windows.Media.DrawingBrush> or <xref:System.Windows.Media.VisualBrush> that contains a <xref:System.Windows.Interop.D3DImage>.</span></span>  
  
## <a name="best-practices-for-multi-monitor-displays"></a><span data-ttu-id="0d060-140">多重監視器的顯示畫面的最佳作法</span><span class="sxs-lookup"><span data-stu-id="0d060-140">Best Practices for Multi-Monitor Displays</span></span>  
 <span data-ttu-id="0d060-141">如果您使用的有多個監視器的電腦，您應該遵循先前所述的最佳作法。</span><span class="sxs-lookup"><span data-stu-id="0d060-141">If you are using a computer that has multiple monitors, you should follow the previously described best practices.</span></span> <span data-ttu-id="0d060-142">另外還有多監視器組態的一些額外的效能考量。</span><span class="sxs-lookup"><span data-stu-id="0d060-142">There are also some additional performance considerations for a multi-monitor configuration.</span></span>  
  
 <span data-ttu-id="0d060-143">當您建立背景緩衝區時，建立特定裝置和配接器，但 WPF 可能會顯示任何配接器為前景緩衝區。</span><span class="sxs-lookup"><span data-stu-id="0d060-143">When you create the back buffer, it is created on a specific device and adapter, but WPF may display the front buffer on any adapter.</span></span> <span data-ttu-id="0d060-144">複製到更新前緩衝的介面卡可以是非常耗費資源。</span><span class="sxs-lookup"><span data-stu-id="0d060-144">Copying across adapters to update the front buffer can be very expensive.</span></span> <span data-ttu-id="0d060-145">在已設定為搭配多個視訊卡與使用 WDDM 的 Windows Vista 上`IDirect3DDevice9Ex`裝置，前景緩衝區是否位於不同的介面卡，但仍然相同的視訊卡上，沒有任何效能產生負面影響。</span><span class="sxs-lookup"><span data-stu-id="0d060-145">On Windows Vista that is configured to use the WDDM with multiple video cards and with an `IDirect3DDevice9Ex` device, if the front buffer is on a different adapter but still the same video card, there is no performance penalty.</span></span> <span data-ttu-id="0d060-146">不過，在 Windows XP 和具有多個視訊卡 XDDM，沒有顯著的效能負面影響時前景緩衝區會顯示在不同的介面卡比背景緩衝區。</span><span class="sxs-lookup"><span data-stu-id="0d060-146">However, on Windows XP and the XDDM with multiple video cards, there is a significant performance penalty when the front buffer is displayed on a different adapter than the back buffer.</span></span> <span data-ttu-id="0d060-147">如需詳細資訊，請參閱 < [WPF 和 Direct3D9 互通](wpf-and-direct3d9-interoperation.md)。</span><span class="sxs-lookup"><span data-stu-id="0d060-147">For more information, see [WPF and Direct3D9 Interoperation](wpf-and-direct3d9-interoperation.md).</span></span>  
  
## <a name="performance-summary"></a><span data-ttu-id="0d060-148">效能摘要</span><span class="sxs-lookup"><span data-stu-id="0d060-148">Performance Summary</span></span>  
 <span data-ttu-id="0d060-149">下表做為作業系統、 像素格式和介面的前景緩衝區更新的效能。</span><span class="sxs-lookup"><span data-stu-id="0d060-149">The following table shows performance of the front buffer update as a function of operating system, pixel format, and surface lockability.</span></span> <span data-ttu-id="0d060-150">背景緩衝區與前景緩衝區會假設為相同的介面卡上。</span><span class="sxs-lookup"><span data-stu-id="0d060-150">The front buffer and back buffer are assumed to be on the same adapter.</span></span> <span data-ttu-id="0d060-151">根據配接器組態中，硬體更新是一般速度也比軟體更新。</span><span class="sxs-lookup"><span data-stu-id="0d060-151">Depending on the adapter configuration, hardware updates are generally much faster than software updates.</span></span>  
  
|<span data-ttu-id="0d060-152">介面的像素格式</span><span class="sxs-lookup"><span data-stu-id="0d060-152">Surface pixel format</span></span>|<span data-ttu-id="0d060-153">Windows Vista，WDDM 9Ex</span><span class="sxs-lookup"><span data-stu-id="0d060-153">Windows Vista, WDDM and 9Ex</span></span>|<span data-ttu-id="0d060-154">Windows Vista 中的其他組態</span><span class="sxs-lookup"><span data-stu-id="0d060-154">Other Windows Vista configurations</span></span>|<span data-ttu-id="0d060-155">Windows XP SP3 或 SP2 與 hotfix</span><span class="sxs-lookup"><span data-stu-id="0d060-155">Windows XP SP3 or SP2 w/ hotfix</span></span>|<span data-ttu-id="0d060-156">Windows XP SP2</span><span class="sxs-lookup"><span data-stu-id="0d060-156">Windows XP SP2</span></span>|  
|--------------------------|---------------------------------|----------------------------------------|--------------------------------------|--------------------|  
|<span data-ttu-id="0d060-157">D3DFMT_X8R8G8B8 （沒有可鎖定）</span><span class="sxs-lookup"><span data-stu-id="0d060-157">D3DFMT_X8R8G8B8 (not lockable)</span></span>|**<span data-ttu-id="0d060-158">硬體更新</span><span class="sxs-lookup"><span data-stu-id="0d060-158">Hardware Update</span></span>**|<span data-ttu-id="0d060-159">軟體更新</span><span class="sxs-lookup"><span data-stu-id="0d060-159">Software Update</span></span>|<span data-ttu-id="0d060-160">軟體更新</span><span class="sxs-lookup"><span data-stu-id="0d060-160">Software Update</span></span>|<span data-ttu-id="0d060-161">軟體更新</span><span class="sxs-lookup"><span data-stu-id="0d060-161">Software Update</span></span>|  
|<span data-ttu-id="0d060-162">D3DFMT_X8R8G8B8 (lockable)</span><span class="sxs-lookup"><span data-stu-id="0d060-162">D3DFMT_X8R8G8B8 (lockable)</span></span>|**<span data-ttu-id="0d060-163">硬體更新</span><span class="sxs-lookup"><span data-stu-id="0d060-163">Hardware Update</span></span>**|<span data-ttu-id="0d060-164">軟體更新</span><span class="sxs-lookup"><span data-stu-id="0d060-164">Software Update</span></span>|**<span data-ttu-id="0d060-165">硬體更新</span><span class="sxs-lookup"><span data-stu-id="0d060-165">Hardware Update</span></span>**|**<span data-ttu-id="0d060-166">硬體更新</span><span class="sxs-lookup"><span data-stu-id="0d060-166">Hardware Update</span></span>**|  
|<span data-ttu-id="0d060-167">D3DFMT_A8R8G8B8 （沒有可鎖定）</span><span class="sxs-lookup"><span data-stu-id="0d060-167">D3DFMT_A8R8G8B8 (not lockable)</span></span>|**<span data-ttu-id="0d060-168">硬體更新</span><span class="sxs-lookup"><span data-stu-id="0d060-168">Hardware Update</span></span>**|<span data-ttu-id="0d060-169">軟體更新</span><span class="sxs-lookup"><span data-stu-id="0d060-169">Software Update</span></span>|<span data-ttu-id="0d060-170">軟體更新</span><span class="sxs-lookup"><span data-stu-id="0d060-170">Software Update</span></span>|<span data-ttu-id="0d060-171">軟體更新</span><span class="sxs-lookup"><span data-stu-id="0d060-171">Software Update</span></span>|  
|<span data-ttu-id="0d060-172">D3DFMT_A8R8G8B8 (lockable)</span><span class="sxs-lookup"><span data-stu-id="0d060-172">D3DFMT_A8R8G8B8 (lockable)</span></span>|**<span data-ttu-id="0d060-173">硬體更新</span><span class="sxs-lookup"><span data-stu-id="0d060-173">Hardware Update</span></span>**|<span data-ttu-id="0d060-174">軟體更新</span><span class="sxs-lookup"><span data-stu-id="0d060-174">Software Update</span></span>|**<span data-ttu-id="0d060-175">硬體更新</span><span class="sxs-lookup"><span data-stu-id="0d060-175">Hardware Update</span></span>**|<span data-ttu-id="0d060-176">軟體更新</span><span class="sxs-lookup"><span data-stu-id="0d060-176">Software Update</span></span>|  
  
## <a name="see-also"></a><span data-ttu-id="0d060-177">另請參閱</span><span class="sxs-lookup"><span data-stu-id="0d060-177">See also</span></span>

- <xref:System.Windows.Interop.D3DImage>
- [<span data-ttu-id="0d060-178">WPF 和 Direct3D9 互通</span><span class="sxs-lookup"><span data-stu-id="0d060-178">WPF and Direct3D9 Interoperation</span></span>](wpf-and-direct3d9-interoperation.md)
- [<span data-ttu-id="0d060-179">逐步解說：建立 Direct3D9 內容以裝載在 WPF 中</span><span class="sxs-lookup"><span data-stu-id="0d060-179">Walkthrough: Creating Direct3D9 Content for Hosting in WPF</span></span>](walkthrough-creating-direct3d9-content-for-hosting-in-wpf.md)
- [<span data-ttu-id="0d060-180">逐步解說：將 Direct3D9 內容裝載在 WPF 中</span><span class="sxs-lookup"><span data-stu-id="0d060-180">Walkthrough: Hosting Direct3D9 Content in WPF</span></span>](walkthrough-hosting-direct3d9-content-in-wpf.md)
