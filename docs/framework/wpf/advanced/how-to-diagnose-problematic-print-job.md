---
title: 作法：診斷問題列印工作
ms.date: 03/30/2017
dev_langs:
- csharp
- vb
- cpp
helpviewer_keywords:
- troubleshooting print job problems [WPF]
- print jobs [WPF], troubleshooting
- print jobs [WPF], diagnosing problems
ms.assetid: b081a170-84c6-48f9-a487-5766a8d58a82
ms.openlocfilehash: 181248f69684860fd43648952ef4eb3cced1c0ba
ms.sourcegitcommit: 68653db98c5ea7744fd438710248935f70020dfb
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 08/22/2019
ms.locfileid: "69944628"
---
# <a name="how-to-diagnose-problematic-print-job"></a><span data-ttu-id="48685-102">HOW TO：診斷問題列印工作</span><span class="sxs-lookup"><span data-stu-id="48685-102">How to: Diagnose Problematic Print Job</span></span>
<span data-ttu-id="48685-103">網路系統管理經常處理使用者對於列印工作的相關抱怨 (不會列印或列印緩慢)。</span><span class="sxs-lookup"><span data-stu-id="48685-103">Network administrators often field complaints from users about print jobs that do not print or print slowly.</span></span> <span data-ttu-id="48685-104">在 .NET Framework Microsoft 的 Api 中公開的一組豐富的列印工作內容, 提供了一種方法來執行列印工作的快速遠端診斷。</span><span class="sxs-lookup"><span data-stu-id="48685-104">The rich set of print job properties exposed in the APIs of Microsoft .NET Framework provide a means for performing a rapid remote diagnosis of print jobs.</span></span>  
  
## <a name="example"></a><span data-ttu-id="48685-105">範例</span><span class="sxs-lookup"><span data-stu-id="48685-105">Example</span></span>  
 <span data-ttu-id="48685-106">建立這類公用程式的主要步驟如下所示。</span><span class="sxs-lookup"><span data-stu-id="48685-106">The major steps for creating this kind of utility are as follows.</span></span>  
  
1. <span data-ttu-id="48685-107">找出使用者所抱怨的列印工作。</span><span class="sxs-lookup"><span data-stu-id="48685-107">Identify the print job that the user is complaining about.</span></span> <span data-ttu-id="48685-108">使用者通常無法準確地找出來。</span><span class="sxs-lookup"><span data-stu-id="48685-108">Users often cannot do this precisely.</span></span> <span data-ttu-id="48685-109">他們可能不知道印表機的列印伺服器名稱。</span><span class="sxs-lookup"><span data-stu-id="48685-109">They may not know the names of the print servers or printers.</span></span> <span data-ttu-id="48685-110">他們可能會以不同于設定其<xref:System.Printing.PrintQueue.Location%2A>屬性的術語來描述印表機的位置。</span><span class="sxs-lookup"><span data-stu-id="48685-110">They may describe the location of the printer in different terminology than was used in setting its <xref:System.Printing.PrintQueue.Location%2A> property.</span></span> <span data-ttu-id="48685-111">因此，最好能產生使用者目前已提交的工作清單。</span><span class="sxs-lookup"><span data-stu-id="48685-111">Accordingly, it is a good idea to generate a list of the user's currently submitted jobs.</span></span> <span data-ttu-id="48685-112">如果有多項工作，使用者與列印系統管理員之間的通訊則可用來指出有問題的工作。</span><span class="sxs-lookup"><span data-stu-id="48685-112">If there is more than one, then communication between the user and the print system administrator can be used to pinpoint the job that is having problems.</span></span> <span data-ttu-id="48685-113">子步驟如下所示。</span><span class="sxs-lookup"><span data-stu-id="48685-113">The substeps are as follows.</span></span>  
  
    1. <span data-ttu-id="48685-114">取得所有列印伺服器的清單。</span><span class="sxs-lookup"><span data-stu-id="48685-114">Obtain a list of all print servers.</span></span>  
  
    2. <span data-ttu-id="48685-115">對伺服器執行迴圈，以查詢其列印佇列。</span><span class="sxs-lookup"><span data-stu-id="48685-115">Loop through the servers to query their print queues.</span></span>  
  
    3. <span data-ttu-id="48685-116">在伺服器迴圈的每次操作中，對所有伺服器的佇列執行迴圈以查詢其工作。</span><span class="sxs-lookup"><span data-stu-id="48685-116">Within each pass of the server loop, loop through all the server's queues to query their jobs</span></span>  
  
    4. <span data-ttu-id="48685-117">在佇列迴圈的每次操作中，對其工作執行迴圈並蒐集有關抱怨使用者所提出工作的識別資訊。</span><span class="sxs-lookup"><span data-stu-id="48685-117">Within each pass of the queue loop, loop through its jobs and gather identifying information about those that were submitted by the complaining user.</span></span>  
  
2. <span data-ttu-id="48685-118">找出有問題的列印工作後，檢查相關屬性以了解問題所在。</span><span class="sxs-lookup"><span data-stu-id="48685-118">When the problematic print job has been identified, examine relevant properties to see what might be the problem.</span></span> <span data-ttu-id="48685-119">例如，工作處於錯誤狀態，或者是為佇列提供服務的印表機在可列印工作之前離線？</span><span class="sxs-lookup"><span data-stu-id="48685-119">For example, is job in an error state or did the printer servicing the queue go offline before the job could print?</span></span>  
  
 <span data-ttu-id="48685-120">下列程式碼是一系列的程式碼範例。</span><span class="sxs-lookup"><span data-stu-id="48685-120">The code below is series of code examples.</span></span> <span data-ttu-id="48685-121">第一個程式碼範例包含列印佇列的迴圈執行。</span><span class="sxs-lookup"><span data-stu-id="48685-121">The first code example contains the loop through the print queues.</span></span> <span data-ttu-id="48685-122">(上面步驟 1c。)變數`myPrintQueues`是目前列印<xref:System.Printing.PrintQueueCollection>伺服器的物件。</span><span class="sxs-lookup"><span data-stu-id="48685-122">(Step 1c above.) The variable `myPrintQueues` is the <xref:System.Printing.PrintQueueCollection> object for the current print server.</span></span>  
  
 <span data-ttu-id="48685-123">程式碼範例一開始會使用<xref:System.Printing.PrintQueue.Refresh%2A?displayProperty=nameWithType>重新整理目前的列印佇列物件。</span><span class="sxs-lookup"><span data-stu-id="48685-123">The code example begins by refreshing the current print queue object with <xref:System.Printing.PrintQueue.Refresh%2A?displayProperty=nameWithType>.</span></span> <span data-ttu-id="48685-124">這可確保物件的屬性精確地呈現它所代表之實體印表機的狀態。</span><span class="sxs-lookup"><span data-stu-id="48685-124">This ensures that the object's properties accurately represent the state of the physical printer that it represents.</span></span> <span data-ttu-id="48685-125">然後, 應用程式會使用<xref:System.Printing.PrintQueue.GetPrintJobInfoCollection%2A>來取得目前列印佇列中的列印工作集合。</span><span class="sxs-lookup"><span data-stu-id="48685-125">Then the application gets the collection of print jobs currently in the print queue by using <xref:System.Printing.PrintQueue.GetPrintJobInfoCollection%2A>.</span></span>  
  
 <span data-ttu-id="48685-126">接下來, 應用程式會<xref:System.Printing.PrintSystemJobInfo>在集合中迴圈<xref:System.Printing.PrintSystemJobInfo.Submitter%2A> , 並比較每個屬性與抱怨使用者的別名。</span><span class="sxs-lookup"><span data-stu-id="48685-126">Next the application loops through the <xref:System.Printing.PrintSystemJobInfo> collection and compares each <xref:System.Printing.PrintSystemJobInfo.Submitter%2A> property with the alias of the complaining user.</span></span> <span data-ttu-id="48685-127">如果兩者相符，應用程式會將有關工作的識別資訊新增至將要呈現的字串。</span><span class="sxs-lookup"><span data-stu-id="48685-127">If they match, the application adds identifying information about the job to the string that will be presented.</span></span> <span data-ttu-id="48685-128">(`userName` 和 `jobList` 變數稍早已在應用程式中初始化。)</span><span class="sxs-lookup"><span data-stu-id="48685-128">(The `userName` and `jobList` variables are initialized earlier in the application.)</span></span>  
  
 [!code-cpp[DiagnoseProblematicPrintJob#EnumerateJobsInQueues](~/samples/snippets/cpp/VS_Snippets_Wpf/DiagnoseProblematicPrintJob/CPP/Program.cpp#enumeratejobsinqueues)]
 [!code-csharp[DiagnoseProblematicPrintJob#EnumerateJobsInQueues](~/samples/snippets/csharp/VS_Snippets_Wpf/DiagnoseProblematicPrintJob/CSharp/Program.cs#enumeratejobsinqueues)]
 [!code-vb[DiagnoseProblematicPrintJob#EnumerateJobsInQueues](~/samples/snippets/visualbasic/VS_Snippets_Wpf/DiagnoseProblematicPrintJob/visualbasic/program.vb#enumeratejobsinqueues)]  
  
 <span data-ttu-id="48685-129">下一個程式碼範例會在步驟 2 中挑選應用程式。</span><span class="sxs-lookup"><span data-stu-id="48685-129">The next code example picks up the application at Step 2.</span></span> <span data-ttu-id="48685-130">(請參閱上面的資訊。)已找出有問題的工作，而且應用程式提示輸入將用來識別該工作的資訊。</span><span class="sxs-lookup"><span data-stu-id="48685-130">(See above.) The problematic job has been identified and the application prompts for the information that will identify it.</span></span> <span data-ttu-id="48685-131">在此資訊中, <xref:System.Printing.PrintServer>它<xref:System.Printing.PrintQueue>會建立<xref:System.Printing.PrintSystemJobInfo> 、和物件。</span><span class="sxs-lookup"><span data-stu-id="48685-131">From this information it creates <xref:System.Printing.PrintServer>, <xref:System.Printing.PrintQueue>, and <xref:System.Printing.PrintSystemJobInfo> objects.</span></span>  
  
 <span data-ttu-id="48685-132">此時應用程式包含一個分支結構，其對應於檢查列印工作狀態的兩種方法︰</span><span class="sxs-lookup"><span data-stu-id="48685-132">At this point the application contains a branching structure corresponding to the two ways of checking a print job's status:</span></span>  
  
- <span data-ttu-id="48685-133">您可以讀取屬於類型<xref:System.Printing.PrintSystemJobInfo.JobStatus%2A> <xref:System.Printing.PrintJobStatus>之屬性的旗標。</span><span class="sxs-lookup"><span data-stu-id="48685-133">You can read the flags of the <xref:System.Printing.PrintSystemJobInfo.JobStatus%2A> property which is of type <xref:System.Printing.PrintJobStatus>.</span></span>  
  
- <span data-ttu-id="48685-134">您可以讀取每個相關屬性<xref:System.Printing.PrintSystemJobInfo.IsBlocked%2A> , 例如和。 <xref:System.Printing.PrintSystemJobInfo.IsInError%2A></span><span class="sxs-lookup"><span data-stu-id="48685-134">You can read each relevant property such as <xref:System.Printing.PrintSystemJobInfo.IsBlocked%2A> and <xref:System.Printing.PrintSystemJobInfo.IsInError%2A>.</span></span>  
  
 <span data-ttu-id="48685-135">這個範例會示範這兩種方法, 因此, 如果使用者想要使用<xref:System.Printing.PrintSystemJobInfo.JobStatus%2A>屬性的旗標, 則先前會提示使用者輸入要使用的方法, 並以 "Y" 回應。</span><span class="sxs-lookup"><span data-stu-id="48685-135">This example demonstrates both methods, so the user was previously prompted as to which method to use and responded with "Y" if he or she wanted to use the flags of the <xref:System.Printing.PrintSystemJobInfo.JobStatus%2A> property.</span></span> <span data-ttu-id="48685-136">請參閱以下兩種方法的詳細資訊。</span><span class="sxs-lookup"><span data-stu-id="48685-136">See below for the details of the two methods.</span></span> <span data-ttu-id="48685-137">最後，應用程式會使用稱為 **ReportQueueAndJobAvailability** 的方法來報告是否可以在每天此時列印此工作。</span><span class="sxs-lookup"><span data-stu-id="48685-137">Finally, the application uses a method called **ReportQueueAndJobAvailability** to report on whether the job can be printed at this time of day.</span></span> <span data-ttu-id="48685-138">[得知列印工作是否可在此時列印](how-to-discover-whether-a-print-job-can-be-printed-at-this-time-of-day.md)會討論此方法。</span><span class="sxs-lookup"><span data-stu-id="48685-138">This method is discussed in [Discover Whether a Print Job Can Be Printed At This Time of Day](how-to-discover-whether-a-print-job-can-be-printed-at-this-time-of-day.md).</span></span>  
  
 [!code-cpp[DiagnoseProblematicPrintJob#IdentifyAndDiagnoseProblematicJob](~/samples/snippets/cpp/VS_Snippets_Wpf/DiagnoseProblematicPrintJob/CPP/Program.cpp#identifyanddiagnoseproblematicjob)]
 [!code-csharp[DiagnoseProblematicPrintJob#IdentifyAndDiagnoseProblematicJob](~/samples/snippets/csharp/VS_Snippets_Wpf/DiagnoseProblematicPrintJob/CSharp/Program.cs#identifyanddiagnoseproblematicjob)]
 [!code-vb[DiagnoseProblematicPrintJob#IdentifyAndDiagnoseProblematicJob](~/samples/snippets/visualbasic/VS_Snippets_Wpf/DiagnoseProblematicPrintJob/visualbasic/program.vb#identifyanddiagnoseproblematicjob)]  
  
 <span data-ttu-id="48685-139">若要使用<xref:System.Printing.PrintSystemJobInfo.JobStatus%2A>屬性的旗標來檢查列印工作狀態, 請檢查每個相關的旗標, 以查看是否已設定。</span><span class="sxs-lookup"><span data-stu-id="48685-139">To check print job status using the flags of the <xref:System.Printing.PrintSystemJobInfo.JobStatus%2A> property, you check each relevant flag to see if it is set.</span></span> <span data-ttu-id="48685-140">若要查看是否已在一組位元旗標中設定一個位元，標準方法就是以這組旗標做為一個運算元，而旗標本身做為另一個運算元來執行邏輯 AND 運算。</span><span class="sxs-lookup"><span data-stu-id="48685-140">The standard way to see if one bit is set in a set of bit flags is to perform a logical AND operation with the set of flags as one operand and the flag itself as the other.</span></span> <span data-ttu-id="48685-141">因為旗標本身只會設定一個位元，所以邏輯 AND 的結果是最多設定相同的位元。</span><span class="sxs-lookup"><span data-stu-id="48685-141">Since the flag itself has only one bit set, the result of the logical AND is that, at most, that same bit is set.</span></span> <span data-ttu-id="48685-142">若要查明是否如此，只要比較邏輯 AND 的結果與旗標本身。</span><span class="sxs-lookup"><span data-stu-id="48685-142">To find out whether it is or not, just compare the result of the logical AND with the flag itself.</span></span> <span data-ttu-id="48685-143">如需詳細資訊, <xref:System.Printing.PrintJobStatus>請參閱[& 運算子 (C#參考)](../../../csharp/language-reference/operators/bitwise-and-shift-operators.md#logical-and-operator-)和。 <xref:System.FlagsAttribute></span><span class="sxs-lookup"><span data-stu-id="48685-143">For more information, see <xref:System.Printing.PrintJobStatus>, the [& Operator (C# Reference)](../../../csharp/language-reference/operators/bitwise-and-shift-operators.md#logical-and-operator-), and <xref:System.FlagsAttribute>.</span></span>  
  
 <span data-ttu-id="48685-144">對於已設定位元的每個屬性，程式碼會將此回報至主控台畫面，而且有時會建議回應方式。</span><span class="sxs-lookup"><span data-stu-id="48685-144">For each attribute whose bit is set, the code reports this to the console screen and sometimes suggests a way to respond.</span></span> <span data-ttu-id="48685-145">(下面會討論工作或佇列暫停時所呼叫的 **HandlePausedJob** 方法。)</span><span class="sxs-lookup"><span data-stu-id="48685-145">(The **HandlePausedJob** method that is called if the job or queue is paused is discussed below.)</span></span>  
  
 [!code-cpp[DiagnoseProblematicPrintJob#SpotTroubleUsingJobAttributes](~/samples/snippets/cpp/VS_Snippets_Wpf/DiagnoseProblematicPrintJob/CPP/Program.cpp#spottroubleusingjobattributes)]
 [!code-csharp[DiagnoseProblematicPrintJob#SpotTroubleUsingJobAttributes](~/samples/snippets/csharp/VS_Snippets_Wpf/DiagnoseProblematicPrintJob/CSharp/Program.cs#spottroubleusingjobattributes)]
 [!code-vb[DiagnoseProblematicPrintJob#SpotTroubleUsingJobAttributes](~/samples/snippets/visualbasic/VS_Snippets_Wpf/DiagnoseProblematicPrintJob/visualbasic/program.vb#spottroubleusingjobattributes)]  
  
 <span data-ttu-id="48685-146">若要使用不同的屬性來檢查列印工作狀態，您只要讀取每個屬性，如果屬性為 `true`，則會回報至主控台畫面並可能建議回應方式。</span><span class="sxs-lookup"><span data-stu-id="48685-146">To check print job status using separate properties, you simply read each property and, if the property is `true`, report to the console screen and possibly suggest a way to respond.</span></span> <span data-ttu-id="48685-147">(下面會討論工作或佇列暫停時所呼叫的 **HandlePausedJob** 方法。)</span><span class="sxs-lookup"><span data-stu-id="48685-147">(The **HandlePausedJob** method that is called if the job or queue is paused is discussed below.)</span></span>  
  
 [!code-cpp[DiagnoseProblematicPrintJob#SpotTroubleUsingJobProperties](~/samples/snippets/cpp/VS_Snippets_Wpf/DiagnoseProblematicPrintJob/CPP/Program.cpp#spottroubleusingjobproperties)]
 [!code-csharp[DiagnoseProblematicPrintJob#SpotTroubleUsingJobProperties](~/samples/snippets/csharp/VS_Snippets_Wpf/DiagnoseProblematicPrintJob/CSharp/Program.cs#spottroubleusingjobproperties)]
 [!code-vb[DiagnoseProblematicPrintJob#SpotTroubleUsingJobProperties](~/samples/snippets/visualbasic/VS_Snippets_Wpf/DiagnoseProblematicPrintJob/visualbasic/program.vb#spottroubleusingjobproperties)]  
  
 <span data-ttu-id="48685-148">**HandlePausedJob** 方法可讓應用程式的使用者從遠端繼續進行已暫停的工作。</span><span class="sxs-lookup"><span data-stu-id="48685-148">The **HandlePausedJob** method enables the application's user to remotely resume paused jobs.</span></span> <span data-ttu-id="48685-149">因為列印佇列暫停可能有充分的理由，所以此方法一開始會提示使用者決定是否要繼續進行。</span><span class="sxs-lookup"><span data-stu-id="48685-149">Because there might be a good reason why the print queue was paused, the method begins by prompting for a user decision about whether to resume it.</span></span> <span data-ttu-id="48685-150">如果答案是「Y」, <xref:System.Printing.PrintQueue.Resume%2A?displayProperty=nameWithType>則會呼叫方法。</span><span class="sxs-lookup"><span data-stu-id="48685-150">If the answer is "Y", then the <xref:System.Printing.PrintQueue.Resume%2A?displayProperty=nameWithType> method is called.</span></span>  
  
 <span data-ttu-id="48685-151">接著會提示使用者決定工作本身是否應該繼續進行，以防萬一其獨立暫停 (與列印佇列無關)。</span><span class="sxs-lookup"><span data-stu-id="48685-151">Next the user is prompted to decide if the job itself should be resumed, just in case it is paused independently of the print queue.</span></span> <span data-ttu-id="48685-152">(比較<xref:System.Printing.PrintQueue.IsPaused%2A?displayProperty=nameWithType>和<xref:System.Printing.PrintSystemJobInfo.IsPaused%2A?displayProperty=nameWithType>)。如果答案是「Y」, 則<xref:System.Printing.PrintSystemJobInfo.Resume%2A?displayProperty=nameWithType>會呼叫, 否則<xref:System.Printing.PrintSystemJobInfo.Cancel%2A>會呼叫。</span><span class="sxs-lookup"><span data-stu-id="48685-152">(Compare <xref:System.Printing.PrintQueue.IsPaused%2A?displayProperty=nameWithType> and <xref:System.Printing.PrintSystemJobInfo.IsPaused%2A?displayProperty=nameWithType>.) If the answer is "Y", then <xref:System.Printing.PrintSystemJobInfo.Resume%2A?displayProperty=nameWithType> is called; otherwise <xref:System.Printing.PrintSystemJobInfo.Cancel%2A> is called.</span></span>  
  
 [!code-cpp[DiagnoseProblematicPrintJob#HandlePausedJob](~/samples/snippets/cpp/VS_Snippets_Wpf/DiagnoseProblematicPrintJob/CPP/Program.cpp#handlepausedjob)]
 [!code-csharp[DiagnoseProblematicPrintJob#HandlePausedJob](~/samples/snippets/csharp/VS_Snippets_Wpf/DiagnoseProblematicPrintJob/CSharp/Program.cs#handlepausedjob)]
 [!code-vb[DiagnoseProblematicPrintJob#HandlePausedJob](~/samples/snippets/visualbasic/VS_Snippets_Wpf/DiagnoseProblematicPrintJob/visualbasic/program.vb#handlepausedjob)]  
  
## <a name="see-also"></a><span data-ttu-id="48685-153">另請參閱</span><span class="sxs-lookup"><span data-stu-id="48685-153">See also</span></span>

- <xref:System.Printing.PrintJobStatus>
- <xref:System.Printing.PrintSystemJobInfo>
- <xref:System.FlagsAttribute>
- <xref:System.Printing.PrintQueue>
- [<span data-ttu-id="48685-154">& 運算子 (C#參考)</span><span class="sxs-lookup"><span data-stu-id="48685-154">& Operator (C# Reference)</span></span>](../../../csharp/language-reference/operators/bitwise-and-shift-operators.md#logical-and-operator-)
- [<span data-ttu-id="48685-155">WPF 中的文件</span><span class="sxs-lookup"><span data-stu-id="48685-155">Documents in WPF</span></span>](documents-in-wpf.md)
- [<span data-ttu-id="48685-156">列印概觀</span><span class="sxs-lookup"><span data-stu-id="48685-156">Printing Overview</span></span>](printing-overview.md)
