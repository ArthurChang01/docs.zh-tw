---
title: "Unmanaged 程式碼的安全編碼指南"
ms.custom: 
ms.date: 03/30/2017
ms.prod: .net-framework
ms.reviewer: 
ms.suite: 
ms.technology:
- dotnet-clr
ms.tgt_pltfrm: 
ms.topic: article
dev_langs:
- VB
- CSharp
- C++
- jsharp
helpviewer_keywords:
- code security, unmanaged code
- unmanaged code, securing
- security [.NET Framework], unmanaged code
- secure coding, unmanaged code
ms.assetid: a8d15139-d368-4c9c-a747-ba757781117c
caps.latest.revision: 13
author: mairaw
ms.author: mairaw
manager: wpickett
ms.translationtype: HT
ms.sourcegitcommit: 306c608dc7f97594ef6f72ae0f5aaba596c936e1
ms.openlocfilehash: 5ebd50589c1ee2710e9d5dfe2c5110554be19ca5
ms.contentlocale: zh-tw
ms.lasthandoff: 08/21/2017

---
# <a name="secure-coding-guidelines-for-unmanaged-code"></a><span data-ttu-id="36e8c-102">Unmanaged 程式碼的安全編碼指南</span><span class="sxs-lookup"><span data-stu-id="36e8c-102">Secure Coding Guidelines for Unmanaged Code</span></span>
<span data-ttu-id="36e8c-103">某些程式庫程式碼需要呼叫 Unmanaged 程式碼 (例如原生程式碼 API，像是 Win32)。</span><span class="sxs-lookup"><span data-stu-id="36e8c-103">Some library code needs to call into unmanaged code (for example, native code APIs, such as Win32).</span></span> <span data-ttu-id="36e8c-104">由於這表示要越過 Managed 程式碼的安全性範疇，所以充分的警告是必要的。</span><span class="sxs-lookup"><span data-stu-id="36e8c-104">Because this means going outside the security perimeter for managed code, due caution is required.</span></span> <span data-ttu-id="36e8c-105">若您的程式碼是安全性中性的，則您的程式碼以及它所呼叫的任何程式碼，都必須具備 Unmanaged 程式碼權限 (指定了具有<xref:System.Security.Permissions.SecurityPermission> 旗標的 <xref:System.Security.Permissions.SecurityPermissionFlag.UnmanagedCode> )。</span><span class="sxs-lookup"><span data-stu-id="36e8c-105">If your code is security-neutral, both your code and any code that calls it must have unmanaged code permission (<xref:System.Security.Permissions.SecurityPermission> with the <xref:System.Security.Permissions.SecurityPermissionFlag.UnmanagedCode> flag specified).</span></span>  
  
 <span data-ttu-id="36e8c-106">不過對於您的呼叫端而言，擁有這類強大的權限並不合理。</span><span class="sxs-lookup"><span data-stu-id="36e8c-106">However, it is often unreasonable for your caller to have such powerful permissions.</span></span> <span data-ttu-id="36e8c-107">在這種情況下，您信任的程式碼可做為中間人，類似 Managed 包裝函式或程式庫程式碼，如設定包裝函式程式碼的安全性 [Safe.GetTimeOfDay](../../../docs/framework/misc/securing-wrapper-code.md)所述。</span><span class="sxs-lookup"><span data-stu-id="36e8c-107">In such cases, your trusted code can be the go-between, similar to the managed wrapper or library code described in [Securing Wrapper Code](../../../docs/framework/misc/securing-wrapper-code.md).</span></span> <span data-ttu-id="36e8c-108">如果基礎 Unmanaged 程式碼功能是完全安全的，則可以直接公開；否則，適當的權限檢查 (要求) 在第一次是必要的。</span><span class="sxs-lookup"><span data-stu-id="36e8c-108">If the underlying unmanaged code functionality is totally safe, it can be directly exposed; otherwise, a suitable permission check (demand) is required first.</span></span>  
  
 <span data-ttu-id="36e8c-109">當您的程式碼呼叫 Unmanaged 程式碼，但您不想要求呼叫端擁有存取 Unmanaged 程式碼的權限時，則必須判斷提示該權限。</span><span class="sxs-lookup"><span data-stu-id="36e8c-109">When your code calls into unmanaged code but you do not want to require your callers to have permission to access unmanaged code, you must assert that right.</span></span> <span data-ttu-id="36e8c-110">判斷提示會封鎖您框架上的堆疊查核行程。</span><span class="sxs-lookup"><span data-stu-id="36e8c-110">An assertion blocks the stack walk at your frame.</span></span> <span data-ttu-id="36e8c-111">您必須非常小心，不要在此處理序中建立安全性漏洞。</span><span class="sxs-lookup"><span data-stu-id="36e8c-111">You must be careful that you do not create a security hole in this process.</span></span> <span data-ttu-id="36e8c-112">通常，這表示您必須要求呼叫端的適當權限，然後使用 Unmanaged 程式碼執行只有該權限所允許的動作。</span><span class="sxs-lookup"><span data-stu-id="36e8c-112">Usually, this means that you must demand a suitable permission of your callers and then use unmanaged code to perform only what that permission allows and no more.</span></span> <span data-ttu-id="36e8c-113">在某些情況下 (例如取得一天中的時間之函式)，Unmanaged 程式碼可以直接公開給呼叫端，而不需任何安全性檢查。</span><span class="sxs-lookup"><span data-stu-id="36e8c-113">In some cases (for example, a get time-of-day function), unmanaged code can be directly exposed to callers without any security checks.</span></span> <span data-ttu-id="36e8c-114">在任何情況下，判斷提示的任何程式碼都必須確保安全。</span><span class="sxs-lookup"><span data-stu-id="36e8c-114">In any case, any code that asserts must take responsibility for security.</span></span>  
  
 <span data-ttu-id="36e8c-115">由於提供進入原生程式碼的程式碼路徑之任何 Managed 程式碼都是惡意程式碼的潛在目標，所以必須特別小心地判斷哪些 Unmanaged 程式碼可以安全使用及如何使用。</span><span class="sxs-lookup"><span data-stu-id="36e8c-115">Because any managed code that provides a code path into native code is a potential target for malicious code, determining which unmanaged code can be safely used and how it must be used requires extreme care.</span></span> <span data-ttu-id="36e8c-116">一般而言，Unmanaged 程式碼應該永遠不會直接公開給部分信任呼叫端。</span><span class="sxs-lookup"><span data-stu-id="36e8c-116">Generally, unmanaged code should never be directly exposed to partially trusted callers.</span></span> <span data-ttu-id="36e8c-117">在可由部分信任程式碼呼叫的程式庫中，評估使用 Unmanaged 程式碼的安全性時，有兩個主要的考量：</span><span class="sxs-lookup"><span data-stu-id="36e8c-117">There are two primary considerations in evaluating the safety of unmanaged code use in libraries that are callable by partially trusted code:</span></span>  
  
-   <span data-ttu-id="36e8c-118">功能**Safe.GetTimeOfDay**。</span><span class="sxs-lookup"><span data-stu-id="36e8c-118">**Functionality**.</span></span> <span data-ttu-id="36e8c-119">Unmanaged 的 API 是否會提供功能，不允許呼叫端執行有潛在危險的作業？</span><span class="sxs-lookup"><span data-stu-id="36e8c-119">Does the unmanaged API provide functionality that does not allow callers to perform potentially dangerous operations?</span></span> <span data-ttu-id="36e8c-120">程式碼存取安全性會使用權限來強制執行資源的存取權，因此請考慮 API 是否使用檔案、使用者介面或執行緒處理，或是否會公開受保護的資訊。</span><span class="sxs-lookup"><span data-stu-id="36e8c-120">Code access security uses permissions to enforce access to resources, so consider whether the API uses files, a user interface, or threading, or whether it exposes protected information.</span></span> <span data-ttu-id="36e8c-121">若是如此，包裝它的 Managed 程式碼必須要求必要的權限，才能允許它進入。</span><span class="sxs-lookup"><span data-stu-id="36e8c-121">If it does, the managed code wrapping it must demand the necessary permissions before allowing it to be entered.</span></span> <span data-ttu-id="36e8c-122">此外，當不受權限保護時，記憶體存取必須限定為嚴格的類型安全。</span><span class="sxs-lookup"><span data-stu-id="36e8c-122">Additionally, while not protected by a permission, memory access must be confined to strict type safety.</span></span>  
  
-   <span data-ttu-id="36e8c-123">參數檢查**Safe.GetTimeOfDay**。</span><span class="sxs-lookup"><span data-stu-id="36e8c-123">**Parameter checking**.</span></span> <span data-ttu-id="36e8c-124">常見的攻擊會傳遞非預期的參數給公開的 Unmanaged 程式碼 API 方法，嘗試造成不合規格的運作。</span><span class="sxs-lookup"><span data-stu-id="36e8c-124">A common attack passes unexpected parameters to exposed unmanaged code API methods in an attempt to cause them to operate out of specification.</span></span> <span data-ttu-id="36e8c-125">使用超出範圍的索引或位移值的緩衝區滿溢是此類型攻擊的常見範例，就如可能會在基礎程式碼中惡意探索 Bug 的任何參數。</span><span class="sxs-lookup"><span data-stu-id="36e8c-125">Buffer overruns using out-of-range index or offset values are one common example of this type of attack, as are any parameters that might exploit a bug in the underlying code.</span></span> <span data-ttu-id="36e8c-126">因此，即使 Unmanaged 程式碼 API 對於部分信任呼叫端在功能上是安全的 (在所需的要求之後)，Managed 程式碼仍必須徹底檢查參數有效性，以確保沒有可能來自使用 Managed 程式碼包裝函式層的惡意程式碼之非預期呼叫。</span><span class="sxs-lookup"><span data-stu-id="36e8c-126">Thus, even if the unmanaged code API is functionally safe (after necessary demands) for partially trusted callers, managed code must also check parameter validity exhaustively to ensure that no unintended calls are possible from malicious code using the managed code wrapper layer.</span></span>  
  
## <a name="using-suppressunmanagedcodesecurityattribute"></a><span data-ttu-id="36e8c-127">使用 SuppressUnmanagedCodeSecurityAttribute</span><span class="sxs-lookup"><span data-stu-id="36e8c-127">Using SuppressUnmanagedCodeSecurityAttribute</span></span>  
 <span data-ttu-id="36e8c-128">有先判斷提示，然後再呼叫 Unmanaged 程式碼的效能層面。</span><span class="sxs-lookup"><span data-stu-id="36e8c-128">There is a performance aspect to asserting and then calling unmanaged code.</span></span> <span data-ttu-id="36e8c-129">對於每個這類呼叫，安全性系統會自動要求 Unmanaged 程式碼權限，每次都會導致堆疊查核行程。</span><span class="sxs-lookup"><span data-stu-id="36e8c-129">For every such call, the security system automatically demands unmanaged code permission, resulting in a stack walk each time.</span></span> <span data-ttu-id="36e8c-130">如果您判斷提示，並立即呼叫 Unmanaged 程式碼，堆疊查核行程並無意義：它由您的判斷提示和 Unmanaged 程式碼呼叫所組成。</span><span class="sxs-lookup"><span data-stu-id="36e8c-130">If you assert and immediately call unmanaged code, the stack walk can be meaningless: it consists of your assert and your unmanaged code call.</span></span>  
  
 <span data-ttu-id="36e8c-131">稱為 <xref:System.Security.SuppressUnmanagedCodeSecurityAttribute> 的自訂屬性可以套用至 Unmanaged 程式碼的進入點，以停用一般安全性檢查，該檢查會要求具有 <xref:System.Security.Permissions.SecurityPermission> 指定權限的 <xref:System.Security.Permissions.SecurityPermissionFlag.UnmanagedCode> 。</span><span class="sxs-lookup"><span data-stu-id="36e8c-131">A custom attribute called <xref:System.Security.SuppressUnmanagedCodeSecurityAttribute> can be applied to unmanaged code entry points to disable the normal security check that demands <xref:System.Security.Permissions.SecurityPermission> with the <xref:System.Security.Permissions.SecurityPermissionFlag.UnmanagedCode> permission specified.</span></span> <span data-ttu-id="36e8c-132">這樣做永遠都須特別小心，因為這個動作會為進入 Unmanaged 程式碼敞開大門，而不需執行階段安全性檢查。</span><span class="sxs-lookup"><span data-stu-id="36e8c-132">Extreme caution must always be taken when doing this, because this action creates an open door into unmanaged code with no runtime security checks.</span></span> <span data-ttu-id="36e8c-133">請注意，即使套用 SuppressUnmanagedCodeSecurityAttribute **Safe.GetTimeOfDay** ，在 Just-In-Time (JIT) 編譯仍有單次安全性檢查，以確保立即呼叫者有權限呼叫 Unmanaged 程式碼。</span><span class="sxs-lookup"><span data-stu-id="36e8c-133">It should be noted that even with **SuppressUnmanagedCodeSecurityAttribute** applied, there is a one-time security check that happens at just-in-time (JIT) compilation to ensure that the immediate caller has permission to call unmanaged code.</span></span>  
  
 <span data-ttu-id="36e8c-134">如果您使用 SuppressUnmanagedCodeSecurityAttribute **Safe.GetTimeOfDay**，請檢查下列各點：</span><span class="sxs-lookup"><span data-stu-id="36e8c-134">If you use the **SuppressUnmanagedCodeSecurityAttribute**, check the following points:</span></span>  
  
-   <span data-ttu-id="36e8c-135">讓 Unmanaged 程式碼進入點位於內部，否則在您的程式碼外部無法存取。</span><span class="sxs-lookup"><span data-stu-id="36e8c-135">Make the unmanaged code entry point internal or otherwise inaccessible outside your code.</span></span>  
  
-   <span data-ttu-id="36e8c-136">對 Unmanaged 程式碼的任何呼叫都是潛在的安全性漏洞。</span><span class="sxs-lookup"><span data-stu-id="36e8c-136">Any call into unmanaged code is a potential security hole.</span></span> <span data-ttu-id="36e8c-137">請確定您的程式碼並非惡意程式碼間接呼叫 Unmanaged 程式碼並躲避安全性檢查的入口。</span><span class="sxs-lookup"><span data-stu-id="36e8c-137">Make sure your code is not a portal for malicious code to indirectly call into unmanaged code and avoid a security check.</span></span> <span data-ttu-id="36e8c-138">請視情況要求權限。</span><span class="sxs-lookup"><span data-stu-id="36e8c-138">Demand permissions, if appropriate.</span></span>  
  
-   <span data-ttu-id="36e8c-139">當您正在建立進入 Unmanaged 程式碼的危險路徑時，請使用命名慣例明確地識別，如下面小節所述。</span><span class="sxs-lookup"><span data-stu-id="36e8c-139">Use a naming convention to explicitly identify when you are creating a dangerous path into unmanaged code, as described in the section below..</span></span>  
  
## <a name="naming-convention-for-unmanaged-code-methods"></a><span data-ttu-id="36e8c-140">Unmanaged 程式碼方法的命名慣例</span><span class="sxs-lookup"><span data-stu-id="36e8c-140">Naming convention for unmanaged code methods</span></span>  
 <span data-ttu-id="36e8c-141">對於 Unmanaged 程式碼方法，已建立實用且強烈建議使用的命名慣例。</span><span class="sxs-lookup"><span data-stu-id="36e8c-141">A useful and highly recommended convention has been established for naming unmanaged code methods.</span></span> <span data-ttu-id="36e8c-142">所有 Unmanaged 程式碼方法分為三個類別：安全 **Safe.GetTimeOfDay**、原生 **Native.Xyz**和不安全 **Unsafe.DangerousAPI**。</span><span class="sxs-lookup"><span data-stu-id="36e8c-142">All unmanaged code methods are separated into three categories: **safe**, **native**, and **unsafe**.</span></span> <span data-ttu-id="36e8c-143">這些關鍵字可做為類別名稱，其中定義各種 Unmanaged 程式碼進入點的種類。</span><span class="sxs-lookup"><span data-stu-id="36e8c-143">These keywords can be used as class names within which the various kinds of unmanaged code entry points are defined.</span></span> <span data-ttu-id="36e8c-144">在原始程式碼中，這些關鍵字應該加入類別名稱，例如就像在 `Safe.GetTimeOfDay`、 `Native.Xyz`或 `Unsafe.DangerousAPI`中一樣。</span><span class="sxs-lookup"><span data-stu-id="36e8c-144">In source code, these keywords should be added to the class name, as in `Safe.GetTimeOfDay`, `Native.Xyz`, or `Unsafe.DangerousAPI`, for example.</span></span> <span data-ttu-id="36e8c-145">這些關鍵字每個都會提供對於使用該類別的開發人員相當實用的安全性資訊，如下表所述。</span><span class="sxs-lookup"><span data-stu-id="36e8c-145">Each of these keywords provides useful security information for developers using that class, as described in the following table.</span></span>  
  
|<span data-ttu-id="36e8c-146">關鍵字</span><span class="sxs-lookup"><span data-stu-id="36e8c-146">Keyword</span></span>|<span data-ttu-id="36e8c-147">安全性考量</span><span class="sxs-lookup"><span data-stu-id="36e8c-147">Security considerations</span></span>|  
|-------------|-----------------------------|  
|<span data-ttu-id="36e8c-148">**Safe.GetTimeOfDay**</span><span class="sxs-lookup"><span data-stu-id="36e8c-148">**safe**</span></span>|<span data-ttu-id="36e8c-149">對於任何程式碼，即使是惡意程式碼，呼叫都完全無害。</span><span class="sxs-lookup"><span data-stu-id="36e8c-149">Completely harmless for any code, even malicious code, to call.</span></span> <span data-ttu-id="36e8c-150">就像其他 Managed 程式碼一樣可以使用。</span><span class="sxs-lookup"><span data-stu-id="36e8c-150">Can be used just like other managed code.</span></span> <span data-ttu-id="36e8c-151">例如，取得一天中的時間之函式通常都是安全的。</span><span class="sxs-lookup"><span data-stu-id="36e8c-151">For example, a function that gets the time of day is typically safe.</span></span>|  
|<span data-ttu-id="36e8c-152">**Native.Xyz**</span><span class="sxs-lookup"><span data-stu-id="36e8c-152">**native**</span></span>|<span data-ttu-id="36e8c-153">安全性中性；也就是 Unmanaged 程式碼需要 Unmanaged 程式碼權限來呼叫。</span><span class="sxs-lookup"><span data-stu-id="36e8c-153">Security-neutral; that is, unmanaged code that requires unmanaged code permission to call.</span></span> <span data-ttu-id="36e8c-154">會檢查安全性，這會停止未經授權的呼叫端。</span><span class="sxs-lookup"><span data-stu-id="36e8c-154">Security is checked, which stops an unauthorized caller.</span></span>|  
|<span data-ttu-id="36e8c-155">**Unsafe.DangerousAPI**</span><span class="sxs-lookup"><span data-stu-id="36e8c-155">**unsafe**</span></span>|<span data-ttu-id="36e8c-156">已隱藏安全性、有潛在危險的 Unmanaged 程式碼進入點。</span><span class="sxs-lookup"><span data-stu-id="36e8c-156">Potentially dangerous unmanaged code entry point with security suppressed.</span></span> <span data-ttu-id="36e8c-157">當使用這類 Unmanaged 程式碼時，開發人員應高度警覺，確定其他保護已就位，以避免安全性弱點。</span><span class="sxs-lookup"><span data-stu-id="36e8c-157">Developers should use the greatest caution when using such unmanaged code, making sure that other protections are in place to prevent a security vulnerability.</span></span> <span data-ttu-id="36e8c-158">開發人員必須要負責，因為這個關鍵字會覆寫安全性系統。</span><span class="sxs-lookup"><span data-stu-id="36e8c-158">Developers must be responsible, as this keyword overrides the security system.</span></span>|  
  
## <a name="see-also"></a><span data-ttu-id="36e8c-159">另請參閱</span><span class="sxs-lookup"><span data-stu-id="36e8c-159">See Also</span></span>  
 [<span data-ttu-id="36e8c-160">安全程式碼撰寫方針</span><span class="sxs-lookup"><span data-stu-id="36e8c-160">Secure Coding Guidelines</span></span>](../../../docs/standard/security/secure-coding-guidelines.md)

