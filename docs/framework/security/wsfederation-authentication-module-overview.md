---
title: WSFederation 驗證模組概觀
ms.date: 03/30/2017
ms.assetid: 02c4d5e8-f0a7-49ee-9cf5-3647578510ad
author: BrucePerlerMS
ms.openlocfilehash: b13536acf71018eb21b6930d7542a9911add8261
ms.sourcegitcommit: 0be8a279af6d8a43e03141e349d3efd5d35f8767
ms.translationtype: HT
ms.contentlocale: zh-TW
ms.lasthandoff: 04/18/2019
ms.locfileid: "59310248"
---
# <a name="wsfederation-authentication-module-overview"></a><span data-ttu-id="3a898-102">WSFederation 驗證模組概觀</span><span class="sxs-lookup"><span data-stu-id="3a898-102">WSFederation Authentication Module Overview</span></span>
<span data-ttu-id="3a898-103">Windows Identity Foundation (WIF) 內含可在 ASP.NET 應用程式中透過 WS-同盟驗證模組 (WS-FAM) 提供同盟驗證的支援。</span><span class="sxs-lookup"><span data-stu-id="3a898-103">Windows Identity Foundation (WIF) includes support for federated authentication in ASP.NET applications through the WS-Federated Authentication Module (WS-FAM).</span></span> <span data-ttu-id="3a898-104">本主題將協助您了解同盟驗證的運作方式以及如何使用它。</span><span class="sxs-lookup"><span data-stu-id="3a898-104">This topic will help you understand how federated authentication works and how to use it.</span></span>  
  
### <a name="overview-of-federated-authentication"></a><span data-ttu-id="3a898-105">同盟驗證的概觀</span><span class="sxs-lookup"><span data-stu-id="3a898-105">Overview of Federated Authentication</span></span>  
 <span data-ttu-id="3a898-106">同盟驗證可讓一個信任網域中的安全性權杖服務 (STS) 將驗證資訊提供給另一個信任網域中的 STS，條件是這兩個網域之間要有信任關係。</span><span class="sxs-lookup"><span data-stu-id="3a898-106">Federated authentication allows a Security Token Service (STS) in one trust domain to provide authentication information to an STS in another trust domain when there is a trust relationship between the two domains.</span></span> <span data-ttu-id="3a898-107">下圖將示範其中一種範例。</span><span class="sxs-lookup"><span data-stu-id="3a898-107">An example of this is shown in the following illustration.</span></span>  
  
 <span data-ttu-id="3a898-108">![同盟驗證情節](../../../docs/framework/security/media/federatedauthentication.gif "FederatedAuthentication")</span><span class="sxs-lookup"><span data-stu-id="3a898-108">![Federation Authentication Scenario](../../../docs/framework/security/media/federatedauthentication.gif "FederatedAuthentication")</span></span>  
  
1. <span data-ttu-id="3a898-109">Fabrikam 信任網域中的用戶端將某個要求傳送到 Contoso 信任網域中的信賴憑證者 (RP) 應用程式。</span><span class="sxs-lookup"><span data-stu-id="3a898-109">A client in the Fabrikam trust domain sends a request to a Relying Party (RP) application in the Contoso trust domain.</span></span>  
  
2. <span data-ttu-id="3a898-110">RP 將用戶端重新導向至 Contoso 信任網域中的 STS。</span><span class="sxs-lookup"><span data-stu-id="3a898-110">The RP redirects the client to an STS in the Contoso trust domain.</span></span> <span data-ttu-id="3a898-111">這個 STS 對該用戶端一無所知。</span><span class="sxs-lookup"><span data-stu-id="3a898-111">This STS has no knowledge of the client.</span></span>  
  
3. <span data-ttu-id="3a898-112">Contoso STS 將用戶端重新導向至與 Contoso 信任網域具有信任關係的 Fabrikam 信任網域中的 STS。</span><span class="sxs-lookup"><span data-stu-id="3a898-112">The Contoso STS redirects the client to an STS in the Fabrikam trust domain, with which the Contoso trust domain has a trust relationship.</span></span>  
  
4. <span data-ttu-id="3a898-113">Fabrikam STS 驗證用戶端的身分識別，並簽發安全性權杖給 Contoso STS。</span><span class="sxs-lookup"><span data-stu-id="3a898-113">The Fabrikam STS verifies the client’s identity and issues a security token to the Contoso STS.</span></span>  
  
5. <span data-ttu-id="3a898-114">Contoso STS 使用 Fabrikam 權杖來建立屬於其自身且可由 RP 使用的權杖，並將它傳送到 RP。</span><span class="sxs-lookup"><span data-stu-id="3a898-114">The Contoso STS uses the Fabrikam token to create its own token that can be used by the RP and sends it to the RP.</span></span>  
  
6. <span data-ttu-id="3a898-115">RP 從安全性權杖擷取用戶端的宣告，並進行授權決策。</span><span class="sxs-lookup"><span data-stu-id="3a898-115">The RP extracts the client’s claims from the security token and makes an authorization decision.</span></span>  
  
### <a name="using-the-federated-authentication-module-with-aspnet"></a><span data-ttu-id="3a898-116">搭配 ASP.NET 來使用同盟驗證模組</span><span class="sxs-lookup"><span data-stu-id="3a898-116">Using the Federated Authentication Module with ASP.NET</span></span>  
 <span data-ttu-id="3a898-117"><xref:System.IdentityModel.Services.WSFederationAuthenticationModule> (WS-FAM) 是可將同盟驗證新增到 [!INCLUDE[vstecasp](../../../includes/vstecasp-md.md)] 應用程式中的 HTTP 模組。</span><span class="sxs-lookup"><span data-stu-id="3a898-117"><xref:System.IdentityModel.Services.WSFederationAuthenticationModule> (WS-FAM) is an HTTP module that lets you add federated authentication to an [!INCLUDE[vstecasp](../../../includes/vstecasp-md.md)] application.</span></span> <span data-ttu-id="3a898-118">同盟驗證會將驗證邏輯交給 STS 處理，讓您可以專心地撰寫商務邏輯。</span><span class="sxs-lookup"><span data-stu-id="3a898-118">Federated authentication lets authentication logic be handled by the STS and lets you focus on writing business logic.</span></span>  
  
 <span data-ttu-id="3a898-119">您可以設定 WS-FAM，以便指定非驗證要求將重新導向至其中的 STS。</span><span class="sxs-lookup"><span data-stu-id="3a898-119">You configure the WS-FAM to specify the STS to which non-authenticated requests should be redirected.</span></span> <span data-ttu-id="3a898-120">WIF 可讓您使用兩種方式來驗證使用者：</span><span class="sxs-lookup"><span data-stu-id="3a898-120">WIF lets you authenticate a user in two ways:</span></span>  
  
1. <span data-ttu-id="3a898-121">被動式重新導向：當未驗證的使用者嘗試存取受保護的資源，並想要只是重新導向至 STS 而不需要登入頁面時，這是正確的方法。</span><span class="sxs-lookup"><span data-stu-id="3a898-121">Passive redirect: When an unauthenticated user tries to access a protected resource, and you want to simply redirect them to an STS without requiring a login page, then this is the right approach.</span></span> <span data-ttu-id="3a898-122">STS 會驗證使用者的身分識別，並簽發包含該使用者之適當宣告的安全性權杖。</span><span class="sxs-lookup"><span data-stu-id="3a898-122">The STS verifies the user’s identity, and issues a security token that contains the appropriate claims for that user.</span></span> <span data-ttu-id="3a898-123">這個選項會要求 WS-FAM 必須加入 HTTP 模組管線中。</span><span class="sxs-lookup"><span data-stu-id="3a898-123">This option requires the WS-FAM to be added in the HTTP Modules pipeline.</span></span> <span data-ttu-id="3a898-124">您可以使用 Visual Studio 2012 的身分識別與存取工具 ，修改應用程式組態檔來使用 WS-FAM 以及建立與 STS 的同盟。</span><span class="sxs-lookup"><span data-stu-id="3a898-124">You can use the Identity and Access Tool for Visual Studio 2012 to modify your application’s configuration file to use the WS-FAM and to federate with an STS.</span></span> <span data-ttu-id="3a898-125">如需詳細資訊，請參閱 [Visual Studio 2012 的身分識別與存取工具](../../../docs/framework/security/identity-and-access-tool-for-vs.md)。</span><span class="sxs-lookup"><span data-stu-id="3a898-125">For more information, see [Identity and Access Tool for Visual Studio 2012](../../../docs/framework/security/identity-and-access-tool-for-vs.md).</span></span>  
  
2. <span data-ttu-id="3a898-126">您可以針對 RP 應用程式的登入頁面，在程式碼後置中呼叫 <xref:System.IdentityModel.Services.WSFederationAuthenticationModule.SignIn%2A?displayProperty=nameWithType> 方法或 <xref:System.IdentityModel.Services.WSFederationAuthenticationModule.RedirectToIdentityProvider%2A> 方法。</span><span class="sxs-lookup"><span data-stu-id="3a898-126">You can call the <xref:System.IdentityModel.Services.WSFederationAuthenticationModule.SignIn%2A?displayProperty=nameWithType> method or the <xref:System.IdentityModel.Services.WSFederationAuthenticationModule.RedirectToIdentityProvider%2A> method from the code-behind for a sign-in page in your RP application.</span></span>  
  
 <span data-ttu-id="3a898-127">在被動式重新導向中，所有通訊都是透過用戶端 (通常是瀏覽器) 的回應/重新導向來執行。</span><span class="sxs-lookup"><span data-stu-id="3a898-127">In passive redirect, all communication is performed through response/redirect from the client (typically a browser).</span></span> <span data-ttu-id="3a898-128">您可以將 WS-FAM 新增至應用程式的 HTTP 管線，它會在其中監看是否有未經驗證的使用者要求，並將使用者重新導向至您指定的 STS。</span><span class="sxs-lookup"><span data-stu-id="3a898-128">You can add the WS-FAM to your application’s HTTP pipeline, where it watches for unauthenticated user requests and redirects users to the STS you specify.</span></span>  
  
 <span data-ttu-id="3a898-129">WS FAM 還會引發數個事件，讓您能夠在 [!INCLUDE[vstecasp](../../../includes/vstecasp-md.md)] 應用程式中自訂其功能。</span><span class="sxs-lookup"><span data-stu-id="3a898-129">The WS-FAM also raises several events that let you customize its functionality in an [!INCLUDE[vstecasp](../../../includes/vstecasp-md.md)] application.</span></span>  
  
### <a name="how-the-ws-fam-works"></a><span data-ttu-id="3a898-130">WS-FAM 的運作方式</span><span class="sxs-lookup"><span data-stu-id="3a898-130">How the WS-FAM Works</span></span>  
 <span data-ttu-id="3a898-131">WS-FAM 會使用 <xref:System.IdentityModel.Services.WSFederationAuthenticationModule> 類別進行實作。</span><span class="sxs-lookup"><span data-stu-id="3a898-131">The WS-FAM is implemented in the <xref:System.IdentityModel.Services.WSFederationAuthenticationModule> class.</span></span> <span data-ttu-id="3a898-132">一般來說，您會將 WS-FAM 加入 [!INCLUDE[vstecasp](../../../includes/vstecasp-md.md)] RP 應用程式的 HTTP 管線。</span><span class="sxs-lookup"><span data-stu-id="3a898-132">Typically, you add the WS-FAM to the HTTP pipeline of your [!INCLUDE[vstecasp](../../../includes/vstecasp-md.md)] RP application.</span></span> <span data-ttu-id="3a898-133">當未驗證使用者嘗試存取受保護資源時，RP 就會傳回「401 授權遭拒」HTTP 回應。</span><span class="sxs-lookup"><span data-stu-id="3a898-133">When an unauthenticated user tries to access a protected resource, the RP returns a "401 authorization denied" HTTP response.</span></span> <span data-ttu-id="3a898-134">WS-FAM 會攔截這個回應而不讓用戶端接收，接著將使用者重新導向至指定的 STS。</span><span class="sxs-lookup"><span data-stu-id="3a898-134">The WS-FAM intercepts this response instead of allowing the client to receive it, then it redirects the user to the specified STS.</span></span> <span data-ttu-id="3a898-135">STS 會簽發安全性權杖，而 WS-FAM 又會再度攔截此權杖。</span><span class="sxs-lookup"><span data-stu-id="3a898-135">The STS issues a security token, which the WS-FAM again intercepts.</span></span> <span data-ttu-id="3a898-136">WS-FAM 會使用此權杖來為已驗證的使用者建立 <xref:System.Security.Claims.ClaimsPrincipal> 執行個體，如此便可使標準的 [!INCLUDE[dnprdnshort](../../../includes/dnprdnshort-md.md)] 授權機制開始運作。</span><span class="sxs-lookup"><span data-stu-id="3a898-136">The WS-FAM uses the token to create an instance of <xref:System.Security.Claims.ClaimsPrincipal> for the authenticated user, which enables regular [!INCLUDE[dnprdnshort](../../../includes/dnprdnshort-md.md)] authorization mechanisms to function.</span></span>  
  
 <span data-ttu-id="3a898-137">因為 HTTP 是無狀態的，所以我們需要採用一種方法，以避免每當使用者嘗試存取其他受保護資源時，就得重複這一整個程序的狀況。</span><span class="sxs-lookup"><span data-stu-id="3a898-137">Because HTTP is stateless, we need a way to avoid repeating this whole process every time that the user tries to access another protected resource.</span></span> <span data-ttu-id="3a898-138">這時就需要用到 <xref:System.IdentityModel.Services.SessionAuthenticationModule>。</span><span class="sxs-lookup"><span data-stu-id="3a898-138">This is where the <xref:System.IdentityModel.Services.SessionAuthenticationModule> comes in.</span></span> <span data-ttu-id="3a898-139">當 STS 簽發使用者的安全性權杖時，<xref:System.IdentityModel.Services.SessionAuthenticationModule> 也會建立該使用者的工作階段安全性權杖，並將它放入 Cookie 中。</span><span class="sxs-lookup"><span data-stu-id="3a898-139">When the STS issues a security token for the user, <xref:System.IdentityModel.Services.SessionAuthenticationModule> also creates a session security token for the user and puts it in a cookie.</span></span> <span data-ttu-id="3a898-140">在處理後續要求時，<xref:System.IdentityModel.Services.SessionAuthenticationModule> 會攔截這個 Cookie，並使用它來重新建構使用者的 <xref:System.Security.Claims.ClaimsPrincipal>。</span><span class="sxs-lookup"><span data-stu-id="3a898-140">On subsequent requests, the <xref:System.IdentityModel.Services.SessionAuthenticationModule> intercepts this cookie and uses it to reconstruct the user’s <xref:System.Security.Claims.ClaimsPrincipal>.</span></span>  
  
 <span data-ttu-id="3a898-141">下圖顯示在被動式重新導向情況下的整體資訊流程。</span><span class="sxs-lookup"><span data-stu-id="3a898-141">The following diagram shows the overall flow of information in the passive redirect case.</span></span> <span data-ttu-id="3a898-142">該要求會自動透過 STS 進行重新導向來建立認證，而無需使用登入頁面：</span><span class="sxs-lookup"><span data-stu-id="3a898-142">The request is automatically redirected via the STS to establish credentials without a login page:</span></span>  
  
 <span data-ttu-id="3a898-143">![使用被動式重新導向進行登入的時機圖表](../../../docs/framework/security/media/signinusingpassiveredirect.gif "SignInUsingPassiveRedirect")</span><span class="sxs-lookup"><span data-stu-id="3a898-143">![Timing diagram for sign&#45;in with passive redirect](../../../docs/framework/security/media/signinusingpassiveredirect.gif "SignInUsingPassiveRedirect")</span></span>  
  
 <span data-ttu-id="3a898-144">下圖針對使用者已向 STS 完成驗證，其安全性權杖接著由 <xref:System.IdentityModel.Services.WSFederationAuthenticationModule> 處理時所發生的狀況，提供更多詳細資料：</span><span class="sxs-lookup"><span data-stu-id="3a898-144">The following diagram shows more detail on what happens when the user has authenticated to the STS and their security tokens are processed by the <xref:System.IdentityModel.Services.WSFederationAuthenticationModule>:</span></span>  
  
 <span data-ttu-id="3a898-145">![使用被動式重新導向進行權杖處理的時機](../../../docs/framework/security/media/signinusingpassiveredirect-tokenprocessing.gif "SignInUsingPassiveRedirect_TokenProcessing")</span><span class="sxs-lookup"><span data-stu-id="3a898-145">![Timing for token processing with passive redirect](../../../docs/framework/security/media/signinusingpassiveredirect-tokenprocessing.gif "SignInUsingPassiveRedirect_TokenProcessing")</span></span>  
  
 <span data-ttu-id="3a898-146">下圖針對使用者的安全性權杖已序列化為 Cookie，並由 <xref:System.IdentityModel.Services.SessionAuthenticationModule> 進行攔截時所發生的狀況，提供更多的詳細資料：</span><span class="sxs-lookup"><span data-stu-id="3a898-146">The following diagram shows more detail on what happens when the user’s security tokens have been serialized into cookies and are intercepted by the <xref:System.IdentityModel.Services.SessionAuthenticationModule>:</span></span>  
  
 <span data-ttu-id="3a898-147">![顯示使用控制項進行登入的 SAM 時機圖表](../../../docs/framework/security/media/signinusingconrols-sam.gif "SignInUsingConrols_SAM")</span><span class="sxs-lookup"><span data-stu-id="3a898-147">![SAM timing diagram showing sign&#45;in using controls](../../../docs/framework/security/media/signinusingconrols-sam.gif "SignInUsingConrols_SAM")</span></span>  
  
### <a name="events"></a><span data-ttu-id="3a898-148">事件</span><span class="sxs-lookup"><span data-stu-id="3a898-148">Events</span></span>  
 <span data-ttu-id="3a898-149"><xref:System.IdentityModel.Services.WSFederationAuthenticationModule>、<xref:System.IdentityModel.Services.SessionAuthenticationModule> 和其父類別 <xref:System.IdentityModel.Services.HttpModuleBase>，會在許多不同的 HTTP 要求處理階段引發事件。</span><span class="sxs-lookup"><span data-stu-id="3a898-149"><xref:System.IdentityModel.Services.WSFederationAuthenticationModule>, <xref:System.IdentityModel.Services.SessionAuthenticationModule>, and their parent class, <xref:System.IdentityModel.Services.HttpModuleBase>, raise events at various stages of processing of an HTTP request.</span></span> <span data-ttu-id="3a898-150">您可以在 [!INCLUDE[vstecasp](../../../includes/vstecasp-md.md)] 應用程式的 `global.asax` 檔案中處理這些事件。</span><span class="sxs-lookup"><span data-stu-id="3a898-150">You can handle these events in the `global.asax` file of your [!INCLUDE[vstecasp](../../../includes/vstecasp-md.md)] application.</span></span>  
  
-   <span data-ttu-id="3a898-151">ASP.NET 基礎結構會叫用模組的 <xref:System.IdentityModel.Services.HttpModuleBase.Init%2A> 方法來初始化模組。</span><span class="sxs-lookup"><span data-stu-id="3a898-151">The ASP.NET infrastructure invokes the module’s <xref:System.IdentityModel.Services.HttpModuleBase.Init%2A> method to initialize the module.</span></span>  
  
-   <span data-ttu-id="3a898-152">當 ASP.NET 基礎結構在衍生自 <xref:System.IdentityModel.Services.HttpModuleBase> 的其中一個應用程式模組上第一次叫用 <xref:System.IdentityModel.Services.HttpModuleBase.Init%2A> 方法時，就會引發 <xref:System.IdentityModel.Services.FederatedAuthentication.FederationConfigurationCreated?displayProperty=nameWithType> 事件。</span><span class="sxs-lookup"><span data-stu-id="3a898-152">The <xref:System.IdentityModel.Services.FederatedAuthentication.FederationConfigurationCreated?displayProperty=nameWithType> event is raised when the ASP.NET infrastructure invokes the <xref:System.IdentityModel.Services.HttpModuleBase.Init%2A> method for the first time on one of the application’s modules that derive from <xref:System.IdentityModel.Services.HttpModuleBase>.</span></span> <span data-ttu-id="3a898-153">這個方法會存取靜態 <xref:System.IdentityModel.Services.FederatedAuthentication.FederationConfiguration%2A?displayProperty=nameWithType> 屬性，因而導致從 Web.config 檔案中載入組態。</span><span class="sxs-lookup"><span data-stu-id="3a898-153">This method accesses the static <xref:System.IdentityModel.Services.FederatedAuthentication.FederationConfiguration%2A?displayProperty=nameWithType> property, which causes configuration to be loaded from the Web.config file.</span></span> <span data-ttu-id="3a898-154">只有在第一次存取這個屬性時才會引發此事件。</span><span class="sxs-lookup"><span data-stu-id="3a898-154">This event is only raised the first time this property is accessed.</span></span> <span data-ttu-id="3a898-155">從組態初始化的 <xref:System.IdentityModel.Services.Configuration.FederationConfiguration> 物件可以透過事件處理常式中的 <xref:System.IdentityModel.Services.Configuration.FederationConfigurationCreatedEventArgs.FederationConfiguration%2A?displayProperty=nameWithType> 屬性進行存取。</span><span class="sxs-lookup"><span data-stu-id="3a898-155">The <xref:System.IdentityModel.Services.Configuration.FederationConfiguration> object that is initialized from configuration can be accessed through the <xref:System.IdentityModel.Services.Configuration.FederationConfigurationCreatedEventArgs.FederationConfiguration%2A?displayProperty=nameWithType> property in an event handler.</span></span> <span data-ttu-id="3a898-156">在將組態套用到任何模組之前，可以使用此事件來修改組態。</span><span class="sxs-lookup"><span data-stu-id="3a898-156">You can use this event to modify the configuration before it is applied to any modules.</span></span> <span data-ttu-id="3a898-157">您可以在 Application_Start 方法中加入此事件的處理常式：</span><span class="sxs-lookup"><span data-stu-id="3a898-157">You can add a handler for this event in the Application_Start method:</span></span>  
  
    ```  
    void Application_Start(object sender, EventArgs e)  
    {  
        FederatedAuthentication.FederationConfigurationCreated += new EventHandler<FederationConfigurationCreatedEventArgs>(FederatedAuthentication_FederationConfigurationCreated);  
    }  
    ```  
  
     <span data-ttu-id="3a898-158">每個模組都會覆寫 <xref:System.IdentityModel.Services.HttpModuleBase.InitializeModule%2A?displayProperty=nameWithType> 和 <xref:System.IdentityModel.Services.HttpModuleBase.InitializePropertiesFromConfiguration%2A?displayProperty=nameWithType> 抽象方法。</span><span class="sxs-lookup"><span data-stu-id="3a898-158">Each module overrides the <xref:System.IdentityModel.Services.HttpModuleBase.InitializeModule%2A?displayProperty=nameWithType> and <xref:System.IdentityModel.Services.HttpModuleBase.InitializePropertiesFromConfiguration%2A?displayProperty=nameWithType> abstract methods.</span></span> <span data-ttu-id="3a898-159">其中的第一個方法會新增與模組相關之 ASP.NET 管線事件的處理常式。</span><span class="sxs-lookup"><span data-stu-id="3a898-159">The first of these methods adds handlers for ASP.NET pipeline events that are of interest to the module.</span></span> <span data-ttu-id="3a898-160">在大部分情況下，模組的預設實作便已足夠。</span><span class="sxs-lookup"><span data-stu-id="3a898-160">In most cases the module’s default implementation will suffice.</span></span> <span data-ttu-id="3a898-161">其中的第二個方法則會從其下列屬性初始化模組的屬性：<xref:System.IdentityModel.Services.HttpModuleBase.FederationConfiguration%2A?displayProperty=nameWithType> 屬性。</span><span class="sxs-lookup"><span data-stu-id="3a898-161">The second of these methods initializes the module’s properties from its <xref:System.IdentityModel.Services.HttpModuleBase.FederationConfiguration%2A?displayProperty=nameWithType> property.</span></span> <span data-ttu-id="3a898-162">(這是先前所載入之組態的複本)。如果您想要針對類別組態中衍生自 <xref:System.IdentityModel.Services.WSFederationAuthenticationModule> 或 <xref:System.IdentityModel.Services.SessionAuthenticationModule> 的新屬性支援其初始化作業，則可以覆寫第二個方法。</span><span class="sxs-lookup"><span data-stu-id="3a898-162">(This is a copy of the configuration that was loaded previously.) You may need to override this second method if you want to support the initialization of new properties from configuration in classes that you derive from <xref:System.IdentityModel.Services.WSFederationAuthenticationModule> or <xref:System.IdentityModel.Services.SessionAuthenticationModule>.</span></span> <span data-ttu-id="3a898-163">在這種情況下，您也必須衍生自適當的組態物件，才能支援新增的組態屬性；例如，衍生自 <xref:System.IdentityModel.Configuration.IdentityConfiguration>、<xref:System.IdentityModel.Services.Configuration.WsFederationConfiguration> 或 <xref:System.IdentityModel.Services.Configuration.FederationConfiguration>。</span><span class="sxs-lookup"><span data-stu-id="3a898-163">In such cases you would also need to derive from the appropriate configuration objects to support the added configuration properties; for example, from <xref:System.IdentityModel.Configuration.IdentityConfiguration>, <xref:System.IdentityModel.Services.Configuration.WsFederationConfiguration>, or <xref:System.IdentityModel.Services.Configuration.FederationConfiguration>.</span></span>  
  
-   <span data-ttu-id="3a898-164">WS-FAM 在攔截 STS 所簽發的安全性權杖時，會引發 <xref:System.IdentityModel.Services.WSFederationAuthenticationModule.SecurityTokenReceived> 事件。</span><span class="sxs-lookup"><span data-stu-id="3a898-164">The WS-FAM raises the <xref:System.IdentityModel.Services.WSFederationAuthenticationModule.SecurityTokenReceived> event when it intercepts a security token that has been issued by the STS.</span></span>  
  
-   <span data-ttu-id="3a898-165">WS-FAM 在驗證權杖之後，會引發 <xref:System.IdentityModel.Services.WSFederationAuthenticationModule.SecurityTokenValidated> 事件。</span><span class="sxs-lookup"><span data-stu-id="3a898-165">The WS-FAM raises the <xref:System.IdentityModel.Services.WSFederationAuthenticationModule.SecurityTokenValidated> event after it has validated the token.</span></span>  
  
-   <span data-ttu-id="3a898-166"><xref:System.IdentityModel.Services.SessionAuthenticationModule> 在建立使用者的工作階段安全性權杖時，會引發 <xref:System.IdentityModel.Services.SessionAuthenticationModule.SessionSecurityTokenCreated> 事件。</span><span class="sxs-lookup"><span data-stu-id="3a898-166">The <xref:System.IdentityModel.Services.SessionAuthenticationModule> raises the <xref:System.IdentityModel.Services.SessionAuthenticationModule.SessionSecurityTokenCreated> event when it creates a session security token for the user.</span></span>  
  
-   <span data-ttu-id="3a898-167"><xref:System.IdentityModel.Services.SessionAuthenticationModule> 在攔截其 Cookie 包含工作階段安全性權杖的後續要求時，會引發 <xref:System.IdentityModel.Services.SessionAuthenticationModule.SessionSecurityTokenReceived> 事件。</span><span class="sxs-lookup"><span data-stu-id="3a898-167">The <xref:System.IdentityModel.Services.SessionAuthenticationModule> raises the <xref:System.IdentityModel.Services.SessionAuthenticationModule.SessionSecurityTokenReceived> event when it intercepts subsequent requests with the cookie that contains the session security token.</span></span>  
  
-   <span data-ttu-id="3a898-168">在 WS-FAM 將使用者重新導向至簽發者之前，它會引發 <xref:System.IdentityModel.Services.WSFederationAuthenticationModule.RedirectingToIdentityProvider> 事件。</span><span class="sxs-lookup"><span data-stu-id="3a898-168">Before the WS-FAM redirects the user to the issuer, it raises the <xref:System.IdentityModel.Services.WSFederationAuthenticationModule.RedirectingToIdentityProvider> event.</span></span> <span data-ttu-id="3a898-169">WS-同盟登入要求是透過事件所傳遞之 <xref:System.IdentityModel.Services.RedirectingToIdentityProviderEventArgs> 的 <xref:System.IdentityModel.Services.RedirectingToIdentityProviderEventArgs.SignInRequestMessage%2A> 屬性來提供。</span><span class="sxs-lookup"><span data-stu-id="3a898-169">The WS-Federation sign-in request is available through the <xref:System.IdentityModel.Services.RedirectingToIdentityProviderEventArgs.SignInRequestMessage%2A> property of the <xref:System.IdentityModel.Services.RedirectingToIdentityProviderEventArgs> passed in the event.</span></span> <span data-ttu-id="3a898-170">您可以選擇修改要求，再將此要求傳送給簽發者。</span><span class="sxs-lookup"><span data-stu-id="3a898-170">You may choose to modify the request before sending this out to the issuer.</span></span>  
  
-   <span data-ttu-id="3a898-171">當 Cookie 順利寫入且使用者已登入時，WS-FAM 會引發 <xref:System.IdentityModel.Services.WSFederationAuthenticationModule.SignedIn> 事件。</span><span class="sxs-lookup"><span data-stu-id="3a898-171">The WS-FAM raises the <xref:System.IdentityModel.Services.WSFederationAuthenticationModule.SignedIn> event when the cookie is successfully written and the user is signed in.</span></span>  
  
-   <span data-ttu-id="3a898-172">WS-FAM 會在每個使用者的工作階段關閉時，針對每一個工作階段引發 <xref:System.IdentityModel.Services.WSFederationAuthenticationModule.SigningOut> 事件一次。</span><span class="sxs-lookup"><span data-stu-id="3a898-172">The WS-FAM raises the <xref:System.IdentityModel.Services.WSFederationAuthenticationModule.SigningOut> event one time per session as the session is being closed down for each user.</span></span> <span data-ttu-id="3a898-173">如果工作階段是在用戶端上關閉 (例如，藉由刪除工作階段 Cookie)，則不會引發此事件。</span><span class="sxs-lookup"><span data-stu-id="3a898-173">It is not raised if the session is closed down on the client-side (for example, by deleting the session cookie).</span></span> <span data-ttu-id="3a898-174">在 SSO 環境中，IP-STS 也可以要求每個 RP 登出。</span><span class="sxs-lookup"><span data-stu-id="3a898-174">In an SSO environment, the IP-STS can request each RP to sign out, too.</span></span> <span data-ttu-id="3a898-175">若將 <xref:System.IdentityModel.Services.SigningOutEventArgs.IsIPInitiated%2A> 設定為 `true`，這也會引發此事件。</span><span class="sxs-lookup"><span data-stu-id="3a898-175">This will also raise this event, with <xref:System.IdentityModel.Services.SigningOutEventArgs.IsIPInitiated%2A> set to `true`.</span></span>  
  
> [!NOTE]
>  <span data-ttu-id="3a898-176">您不應該在 <xref:System.IdentityModel.Services.WSFederationAuthenticationModule> 或 <xref:System.IdentityModel.Services.SessionAuthenticationModule> 所引發的任何事件期間使用 <xref:System.Threading.Thread.CurrentPrincipal%2A?displayProperty=nameWithType> 屬性。</span><span class="sxs-lookup"><span data-stu-id="3a898-176">You should not use the <xref:System.Threading.Thread.CurrentPrincipal%2A?displayProperty=nameWithType> property during any event raised by <xref:System.IdentityModel.Services.WSFederationAuthenticationModule> or <xref:System.IdentityModel.Services.SessionAuthenticationModule>.</span></span> <span data-ttu-id="3a898-177">這是因為 <xref:System.Threading.Thread.CurrentPrincipal%2A?displayProperty=nameWithType> 會在驗證程序之後才設定，而事件則是在驗證程序期間引發。</span><span class="sxs-lookup"><span data-stu-id="3a898-177">This is because <xref:System.Threading.Thread.CurrentPrincipal%2A?displayProperty=nameWithType> is set after the authentication process, while events are raised during the authentication process.</span></span>  
  
### <a name="configuration-of-federated-authentication"></a><span data-ttu-id="3a898-178">同盟驗證的組態</span><span class="sxs-lookup"><span data-stu-id="3a898-178">Configuration of Federated Authentication</span></span>  
 <span data-ttu-id="3a898-179">WS-FAM 和 SAM 是透過 [\<federationConfiguration>](../../../docs/framework/configure-apps/file-schema/windows-identity-foundation/federationconfiguration.md) 元素進行設定。</span><span class="sxs-lookup"><span data-stu-id="3a898-179">The WS-FAM and SAM are configured through the [\<federationConfiguration>](../../../docs/framework/configure-apps/file-schema/windows-identity-foundation/federationconfiguration.md) element.</span></span> <span data-ttu-id="3a898-180">[\<wsFederation>](../../../docs/framework/configure-apps/file-schema/windows-identity-foundation/wsfederation.md) 子元素可設定 WS-FAM 屬性的預設值；例如 <xref:System.IdentityModel.Services.WSFederationAuthenticationModule.Issuer%2A> 屬性和 <xref:System.IdentityModel.Services.WSFederationAuthenticationModule.Realm%2A> 屬性。</span><span class="sxs-lookup"><span data-stu-id="3a898-180">The [\<wsFederation>](../../../docs/framework/configure-apps/file-schema/windows-identity-foundation/wsfederation.md) child element configures default values for the WS-FAM properties; such as the <xref:System.IdentityModel.Services.WSFederationAuthenticationModule.Issuer%2A> property and the <xref:System.IdentityModel.Services.WSFederationAuthenticationModule.Realm%2A> property.</span></span> <span data-ttu-id="3a898-181">(藉由提供某些 WS FAM 事件的處理常式，即可依要求來變更這些值；例如 <xref:System.IdentityModel.Services.WSFederationAuthenticationModule.RedirectingToIdentityProvider>)。SAM 所使用的 Cookie 處理常式則是透過 [\<cookieHandler>](../../../docs/framework/configure-apps/file-schema/windows-identity-foundation/cookiehandler.md) 子元素進行設定。</span><span class="sxs-lookup"><span data-stu-id="3a898-181">(These values can be changed on a per request basis by providing handlers for some of the WS-FAM events; for example, <xref:System.IdentityModel.Services.WSFederationAuthenticationModule.RedirectingToIdentityProvider>.) The cookie handler that is used by the SAM is configured through the [\<cookieHandler>](../../../docs/framework/configure-apps/file-schema/windows-identity-foundation/cookiehandler.md) child element.</span></span> <span data-ttu-id="3a898-182">WIF 提供了已在 <xref:System.IdentityModel.Services.ChunkedCookieHandler> 類別中實作的預設 Cookie 處理常式，其區塊大小可透過 [\<chunkedCookieHandler>](../../../docs/framework/configure-apps/file-schema/windows-identity-foundation/chunkedcookiehandler.md) 元素來設定。</span><span class="sxs-lookup"><span data-stu-id="3a898-182">WIF provides a default cookie handler implemented in the <xref:System.IdentityModel.Services.ChunkedCookieHandler> class that can have its chunk size set through the [\<chunkedCookieHandler>](../../../docs/framework/configure-apps/file-schema/windows-identity-foundation/chunkedcookiehandler.md) element.</span></span> <span data-ttu-id="3a898-183">`<federationConfiguration>` 元素會參考 <xref:System.IdentityModel.Configuration.IdentityConfiguration>，這樣便可提供應用程式所使用之其他 WIF 元件的組態，例如 <xref:System.Security.Claims.ClaimsAuthenticationManager> 和 <xref:System.Security.Claims.ClaimsAuthorizationManager>。</span><span class="sxs-lookup"><span data-stu-id="3a898-183">The `<federationConfiguration>` element references an <xref:System.IdentityModel.Configuration.IdentityConfiguration>, which provides configuration for other WIF components used in the application, such as the <xref:System.Security.Claims.ClaimsAuthenticationManager> and the <xref:System.Security.Claims.ClaimsAuthorizationManager>.</span></span> <span data-ttu-id="3a898-184">透過在 `<federationConfiguration>` 元素的 `identityConfigurationName` 屬性中指定具名的 [\<identityConfiguration>](../../../docs/framework/configure-apps/file-schema/windows-identity-foundation/identityconfiguration.md) 元素，即可明確參考身分識別組態。</span><span class="sxs-lookup"><span data-stu-id="3a898-184">The identity configuration may be referenced explicitly by specifying a named [\<identityConfiguration>](../../../docs/framework/configure-apps/file-schema/windows-identity-foundation/identityconfiguration.md) element in the `identityConfigurationName` attribute of the `<federationConfiguration>` element.</span></span> <span data-ttu-id="3a898-185">如果未明確參考身分識別組態，將會使用預設的身分識別組態。</span><span class="sxs-lookup"><span data-stu-id="3a898-185">If the identity configuration is not referenced explicitly, the default identity configuration will be used.</span></span>  
  
 <span data-ttu-id="3a898-186">下列 XML 顯示 ASP.NET 信賴憑證者 (RP) 應用程式的組態。</span><span class="sxs-lookup"><span data-stu-id="3a898-186">The following XML shows a configuration of an ASP.NET relying party (RP) application.</span></span> <span data-ttu-id="3a898-187"><xref:System.IdentityModel.Configuration.SystemIdentityModelSection> 和 <xref:System.IdentityModel.Services.Configuration.SystemIdentityModelServicesSection> 組態區段會新增到 `<configSections>` 元素下。</span><span class="sxs-lookup"><span data-stu-id="3a898-187">The <xref:System.IdentityModel.Configuration.SystemIdentityModelSection> and <xref:System.IdentityModel.Services.Configuration.SystemIdentityModelServicesSection> configuration sections are added under the `<configSections>` element.</span></span> <span data-ttu-id="3a898-188">SAM 和 WS-FAM 則會新增到 `<system.webServer>`/`<modules>` 元素下的 HTTP 模組。</span><span class="sxs-lookup"><span data-stu-id="3a898-188">The SAM and WS-FAM are added to the HTTP Modules under the `<system.webServer>`/`<modules>` element.</span></span> <span data-ttu-id="3a898-189">最後，會在 `<system.identityModel>`/`<identityConfiguration>`和 `<system.identityModel.services>`/`<federationConfiguration>` 元素下設定 WIF 元件。</span><span class="sxs-lookup"><span data-stu-id="3a898-189">Finally the WIF components are configured under the `<system.identityModel>`/`<identityConfiguration>` and `<system.identityModel.services>`/`<federationConfiguration>` elements.</span></span> <span data-ttu-id="3a898-190">這個組態會指定區塊 Cookie 處理常式，因為它是預設的 Cookie 處理常式，但沒有在 `<cookieHandler>` 元素中指定的 Cookie 處理常式類型。</span><span class="sxs-lookup"><span data-stu-id="3a898-190">This configuration specifies the chunked cookie handler as it is the default cookie handler and there is not a cookie handler type specified in the `<cookieHandler>` element.</span></span>  
  
> [!WARNING]
>  <span data-ttu-id="3a898-191">在下列範例中，`<wsFederation>` 元素的 `requireHttps` 屬性和 `<cookieHandler>` 元素的 `requireSsl` 屬性都是 `false`。</span><span class="sxs-lookup"><span data-stu-id="3a898-191">In the following example, both the `requireHttps` attribute of the `<wsFederation>` element and the `requireSsl` attribute of the `<cookieHandler>` element are `false`.</span></span> <span data-ttu-id="3a898-192">這會造成潛在的安全性威脅。</span><span class="sxs-lookup"><span data-stu-id="3a898-192">This presents a potential security threat.</span></span> <span data-ttu-id="3a898-193">在生產環境中，這兩個值都應該設定為 `true`。</span><span class="sxs-lookup"><span data-stu-id="3a898-193">In production, both these values should be set `true`.</span></span>  
  
```xml  
<configuration>  
  <configSections>  
    <section name="system.identityModel" type="System.IdentityModel.Configuration.SystemIdentityModelSection, System.IdentityModel, Version=4.0.0.0, Culture=neutral, PublicKeyToken=B77A5C561934E089" />  
    <section name="system.identityModel.services" type="System.IdentityModel.Services.Configuration.SystemIdentityModelServicesSection, System.IdentityModel.Services, Version=4.0.0.0, Culture=neutral, PublicKeyToken=B77A5C561934E089" />  
  </configSections>  
  
  ...  
  
  <system.webServer>  
    <modules>  
      <add name="WSFederationAuthenticationModule" type="System.IdentityModel.Services.WSFederationAuthenticationModule, System.IdentityModel.Services, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089" preCondition="managedHandler" />  
      <add name="SessionAuthenticationModule" type="System.IdentityModel.Services.SessionAuthenticationModule, System.IdentityModel.Services, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089" preCondition="managedHandler" />  
    </modules>  
  </system.webServer>  
  
  <system.identityModel>  
    <identityConfiguration>  
      <audienceUris>  
        <add value="http://localhost:50969/" />  
      </audienceUris>  
      <certificateValidation certificateValidationMode="None" />  
      <issuerNameRegistry type="System.IdentityModel.Tokens.ConfigurationBasedIssuerNameRegistry, System.IdentityModel, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089">  
        <trustedIssuers>  
          <add thumbprint="9B74CB2F320F7AAFC156E1252270B1DC01EF40D0" name="LocalSTS" />  
        </trustedIssuers>  
      </issuerNameRegistry>  
    </identityConfiguration>  
  </system.identityModel>  
  <system.identityModel.services>  
    <federationConfiguration>  
      <wsFederation passiveRedirectEnabled="true" issuer="http://localhost:15839/wsFederationSTS/Issue" realm="http://localhost:50969/" reply="http://localhost:50969/" requireHttps="false" />  
      <cookieHandler requireSsl="false" />  
    </federationConfiguration>  
  </system.identityModel.services>  
</configuration>  
```  
  
## <a name="see-also"></a><span data-ttu-id="3a898-194">另請參閱</span><span class="sxs-lookup"><span data-stu-id="3a898-194">See also</span></span>

- <xref:System.IdentityModel.Services.SessionAuthenticationModule>
- <xref:System.IdentityModel.Services.WSFederationAuthenticationModule>
- [<span data-ttu-id="3a898-195">\<federationConfiguration></span><span class="sxs-lookup"><span data-stu-id="3a898-195">\<federationConfiguration></span></span>](../../../docs/framework/configure-apps/file-schema/windows-identity-foundation/federationconfiguration.md)
