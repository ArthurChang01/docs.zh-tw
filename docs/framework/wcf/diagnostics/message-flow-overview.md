---
title: 訊息流程概觀
ms.date: 03/30/2017
ms.assetid: fb0899e1-84cc-4d90-b45b-dc5a50063943
ms.openlocfilehash: aea0ca4c5a8574f6039cd055561ce7da0099841b
ms.sourcegitcommit: 15109844229ade1c6449f48f3834db1b26907824
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 05/07/2018
ms.locfileid: "33809790"
---
# <a name="message-flow-overview"></a><span data-ttu-id="7831a-102">訊息流程概觀</span><span class="sxs-lookup"><span data-stu-id="7831a-102">Message Flow Overview</span></span>
<span data-ttu-id="7831a-103">在包含互連服務的分散式系統中，您必須判斷服務之間的因果關係。</span><span class="sxs-lookup"><span data-stu-id="7831a-103">In a distributed system containing interconnected services, it is necessary to determine causal relationships between the services.</span></span> <span data-ttu-id="7831a-104">請務必了解屬於要求流程一部分的各種元件，以便支援重要案例，例如健康監視、疑難排解和根本原因分析。</span><span class="sxs-lookup"><span data-stu-id="7831a-104">It is important to understand the various components that were part of a request flow to support critical scenarios such as health monitoring, troubleshooting, and root cause analysis.</span></span> <span data-ttu-id="7831a-105">為了讓各種服務之間的追蹤相互關聯，我們透過下列功能，在 .NET Framework 4 中加入了支援：</span><span class="sxs-lookup"><span data-stu-id="7831a-105">To enable the correlation of traces between various services, in the .NET Framework 4 we added support through the following features:</span></span>  
  
-   <span data-ttu-id="7831a-106">分析追蹤：使用 Windows 事件追蹤 (ETW) 的高效能、低詳細等級追蹤功能。</span><span class="sxs-lookup"><span data-stu-id="7831a-106">Analytic tracing: A high performance and low verbosity tracing feature using Event Tracing for Windows (ETW).</span></span>  
  
-   <span data-ttu-id="7831a-107">WCF/WF 服務的端對端活動模型：這項功能支援 <xref:System.ServiceModel> 和 <xref:System.Workflow.ComponentModel> 命名空間所產生之追蹤的相互關聯。</span><span class="sxs-lookup"><span data-stu-id="7831a-107">End-to-end activity model for WCF/WF services: This feature supports correlation of traces generated by the <xref:System.ServiceModel> and <xref:System.Workflow.ComponentModel> namespaces.</span></span>  
  
-   <span data-ttu-id="7831a-108">WF 的 ETW 追蹤：這項功能會使用 WF 服務所產生的追蹤記錄來提供工作流程之目前狀態和進度的可視性。</span><span class="sxs-lookup"><span data-stu-id="7831a-108">ETW tracking for WF: This feature uses tracking records generated by WF services to provide visibility into the workflow’s current state and progress.</span></span>  
  
 <span data-ttu-id="7831a-109">在追蹤或追蹤記錄中記錄的錯誤可用來尋找程式碼缺失或格式錯誤的訊息。</span><span class="sxs-lookup"><span data-stu-id="7831a-109">Errors logged in a tracking or tracing record can be used to find code defects or incorrectly formed messages.</span></span> <span data-ttu-id="7831a-110">在事件的訊息標頭中，Correlation 節點的 ActivityId 屬性可用來判斷錯誤的活動。</span><span class="sxs-lookup"><span data-stu-id="7831a-110">The ActivityId property of the Correlation node in the event’s message header can be used to determine the faulting activity.</span></span> <span data-ttu-id="7831a-111">若要啟用訊息流程追蹤的活動識別碼，請參閱[設定訊息流程追蹤](../../../../docs/framework/wcf/diagnostics/etw/configuring-message-flow-tracing.md)。</span><span class="sxs-lookup"><span data-stu-id="7831a-111">To enable message flow tracing by activity ID, see [Configuring Message Flow Tracing](../../../../docs/framework/wcf/diagnostics/etw/configuring-message-flow-tracing.md).</span></span> <span data-ttu-id="7831a-112">本主題將示範如何在＜使用者入門教學課程＞中建立的專案內啟用訊息流程追蹤。</span><span class="sxs-lookup"><span data-stu-id="7831a-112">This topic demonstrates how to enable message flow tracing in the project created in the Getting Started tutorial.</span></span>  
  
### <a name="to-enable-message-flow-tracing-in-the-getting-started-tutorial"></a><span data-ttu-id="7831a-113">若要在使用者入門教學課程中啟用訊息流程追蹤</span><span class="sxs-lookup"><span data-stu-id="7831a-113">To enable message flow tracing in the Getting Started tutorial</span></span>  
  
1.  <span data-ttu-id="7831a-114">開啟事件檢視器，依序按一下**啟動**，**執行**，並輸入`eventvwr.exe`。</span><span class="sxs-lookup"><span data-stu-id="7831a-114">Open Event Viewer by clicking **Start**, **Run**, and entering `eventvwr.exe`.</span></span>  
  
2.  <span data-ttu-id="7831a-115">如果您尚未啟用分析追蹤，展開**Applications and Services Logs**， **Microsoft**， **Windows**，**應用程式伺服器-應用程式**.</span><span class="sxs-lookup"><span data-stu-id="7831a-115">If you haven’t enabled analytic tracing, expand **Applications and Services Logs**, **Microsoft**, **Windows**, **Application Server-Applications**.</span></span> <span data-ttu-id="7831a-116">選取**檢視**，**顯示分析與偵錯記錄檔**。</span><span class="sxs-lookup"><span data-stu-id="7831a-116">Select **View**, **Show Analytic and Debug Logs**.</span></span> <span data-ttu-id="7831a-117">以滑鼠右鍵按一下**分析**選取**啟用記錄**。</span><span class="sxs-lookup"><span data-stu-id="7831a-117">Right-click **Analytic** and select **Enable Log**.</span></span> <span data-ttu-id="7831a-118">讓 [事件檢視器] 保持開啟狀態，以便檢視追蹤。</span><span class="sxs-lookup"><span data-stu-id="7831a-118">Leave Event Viewer open so that traces can be viewed.</span></span>  
  
3.  <span data-ttu-id="7831a-119">開啟範例中建立[入門教學課程](../../../../docs/framework/wcf/getting-started-tutorial.md)中[!INCLUDE[vs_current_long](../../../../includes/vs-current-long-md.md)]。</span><span class="sxs-lookup"><span data-stu-id="7831a-119">Open the sample created in the [Getting Started Tutorial](../../../../docs/framework/wcf/getting-started-tutorial.md) in [!INCLUDE[vs_current_long](../../../../includes/vs-current-long-md.md)].</span></span> <span data-ttu-id="7831a-120">請注意，您必須以系統管理員的身分執行 [!INCLUDE[vs_current_long](../../../../includes/vs-current-long-md.md)]，才能建立此服務。</span><span class="sxs-lookup"><span data-stu-id="7831a-120">Note that you must run [!INCLUDE[vs_current_long](../../../../includes/vs-current-long-md.md)] as an administrator so that the service can be created.</span></span> <span data-ttu-id="7831a-121">如果您有安裝 WCF 範例，您可以開啟[入門](../../../../docs/framework/wcf/samples/getting-started-sample.md)，其中包含已完成本教學課程中建立的專案。</span><span class="sxs-lookup"><span data-stu-id="7831a-121">If you have the WCF samples installed, you can open the [Getting Started](../../../../docs/framework/wcf/samples/getting-started-sample.md), which contains the completed project created in the tutorial.</span></span>  
  
4.  <span data-ttu-id="7831a-122">以滑鼠右鍵按一下**服務**專案，然後選取**新增**，**新項目**。</span><span class="sxs-lookup"><span data-stu-id="7831a-122">Right-click the **Service** project and select **Add**, **New Item**.</span></span> <span data-ttu-id="7831a-123">選取**應用程式組態檔**按一下**確定**。</span><span class="sxs-lookup"><span data-stu-id="7831a-123">Select **Application Configuration File** and click **OK**.</span></span>  
  
5.  <span data-ttu-id="7831a-124">將下列程式碼加入至您在上一個步驟中建立的 App.Config 檔案。</span><span class="sxs-lookup"><span data-stu-id="7831a-124">Add the following code to the App.Config file created in the previous step.</span></span>  
  
    ```xml  
    <system.serviceModel>  
      <diagnostics>  
        <endToEndTracing propagateActivity="true" messageFlowTracing="true"/>  
      </diagnostics>  
    </system.serviceModel>  
    ```  
  
6.  <span data-ttu-id="7831a-125">按 CTRL+F5 鍵執行伺服器應用程式，而不偵錯。</span><span class="sxs-lookup"><span data-stu-id="7831a-125">Execute the server application without debugging by pressing CTRL+F5.</span></span> <span data-ttu-id="7831a-126">執行用戶端專案，以滑鼠右鍵按一下**用戶端**專案，並選取**偵錯**，**開始新執行個體**。</span><span class="sxs-lookup"><span data-stu-id="7831a-126">Execute the client project by right-clicking the **Client** project and selecting **Debug**, **Start New Instance**.</span></span>  
  
7.  <span data-ttu-id="7831a-127">若要追蹤用戶端與伺服器之間的事件，請將下列程式碼加入至用戶端專案中的應用程式組態檔。</span><span class="sxs-lookup"><span data-stu-id="7831a-127">To trace the events from the client to the server, add the following to the application configuration file in the Client project.</span></span>  
  
    ```xml  
    <diagnostics>  
      <endToEndTracing propagateActivity="true" messageFlowTracing="true"/>  
    </diagnostics>  
    ```  
  
8.  <span data-ttu-id="7831a-128">在用戶端的 Program.cs 中，加入下列 Using 陳述式。</span><span class="sxs-lookup"><span data-stu-id="7831a-128">In Program.cs in the client, add the following Using statement.</span></span>  
  
    ```  
    using System.Diagnostics;  
    ```  
  
9. <span data-ttu-id="7831a-129">在用戶端專案 program.cs 檔案的 Main 方法中，設定要在事件記錄檔中傳播的追蹤 GUID。</span><span class="sxs-lookup"><span data-stu-id="7831a-129">In the Main method in the program.cs file in the client project, set the Trace GUID to be propagated in the event log.</span></span>  
  
    ```  
    Guid guid = Guid.NewGuid();  
    Trace.CorrelationManager.ActivityId = guid;  
    ```  
  
10. <span data-ttu-id="7831a-130">重新整理並檢查**分析**記錄檔。</span><span class="sxs-lookup"><span data-stu-id="7831a-130">Refresh and examine the **Analytic**  log.</span></span>  <span data-ttu-id="7831a-131">尋找 [事件 ID] 為 220 的事件。</span><span class="sxs-lookup"><span data-stu-id="7831a-131">Look for an event with Event ID 220.</span></span>  <span data-ttu-id="7831a-132">選取事件，然後按一下 **詳細資料**預覽窗格中的索引標籤。</span><span class="sxs-lookup"><span data-stu-id="7831a-132">Select the event, and click the **Details** tab in the preview pane.</span></span> <span data-ttu-id="7831a-133">這個事件將包含呼叫活動的相互關聯 ID。</span><span class="sxs-lookup"><span data-stu-id="7831a-133">This event will contain the correlation ID for the calling activity.</span></span>  
  
    ```xml  
    <Correlation ActivityID="{A066CCF1-8AB3-459B-B62F-F79F957A5036}" />  
    ```  
  
    > [!NOTE]
    >  <span data-ttu-id="7831a-134">在 ActivityID 中，具有相同 GUID 的所有事件都與單一要求相關。</span><span class="sxs-lookup"><span data-stu-id="7831a-134">All events with the same GUID in the ActivityID are related to one request.</span></span> <span data-ttu-id="7831a-135">這可用來相互關聯特定用戶端與特定服務之間的訊息。</span><span class="sxs-lookup"><span data-stu-id="7831a-135">This can be used to correlate messages from a specific client to a specific service.</span></span> <span data-ttu-id="7831a-136">如果用戶端呼叫了其他服務，ActivityID 就可以識別相同的用戶端。</span><span class="sxs-lookup"><span data-stu-id="7831a-136">If the client called another service, then the same client could be identified by ActivityID.</span></span>  
  
11. <span data-ttu-id="7831a-137">在某些情況下，ActivityID 可能會從原始 GUID 變更為新的 ActivityID。</span><span class="sxs-lookup"><span data-stu-id="7831a-137">In some cases, the ActivityID can change from the original GUID to a new ActivityID.</span></span> <span data-ttu-id="7831a-138">在該情況下，系統會發出傳輸事件。</span><span class="sxs-lookup"><span data-stu-id="7831a-138">In that case, a transfer event is emitted.</span></span> <span data-ttu-id="7831a-139">這個事件 ID 為 499，而且此事件的標頭將包含下列資料。</span><span class="sxs-lookup"><span data-stu-id="7831a-139">This event ID is 499, and the event will contain the following data in the header.</span></span>  
  
    ```xml  
    <Event xmlns="http://schemas.microsoft.com/win/2004/08/events/event">  
        <System>  
            <Provider Name="Microsoft-Windows-Application Server-Applications" Guid="{c651f5f6-1c0d-492e-8ae1-b4efd7c9d503}" />   
            <EventID>499</EventID>   
            ...  
            <Correlation ActivityID="{A066CCF1-8AB3-459B-B62F-F79F957A5036}" RelatedActivityID="{85FC0930-9C49-42DA-804B-A7368104BD1B}" />   
            ...  
       </System>  
    </Event>  
    ```  
  
    > [!NOTE]
    >  <span data-ttu-id="7831a-140">傳輸事件會記錄作用中 ActivityID 從指定為 ActivityID 的 GUID 變更為指定為 RelatedActivityID 的 GUID。</span><span class="sxs-lookup"><span data-stu-id="7831a-140">The transfer event records the change of the active ActivityID from the GUID specified as the ActivityID to the GUID specified as RelatedActivityID.</span></span> <span data-ttu-id="7831a-141">當系統發出傳輸事件之後，所有事件都將包含新的 GUID 做為 ActivityID。</span><span class="sxs-lookup"><span data-stu-id="7831a-141">After the transfer event is emitted, all events will contain the new GUID as the ActivityID.</span></span>
