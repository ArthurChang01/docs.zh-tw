---
title: HOW TO：建立聯合用戶端
ms.date: 03/30/2017
dev_langs:
- csharp
- vb
helpviewer_keywords:
- WCF, federation
- federation
ms.assetid: 56ece47e-98bf-4346-b92b-fda1fc3b4d9c
ms.openlocfilehash: a9213d8cbbafaaa1fffa3a1db0d6936c2fc6544f
ms.sourcegitcommit: 7588136e355e10cbc2582f389c90c127363c02a5
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 03/12/2020
ms.locfileid: "79185047"
---
# <a name="how-to-create-a-federated-client"></a><span data-ttu-id="77eac-102">HOW TO：建立聯合用戶端</span><span class="sxs-lookup"><span data-stu-id="77eac-102">How to: Create a Federated Client</span></span>
<span data-ttu-id="77eac-103">在 Windows 通信基礎 （WCF） 中，為*聯合服務*創建用戶端包括三個主要步驟：</span><span class="sxs-lookup"><span data-stu-id="77eac-103">In Windows Communication Foundation (WCF), creating a client for a *federated service* consists of three main steps:</span></span>  
  
1. <span data-ttu-id="77eac-104">配置[\<ws-IaiHTTP 綁定>](../../../../docs/framework/configure-apps/file-schema/wcf/wsfederationhttpbinding.md)或類似的自訂綁定。</span><span class="sxs-lookup"><span data-stu-id="77eac-104">Configure a [\<wsFederationHttpBinding>](../../../../docs/framework/configure-apps/file-schema/wcf/wsfederationhttpbinding.md) or similar custom binding.</span></span> <span data-ttu-id="77eac-105">有關創建適當綁定的詳細資訊，請參閱[：創建 WS聯邦Http綁定](../../../../docs/framework/wcf/feature-details/how-to-create-a-wsfederationhttpbinding.md)。</span><span class="sxs-lookup"><span data-stu-id="77eac-105">For more information about creating an appropriate binding, see [How to: Create a WSFederationHttpBinding](../../../../docs/framework/wcf/feature-details/how-to-create-a-wsfederationhttpbinding.md).</span></span> <span data-ttu-id="77eac-106">或者，根據聯合服務的中繼資料終結點運行[ServiceModel 中繼資料實用程式工具 （Svcutil.exe），](../../../../docs/framework/wcf/servicemodel-metadata-utility-tool-svcutil-exe.md)以生成用於與聯合服務和一個或多個安全權杖服務通信的設定檔。</span><span class="sxs-lookup"><span data-stu-id="77eac-106">Alternatively, run the [ServiceModel Metadata Utility Tool (Svcutil.exe)](../../../../docs/framework/wcf/servicemodel-metadata-utility-tool-svcutil-exe.md) against the metadata endpoint of the federated service to generate a configuration file for communicating with the federated service and one or more security token services.</span></span>  
  
2. <span data-ttu-id="77eac-107">針對可控制用戶端與安全性權杖服務之間各種互動方式的 <xref:System.ServiceModel.Security.IssuedTokenClientCredential> 設定其屬性。</span><span class="sxs-lookup"><span data-stu-id="77eac-107">Set the properties of the <xref:System.ServiceModel.Security.IssuedTokenClientCredential> that controls various aspects of a client's interaction with a security token service.</span></span>  
  
3. <span data-ttu-id="77eac-108">設定 <xref:System.ServiceModel.Security.X509CertificateRecipientClientCredential> 的屬性，以提供與特定端點 (例如，安全性權杖服務) 安全通訊所需的憑證。</span><span class="sxs-lookup"><span data-stu-id="77eac-108">Set the properties of the <xref:System.ServiceModel.Security.X509CertificateRecipientClientCredential>, which allows certificates needed to communicate securely with given endpoints, such as security token services.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="77eac-109">當用戶端使用模擬認證、<xref:System.Security.Cryptography.CryptographicException> 繫結或自訂發行權杖，以及非對稱金鑰時，可能會擲回 <xref:System.ServiceModel.WSFederationHttpBinding>。</span><span class="sxs-lookup"><span data-stu-id="77eac-109">A <xref:System.Security.Cryptography.CryptographicException> might be thrown when a client uses impersonated credentials, the <xref:System.ServiceModel.WSFederationHttpBinding> binding or a custom-issued token, and asymmetric keys.</span></span> <span data-ttu-id="77eac-110">當 <xref:System.ServiceModel.WSFederationHttpBinding> 和 <xref:System.ServiceModel.FederatedMessageSecurityOverHttp.IssuedKeyType%2A> 屬性分別設為 <xref:System.ServiceModel.Security.Tokens.IssuedSecurityTokenParameters.KeyType%2A> 時，非對稱金鑰便能與 <xref:System.IdentityModel.Tokens.SecurityKeyType.AsymmetricKey> 繫結或自訂發行權杖一起使用。</span><span class="sxs-lookup"><span data-stu-id="77eac-110">Asymmetric keys are used with the <xref:System.ServiceModel.WSFederationHttpBinding> binding and custom-issued tokens when the <xref:System.ServiceModel.FederatedMessageSecurityOverHttp.IssuedKeyType%2A> and <xref:System.ServiceModel.Security.Tokens.IssuedSecurityTokenParameters.KeyType%2A> properties, respectively, are set to <xref:System.IdentityModel.Tokens.SecurityKeyType.AsymmetricKey>.</span></span> <span data-ttu-id="77eac-111">當用戶端嘗試傳送訊息，而用戶端想要模擬的身分識別並沒有使用者設定檔時，就會擲回 <xref:System.Security.Cryptography.CryptographicException>。</span><span class="sxs-lookup"><span data-stu-id="77eac-111">The <xref:System.Security.Cryptography.CryptographicException> is thrown when the client attempts to send a message and a user profile doesn’t exist for the identity that the client is impersonating.</span></span> <span data-ttu-id="77eac-112">若要減少發生這個問題，請在傳送訊息之前登入用戶端電腦，或是呼叫 `LoadUserProfile`。</span><span class="sxs-lookup"><span data-stu-id="77eac-112">To mitigate this issue, log on to the client computer or call `LoadUserProfile` before sending the message.</span></span>  
  
 <span data-ttu-id="77eac-113">本主題提供這些程序的詳細資訊。</span><span class="sxs-lookup"><span data-stu-id="77eac-113">This topic provides detailed information about these procedures.</span></span> <span data-ttu-id="77eac-114">有關創建適當綁定的詳細資訊，請參閱[：創建 WS聯邦Http綁定](../../../../docs/framework/wcf/feature-details/how-to-create-a-wsfederationhttpbinding.md)。</span><span class="sxs-lookup"><span data-stu-id="77eac-114">For more information about creating an appropriate binding, see [How to: Create a WSFederationHttpBinding](../../../../docs/framework/wcf/feature-details/how-to-create-a-wsfederationhttpbinding.md).</span></span> <span data-ttu-id="77eac-115">有關聯合服務的工作原理的詳細資訊，請參閱[聯合服務](../../../../docs/framework/wcf/feature-details/federation.md)。</span><span class="sxs-lookup"><span data-stu-id="77eac-115">For more information about how a federated service works, see [Federation](../../../../docs/framework/wcf/feature-details/federation.md).</span></span>  
  
### <a name="to-generate-and-examine-the-configuration-for-a-federated-service"></a><span data-ttu-id="77eac-116">若要產生並檢查聯合服務的組態</span><span class="sxs-lookup"><span data-stu-id="77eac-116">To generate and examine the configuration for a federated service</span></span>  
  
1. <span data-ttu-id="77eac-117">運行[服務模型中繼資料實用程式工具 （Svcutil.exe），](../../../../docs/framework/wcf/servicemodel-metadata-utility-tool-svcutil-exe.md)將服務的中繼資料 URL 的位址作為命令列參數運行。</span><span class="sxs-lookup"><span data-stu-id="77eac-117">Run the [ServiceModel Metadata Utility Tool (Svcutil.exe)](../../../../docs/framework/wcf/servicemodel-metadata-utility-tool-svcutil-exe.md) with the address of the metadata URL of the service as a command-line parameter.</span></span>  
  
2. <span data-ttu-id="77eac-118">透過適當的編輯器開啟產生的組態檔。</span><span class="sxs-lookup"><span data-stu-id="77eac-118">Open the generated configuration file in an appropriate editor.</span></span>  
  
3. <span data-ttu-id="77eac-119">檢查任何生成的[\<頒發者>](../../../../docs/framework/configure-apps/file-schema/wcf/issuer.md)和[\<頒發者中繼資料>](../../../../docs/framework/configure-apps/file-schema/wcf/issuermetadata.md)元素的屬性和內容。</span><span class="sxs-lookup"><span data-stu-id="77eac-119">Examine the attributes and content of any generated [\<issuer>](../../../../docs/framework/configure-apps/file-schema/wcf/issuer.md) and [\<issuerMetadata>](../../../../docs/framework/configure-apps/file-schema/wcf/issuermetadata.md) elements.</span></span> <span data-ttu-id="77eac-120">它們位於[\<ws-IaBHttpBinding>](../../../../docs/framework/configure-apps/file-schema/wcf/wsfederationhttpbinding.md)或自訂繫結元素[\<的安全>](../../../../docs/framework/configure-apps/file-schema/wcf/security-of-wsfederationhttpbinding.md)元素中。</span><span class="sxs-lookup"><span data-stu-id="77eac-120">These are located within the [\<security>](../../../../docs/framework/configure-apps/file-schema/wcf/security-of-wsfederationhttpbinding.md) elements for the [\<wsFederationHttpBinding>](../../../../docs/framework/configure-apps/file-schema/wcf/wsfederationhttpbinding.md) or custom bindings elements.</span></span> <span data-ttu-id="77eac-121">請確定位址包含預期的網域名稱或其他位址資訊。</span><span class="sxs-lookup"><span data-stu-id="77eac-121">Ensure that the addresses contain the expected domain names or other address information.</span></span> <span data-ttu-id="77eac-122">請務必檢查這項資訊，因為用戶端會對這些位址進行驗證，而且可能揭露使用者名稱/密碼組這類的資訊。</span><span class="sxs-lookup"><span data-stu-id="77eac-122">It is important to check this information because the client authenticates to these addresses and may disclose information such as user name/password pairs.</span></span> <span data-ttu-id="77eac-123">如果位址不是預期的位址，可能會導致向不適當的收件者揭露資訊。</span><span class="sxs-lookup"><span data-stu-id="77eac-123">If the address is not the expected address, this could result in information disclosure to an unintended recipient.</span></span>  
  
4. <span data-ttu-id="77eac-124">檢查注釋`alternativeIssuedTokenParameters`<>元素中的任何其他[\<頒發的Token參數>](../../../../docs/framework/configure-apps/file-schema/wcf/issuedtokenparameters.md)元素。</span><span class="sxs-lookup"><span data-stu-id="77eac-124">Examine any additional [\<issuedTokenParameters>](../../../../docs/framework/configure-apps/file-schema/wcf/issuedtokenparameters.md) elements inside the commented out <`alternativeIssuedTokenParameters`> element.</span></span> <span data-ttu-id="77eac-125">使用 Svcutil.exe 工具來產生聯合服務的組態時，如果聯合服務或任何中繼安全性權杖服務未指定發行者位址，而是指定了會公開多個端點之安全性權杖服務的中繼資料位址，則結果組態檔會參照到第一個端點。</span><span class="sxs-lookup"><span data-stu-id="77eac-125">When using the Svcutil.exe tool to generate configuration for a federated service, if the federated service or any intermediate security token services do not specify an issuer address, but rather specify a metadata address for a security token service that exposes multiple endpoints, the resulting configuration file refers to the first endpoint.</span></span> <span data-ttu-id="77eac-126">其他終結點在設定檔中作為注釋`alternativeIssuedTokenParameters`<>元素。</span><span class="sxs-lookup"><span data-stu-id="77eac-126">Additional endpoints are in the configuration file as commented-out <`alternativeIssuedTokenParameters`> elements.</span></span>  
  
     <span data-ttu-id="77eac-127">確定這些<>`issuedTokenParameters`之一是否比配置中已有的>更可取。</span><span class="sxs-lookup"><span data-stu-id="77eac-127">Determine whether one of these <`issuedTokenParameters`> is preferable to the one already present in the configuration.</span></span> <span data-ttu-id="77eac-128">例如，用戶端可能更願意使用 Windows CardSpace 權杖而不是使用者名和密碼對對安全權杖服務進行身份驗證。</span><span class="sxs-lookup"><span data-stu-id="77eac-128">For example, the client may prefer to authenticate to a security token service using a Windows CardSpace token rather than a user name/password pair.</span></span>  
  
    > [!NOTE]
    > <span data-ttu-id="77eac-129">如果與服務進行通訊之前，必須周遊多個安全性權杖服務時，中繼安全性權杖服務可能會將用戶端導向不正確的安全性權杖服務。</span><span class="sxs-lookup"><span data-stu-id="77eac-129">Where multiple security token services must be traversed before communicating with the service, it is possible for an intermediate security token service to direct the client to an incorrect security token service.</span></span> <span data-ttu-id="77eac-130">因此，請確保[\<已頒發 Token 參數](../../../../docs/framework/configure-apps/file-schema/wcf/issuedtokenparameters.md)中的安全權杖服務的終結點>是預期的安全權杖服務，而不是未知的安全權杖服務。</span><span class="sxs-lookup"><span data-stu-id="77eac-130">Therefore, ensure that the endpoint for the security token service in the [\<issuedTokenParameters>](../../../../docs/framework/configure-apps/file-schema/wcf/issuedtokenparameters.md) is the expected security token service and not an unknown security token service.</span></span>  
  
### <a name="to-configure-an-issuedtokenclientcredential-in-code"></a><span data-ttu-id="77eac-131">若要透過程式碼設定 IssuedTokenClientCredential</span><span class="sxs-lookup"><span data-stu-id="77eac-131">To configure an IssuedTokenClientCredential in code</span></span>  
  
1. <span data-ttu-id="77eac-132">如下列範例程式碼所示，透過 <xref:System.ServiceModel.Security.IssuedTokenClientCredential> 類別的 <xref:System.ServiceModel.Description.ClientCredentials.IssuedToken%2A> 屬性，存取 <xref:System.ServiceModel.Description.ClientCredentials> (由 <xref:System.ServiceModel.ClientBase%601.ClientCredentials%2A> 類別的 <xref:System.ServiceModel.ClientBase%601> 屬性傳回，或是透過 <xref:System.ServiceModel.ChannelFactory> 類別)。</span><span class="sxs-lookup"><span data-stu-id="77eac-132">Access the <xref:System.ServiceModel.Security.IssuedTokenClientCredential> through the <xref:System.ServiceModel.Description.ClientCredentials.IssuedToken%2A> property of the <xref:System.ServiceModel.Description.ClientCredentials> class (returned by the <xref:System.ServiceModel.ClientBase%601.ClientCredentials%2A> property of the <xref:System.ServiceModel.ClientBase%601> class, or through the <xref:System.ServiceModel.ChannelFactory> class), as shown in the following example code.</span></span>  
  
     [!code-csharp[c_CreateSTS#9](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_creatests/cs/source.cs#9)]
     [!code-vb[c_CreateSTS#9](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_creatests/vb/source.vb#9)]  
  
2. <span data-ttu-id="77eac-133">如果不需要權杖快取，請將 <xref:System.ServiceModel.Security.IssuedTokenClientCredential.CacheIssuedTokens%2A> 屬性設為 `false`。</span><span class="sxs-lookup"><span data-stu-id="77eac-133">If token caching is not required, set the <xref:System.ServiceModel.Security.IssuedTokenClientCredential.CacheIssuedTokens%2A> property to `false`.</span></span> <span data-ttu-id="77eac-134"><xref:System.ServiceModel.Security.IssuedTokenClientCredential.CacheIssuedTokens%2A> 屬性控制是否快取來自安全性權杖服務的這類權杖。</span><span class="sxs-lookup"><span data-stu-id="77eac-134">The <xref:System.ServiceModel.Security.IssuedTokenClientCredential.CacheIssuedTokens%2A> property controls whether such tokens from a security token service are cached.</span></span> <span data-ttu-id="77eac-135">如果此屬性設為 `false`，每當用戶端必須向聯合服務重新驗證自己時，不管前一個權杖是否仍舊有效，都會向安全性權杖服務要求新的權杖。</span><span class="sxs-lookup"><span data-stu-id="77eac-135">If this property is set to `false`, the client requests a new token from the security token service whenever it must re-authenticate itself to the federated service, regardless of whether a previous token is still valid.</span></span> <span data-ttu-id="77eac-136">如果此屬性設為 `true`，每當用戶端必須向聯合服務重新驗證自己時，只要權杖尚未到期，用戶端都會重複使用現有的權杖。</span><span class="sxs-lookup"><span data-stu-id="77eac-136">If this property is set to `true`, the client reuses an existing token whenever it must re-authenticate itself to the federated service (as long as the token has not expired).</span></span> <span data-ttu-id="77eac-137">預設值為 `true`。</span><span class="sxs-lookup"><span data-stu-id="77eac-137">The default is `true`.</span></span>  
  
3. <span data-ttu-id="77eac-138">如果必須在快取的權杖上設定時間限制，請將 <xref:System.ServiceModel.Security.IssuedTokenClientCredential.MaxIssuedTokenCachingTime%2A> 屬性設為 <xref:System.TimeSpan> 值。</span><span class="sxs-lookup"><span data-stu-id="77eac-138">If a time limit is required on cached tokens, set the <xref:System.ServiceModel.Security.IssuedTokenClientCredential.MaxIssuedTokenCachingTime%2A> property to a <xref:System.TimeSpan> value.</span></span> <span data-ttu-id="77eac-139">此屬性會指定多久快取權杖一次。</span><span class="sxs-lookup"><span data-stu-id="77eac-139">The property specifies how long a token can be cached.</span></span> <span data-ttu-id="77eac-140">一旦經過了指定的時間範圍，就會從用戶端快取中移除權杖。</span><span class="sxs-lookup"><span data-stu-id="77eac-140">After the specified time span has elapsed, the token is removed from the client cache.</span></span> <span data-ttu-id="77eac-141">根據預設，權杖無快取時間限制。</span><span class="sxs-lookup"><span data-stu-id="77eac-141">By default, tokens are cached indefinitely.</span></span> <span data-ttu-id="77eac-142">下列範例會將時間範圍設為 10 分鐘。</span><span class="sxs-lookup"><span data-stu-id="77eac-142">The following example sets the time span to 10 minutes.</span></span>  
  
     [!code-csharp[c_CreateSTS#15](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_creatests/cs/source.cs#15)]
     [!code-vb[c_CreateSTS#15](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_creatests/vb/source.vb#15)]  
  
4. <span data-ttu-id="77eac-143">選擇性。</span><span class="sxs-lookup"><span data-stu-id="77eac-143">Optional.</span></span> <span data-ttu-id="77eac-144">將 <xref:System.ServiceModel.Security.IssuedTokenClientCredential.IssuedTokenRenewalThresholdPercentage%2A> 設為百分比。</span><span class="sxs-lookup"><span data-stu-id="77eac-144">Set the <xref:System.ServiceModel.Security.IssuedTokenClientCredential.IssuedTokenRenewalThresholdPercentage%2A> to a percentage.</span></span> <span data-ttu-id="77eac-145">預設為 60%。</span><span class="sxs-lookup"><span data-stu-id="77eac-145">The default is 60 (percent).</span></span> <span data-ttu-id="77eac-146">此屬性會指定權杖的有效期間百分比。</span><span class="sxs-lookup"><span data-stu-id="77eac-146">The property specifies a percentage of the token's validity period.</span></span> <span data-ttu-id="77eac-147">例如，如果發行權杖有效時間是 10 小時，而 <xref:System.ServiceModel.Security.IssuedTokenClientCredential.IssuedTokenRenewalThresholdPercentage%2A> 設為 80，則權杖會在 8 小時後更新。</span><span class="sxs-lookup"><span data-stu-id="77eac-147">For example, if the issued token is valid for 10 hours and <xref:System.ServiceModel.Security.IssuedTokenClientCredential.IssuedTokenRenewalThresholdPercentage%2A> is set to 80, then the token is renewed after eight hours.</span></span> <span data-ttu-id="77eac-148">下例範例會將值設為 80%。</span><span class="sxs-lookup"><span data-stu-id="77eac-148">The following example sets the value to 80 percent.</span></span>  
  
     [!code-csharp[c_CreateSTS#16](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_creatests/cs/source.cs#16)]
     [!code-vb[c_CreateSTS#16](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_creatests/vb/source.vb#16)]  
  
     <span data-ttu-id="77eac-149">當快取時間比更新閾值時間還短時，由權杖有效期間與 `IssuedTokenRenewalThresholdPercentage` 值決定的更新間隔會被 `MaxIssuedTokenCachingTime` 值覆寫。</span><span class="sxs-lookup"><span data-stu-id="77eac-149">The renewal interval determined by the token validity period and the `IssuedTokenRenewalThresholdPercentage` value is overridden by the `MaxIssuedTokenCachingTime` value in cases where the caching time is shorter than the renewal threshold time.</span></span> <span data-ttu-id="77eac-150">例如，如果 `IssuedTokenRenewalThresholdPercentage` 和權杖有效期間的乘積是 8 小時，而 `MaxIssuedTokenCachingTime` 值為 10 分鐘，則用戶端會每 10 分鐘連絡一次安全性權杖服務以取得更新的權杖。</span><span class="sxs-lookup"><span data-stu-id="77eac-150">For example, if the product of `IssuedTokenRenewalThresholdPercentage` and the token's duration is eight hours, and the `MaxIssuedTokenCachingTime` value is 10 minutes, the client contacts the security token service for an updated token every 10 minutes.</span></span>  
  
5. <span data-ttu-id="77eac-151">如果不使用訊息安全性或傳輸安全性來搭配訊息認證的繫結，需要 <xref:System.ServiceModel.Security.SecurityKeyEntropyMode.CombinedEntropy> 以外的金鑰 Entropy 模式 (例如，</span><span class="sxs-lookup"><span data-stu-id="77eac-151">If a key entropy mode other than <xref:System.ServiceModel.Security.SecurityKeyEntropyMode.CombinedEntropy> is needed on a binding that does not use message security or transport security with message credentials (for example.</span></span> <span data-ttu-id="77eac-152">繫結不包含 <xref:System.ServiceModel.Channels.SecurityBindingElement>)，請將 <xref:System.ServiceModel.Security.IssuedTokenClientCredential.DefaultKeyEntropyMode%2A> 屬性設為適當值。</span><span class="sxs-lookup"><span data-stu-id="77eac-152">the binding does not have a <xref:System.ServiceModel.Channels.SecurityBindingElement>), set the <xref:System.ServiceModel.Security.IssuedTokenClientCredential.DefaultKeyEntropyMode%2A> property to an appropriate value.</span></span> <span data-ttu-id="77eac-153">*熵*模式確定是否可以使用 屬性<xref:System.ServiceModel.Security.IssuedTokenClientCredential.DefaultKeyEntropyMode%2A>控制對稱鍵。</span><span class="sxs-lookup"><span data-stu-id="77eac-153">The *entropy* mode determines whether symmetric keys can be controlled using the <xref:System.ServiceModel.Security.IssuedTokenClientCredential.DefaultKeyEntropyMode%2A> property.</span></span> <span data-ttu-id="77eac-154">預設是 <xref:System.ServiceModel.Security.SecurityKeyEntropyMode.CombinedEntropy>，其中用戶端與權杖發行者所提供的資料將合併用來產生真正的金鑰。</span><span class="sxs-lookup"><span data-stu-id="77eac-154">This default is <xref:System.ServiceModel.Security.SecurityKeyEntropyMode.CombinedEntropy>, where both the client and the token issuer provide data that is combined to produce the actual key.</span></span> <span data-ttu-id="77eac-155">其他值則是 <xref:System.ServiceModel.Security.SecurityKeyEntropyMode.ClientEntropy> 和 <xref:System.ServiceModel.Security.SecurityKeyEntropyMode.ServerEntropy>，這兩個值表示整個金鑰將分別由用戶端或伺服器全權決定。</span><span class="sxs-lookup"><span data-stu-id="77eac-155">Other values are <xref:System.ServiceModel.Security.SecurityKeyEntropyMode.ClientEntropy> and <xref:System.ServiceModel.Security.SecurityKeyEntropyMode.ServerEntropy>, which means the entire key is specified by the client or the server, respectively.</span></span> <span data-ttu-id="77eac-156">下列範例設定的屬性將會只使用伺服器資料來產生金鑰。</span><span class="sxs-lookup"><span data-stu-id="77eac-156">The following example sets the property to use only the server data for the key.</span></span>  
  
     [!code-csharp[c_CreateSTS#17](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_creatests/cs/source.cs#17)]
     [!code-vb[c_CreateSTS#17](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_creatests/vb/source.vb#17)]  
  
    > [!NOTE]
    > <span data-ttu-id="77eac-157">如果安全性權杖服務或服務繫結中存在 <xref:System.ServiceModel.Channels.SecurityBindingElement>，則 <xref:System.ServiceModel.Security.IssuedTokenClientCredential.DefaultKeyEntropyMode%2A> 上所設定的 <xref:System.ServiceModel.Security.IssuedTokenClientCredential> 會被 <xref:System.ServiceModel.Channels.SecurityBindingElement.KeyEntropyMode%2A> 的 `SecurityBindingElement` 屬性覆寫。</span><span class="sxs-lookup"><span data-stu-id="77eac-157">If a <xref:System.ServiceModel.Channels.SecurityBindingElement> is present in a security token service or service binding, the <xref:System.ServiceModel.Security.IssuedTokenClientCredential.DefaultKeyEntropyMode%2A> set on <xref:System.ServiceModel.Security.IssuedTokenClientCredential> is overridden by the <xref:System.ServiceModel.Channels.SecurityBindingElement.KeyEntropyMode%2A> property of the `SecurityBindingElement`.</span></span>  
  
6. <span data-ttu-id="77eac-158">設定任何特定發行者的端點行為時，請將它們新增至 <xref:System.ServiceModel.Security.IssuedTokenClientCredential.IssuerChannelBehaviors%2A> 屬性所傳回的集合中。</span><span class="sxs-lookup"><span data-stu-id="77eac-158">Configure any issuer-specific endpoint behaviors by adding them to the collection returned by the <xref:System.ServiceModel.Security.IssuedTokenClientCredential.IssuerChannelBehaviors%2A> property.</span></span>  
  
     [!code-csharp[c_CreateSTS#14](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_creatests/cs/source.cs#14)]
     [!code-vb[c_CreateSTS#14](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_creatests/vb/source.vb#14)]  
  
### <a name="to-configure-the-issuedtokenclientcredential-in-configuration"></a><span data-ttu-id="77eac-159">若要透過組態設定 IssuedTokenClientCredential</span><span class="sxs-lookup"><span data-stu-id="77eac-159">To configure the IssuedTokenClientCredential in configuration</span></span>  
  
1. <span data-ttu-id="77eac-160">在[\<終結點行為中創建已頒發的Token>](../../../../docs/framework/configure-apps/file-schema/wcf/issuedtoken.md)元素作為[\<已頒發Token>](../../../../docs/framework/configure-apps/file-schema/wcf/issuedtoken.md)元素的子項目。</span><span class="sxs-lookup"><span data-stu-id="77eac-160">Create an [\<issuedToken>](../../../../docs/framework/configure-apps/file-schema/wcf/issuedtoken.md) element as a child of the [\<issuedToken>](../../../../docs/framework/configure-apps/file-schema/wcf/issuedtoken.md) element in an endpoint behavior.</span></span>  
  
2. <span data-ttu-id="77eac-161">如果不需要權杖緩存，則將`cacheIssuedTokens`屬性（<>`issuedToken`元素）設置為`false`。</span><span class="sxs-lookup"><span data-stu-id="77eac-161">If token caching is not required, set the `cacheIssuedTokens` attribute (of the <`issuedToken`> element) to `false`.</span></span>  
  
3. <span data-ttu-id="77eac-162">如果緩存權杖需要時間限制，則`maxIssuedTokenCachingTime``issuedToken`<>元素的屬性設置為適當的值。</span><span class="sxs-lookup"><span data-stu-id="77eac-162">If a time limit is required on cached tokens, set the `maxIssuedTokenCachingTime` attribute on the <`issuedToken`> element to an appropriate value.</span></span> <span data-ttu-id="77eac-163">例如：</span><span class="sxs-lookup"><span data-stu-id="77eac-163">For example:</span></span>  
    `<issuedToken maxIssuedTokenCachingTime='00:10:00' />`  
  
4. <span data-ttu-id="77eac-164">如果首選預設值以外的值，則將`issuedTokenRenewalThresholdPercentage`<>`issuedToken`元素的屬性設置為適當的值，例如：</span><span class="sxs-lookup"><span data-stu-id="77eac-164">If a value other than the default is preferred, set the `issuedTokenRenewalThresholdPercentage` attribute on the <`issuedToken`> element to an appropriate value, for example:</span></span>  
  
    ```xml  
    <issuedToken issuedTokenRenewalThresholdPercentage = "80" />  
    ```  
  
5. <span data-ttu-id="77eac-165">如果不使用訊息安全性或傳輸安全性來搭配訊息認證的繫結程序需要的是 `CombinedEntropy` 以外的金鑰 Entropy 模式 (例如，繫結程序不包含 `SecurityBindingElement`)，請視需要將 `defaultKeyEntropyMode` 項目上的 `<issuedToken>` 屬性設為 `ServerEntropy` 或 `ClientEntropy`。</span><span class="sxs-lookup"><span data-stu-id="77eac-165">If a key entropy mode other than `CombinedEntropy` is on a binding that does not use message security or transport security with message credentials (for example, the binding does not have a `SecurityBindingElement`), set the `defaultKeyEntropyMode` attribute on the `<issuedToken>` element to a either `ServerEntropy` or `ClientEntropy` as required.</span></span>  
  
    ```xml  
    <issuedToken defaultKeyEntropyMode = "ServerEntropy" />  
    ```  
  
6. <span data-ttu-id="77eac-166">選擇性。</span><span class="sxs-lookup"><span data-stu-id="77eac-166">Optional.</span></span> <span data-ttu-id="77eac-167">通過將<>`issuerChannelBehaviors`元素作為<>`issuedToken`元素的子項目來配置任何特定于頒發器的自訂終結點行為。</span><span class="sxs-lookup"><span data-stu-id="77eac-167">Configure any issuer-specific custom endpoint behavior by creating an <`issuerChannelBehaviors`> element as a child of the <`issuedToken`> element.</span></span> <span data-ttu-id="77eac-168">對於每個行為，創建一個`add`<>元素作為<>`issuerChannelBehaviors`元素的子項目。</span><span class="sxs-lookup"><span data-stu-id="77eac-168">For each behavior, create an <`add`> element as a child of the <`issuerChannelBehaviors`> element.</span></span> <span data-ttu-id="77eac-169">通過在<>`issuerAddress``add`元素上設置屬性來指定行為的頒發者位址。</span><span class="sxs-lookup"><span data-stu-id="77eac-169">Specify the issuer address of the behavior by setting the `issuerAddress` attribute on the <`add`> element.</span></span> <span data-ttu-id="77eac-170">通過在<>`add`元素上設置屬性`behaviorConfiguration`來指定行為本身。</span><span class="sxs-lookup"><span data-stu-id="77eac-170">Specify the behavior itself by setting the `behaviorConfiguration` attribute on the <`add`> element.</span></span>  
  
    ```xml  
    <issuerChannelBehaviors>  
    <add issuerAddress="http://fabrikam.org/sts" behaviorConfiguration="FabrikamSTS" />  
    </issuerChannelBehaviors>  
    ```  
  
### <a name="to-configure-an-x509certificaterecipientclientcredential-in-code"></a><span data-ttu-id="77eac-171">若要透過程式碼設定 X509CertificateRecipientClientCredential</span><span class="sxs-lookup"><span data-stu-id="77eac-171">To configure an X509CertificateRecipientClientCredential in code</span></span>  
  
1. <span data-ttu-id="77eac-172">透過屬於 <xref:System.ServiceModel.Security.X509CertificateRecipientClientCredential> 類別或 <xref:System.ServiceModel.Description.ClientCredentials.ServiceCertificate%2A> 屬性的 <xref:System.ServiceModel.ClientBase%601.ClientCredentials%2A> 屬性之 <xref:System.ServiceModel.ClientBase%601> 屬性，存取 <xref:System.ServiceModel.ChannelFactory>。</span><span class="sxs-lookup"><span data-stu-id="77eac-172">Access the <xref:System.ServiceModel.Security.X509CertificateRecipientClientCredential> through the <xref:System.ServiceModel.Description.ClientCredentials.ServiceCertificate%2A> property of the <xref:System.ServiceModel.ClientBase%601.ClientCredentials%2A> property of the <xref:System.ServiceModel.ClientBase%601> class or the <xref:System.ServiceModel.ChannelFactory> property.</span></span>  
  
     [!code-csharp[c_CreateSTS#18](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_creatests/cs/source.cs#18)]
     [!code-vb[c_CreateSTS#18](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_creatests/vb/source.vb#18)]  
  
2. <span data-ttu-id="77eac-173">如果特定端點憑證可使用 <xref:System.Security.Cryptography.X509Certificates.X509Certificate2> 執行個體，請使用 <xref:System.Collections.Generic.ICollection%601.Add%2A> 屬性所傳回之集合的 <xref:System.ServiceModel.Security.X509CertificateRecipientClientCredential.ScopedCertificates%2A> 方法。</span><span class="sxs-lookup"><span data-stu-id="77eac-173">If an <xref:System.Security.Cryptography.X509Certificates.X509Certificate2> instance is available for the certificate for a given endpoint, use the <xref:System.Collections.Generic.ICollection%601.Add%2A> method of the collection returned by the <xref:System.ServiceModel.Security.X509CertificateRecipientClientCredential.ScopedCertificates%2A> property.</span></span>  
  
     [!code-csharp[c_CreateSTS#19](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_creatests/cs/source.cs#19)]
     [!code-vb[c_CreateSTS#19](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_creatests/vb/source.vb#19)]  
  
3. <span data-ttu-id="77eac-174">如下列範例所示，如果無法使用 <xref:System.Security.Cryptography.X509Certificates.X509Certificate2> 執行個體，請使用 <xref:System.ServiceModel.Security.X509CertificateRecipientClientCredential.SetScopedCertificate%2A> 類別的 <xref:System.ServiceModel.Security.X509CertificateRecipientClientCredential> 方法。</span><span class="sxs-lookup"><span data-stu-id="77eac-174">If an <xref:System.Security.Cryptography.X509Certificates.X509Certificate2> instance is not available, use the <xref:System.ServiceModel.Security.X509CertificateRecipientClientCredential.SetScopedCertificate%2A> method of the <xref:System.ServiceModel.Security.X509CertificateRecipientClientCredential> class as shown in the following example.</span></span>  
  
     [!code-csharp[c_CreateSTS#20](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_creatests/cs/source.cs#20)]
     [!code-vb[c_CreateSTS#20](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_creatests/vb/source.vb#20)]  
  
### <a name="to-configure-an-x509certificaterecipientclientcredential-in-configuration"></a><span data-ttu-id="77eac-175">若要透過組態設定 X509CertificateRecipientClientCredential</span><span class="sxs-lookup"><span data-stu-id="77eac-175">To configure an X509CertificateRecipientClientCredential in configuration</span></span>  
  
1. <span data-ttu-id="77eac-176">將[\<作用域證書>](../../../../docs/framework/configure-apps/file-schema/wcf/scopedcertificates-element.md)元素作為[\<服務證書>](../../../../docs/framework/configure-apps/file-schema/wcf/servicecertificate-of-clientcredentials-element.md)元素的子項目創建，該元素本身是終結點行為中[\<用戶端憑據>](../../../../docs/framework/configure-apps/file-schema/wcf/clientcredentials.md)元素的子項目。</span><span class="sxs-lookup"><span data-stu-id="77eac-176">Create a [\<scopedCertificates>](../../../../docs/framework/configure-apps/file-schema/wcf/scopedcertificates-element.md) element as a child of the [\<serviceCertificate>](../../../../docs/framework/configure-apps/file-schema/wcf/servicecertificate-of-clientcredentials-element.md) element that is itself a child of the [\<clientCredentials>](../../../../docs/framework/configure-apps/file-schema/wcf/clientcredentials.md) element in an endpoint behavior.</span></span>  
  
2. <span data-ttu-id="77eac-177">建立 `<add>` 項目以做為 `<scopedCertificates>` 項目的子項。</span><span class="sxs-lookup"><span data-stu-id="77eac-177">Create an `<add>` element as a child of the `<scopedCertificates>` element.</span></span> <span data-ttu-id="77eac-178">指定 `storeLocation`、`storeName`、`x509FindType` 和 `findValue` 的屬性值以參照到適當的憑證。</span><span class="sxs-lookup"><span data-stu-id="77eac-178">Specify values for the `storeLocation`, `storeName`, `x509FindType`, and `findValue` attributes to refer to the appropriate certificate.</span></span> <span data-ttu-id="77eac-179">將 `targetUri` 的屬性值設為將使用該憑證之端點的位址，如下列範例所示。</span><span class="sxs-lookup"><span data-stu-id="77eac-179">Set the `targetUri` attribute to a value that provides the address of the endpoint that the certificate is to be used for, as shown in the following example.</span></span>  
  
    ```xml  
    <scopedCertificates>  
     <add targetUri="http://fabrikam.com/sts"
          storeLocation="CurrentUser"  
          storeName="TrustedPeople"  
          x509FindType="FindBySubjectName"  
          findValue="FabrikamSTS" />  
    </scopedCertificates>  
    ```  
  
## <a name="example"></a><span data-ttu-id="77eac-180">範例</span><span class="sxs-lookup"><span data-stu-id="77eac-180">Example</span></span>  
 <span data-ttu-id="77eac-181">下列程式碼範例會透過程式碼設定 <xref:System.ServiceModel.Security.IssuedTokenClientCredential> 類別的執行個體。</span><span class="sxs-lookup"><span data-stu-id="77eac-181">The following code sample configures an instance of the <xref:System.ServiceModel.Security.IssuedTokenClientCredential> class in code.</span></span>  
  
 [!code-csharp[c_FederatedClient#2](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_federatedclient/cs/source.cs#2)]
 [!code-vb[c_FederatedClient#2](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_federatedclient/vb/source.vb#2)]  
  
## <a name="net-framework-security"></a><span data-ttu-id="77eac-182">.NET Framework 安全性</span><span class="sxs-lookup"><span data-stu-id="77eac-182">.NET Framework Security</span></span>  
 <span data-ttu-id="77eac-183">為了避免發生資訊洩露，執行 Svcutil.exe 工具以處理來自聯合端點之中繼資料的用戶端需要確定結果的安全性權杖服務位址是所需要的。</span><span class="sxs-lookup"><span data-stu-id="77eac-183">To prevent possible information disclosure, clients that are running the Svcutil.exe tool to process metadata from federated endpoints should ensure that the resulting security token service addresses are what they expect.</span></span> <span data-ttu-id="77eac-184">當安全性權杖服務公開多個端點時，這點特別重要，因為 Svcutil.exe 工具會產生結果組態檔以運用第一個此類端點，但是這可能不是用戶端應該使用的端點。</span><span class="sxs-lookup"><span data-stu-id="77eac-184">This is especially important when a security token service exposes multiple endpoints, because the Svcutil.exe tool generates the resulting configuration file to use the first such endpoint, which may not be the one the client should be using.</span></span>  
  
## <a name="localissuer-required"></a><span data-ttu-id="77eac-185">需要 LocalIssuer</span><span class="sxs-lookup"><span data-stu-id="77eac-185">LocalIssuer Required</span></span>  
 <span data-ttu-id="77eac-186">如果用戶端預期一律使用本機發行者，請注意下列事項：如果鏈結中倒數第二個安全性權杖服務指定了發行者位址或發行者中繼資料位址，則預設的 Svcutil.exe 輸出將會導致無法使用本機發行者。</span><span class="sxs-lookup"><span data-stu-id="77eac-186">If clients are expected to always use a local issuer, note the following: the default output of Svcutil.exe results in the local issuer not being used if the second-to-last security token service in the chain specifies an issuer address or issuer metadata address.</span></span>  
  
 <span data-ttu-id="77eac-187">有關設置<xref:System.ServiceModel.Security.IssuedTokenClientCredential.LocalIssuerAddress%2A><xref:System.ServiceModel.Security.IssuedTokenClientCredential.LocalIssuerBinding%2A><xref:System.ServiceModel.Security.IssuedTokenClientCredential>類 的 和<xref:System.ServiceModel.Security.IssuedTokenClientCredential.LocalIssuerChannelBehaviors%2A>屬性的詳細資訊，請參閱[如何：配置本地頒發者](../../../../docs/framework/wcf/feature-details/how-to-configure-a-local-issuer.md)。</span><span class="sxs-lookup"><span data-stu-id="77eac-187">For more information about setting the <xref:System.ServiceModel.Security.IssuedTokenClientCredential.LocalIssuerAddress%2A>, <xref:System.ServiceModel.Security.IssuedTokenClientCredential.LocalIssuerBinding%2A>, and <xref:System.ServiceModel.Security.IssuedTokenClientCredential.LocalIssuerChannelBehaviors%2A> properties of the <xref:System.ServiceModel.Security.IssuedTokenClientCredential> class, see [How to: Configure a Local Issuer](../../../../docs/framework/wcf/feature-details/how-to-configure-a-local-issuer.md).</span></span>  
  
## <a name="scoped-certificates"></a><span data-ttu-id="77eac-188">範圍憑證</span><span class="sxs-lookup"><span data-stu-id="77eac-188">Scoped Certificates</span></span>  
 <span data-ttu-id="77eac-189">一般來說，如果因為沒有使用憑證交涉而必須指定服務憑證才能與任何一項安全性權杖服務通訊的話，您可以透過 <xref:System.ServiceModel.Security.X509CertificateRecipientClientCredential.ScopedCertificates%2A> 類別的 <xref:System.ServiceModel.Security.X509CertificateRecipientClientCredential> 屬性來指定服務憑證。</span><span class="sxs-lookup"><span data-stu-id="77eac-189">If service certificates must be specified for communicating with any of the security token services, typically because certificate negotiation is not being used, they can be specified using the <xref:System.ServiceModel.Security.X509CertificateRecipientClientCredential.ScopedCertificates%2A> property of the <xref:System.ServiceModel.Security.X509CertificateRecipientClientCredential> class.</span></span> <span data-ttu-id="77eac-190"><xref:System.ServiceModel.Security.X509CertificateRecipientClientCredential.SetDefaultCertificate%2A> 方法會採用 <xref:System.Uri> 和 <xref:System.Security.Cryptography.X509Certificates.X509Certificate2> 做為參數。</span><span class="sxs-lookup"><span data-stu-id="77eac-190">The <xref:System.ServiceModel.Security.X509CertificateRecipientClientCredential.SetDefaultCertificate%2A> method takes a <xref:System.Uri> and an <xref:System.Security.Cryptography.X509Certificates.X509Certificate2> as parameters.</span></span> <span data-ttu-id="77eac-191">在指定的 URI 上與端點通訊時，會使用指定的憑證。</span><span class="sxs-lookup"><span data-stu-id="77eac-191">The specified certificate is used when communicating with endpoints at the specified URI.</span></span> <span data-ttu-id="77eac-192">或者，您可以使用 <xref:System.ServiceModel.Security.X509CertificateRecipientClientCredential.SetScopedCertificate%2A> 方法，將憑證新增至 <xref:System.ServiceModel.Security.X509CertificateRecipientClientCredential.ScopedCertificates%2A> 屬性所傳回的集合中。</span><span class="sxs-lookup"><span data-stu-id="77eac-192">Alternatively, you can use the <xref:System.ServiceModel.Security.X509CertificateRecipientClientCredential.SetScopedCertificate%2A> method to add a certificate to the collection returned by the <xref:System.ServiceModel.Security.X509CertificateRecipientClientCredential.ScopedCertificates%2A> property.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="77eac-193">用戶端對於規範到特定 URI 範圍的憑證概念，只會套用到對服務 (可在這些 URI 上公開端點) 執行傳出呼叫的應用程式上。</span><span class="sxs-lookup"><span data-stu-id="77eac-193">The client idea of certificates that are scoped to a given URI applies only to applications that are making outbound calls to services that expose endpoints at those URIs.</span></span> <span data-ttu-id="77eac-194">它不適用於用於對已頒發的權杖進行簽名的證書，例如<xref:System.ServiceModel.Security.IssuedTokenServiceCredential.KnownCertificates%2A><xref:System.ServiceModel.Security.IssuedTokenServiceCredential>類返回的集合中伺服器上配置的權杖。</span><span class="sxs-lookup"><span data-stu-id="77eac-194">It does not apply to certificates that are used to sign issued tokens, such as those configured on the server in the collection returned by the <xref:System.ServiceModel.Security.IssuedTokenServiceCredential.KnownCertificates%2A> of the <xref:System.ServiceModel.Security.IssuedTokenServiceCredential> class.</span></span> <span data-ttu-id="77eac-195">有關詳細資訊，請參閱[：在識別身分同盟服務上配置憑據](../../../../docs/framework/wcf/feature-details/how-to-configure-credentials-on-a-federation-service.md)。</span><span class="sxs-lookup"><span data-stu-id="77eac-195">For more information, see [How to: Configure Credentials on a Federation Service](../../../../docs/framework/wcf/feature-details/how-to-configure-credentials-on-a-federation-service.md).</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="77eac-196">另請參閱</span><span class="sxs-lookup"><span data-stu-id="77eac-196">See also</span></span>

- [<span data-ttu-id="77eac-197">同盟範例</span><span class="sxs-lookup"><span data-stu-id="77eac-197">Federation Sample</span></span>](../../../../docs/framework/wcf/samples/federation-sample.md)
- [<span data-ttu-id="77eac-198">HOW TO：在 WSFederationHttpBinding 上停用安全工作階段</span><span class="sxs-lookup"><span data-stu-id="77eac-198">How to: Disable Secure Sessions on a WSFederationHttpBinding</span></span>](../../../../docs/framework/wcf/feature-details/how-to-disable-secure-sessions-on-a-wsfederationhttpbinding.md)
- [<span data-ttu-id="77eac-199">如何：建立 WSFederationHttpBinding</span><span class="sxs-lookup"><span data-stu-id="77eac-199">How to: Create a WSFederationHttpBinding</span></span>](../../../../docs/framework/wcf/feature-details/how-to-create-a-wsfederationhttpbinding.md)
- [<span data-ttu-id="77eac-200">HOW TO：設定聯合服務的認證</span><span class="sxs-lookup"><span data-stu-id="77eac-200">How to: Configure Credentials on a Federation Service</span></span>](../../../../docs/framework/wcf/feature-details/how-to-configure-credentials-on-a-federation-service.md)
- [<span data-ttu-id="77eac-201">HOW TO：設定本機簽發者</span><span class="sxs-lookup"><span data-stu-id="77eac-201">How to: Configure a Local Issuer</span></span>](../../../../docs/framework/wcf/feature-details/how-to-configure-a-local-issuer.md)
- [<span data-ttu-id="77eac-202">中繼資料的安全性考量</span><span class="sxs-lookup"><span data-stu-id="77eac-202">Security Considerations with Metadata</span></span>](../../../../docs/framework/wcf/feature-details/security-considerations-with-metadata.md)
- [<span data-ttu-id="77eac-203">HOW TO：安全中繼資料端點</span><span class="sxs-lookup"><span data-stu-id="77eac-203">How to: Secure Metadata Endpoints</span></span>](../../../../docs/framework/wcf/feature-details/how-to-secure-metadata-endpoints.md)
