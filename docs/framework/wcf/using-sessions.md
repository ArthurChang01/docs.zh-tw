---
title: 使用工作階段
ms.date: 03/30/2017
dev_langs:
- csharp
- vb
helpviewer_keywords:
- sessions [WCF]
ms.assetid: 864ba12f-3331-4359-a359-6d6d387f1035
ms.openlocfilehash: a879e90aeab7b40529df1f1a60cd1f879c39720a
ms.sourcegitcommit: 7588136e355e10cbc2582f389c90c127363c02a5
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 03/12/2020
ms.locfileid: "79143170"
---
# <a name="using-sessions"></a><span data-ttu-id="e6182-102">使用工作階段</span><span class="sxs-lookup"><span data-stu-id="e6182-102">Using Sessions</span></span>
<span data-ttu-id="e6182-103">在 Windows 通信基礎 （WCF） 應用程式中，*會話*將一組消息關聯到會話中。</span><span class="sxs-lookup"><span data-stu-id="e6182-103">In Windows Communication Foundation (WCF) applications, a *session* correlates a group of messages into a conversation.</span></span> <span data-ttu-id="e6182-104">WCF 會話不同于ASP.NET應用程式中可用的會話物件，支援不同的行為，並且以不同的方式控制。</span><span class="sxs-lookup"><span data-stu-id="e6182-104">WCF sessions are different than the session object available in ASP.NET applications, support different behaviors, and are controlled in different ways.</span></span> <span data-ttu-id="e6182-105">本主題介紹會話在 WCF 應用程式中啟用的功能以及如何使用它們。</span><span class="sxs-lookup"><span data-stu-id="e6182-105">This topic describes the features that sessions enable in WCF applications and how to use them.</span></span>  
  
## <a name="sessions-in-windows-communication-foundation-applications"></a><span data-ttu-id="e6182-106">Windows Communication Foundation 應用程式中的工作階段</span><span class="sxs-lookup"><span data-stu-id="e6182-106">Sessions in Windows Communication Foundation Applications</span></span>  
 <span data-ttu-id="e6182-107">當服務合約指定其需要工作階段時，該合約會指定所有的呼叫 (即支援呼叫的基礎訊息交換) 必須是同一個對話的一部分。</span><span class="sxs-lookup"><span data-stu-id="e6182-107">When a service contract specifies that it requires a session, that contract is specifying that all calls (that is, the underlying message exchanges that support the calls) must be part of the same conversation.</span></span> <span data-ttu-id="e6182-108">如果合約指定其允許使用工作階段，但不需要工作階段，則用戶端可以連線，並選擇是否要建立工作階段。</span><span class="sxs-lookup"><span data-stu-id="e6182-108">If a contract specifies that it allows sessions but does not require one, clients can connect and either establish a session or not establish a session.</span></span> <span data-ttu-id="e6182-109">如果工作階段結束，而且某個訊息已透過相同的通道傳送，就會擲回例外狀況。</span><span class="sxs-lookup"><span data-stu-id="e6182-109">If the session ends and a message is sent through the same channel an exception is thrown.</span></span>  
  
 <span data-ttu-id="e6182-110">WCF 會話具有以下主要概念特徵：</span><span class="sxs-lookup"><span data-stu-id="e6182-110">WCF sessions have the following main conceptual features:</span></span>  
  
- <span data-ttu-id="e6182-111">工作階段是由呼叫的應用程式 (WCF 用戶端) 明確地啟始及終止。</span><span class="sxs-lookup"><span data-stu-id="e6182-111">They are explicitly initiated and terminated by the calling application (the WCF client).</span></span>  
  
- <span data-ttu-id="e6182-112">工作階段期間傳遞的訊息是依其接收的順序進行處理。</span><span class="sxs-lookup"><span data-stu-id="e6182-112">Messages delivered during a session are processed in the order in which they are received.</span></span>  
  
- <span data-ttu-id="e6182-113">工作階段會將一群訊息互相關聯為對話。</span><span class="sxs-lookup"><span data-stu-id="e6182-113">Sessions correlate a group of messages into a conversation.</span></span> <span data-ttu-id="e6182-114">可能會有不同類型的相互關聯。</span><span class="sxs-lookup"><span data-stu-id="e6182-114">Different types of correlation are possible.</span></span> <span data-ttu-id="e6182-115">例如，某個工作階段架構通道可能會根據共用的網路連線將訊息相互關聯，而另一個工作階段架構通道可能會根據訊息本文內的共用標記將訊息相互關聯。</span><span class="sxs-lookup"><span data-stu-id="e6182-115">For instance, one session-based channel may correlate messages based on a shared network connection while another session-based channel may correlate messages based on a shared tag in the message body.</span></span> <span data-ttu-id="e6182-116">這些可以衍生自工作階段的功能視相互關聯的本質而定。</span><span class="sxs-lookup"><span data-stu-id="e6182-116">The features that can be derived from the session depend on the nature of the correlation.</span></span>  
  
- <span data-ttu-id="e6182-117">沒有與 WCF 會話關聯的常規資料存儲。</span><span class="sxs-lookup"><span data-stu-id="e6182-117">There is no general data store associated with a WCF session.</span></span>  
  
 <span data-ttu-id="e6182-118">如果您熟悉ASP.NET應用程式中的<xref:System.Web.SessionState.HttpSessionState?displayProperty=nameWithType>類及其提供的功能，您可能會注意到此類會話和 WCF 會話之間的以下差異：</span><span class="sxs-lookup"><span data-stu-id="e6182-118">If you are familiar with the <xref:System.Web.SessionState.HttpSessionState?displayProperty=nameWithType> class in ASP.NET applications and the functionality it provides, you might notice the following differences between that kind of session and WCF sessions:</span></span>  
  
- <span data-ttu-id="e6182-119">ASP.NET會話始終由伺服器啟動。</span><span class="sxs-lookup"><span data-stu-id="e6182-119">ASP.NET sessions are always server-initiated.</span></span>  
  
- <span data-ttu-id="e6182-120">ASP.NET會話隱式無序。</span><span class="sxs-lookup"><span data-stu-id="e6182-120">ASP.NET sessions are implicitly unordered.</span></span>  
  
- <span data-ttu-id="e6182-121">ASP.NET會話提供跨請求的一般資料存儲機制。</span><span class="sxs-lookup"><span data-stu-id="e6182-121">ASP.NET sessions provide a general data storage mechanism across requests.</span></span>  
  
 <span data-ttu-id="e6182-122">本主題說明：</span><span class="sxs-lookup"><span data-stu-id="e6182-122">This topic describes:</span></span>  
  
- <span data-ttu-id="e6182-123">使用服務模型層中工作階段架構繫結時的預設執行行為。</span><span class="sxs-lookup"><span data-stu-id="e6182-123">The default execution behavior when using session-based bindings in the service model layer.</span></span>  
  
- <span data-ttu-id="e6182-124">基於 WCF 會話的系統提供的綁定提供的功能類型。</span><span class="sxs-lookup"><span data-stu-id="e6182-124">The types of features that the WCF session-based, system-provided bindings provide.</span></span>  
  
- <span data-ttu-id="e6182-125">如何建立會宣告工作階段需求的合約。</span><span class="sxs-lookup"><span data-stu-id="e6182-125">How to create a contract that declares a session requirement.</span></span>  
  
- <span data-ttu-id="e6182-126">如何了解並控制工作階段的建立與終止，以及工作階段與服務執行個體之間的關係。</span><span class="sxs-lookup"><span data-stu-id="e6182-126">How to understand and control the creation and termination of the session and the relationship of the session to the service instance.</span></span>  
  
## <a name="default-execution-behavior-using-sessions"></a><span data-ttu-id="e6182-127">使用工作階段的預設執行行為</span><span class="sxs-lookup"><span data-stu-id="e6182-127">Default Execution Behavior Using Sessions</span></span>  
 <span data-ttu-id="e6182-128">會嘗試初始化工作階段的繫結稱為「 *工作階段架構* 」(Session-based) 繫結。</span><span class="sxs-lookup"><span data-stu-id="e6182-128">A binding that attempts to initiate a session is called a *session-based* binding.</span></span> <span data-ttu-id="e6182-129">服務合約會指定其需要、允許，或拒絕工作階段架構繫結，方法是將服務合約介面 (或類別) 上的 <xref:System.ServiceModel.ServiceContractAttribute.SessionMode%2A?displayProperty=nameWithType> 屬性設為其中一個 <xref:System.ServiceModel.SessionMode?displayProperty=nameWithType> 列舉值。</span><span class="sxs-lookup"><span data-stu-id="e6182-129">Service contracts specify that they require, permit, or refuse session-based bindings by setting the <xref:System.ServiceModel.ServiceContractAttribute.SessionMode%2A?displayProperty=nameWithType> property on the service contract interface (or class) to one of the <xref:System.ServiceModel.SessionMode?displayProperty=nameWithType> enumeration values.</span></span> <span data-ttu-id="e6182-130">預設情況下，此屬性的值為<xref:System.ServiceModel.SessionMode.Allowed>，這意味著如果用戶端使用基於會話的綁定與 WCF 服務實現，該服務建立並使用提供的會話。</span><span class="sxs-lookup"><span data-stu-id="e6182-130">By default, the value of this property is <xref:System.ServiceModel.SessionMode.Allowed>, which means that if a client uses a session-based binding with a WCF service implementation, the service establishes and uses the session provided.</span></span>  
  
 <span data-ttu-id="e6182-131">當 WCF 服務接受用戶端會話時，預設情況下啟用以下功能：</span><span class="sxs-lookup"><span data-stu-id="e6182-131">When a WCF service accepts a client session, the following features are enabled by default:</span></span>  
  
1. <span data-ttu-id="e6182-132">WCF 用戶端物件之間的所有調用都由同一服務實例處理。</span><span class="sxs-lookup"><span data-stu-id="e6182-132">All calls between a WCF client object are handled by the same service instance.</span></span>  
  
2. <span data-ttu-id="e6182-133">不同的工作階段架構繫結會提供額外的功能。</span><span class="sxs-lookup"><span data-stu-id="e6182-133">Different session-based bindings provide additional features.</span></span>  
  
## <a name="system-provided-session-types"></a><span data-ttu-id="e6182-134">系統提供的工作階段類型</span><span class="sxs-lookup"><span data-stu-id="e6182-134">System-Provided Session Types</span></span>  
 <span data-ttu-id="e6182-135">工作階段架構繫結支援服務執行個體與特定工作階段之間的預設關聯。</span><span class="sxs-lookup"><span data-stu-id="e6182-135">A session-based binding supports the default association of a service instance with a particular session.</span></span> <span data-ttu-id="e6182-136">然而，除了啟用先前所述的工作階段架構執行個體控制之外，不同的工作階段架構繫結也支援不同的功能。</span><span class="sxs-lookup"><span data-stu-id="e6182-136">However, different session-based bindings support different features in addition to enabling the session-based instancing control previously described.</span></span>  
  
 <span data-ttu-id="e6182-137">WCF 提供以下類型的基於會話的應用程式行為：</span><span class="sxs-lookup"><span data-stu-id="e6182-137">WCF provides the following types of session-based application behavior:</span></span>  
  
- <span data-ttu-id="e6182-138"><xref:System.ServiceModel.Channels.SecurityBindingElement?displayProperty=nameWithType> 支援安全性工作階段，其中通訊兩端均同意特定安全對話。</span><span class="sxs-lookup"><span data-stu-id="e6182-138">The <xref:System.ServiceModel.Channels.SecurityBindingElement?displayProperty=nameWithType> supports security-based sessions, in which both ends of communication have agreed upon a specific secure conversation.</span></span> <span data-ttu-id="e6182-139">有關詳細資訊，請參閱[保護服務](securing-services.md)。</span><span class="sxs-lookup"><span data-stu-id="e6182-139">For more information, see [Securing Services](securing-services.md).</span></span> <span data-ttu-id="e6182-140">例如， <xref:System.ServiceModel.WSHttpBinding?displayProperty=nameWithType> 繫結同時支援安全性工作階段與可靠工作階段，但根據預設，只會使用加密並以數位方式簽署訊息的安全工作階段。</span><span class="sxs-lookup"><span data-stu-id="e6182-140">For example, the <xref:System.ServiceModel.WSHttpBinding?displayProperty=nameWithType> binding, which contains support for both security sessions and reliable sessions, by default uses only a secure session that encrypts and digitally signs messages.</span></span>  
  
- <span data-ttu-id="e6182-141"><xref:System.ServiceModel.NetTcpBinding?displayProperty=nameWithType> 繫結支援 TCP/IP 架構工作階段，可確保所有訊息都在通訊端層級由連線建立相互關聯。</span><span class="sxs-lookup"><span data-stu-id="e6182-141">The <xref:System.ServiceModel.NetTcpBinding?displayProperty=nameWithType> binding supports TCP/IP-based sessions to ensure that all messages are correlated by the connection at the socket level.</span></span>  
  
- <span data-ttu-id="e6182-142"><xref:System.ServiceModel.Channels.ReliableSessionBindingElement?displayProperty=nameWithType> 項目會實作 WS-ReliableMessaging 規格，支援可在其中將訊息設定為依序傳遞且只傳遞一次的可靠工作階段，確保即使訊息在對話期間行經多個節點仍會收到訊息。</span><span class="sxs-lookup"><span data-stu-id="e6182-142">The <xref:System.ServiceModel.Channels.ReliableSessionBindingElement?displayProperty=nameWithType> element, which implements the WS-ReliableMessaging specification, provides support for reliable sessions in which messages can be configured to be delivered in order and exactly once, ensuring messages are received even when messages travel across multiple nodes during the conversation.</span></span> <span data-ttu-id="e6182-143">有關詳細資訊，請參閱[可靠會話](./feature-details/reliable-sessions.md)。</span><span class="sxs-lookup"><span data-stu-id="e6182-143">For more information, see [Reliable Sessions](./feature-details/reliable-sessions.md).</span></span>  
  
- <span data-ttu-id="e6182-144"><xref:System.ServiceModel.NetMsmqBinding?displayProperty=nameWithType> 繫結提供 MSMQ 資料包工作階段。</span><span class="sxs-lookup"><span data-stu-id="e6182-144">The <xref:System.ServiceModel.NetMsmqBinding?displayProperty=nameWithType> binding provides MSMQ datagram sessions.</span></span> <span data-ttu-id="e6182-145">有關詳細資訊，請參閱[WCF 中的佇列](./feature-details/queues-in-wcf.md)。</span><span class="sxs-lookup"><span data-stu-id="e6182-145">For more information, see [Queues in WCF](./feature-details/queues-in-wcf.md).</span></span>  
  
 <span data-ttu-id="e6182-146">設定 <xref:System.ServiceModel.ServiceContractAttribute.SessionMode%2A> 屬性不會指定合約所需的工作階段類型，只代表它需要工作階段。</span><span class="sxs-lookup"><span data-stu-id="e6182-146">Setting the <xref:System.ServiceModel.ServiceContractAttribute.SessionMode%2A> property does not specify the type of session the contract requires, only that it requires one.</span></span>  
  
## <a name="creating-a-contract-that-requires-a-session"></a><span data-ttu-id="e6182-147">建立需要工作階段的合約</span><span class="sxs-lookup"><span data-stu-id="e6182-147">Creating a Contract That Requires a Session</span></span>  
 <span data-ttu-id="e6182-148">建立需要工作階段的合約表示服務合約所宣告的作業群組必須都在同一個工作階段中執行，而且必須依序傳遞訊息。</span><span class="sxs-lookup"><span data-stu-id="e6182-148">Creating a contract that requires a session states that the group of operations that the service contract declares must all be executed within the same session and that messages must be delivered in order.</span></span> <span data-ttu-id="e6182-149">若要對服務合約所需要的工作階段支援層級進行判斷提示，請將您服務合約介面或類別的 <xref:System.ServiceModel.ServiceContractAttribute.SessionMode%2A?displayProperty=nameWithType> 屬性設為 <xref:System.ServiceModel.SessionMode?displayProperty=nameWithType> 列舉的值，以指定合約是否：</span><span class="sxs-lookup"><span data-stu-id="e6182-149">To assert the level of session support that a service contract requires, set the <xref:System.ServiceModel.ServiceContractAttribute.SessionMode%2A?displayProperty=nameWithType> property on your service contract interface or class to the value of the <xref:System.ServiceModel.SessionMode?displayProperty=nameWithType> enumeration to specify whether the contract:</span></span>  
  
- <span data-ttu-id="e6182-150">需要工作階段。</span><span class="sxs-lookup"><span data-stu-id="e6182-150">Requires a session.</span></span>  
  
- <span data-ttu-id="e6182-151">允許用戶端建立工作階段。</span><span class="sxs-lookup"><span data-stu-id="e6182-151">Allows a client to establish a session.</span></span>  
  
- <span data-ttu-id="e6182-152">禁止工作階段。</span><span class="sxs-lookup"><span data-stu-id="e6182-152">Prohibits a session.</span></span>  
  
 <span data-ttu-id="e6182-153">但是，設定 <xref:System.ServiceModel.ServiceContractAttribute.SessionMode%2A> 屬性不會指定合約所需的工作階段架構行為類型，</span><span class="sxs-lookup"><span data-stu-id="e6182-153">Setting the <xref:System.ServiceModel.ServiceContractAttribute.SessionMode%2A> property does not, however, specify the type of session-based behavior the contract requires.</span></span> <span data-ttu-id="e6182-154">它指示 WCF 在運行時確認服務的配置綁定（創建通信通道）在實現服務時是否、沒有或可以建立會話。</span><span class="sxs-lookup"><span data-stu-id="e6182-154">It instructs WCF to confirm at runtime that the configured binding (which creates the communication channel) for the service does, does not, or can establish a session when implementing a service.</span></span> <span data-ttu-id="e6182-155">同時，繫結可以其選擇的任何工作階段架構行為類型 (安全性、傳輸、可靠或某種組合) 滿足該需求，</span><span class="sxs-lookup"><span data-stu-id="e6182-155">Again, the binding can satisfy that requirement with any type of session-based behavior it chooses—security, transport, reliable, or some combination.</span></span> <span data-ttu-id="e6182-156">實際的行為則視選取的 <xref:System.ServiceModel.SessionMode?displayProperty=nameWithType> 值而定。</span><span class="sxs-lookup"><span data-stu-id="e6182-156">The exact behavior depends on the <xref:System.ServiceModel.SessionMode?displayProperty=nameWithType> value selected.</span></span> <span data-ttu-id="e6182-157">如果設定的服務繫結不符合 <xref:System.ServiceModel.ServiceContractAttribute.SessionMode%2A>的值，就會擲回例外狀況。</span><span class="sxs-lookup"><span data-stu-id="e6182-157">If the configured binding of the service does not conform to the value of <xref:System.ServiceModel.ServiceContractAttribute.SessionMode%2A>, an exception is thrown.</span></span> <span data-ttu-id="e6182-158">支援工作階段的繫結及其建立的通道都稱為工作階段架構繫結和通道。</span><span class="sxs-lookup"><span data-stu-id="e6182-158">Bindings and the channels they create that support sessions are said to be session-based.</span></span>  
  
 <span data-ttu-id="e6182-159">下列服務合約指定 `ICalculatorSession` 中的所有作業必須在工作階段中交換。</span><span class="sxs-lookup"><span data-stu-id="e6182-159">The following service contract specifies that all operations in the `ICalculatorSession` must be exchanged within a session.</span></span> <span data-ttu-id="e6182-160">除了 `Equals` 方法以外，任何作業都不會將值傳回呼叫者。</span><span class="sxs-lookup"><span data-stu-id="e6182-160">None of the operations returns a value to the caller except the `Equals` method.</span></span> <span data-ttu-id="e6182-161">然而， `Equals` 方法不會採用任何參數，因此只能在工作階段中傳回非零的值，而其中資料已經傳遞至其他作業。</span><span class="sxs-lookup"><span data-stu-id="e6182-161">However, the `Equals` method takes no parameters and, therefore, can only return a non-zero value inside a session in which data has already been passed to the other operations.</span></span> <span data-ttu-id="e6182-162">此合約需要工作階段才能正確運作，</span><span class="sxs-lookup"><span data-stu-id="e6182-162">This contract requires a session to function properly.</span></span> <span data-ttu-id="e6182-163">如果缺乏與特定用戶端關聯的工作階段，服務執行個體便無法得知此用戶端先前傳送了哪些資料。</span><span class="sxs-lookup"><span data-stu-id="e6182-163">Without a session associated with a specific client, the service instance has no way of knowing what previous data this client has sent.</span></span>  
  
 [!code-csharp[S_Service_Session#1](../../../samples/snippets/csharp/VS_Snippets_CFX/s_service_session/cs/service.cs#1)]
 [!code-vb[S_Service_Session#1](../../../samples/snippets/visualbasic/VS_Snippets_CFX/s_service_session/vb/service.vb#1)]  
  
 <span data-ttu-id="e6182-164">如果服務允許使用工作階段，則會在用戶端初始化工作階段後建立一個工作階段並加以使用；否則，將不會建立任何工作階段。</span><span class="sxs-lookup"><span data-stu-id="e6182-164">If a service allows a session, then a session is established and used if the client initiates one; otherwise, no session is established.</span></span>  
  
## <a name="sessions-and-service-instances"></a><span data-ttu-id="e6182-165">工作階段與服務執行個體</span><span class="sxs-lookup"><span data-stu-id="e6182-165">Sessions and Service Instances</span></span>  
 <span data-ttu-id="e6182-166">如果在 WCF 中使用預設具現化行為，則 WCF 用戶端物件之間的所有調用都由同一服務實例處理。</span><span class="sxs-lookup"><span data-stu-id="e6182-166">If you use the default instancing behavior in WCF, all calls between a WCF client object are handled by the same service instance.</span></span> <span data-ttu-id="e6182-167">因此，在應用程式層級，您可以將工作階段視為一個類似本機呼叫行為的啟用應用程式行為。</span><span class="sxs-lookup"><span data-stu-id="e6182-167">Therefore, at the application level, you can think of a session as enabling application behavior similar to local call behavior.</span></span> <span data-ttu-id="e6182-168">例如，當您建立本機物件時：</span><span class="sxs-lookup"><span data-stu-id="e6182-168">For example, when you create a local object:</span></span>  
  
- <span data-ttu-id="e6182-169">會呼叫建構函式。</span><span class="sxs-lookup"><span data-stu-id="e6182-169">A constructor is called.</span></span>  
  
- <span data-ttu-id="e6182-170">對 WCF 用戶端物件引用的所有後續調用都由同一物件實例處理。</span><span class="sxs-lookup"><span data-stu-id="e6182-170">All subsequent calls made to the WCF client object reference are processed by the same object instance.</span></span>  
  
- <span data-ttu-id="e6182-171">會在終結物件參考時呼叫解構函式 (Destructor)。</span><span class="sxs-lookup"><span data-stu-id="e6182-171">A destructor is called when the object reference is destroyed.</span></span>  
  
 <span data-ttu-id="e6182-172">只要是使用預設的服務執行個體行為，工作階段就會在用戶端與服務之間啟用類似的行為。</span><span class="sxs-lookup"><span data-stu-id="e6182-172">Sessions enable a similar behavior between clients and services as long as the default service instance behavior is used.</span></span> <span data-ttu-id="e6182-173">如果服務合約需要或支援工作階段，您可以設定 <xref:System.ServiceModel.OperationContractAttribute.IsInitiating%2A> 和 <xref:System.ServiceModel.OperationContractAttribute.IsTerminating%2A> 屬性，將一或多個合約作業標示為初始化工作階段或終止工作階段。</span><span class="sxs-lookup"><span data-stu-id="e6182-173">If a service contract requires or supports sessions, one or more contract operations can be marked as initiating or terminating a session by setting the <xref:System.ServiceModel.OperationContractAttribute.IsInitiating%2A> and <xref:System.ServiceModel.OperationContractAttribute.IsTerminating%2A> properties.</span></span>  
  
 <span data-ttu-id="e6182-174">「*初始化作業* 」(Initiating Operation) 是指必須當做新工作階段第一個作業呼叫的作業。</span><span class="sxs-lookup"><span data-stu-id="e6182-174">*Initiating operations* are those that must be called as the first operation of a new session.</span></span> <span data-ttu-id="e6182-175">只有在已呼叫至少一個初始化作業後才能呼叫非初始化作業。</span><span class="sxs-lookup"><span data-stu-id="e6182-175">Non-initiating operations can be called only after at least one initiating operation has been called.</span></span> <span data-ttu-id="e6182-176">因此，您可以宣告設計用來接收服務執行個體開頭適用之用戶端輸入的初始化作業，為服務建立一種工作階段建構函式</span><span class="sxs-lookup"><span data-stu-id="e6182-176">You can therefore create a kind of session constructor for your service by declaring initiating operations designed to take input from clients appropriate to the beginning of the service instance.</span></span> <span data-ttu-id="e6182-177">(但是，狀態會與工作階段而非服務物件相關聯)。</span><span class="sxs-lookup"><span data-stu-id="e6182-177">(The state is associated with the session, however, and not the service object.)</span></span>  
  
 <span data-ttu-id="e6182-178">相反地，「*終止作業*」(Terminating Operation) 則必須當做現有工作階段的最後一則訊息來呼叫。</span><span class="sxs-lookup"><span data-stu-id="e6182-178">*Terminating operations*, conversely, are those that must be called as the last message in an existing session.</span></span> <span data-ttu-id="e6182-179">在預設案例中，WCF 會在其中關聯著服務的工作階段關閉後回收服務物件及其內容。</span><span class="sxs-lookup"><span data-stu-id="e6182-179">In the default case, WCF recycles the service object and its context after the session with which the service was associated is closed.</span></span> <span data-ttu-id="e6182-180">因此，您可以宣告設計用來執行服務執行個體結尾適用之函式的終止作業，藉此建立一種解構函式。</span><span class="sxs-lookup"><span data-stu-id="e6182-180">You can, therefore, create a kind of destructor by declaring terminating operations designed to perform a function appropriate to the end of the service instance.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="e6182-181">雖然預設行為與本機建構函式和解構函式有相似之處，但也只是相似而已。</span><span class="sxs-lookup"><span data-stu-id="e6182-181">Although the default behavior bears a resemblance to local constructors and destructors, it is only a resemblance.</span></span> <span data-ttu-id="e6182-182">任何 WCF 服務操作都可以是啟動或終止操作，也可以同時同時啟動或終止操作。</span><span class="sxs-lookup"><span data-stu-id="e6182-182">Any WCF service operation can be an initiating or terminating operation, or both at the same time.</span></span> <span data-ttu-id="e6182-183">此外，在預設案例中，您可以不按次序且不限次數地呼叫啟始作業。一旦建立工作階段並使其與執行個體產生關聯，就不能再建立其他工作階段，除非您明確地控制服務執行個體的存留期 (管理 <xref:System.ServiceModel.InstanceContext?displayProperty=nameWithType> 物件)。</span><span class="sxs-lookup"><span data-stu-id="e6182-183">In addition, in the default case, initiating operations can be called any number of times in any order; no additional sessions are created once the session is established and associated with an instance unless you explicitly control the lifetime of the service instance (by manipulating the <xref:System.ServiceModel.InstanceContext?displayProperty=nameWithType> object).</span></span> <span data-ttu-id="e6182-184">最後，狀態會與工作階段而非服務物件相關聯。</span><span class="sxs-lookup"><span data-stu-id="e6182-184">Finally, the state is associated with the session and not the service object.</span></span>  
  
 <span data-ttu-id="e6182-185">例如，上例`ICalculatorSession`中使用的協定要求 WCF 用戶端物件在任何其他操作之前首先調用`Clear`該操作，並且具有此 WCF 用戶端物件的會話應在調用`Equals`該操作時終止。</span><span class="sxs-lookup"><span data-stu-id="e6182-185">For example, the `ICalculatorSession` contract used in the preceding example requires that the WCF client object first call the `Clear` operation prior to any other operation and that the session with this WCF client object should terminate when it calls the `Equals` operation.</span></span> <span data-ttu-id="e6182-186">下列程式碼範例示範強制執行這些要求的合約。</span><span class="sxs-lookup"><span data-stu-id="e6182-186">The following code example shows a contract that enforces these requirements.</span></span> <span data-ttu-id="e6182-187">必須先呼叫`Clear` ，才能起始工作階段，而該工作階段會在呼叫 `Equals` 時結束。</span><span class="sxs-lookup"><span data-stu-id="e6182-187">`Clear` must be called first to initiate a session, and that session ends when `Equals` is called.</span></span>  
  
 [!code-csharp[SCA.IsInitiatingIsTerminating#1](../../../samples/snippets/csharp/VS_Snippets_CFX/sca.isinitiatingisterminating/cs/service.cs#1)]
 [!code-vb[SCA.IsInitiatingIsTerminating#1](../../../samples/snippets/visualbasic/VS_Snippets_CFX/sca.isinitiatingisterminating/vb/service.vb#1)]  
  
 <span data-ttu-id="e6182-188">服務不會啟動用戶端的工作階段。</span><span class="sxs-lookup"><span data-stu-id="e6182-188">Services do not start sessions with clients.</span></span> <span data-ttu-id="e6182-189">在 WCF 用戶端應用程式中，基於會話的通道的存留期與會話本身的存留期之間存在直接關係。</span><span class="sxs-lookup"><span data-stu-id="e6182-189">In WCF client applications, a direct relationship exists between the lifetime of the session-based channel and the lifetime of the session itself.</span></span> <span data-ttu-id="e6182-190">因此，用戶端會藉由建立新的工作階段架構通道來建立新工作階段，然後適當地關閉工作階段架構通道來終止現有的工作階段。</span><span class="sxs-lookup"><span data-stu-id="e6182-190">As such, clients create new sessions by creating new session-based channels and tear down existing sessions by closing session-based channels gracefully.</span></span> <span data-ttu-id="e6182-191">用戶端會呼叫下列其中一項，藉此啟動服務端點的工作階段：</span><span class="sxs-lookup"><span data-stu-id="e6182-191">A client starts a session with a service endpoint by calling one of the following:</span></span>  
  
- <span data-ttu-id="e6182-192">通道上藉由呼叫<xref:System.ServiceModel.ICommunicationObject.Open%2A?displayProperty=nameWithType> 所傳回的 <xref:System.ServiceModel.ChannelFactory%601.CreateChannel%2A?displayProperty=nameWithType>。</span><span class="sxs-lookup"><span data-stu-id="e6182-192"><xref:System.ServiceModel.ICommunicationObject.Open%2A?displayProperty=nameWithType> on the channel returned by a call to <xref:System.ServiceModel.ChannelFactory%601.CreateChannel%2A?displayProperty=nameWithType>.</span></span>  
  
- <span data-ttu-id="e6182-193"><xref:System.ServiceModel.ClientBase%601.Open%2A?displayProperty=nameWithType>在[服務模型中繼資料實用程式工具 （Svcutil.exe）](servicemodel-metadata-utility-tool-svcutil-exe.md)生成的 WCF 用戶端物件上。</span><span class="sxs-lookup"><span data-stu-id="e6182-193"><xref:System.ServiceModel.ClientBase%601.Open%2A?displayProperty=nameWithType> on the WCF client object generated by the [ServiceModel Metadata Utility Tool (Svcutil.exe)](servicemodel-metadata-utility-tool-svcutil-exe.md).</span></span>  
  
- <span data-ttu-id="e6182-194">對任一類型的 WCF 用戶端物件啟動操作（預設情況下，所有操作都正在啟動）。</span><span class="sxs-lookup"><span data-stu-id="e6182-194">An initiating operation on either type of WCF client object (by default, all operations are initiating).</span></span> <span data-ttu-id="e6182-195">調用第一個操作時，WCF 用戶端物件會自動打開通道並啟動會話。</span><span class="sxs-lookup"><span data-stu-id="e6182-195">When the first operation is called, the WCF client object automatically opens the channel and initiates a session.</span></span>  
  
 <span data-ttu-id="e6182-196">一般來說，用戶端會呼叫下列其中一項，藉此結束服務端點的工作階段：</span><span class="sxs-lookup"><span data-stu-id="e6182-196">Typically a client ends a session with a service endpoint by calling one of the following:</span></span>  
  
- <span data-ttu-id="e6182-197">通道上藉由呼叫<xref:System.ServiceModel.ICommunicationObject.Close%2A?displayProperty=nameWithType> 所傳回的 <xref:System.ServiceModel.ChannelFactory%601.CreateChannel%2A?displayProperty=nameWithType>。</span><span class="sxs-lookup"><span data-stu-id="e6182-197"><xref:System.ServiceModel.ICommunicationObject.Close%2A?displayProperty=nameWithType> on the channel returned by a call to <xref:System.ServiceModel.ChannelFactory%601.CreateChannel%2A?displayProperty=nameWithType>.</span></span>  
  
- <span data-ttu-id="e6182-198"><xref:System.ServiceModel.ClientBase%601.Close%2A?displayProperty=nameWithType>在 Svcutil.exe 生成的 WCF 用戶端物件上。</span><span class="sxs-lookup"><span data-stu-id="e6182-198"><xref:System.ServiceModel.ClientBase%601.Close%2A?displayProperty=nameWithType> on the WCF client object generated by Svcutil.exe.</span></span>  
  
- <span data-ttu-id="e6182-199">對任一類型的 WCF 用戶端物件執行終止操作（預設情況下，沒有操作正在終止;協定必須顯式指定終止操作）。</span><span class="sxs-lookup"><span data-stu-id="e6182-199">A terminating operation on either type of WCF client object (by default, no operations are terminating; the contract must explicitly specify a terminating operation).</span></span> <span data-ttu-id="e6182-200">調用第一個操作時，WCF 用戶端物件會自動打開通道並啟動會話。</span><span class="sxs-lookup"><span data-stu-id="e6182-200">When the first operation is called, the WCF client object automatically opens the channel and initiates a session.</span></span>  
  
 <span data-ttu-id="e6182-201">如需範例，請參閱 [How to: Create a Service That Requires Sessions](./feature-details/how-to-create-a-service-that-requires-sessions.md) 、 [Default Service Behavior](./samples/default-service-behavior.md) 和 [Instancing](./samples/instancing.md) 範例。</span><span class="sxs-lookup"><span data-stu-id="e6182-201">For examples, see [How to: Create a Service That Requires Sessions](./feature-details/how-to-create-a-service-that-requires-sessions.md) as well as the [Default Service Behavior](./samples/default-service-behavior.md) and [Instancing](./samples/instancing.md) samples.</span></span>  
  
 <span data-ttu-id="e6182-202">有關用戶端和會話的詳細資訊，請參閱使用[WCF 用戶端存取服務](./feature-details/accessing-services-using-a-client.md)。</span><span class="sxs-lookup"><span data-stu-id="e6182-202">For more information about clients and sessions, see [Accessing Services Using a WCF Client](./feature-details/accessing-services-using-a-client.md).</span></span>  
  
## <a name="sessions-interact-with-instancecontext-settings"></a><span data-ttu-id="e6182-203">與 InstanceContext 設定互動的工作階段</span><span class="sxs-lookup"><span data-stu-id="e6182-203">Sessions Interact with InstanceContext Settings</span></span>  
 <span data-ttu-id="e6182-204">合約內的 <xref:System.ServiceModel.SessionMode> 列舉與 <xref:System.ServiceModel.ServiceBehaviorAttribute.InstanceContextMode%2A?displayProperty=nameWithType> 屬性之間會進行互動，以控制通道和特定服務物件之間的關聯。</span><span class="sxs-lookup"><span data-stu-id="e6182-204">There is an interaction between the <xref:System.ServiceModel.SessionMode> enumeration in a contract and the <xref:System.ServiceModel.ServiceBehaviorAttribute.InstanceContextMode%2A?displayProperty=nameWithType> property, which controls the association between channels and specific service objects.</span></span> <span data-ttu-id="e6182-205">有關詳細資訊，請參閱[會話、具現化和併發](./feature-details/sessions-instancing-and-concurrency.md)。</span><span class="sxs-lookup"><span data-stu-id="e6182-205">For more information, see [Sessions, Instancing, and Concurrency](./feature-details/sessions-instancing-and-concurrency.md).</span></span>  
  
### <a name="sharing-instancecontext-objects"></a><span data-ttu-id="e6182-206">共用 InstanceContext 物件</span><span class="sxs-lookup"><span data-stu-id="e6182-206">Sharing InstanceContext Objects</span></span>  
 <span data-ttu-id="e6182-207">您也可以自行執行該關聯，以控制哪個工作階段架構通道或呼叫與哪個 <xref:System.ServiceModel.InstanceContext> 物件關聯。</span><span class="sxs-lookup"><span data-stu-id="e6182-207">You can also control which session-based channel or call is associated with which <xref:System.ServiceModel.InstanceContext> object by performing that association yourself.</span></span>
  
## <a name="sessions-and-streaming"></a><span data-ttu-id="e6182-208">工作階段和資料流</span><span class="sxs-lookup"><span data-stu-id="e6182-208">Sessions and Streaming</span></span>  
 <span data-ttu-id="e6182-209">當您有大量資料要傳輸時，WCF 中的流傳輸模式是緩衝和處理整個記憶體中消息的預設行為的可行替代方法。</span><span class="sxs-lookup"><span data-stu-id="e6182-209">When you have a large amount of data to transfer, the streaming transfer mode in WCF is a feasible alternative to the default behavior of buffering and processing messages in memory in their entirety.</span></span> <span data-ttu-id="e6182-210">使用工作階段架構繫結對呼叫進行資料流處理時，可能會遇到未預期的行為。</span><span class="sxs-lookup"><span data-stu-id="e6182-210">You may get unexpected behavior when streaming calls with a session-based binding.</span></span> <span data-ttu-id="e6182-211">即使使用的繫結已設定為使用工作階段，所有資料流處理呼叫還是會透過不支援工作階段的單一通道 (資料包通道) 來進行。</span><span class="sxs-lookup"><span data-stu-id="e6182-211">All streaming calls are made through a single channel (the datagram channel) that does not support sessions even if the binding being used is configured to use sessions.</span></span> <span data-ttu-id="e6182-212">如果多個用戶端透過工作階段架構繫結對同一個服務物件進行資料流處理呼叫，而且服務物件的並行模式已設為單一且其執行個體內容模式已設為 `PerSession`，則所有呼叫必須經過資料包通道，所以一次只能處理一個呼叫。</span><span class="sxs-lookup"><span data-stu-id="e6182-212">If multiple clients make streaming calls to the same service object over a session-based binding, and the service object's concurrency mode is set to single and its instance context mode is set to `PerSession`, all calls must go through the datagram channel and so only one call is processed at a time.</span></span> <span data-ttu-id="e6182-213">然後，一個或多個用戶端可能會超時。您可以通過將服務物件的 設置為`InstanceContextMode``PerCall`或 併發設置為多個來解決此問題。</span><span class="sxs-lookup"><span data-stu-id="e6182-213">One or more clients may then time out. You can work around this issue by either setting the service object's `InstanceContextMode` to `PerCall` or Concurrency to multiple.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="e6182-214">此時 MaxConcurrentSessions 沒有作用，因為只有一個可用的「工作階段」。</span><span class="sxs-lookup"><span data-stu-id="e6182-214">MaxConcurrentSessions have no effect in this case because there is only one "session" available.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="e6182-215">另請參閱</span><span class="sxs-lookup"><span data-stu-id="e6182-215">See also</span></span>

- <xref:System.ServiceModel.OperationContractAttribute.IsInitiating%2A>
- <xref:System.ServiceModel.OperationContractAttribute.IsTerminating%2A>
