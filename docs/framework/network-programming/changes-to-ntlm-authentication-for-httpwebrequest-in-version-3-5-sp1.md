---
title: 3.5 SP1 版中 HttpWebRequest 之 NTLM 驗證的變更
ms.date: 03/30/2017
ms.assetid: 8bf0b428-5a21-4299-8d6e-bf8251fd978a
author: mcleblanc
ms.author: markl
manager: markl
ms.openlocfilehash: f5affc15607ddae76ec90a90928cb42fa0ad49e1
ms.sourcegitcommit: 3d5d33f384eeba41b2dff79d096f47ccc8d8f03d
ms.translationtype: HT
ms.contentlocale: zh-TW
ms.lasthandoff: 05/04/2018
ms.locfileid: "33397906"
---
# <a name="changes-to-ntlm-authentication-for-httpwebrequest-in-version-35-sp1"></a><span data-ttu-id="4ccc2-102">3.5 SP1 版中 HttpWebRequest 之 NTLM 驗證的變更</span><span class="sxs-lookup"><span data-stu-id="4ccc2-102">Changes to NTLM authentication for HttpWebRequest in Version 3.5 SP1</span></span>
<span data-ttu-id="4ccc2-103">已在 .NET Framework 版本 3.5 SP1 和更新版本中進行安全性變更，這些變更會影響 <xref:System.Net.HttpWebRequest>、<xref:System.Net.HttpListener>、<xref:System.Net.Security.NegotiateStream> 以及 System.Net 命名空間中的相關類別處理整合式 Windows 驗證的方式。</span><span class="sxs-lookup"><span data-stu-id="4ccc2-103">Security changes were made in .NET Framework version 3.5 SP1 and later that affect how integrated Windows authentication is handled by the <xref:System.Net.HttpWebRequest>, <xref:System.Net.HttpListener>, <xref:System.Net.Security.NegotiateStream>, and related classes in the System.Net namespace.</span></span> <span data-ttu-id="4ccc2-104">這些變更可能會影響使用這些類別提出 Web 要求並接收回應的應用程式，而且其中使用根據 NTLM 的整合式 Windows 驗證。</span><span class="sxs-lookup"><span data-stu-id="4ccc2-104">These changes can affect applications that use these classes to make web requests and receive responses where integrated Windows authentication based on NTLM is used.</span></span> <span data-ttu-id="4ccc2-105">這項變更可能會影響設定成使用整合式 Windows 驗證的網頁伺服器和用戶端應用程式。</span><span class="sxs-lookup"><span data-stu-id="4ccc2-105">This change can impact web servers and client applications that are configured to use integrated Windows authentication.</span></span>  
  
## <a name="overview"></a><span data-ttu-id="4ccc2-106">總覽</span><span class="sxs-lookup"><span data-stu-id="4ccc2-106">Overview</span></span>  
 <span data-ttu-id="4ccc2-107">整合式 Windows 驗證的設計可讓某些認證回應成為通用，這表示可以重複使用或轉寄它們。</span><span class="sxs-lookup"><span data-stu-id="4ccc2-107">The design of integrated Windows authentication allows for some credential responses to be universal, meaning they can be re-used or forwarded.</span></span> <span data-ttu-id="4ccc2-108">如果不需要此特定設計功能，則驗證通訊協定應該執行目標特定資訊，以及通道特定資訊。</span><span class="sxs-lookup"><span data-stu-id="4ccc2-108">If this particular design feature is not needed, then the authentication protocols should carry target specific information as well as channel specific information.</span></span> <span data-ttu-id="4ccc2-109">服務隨後可以提供延伸保護，確保認證回應包含服務特定資訊 (例如服務主體名稱 (SPN))。</span><span class="sxs-lookup"><span data-stu-id="4ccc2-109">Services can then provide extended protection to ensure that credential responses contain service specific information such as a Service Principal Name (SPN).</span></span> <span data-ttu-id="4ccc2-110">在認證交換時利用此資訊，服務就能進一步免於惡意使用可能未正確取得的認證回應。</span><span class="sxs-lookup"><span data-stu-id="4ccc2-110">With this information in the credential exchanges, services are able to better protect against malicious use of credential responses that might have been improperly obtained.</span></span>  
  
 <span data-ttu-id="4ccc2-111"><xref:System.Net> 和 <xref:System.Net.Security> 命名空間中的多個元件都會代表呼叫端應用程式執行整合式 Windows 驗證。</span><span class="sxs-lookup"><span data-stu-id="4ccc2-111">Multiple components in the <xref:System.Net> and <xref:System.Net.Security> namespaces perform integrated Windows authentication on behalf of a calling application.</span></span> <span data-ttu-id="4ccc2-112">本節描述在使用整合式 Windows 驗證時新增擴充保護的 System.Net 元件變更。</span><span class="sxs-lookup"><span data-stu-id="4ccc2-112">This section describes changes to System.Net components to add extended protection in their use of integrated Windows authentication.</span></span>  
  
## <a name="changes"></a><span data-ttu-id="4ccc2-113">變更</span><span class="sxs-lookup"><span data-stu-id="4ccc2-113">Changes</span></span>  
 <span data-ttu-id="4ccc2-114">與整合式 Windows 驗證搭配使用的 NTLM 驗證程序包含目的電腦所發出並傳回給用戶端電腦的挑戰。</span><span class="sxs-lookup"><span data-stu-id="4ccc2-114">The NTLM authentication process used with integrated Windows authentication includes a challenge issued by the destination computer and sent back to the client computer.</span></span> <span data-ttu-id="4ccc2-115">除非連線是迴路連線 (例如，IPv4 位址 127.0.0.1)，否則電腦在收到它自己產生的挑戰時，驗證會失敗。</span><span class="sxs-lookup"><span data-stu-id="4ccc2-115">When a computer receives a challenge it generated itself, the authentication will fail unless the connection is a loop back connection (IPv4 address 127.0.0.1, for example).</span></span>  
  
 <span data-ttu-id="4ccc2-116">存取在內部網頁伺服器上執行的服務時，通常會使用與 http://contoso/service 或 https://contoso/service 類似的 URL 存取服務。</span><span class="sxs-lookup"><span data-stu-id="4ccc2-116">When accessing a service running on an internal Web server, it is common to access the service using a URL similar to http://contoso/service or https://contoso/service.</span></span> <span data-ttu-id="4ccc2-117">"contoso" 名稱通常不是服務部署所在電腦的電腦名稱。</span><span class="sxs-lookup"><span data-stu-id="4ccc2-117">The name "contoso" is often not the computer name of the computer on which the service is deployed.</span></span> <span data-ttu-id="4ccc2-118">使用 Active Directory、DNS、NetBIOS、本機電腦的 hosts 檔案 (例如，通常是 WINDOWS\system32\drivers\etc\hosts) 或本機電腦的 lmhosts 檔案 (例如，通常是 WINDOWS\system32\drivers\etc\lmhosts) 的 <xref:System.Net> 和相關命名空間支援，以將名稱解析為位址。</span><span class="sxs-lookup"><span data-stu-id="4ccc2-118">The <xref:System.Net> and related namespaces support using Active Directory, DNS, NetBIOS, the local computer's hosts file (typically WINDOWS\system32\drivers\etc\hosts, for example), or the local computer's lmhosts file (typically WINDOWS\system32\drivers\etc\lmhosts, for example) to resolve names to addresses.</span></span> <span data-ttu-id="4ccc2-119">已解析名稱 "contoso"，以將傳送至 "contoso" 的要求傳送至適當的伺服器電腦。</span><span class="sxs-lookup"><span data-stu-id="4ccc2-119">The name "contoso" is resolved so that requests sent to "contoso" are sent to the appropriate server computer.</span></span>  
  
 <span data-ttu-id="4ccc2-120">針對大型部署進行設定時，也經常會將單一虛擬伺服器名稱授與用戶端應用程式和終端使用者絕不會使用之基礎電腦名稱的部署。</span><span class="sxs-lookup"><span data-stu-id="4ccc2-120">When configured for large deployments, it is also common for a single virtual server name to be given to the deployment with the underlying machine names never used by client applications and end users.</span></span> <span data-ttu-id="4ccc2-121">例如，您可能會呼叫 www.contoso.com 伺服器，但在內部網路上只需要使用 "contoso"。</span><span class="sxs-lookup"><span data-stu-id="4ccc2-121">For example, you might call the server www.contoso.com, but on an internal network simply use "contoso".</span></span> <span data-ttu-id="4ccc2-122">此名稱稱為用戶端 Web 要求中的主機標頭。</span><span class="sxs-lookup"><span data-stu-id="4ccc2-122">This name is called the Host header in the client web request.</span></span> <span data-ttu-id="4ccc2-123">根據 HTTP 通訊協定所指定，主機要求標頭欄位可指定所要求資源的網際網路主機和連接埠號碼。</span><span class="sxs-lookup"><span data-stu-id="4ccc2-123">As specified by the HTTP protocol, the Host request-header field specifies the Internet host and port number of the resource being requested.</span></span> <span data-ttu-id="4ccc2-124">這項資訊取自使用者或參考資源所提供的原始 URI (通常是 HTTP URL)。</span><span class="sxs-lookup"><span data-stu-id="4ccc2-124">This information is obtained from the original URI given by the user or referring resource (generally an HTTP URL).</span></span> <span data-ttu-id="4ccc2-125">在 .NET Framework 版本 4 上，用戶端也可以使用 <xref:System.Net.HttpWebRequest.Host%2A> 屬性來設定這項資訊。</span><span class="sxs-lookup"><span data-stu-id="4ccc2-125">On .NET Framework version 4, this information can also be set by the client using the new <xref:System.Net.HttpWebRequest.Host%2A> property.</span></span>  
  
 <span data-ttu-id="4ccc2-126"><xref:System.Net.AuthenticationManager> 類別控制 <xref:System.Net.WebRequest> 衍生類別和 <xref:System.Net.WebClient> 類別所使用的 Managed 驗證元件 (「模組」)。</span><span class="sxs-lookup"><span data-stu-id="4ccc2-126">The <xref:System.Net.AuthenticationManager> class controls the managed authentication components ("modules") that are used by <xref:System.Net.WebRequest> derivative classes and the <xref:System.Net.WebClient> class.</span></span> <span data-ttu-id="4ccc2-127"><xref:System.Net.AuthenticationManager> 類別提供屬性來公開以 URI 字串編製索引的 <xref:System.Net.AuthenticationManager.CustomTargetNameDictionary%2A?displayProperty=nameWithType> 物件，讓應用程式提供要在驗證期間使用的自訂 SPN 字串。</span><span class="sxs-lookup"><span data-stu-id="4ccc2-127">The <xref:System.Net.AuthenticationManager> class provides a property that exposes a <xref:System.Net.AuthenticationManager.CustomTargetNameDictionary%2A?displayProperty=nameWithType> object, indexed by URI string, for applications to supply a custom SPN string to be used during authentication.</span></span>  
  
 <span data-ttu-id="4ccc2-128">如果未設定 <xref:System.Net.AuthenticationManager.CustomTargetNameDictionary%2A> 屬性，版本 3.5 SP1 現在預設成指定 NTLM (NT LAN Manager) 驗證交換時 SPN 之要求 URL 中所使用的主機名稱。</span><span class="sxs-lookup"><span data-stu-id="4ccc2-128">Version 3.5 SP1 now defaults to specifying the host name used in the request URL in the SPN in the NTLM (NT LAN Manager) authentication exchange when the <xref:System.Net.AuthenticationManager.CustomTargetNameDictionary%2A> property is not set.</span></span> <span data-ttu-id="4ccc2-129">要求 URL 中所使用的主機名稱可能不同於用戶端要求的 <xref:System.Net.HttpRequestHeader?displayProperty=nameWithType> 中所指定的主機標頭。</span><span class="sxs-lookup"><span data-stu-id="4ccc2-129">The host name used in the request URL may be different from the Host header specified in the <xref:System.Net.HttpRequestHeader?displayProperty=nameWithType> in the client request.</span></span> <span data-ttu-id="4ccc2-130">要求 URL 中所使用的主機名稱可能不同於伺服器的實際主機名稱、伺服器的電腦名稱、電腦的 IP 位址或迴路位址。</span><span class="sxs-lookup"><span data-stu-id="4ccc2-130">The host name used in the request URL may be different from the actual host name of the server, the machine name of the server, the computer's IP address, or the loopback address.</span></span> <span data-ttu-id="4ccc2-131">在這些情況下，Windows 會讓驗證要求失敗。</span><span class="sxs-lookup"><span data-stu-id="4ccc2-131">In these cases, Windows will fail the authentication request.</span></span> <span data-ttu-id="4ccc2-132">若要解決這個問題，我們需要通知 Windows：用戶端要求的要求 URL 中所使用的主機名稱 (例如，"contoso") 實際上是本機電腦的替代名稱。</span><span class="sxs-lookup"><span data-stu-id="4ccc2-132">To address the issue, we need to notify Windows that the host name used in the request URL in the client request ("contoso", for example) is actually an alternate name for the local computer.</span></span>  
  
 <span data-ttu-id="4ccc2-133">有數種可行的方法可讓伺服器應用程式解決這項變更。</span><span class="sxs-lookup"><span data-stu-id="4ccc2-133">There are several possible methods for a server application to work around this change.</span></span> <span data-ttu-id="4ccc2-134">建議的方法是將要求 URL 中所使用的主機名稱對應至伺服器登錄中的 `BackConnectionHostNames` 機碼。</span><span class="sxs-lookup"><span data-stu-id="4ccc2-134">The recommended approach is to map the host name used in the request URL to the `BackConnectionHostNames` key in the registry on the server.</span></span> <span data-ttu-id="4ccc2-135">`BackConnectionHostNames` 登錄機碼通常用來將主機名稱對應至迴路位址。</span><span class="sxs-lookup"><span data-stu-id="4ccc2-135">The `BackConnectionHostNames` registry key is normally used to map a host name to a loopback address.</span></span> <span data-ttu-id="4ccc2-136">步驟如下所列。</span><span class="sxs-lookup"><span data-stu-id="4ccc2-136">The steps are listed below.</span></span>  
  
 <span data-ttu-id="4ccc2-137">若要指定對應至迴路位址且可連線至本機電腦上網站的主機名稱，請遵循下列步驟：</span><span class="sxs-lookup"><span data-stu-id="4ccc2-137">To specify the host names that are mapped to the loopback address and can connect to Web sites on a local computer, follow these steps:</span></span>  
  
 1. <span data-ttu-id="4ccc2-138">依序按一下 [開始] 和 [執行]，鍵入 regedit.exe，然後按一下 [確定]。</span><span class="sxs-lookup"><span data-stu-id="4ccc2-138">Click Start, click Run, type regedit, and then click OK.</span></span>  
  
 2. <span data-ttu-id="4ccc2-139">在登錄編輯程式中，找到並按一下下列登錄機碼：</span><span class="sxs-lookup"><span data-stu-id="4ccc2-139">In Registry Editor, locate and then click the following registry key:</span></span>  
  
 `HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Lsa\MSV1_0`  
  
 3. <span data-ttu-id="4ccc2-140">以滑鼠右鍵按一下 MSV1_0，並指向 [新增]，然後按一下 [多字串值]。</span><span class="sxs-lookup"><span data-stu-id="4ccc2-140">Right-click MSV1_0, point to New, and then click Multi-String Value.</span></span>  
  
 4. <span data-ttu-id="4ccc2-141">鍵入 `BackConnectionHostNames`，然後按 ENTER。</span><span class="sxs-lookup"><span data-stu-id="4ccc2-141">Type `BackConnectionHostNames`, and then press ENTER.</span></span>  
  
 5. <span data-ttu-id="4ccc2-142">以滑鼠右鍵按一下 `BackConnectionHostNames`，然後按一下 [修改]。</span><span class="sxs-lookup"><span data-stu-id="4ccc2-142">Right-click `BackConnectionHostNames`, and then click Modify.</span></span>  
  
 6. <span data-ttu-id="4ccc2-143">在 [數值資料] 方塊中，鍵入主機名稱或本機電腦上網站的主機名稱 (要求 URL 中所使用的主機名稱)，然後按一下 [確定]。</span><span class="sxs-lookup"><span data-stu-id="4ccc2-143">In the Value data box, type the host name or the host names for the sites (the host name used in the request URL) that are on the local computer, and then click OK.</span></span>  
  
 7. <span data-ttu-id="4ccc2-144">結束登錄編輯程式，然後重新啟動 IISAdmin 服務並執行 IISReset。</span><span class="sxs-lookup"><span data-stu-id="4ccc2-144">Quit Registry Editor, and then restart the IISAdmin service and run IISReset.</span></span>  
  
 <span data-ttu-id="4ccc2-145">較不安全的因應措施是停用迴圈檢查，如 [http://support.microsoft.com/kb/896861](http://go.microsoft.com/fwlink/?LinkID=179657) 中所述。</span><span class="sxs-lookup"><span data-stu-id="4ccc2-145">A less secure work around is to disable the loop back check, as described in [http://support.microsoft.com/kb/896861](http://go.microsoft.com/fwlink/?LinkID=179657).</span></span> <span data-ttu-id="4ccc2-146">這會停用反映攻擊的保護。</span><span class="sxs-lookup"><span data-stu-id="4ccc2-146">This disables the protection against reflection attacks.</span></span> <span data-ttu-id="4ccc2-147">因此，最好只將這組替代名稱限制為預期電腦實際使用的替代名稱。</span><span class="sxs-lookup"><span data-stu-id="4ccc2-147">So it is better to constrain the set of alternate names to only those you expect the machine to actually use.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="4ccc2-148">請參閱</span><span class="sxs-lookup"><span data-stu-id="4ccc2-148">See Also</span></span>  
 <xref:System.Net.AuthenticationManager.CustomTargetNameDictionary%2A?displayProperty=nameWithType>  
 <xref:System.Net.HttpRequestHeader?displayProperty=nameWithType>  
 <xref:System.Net.HttpWebRequest.Host%2A?displayProperty=nameWithType>
