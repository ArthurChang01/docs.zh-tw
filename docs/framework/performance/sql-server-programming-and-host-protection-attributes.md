---
title: SQL Server 程式設計和主機保護屬性
ms.date: 03/30/2017
helpviewer_keywords:
- SQL Server [.NET Framework]
- permission sets, SQL Server
- SQL Server Programming and Host Protection Attributes
- managed code, SQL Server
- reliability [.NET Framework]
- writing reliable code
- hosts, reliability
- host protection attributes
- HostProtectionAttribute class, reliability
ms.assetid: 7dfa36b4-e773-4c75-a3ff-ff1af3ce4c4f
author: mairaw
ms.author: mairaw
ms.openlocfilehash: f1049187dabbea64599617bb4372ed50515a51e3
ms.sourcegitcommit: 5b6d778ebb269ee6684fb57ad69a8c28b06235b9
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 04/08/2019
ms.locfileid: "59088715"
---
# <a name="sql-server-programming-and-host-protection-attributes"></a>SQL Server 程式設計和主機保護屬性
在 SQL Server 主機中載入和執行 Managed 程式碼的功能需要符合主機對程式碼存取安全性和主機資源保護的需求。  三個 SQL Server 權限集的其中一個指定的程式碼存取安全性需求：SAFE、 EXTERNAL-ACCESS 或 UNSAFE。 在 SAFE 或 EXTERNAL-ACCESS 權限集合內執行的程式碼，必須避免已套用 <xref:System.Security.Permissions.HostProtectionAttribute> 屬性的特定類型或成員。 <xref:System.Security.Permissions.HostProtectionAttribute> 不像可靠性保證一樣是安全性權限，關鍵在於它會識別主機可能不允許的特定程式碼建構 (類型或方法)。  使用 <xref:System.Security.Permissions.HostProtectionAttribute> 會強制使用有助於保護主機穩定性的程式設計模型。  
  
## <a name="host-protection-attributes"></a>主機保護屬性  
 主機保護屬性可識別不適合主機程式設計模型的類型或成員，並且代表下列遞增的可靠性威脅層級：  
  
-   不是良性。  
  
-   可能會導致伺服器管理的使用者程式碼不穩定。  
  
-   可能會導致伺服器處理序本身不穩定。  
  
 SQL Server 不允許使用具有 <xref:System.Security.Permissions.HostProtectionAttribute> 且其 <xref:System.Security.Permissions.HostProtectionResource> 值指定為 <xref:System.Security.Permissions.HostProtectionResource.SharedState>、<xref:System.Security.Permissions.HostProtectionResource.Synchronization>、<xref:System.Security.Permissions.HostProtectionResource.MayLeakOnAbort> 或 <xref:System.Security.Permissions.HostProtectionResource.ExternalProcessMgmt> 的類型或成員。 這可防止組件呼叫可啟用共用狀態、執行同步處理、可能造成終止時資源流失，或影響 SQL Server 程序完整性的成員。  
  
### <a name="disallowed-types-and-members"></a>不允許的類型和成員  
 下表提供 SQL Server 不允許其 <xref:System.Security.Permissions.HostProtectionResource> 值的類型和成員。  
  
|命名空間|類型或成員|  
|---------------|--------------------|  
|`Microsoft.Win32`|<xref:Microsoft.Win32.PowerModeChangedEventArgs> Class - 類別<br /><br /> <xref:Microsoft.Win32.PowerModeChangedEventHandler> Delegate - 委派<br /><br /> <xref:Microsoft.Win32.SessionEndedEventArgs> Class - 類別<br /><br /> <xref:Microsoft.Win32.SessionEndedEventHandler> Delegate - 委派<br /><br /> <xref:Microsoft.Win32.SessionEndingEventArgs> Class - 類別<br /><br /> <xref:Microsoft.Win32.SessionEndingEventHandler> Delegate - 委派<br /><br /> <xref:Microsoft.Win32.SessionSwitchEventArgs> Class - 類別<br /><br /> <xref:Microsoft.Win32.SessionSwitchEventHandler> Delegate - 委派<br /><br /> <xref:Microsoft.Win32.SystemEvents> Class - 類別<br /><br /> <xref:Microsoft.Win32.TimerElapsedEventArgs> Class - 類別<br /><br /> <xref:Microsoft.Win32.TimerElapsedEventHandler> Delegate - 委派<br /><br /> <xref:Microsoft.Win32.UserPreferenceChangedEventArgs> Class - 類別<br /><br /> <xref:Microsoft.Win32.UserPreferenceChangingEventArgs> Class - 類別|  
|`System.Collections`|<xref:System.Collections.ArrayList.Synchronized%2A?displayProperty=nameWithType> 方法<br /><br /> <xref:System.Collections.Hashtable.Synchronized%2A?displayProperty=nameWithType> 方法<br /><br /> <xref:System.Collections.Queue.Synchronized%2A?displayProperty=nameWithType> 方法<br /><br /> <xref:System.Collections.SortedList.Synchronized%2A?displayProperty=nameWithType> 方法<br /><br /> <xref:System.Collections.Stack.Synchronized%2A?displayProperty=nameWithType> 方法|  
|`System.ComponentModel`|<xref:System.ComponentModel.AddingNewEventArgs> Class - 類別<br /><br /> <xref:System.ComponentModel.AddingNewEventHandler> Delegate - 委派<br /><br /> <xref:System.ComponentModel.ArrayConverter> Class - 類別<br /><br /> <xref:System.ComponentModel.AsyncCompletedEventArgs> Class - 類別<br /><br /> <xref:System.ComponentModel.AsyncCompletedEventHandler> Delegate - 委派<br /><br /> <xref:System.ComponentModel.AsyncOperation> Class - 類別<br /><br /> <xref:System.ComponentModel.AsyncOperationManager> Class - 類別<br /><br /> <xref:System.ComponentModel.AttributeCollection> Class - 類別<br /><br /> <xref:System.ComponentModel.BackgroundWorker> Class - 類別<br /><br /> <xref:System.ComponentModel.BaseNumberConverter> Class - 類別<br /><br /> <xref:System.ComponentModel.BindingList%601> Class - 類別<br /><br /> <xref:System.ComponentModel.BooleanConverter> Class - 類別<br /><br /> <xref:System.ComponentModel.ByteConverter> Class - 類別<br /><br /> <xref:System.ComponentModel.CancelEventArgs> Class - 類別<br /><br /> <xref:System.ComponentModel.CancelEventHandler> Delegate - 委派<br /><br /> <xref:System.ComponentModel.CharConverter> Class - 類別<br /><br /> <xref:System.ComponentModel.CollectionChangeEventArgs> Class - 類別<br /><br /> <xref:System.ComponentModel.CollectionChangeEventHandler> Delegate - 委派<br /><br /> <xref:System.ComponentModel.CollectionConverter> Class - 類別<br /><br /> <xref:System.ComponentModel.ComponentCollection> Class - 類別<br /><br /> <xref:System.ComponentModel.ComponentConverter> Class - 類別<br /><br /> <xref:System.ComponentModel.ComponentEditor> Class - 類別<br /><br /> <xref:System.ComponentModel.ComponentResourceManager> Class - 類別<br /><br /> <xref:System.ComponentModel.Container> Class - 類別<br /><br /> <xref:System.ComponentModel.ContainerFilterService> Class - 類別<br /><br /> <xref:System.ComponentModel.CultureInfoConverter> Class - 類別<br /><br /> <xref:System.ComponentModel.CustomTypeDescriptor> Class - 類別<br /><br /> <xref:System.ComponentModel.DateTimeConverter> Class - 類別<br /><br /> <xref:System.ComponentModel.DecimalConverter> Class - 類別<br /><br /> <xref:System.ComponentModel.Design.ActiveDesignerEventArgs> Class - 類別<br /><br /> <xref:System.ComponentModel.Design.ActiveDesignerEventHandler> Delegate - 委派<br /><br /> <xref:System.ComponentModel.Design.CheckoutException> Class - 類別<br /><br /> <xref:System.ComponentModel.Design.CommandID> Class - 類別<br /><br /> <xref:System.ComponentModel.Design.ComponentChangedEventArgs> Class - 類別<br /><br /> <xref:System.ComponentModel.Design.ComponentChangedEventHandler> Delegate - 委派<br /><br /> <xref:System.ComponentModel.Design.ComponentChangingEventArgs> Class - 類別<br /><br /> <xref:System.ComponentModel.Design.ComponentChangingEventHandler> Delegate - 委派<br /><br /> <xref:System.ComponentModel.Design.ComponentEventArgs> Class - 類別<br /><br /> <xref:System.ComponentModel.Design.ComponentEventHandler> Delegate - 委派<br /><br /> <xref:System.ComponentModel.Design.ComponentRenameEventArgs> Class - 類別<br /><br /> <xref:System.ComponentModel.Design.ComponentRenameEventHandler> Delegate - 委派<br /><br /> <xref:System.ComponentModel.Design.DesignerCollection> Class - 類別<br /><br /> <xref:System.ComponentModel.Design.DesignerEventArgs> Class - 類別<br /><br /> <xref:System.ComponentModel.Design.DesignerEventHandler> Delegate - 委派<br /><br /> <xref:System.ComponentModel.Design.DesignerOptionService> Class - 類別<br /><br /> <xref:System.ComponentModel.Design.DesignerTransaction> Class - 類別<br /><br /> <xref:System.ComponentModel.Design.DesignerTransactionCloseEventArgs> Class - 類別<br /><br /> <xref:System.ComponentModel.Design.DesignerTransactionCloseEventHandler> Delegate - 委派<br /><br /> <xref:System.ComponentModel.Design.DesignerVerb> Class - 類別<br /><br /> <xref:System.ComponentModel.Design.DesignerVerbCollection> Class - 類別<br /><br /> <xref:System.ComponentModel.Design.DesigntimeLicenseContext> Class - 類別<br /><br /> <xref:System.ComponentModel.Design.DesigntimeLicenseContextSerializer> Class - 類別<br /><br /> <xref:System.ComponentModel.Design.MenuCommand> Class - 類別<br /><br /> <xref:System.ComponentModel.Design.Serialization.ComponentSerializationService> Class - 類別<br /><br /> <xref:System.ComponentModel.Design.Serialization.ContextStack> Class - 類別<br /><br /> <xref:System.ComponentModel.Design.Serialization.DesignerLoader> Class - 類別<br /><br /> <xref:System.ComponentModel.Design.Serialization.InstanceDescriptor> Class - 類別<br /><br /> <xref:System.ComponentModel.Design.Serialization.MemberRelationshipService> Class - 類別<br /><br /> <xref:System.ComponentModel.Design.Serialization.ResolveNameEventArgs> Class - 類別<br /><br /> <xref:System.ComponentModel.Design.Serialization.ResolveNameEventHandler> Delegate - 委派<br /><br /> <xref:System.ComponentModel.Design.Serialization.SerializationStore> Class - 類別<br /><br /> <xref:System.ComponentModel.Design.ServiceContainer> Class - 類別<br /><br /> <xref:System.ComponentModel.Design.ServiceCreatorCallback> Delegate - 委派<br /><br /> <xref:System.ComponentModel.Design.StandardCommands> Class - 類別<br /><br /> <xref:System.ComponentModel.Design.StandardToolWindows> Class - 類別<br /><br /> <xref:System.ComponentModel.DoubleConverter> Class - 類別<br /><br /> <xref:System.ComponentModel.DoWorkEventArgs> Class - 類別<br /><br /> <xref:System.ComponentModel.DoWorkEventHandler> Delegate - 委派<br /><br /> <xref:System.ComponentModel.EnumConverter> Class - 類別<br /><br /> <xref:System.ComponentModel.EventDescriptor> Class - 類別<br /><br /> <xref:System.ComponentModel.EventDescriptorCollection> Class - 類別<br /><br /> <xref:System.ComponentModel.EventHandlerList> Class - 類別<br /><br /> <xref:System.ComponentModel.ExpandableObjectConverter> Class - 類別<br /><br /> <xref:System.ComponentModel.HandledEventArgs> Class - 類別<br /><br /> <xref:System.ComponentModel.HandledEventHandler> Delegate - 委派<br /><br /> <xref:System.ComponentModel.InstanceCreationEditor> Class - 類別<br /><br /> <xref:System.ComponentModel.Int16Converter> Class - 類別<br /><br /> <xref:System.ComponentModel.Int32Converter> Class - 類別<br /><br /> <xref:System.ComponentModel.Int64Converter> Class - 類別<br /><br /> <xref:System.ComponentModel.InvalidAsynchronousStateException> Class - 類別<br /><br /> <xref:System.ComponentModel.InvalidEnumArgumentException> Class - 類別<br /><br /> <xref:System.ComponentModel.ISynchronizeInvoke.BeginInvoke%2A> 方法<br /><br /> <xref:System.ComponentModel.License> Class - 類別<br /><br /> <xref:System.ComponentModel.LicenseContext> Class - 類別<br /><br /> <xref:System.ComponentModel.LicenseException> Class - 類別<br /><br /> <xref:System.ComponentModel.LicenseManager> Class - 類別<br /><br /> <xref:System.ComponentModel.LicenseProvider> Class - 類別<br /><br /> <xref:System.ComponentModel.LicFileLicenseProvider> Class - 類別<br /><br /> <xref:System.ComponentModel.ListChangedEventArgs> Class - 類別<br /><br /> <xref:System.ComponentModel.ListChangedEventHandler> Delegate - 委派<br /><br /> <xref:System.ComponentModel.ListSortDescription> Class - 類別<br /><br /> <xref:System.ComponentModel.ListSortDescriptionCollection> Class - 類別<br /><br /> <xref:System.ComponentModel.MaskedTextProvider> Class - 類別<br /><br /> <xref:System.ComponentModel.MemberDescriptor> Class - 類別<br /><br /> <xref:System.ComponentModel.MultilineStringConverter> Class - 類別<br /><br /> <xref:System.ComponentModel.NestedContainer> Class - 類別<br /><br /> <xref:System.ComponentModel.NullableConverter> Class - 類別<br /><br /> <xref:System.ComponentModel.ProgressChangedEventArgs> Class - 類別<br /><br /> <xref:System.ComponentModel.ProgressChangedEventHandler> Delegate - 委派<br /><br /> <xref:System.ComponentModel.PropertyChangedEventArgs> Class - 類別<br /><br /> <xref:System.ComponentModel.PropertyChangedEventHandler> Delegate - 委派<br /><br /> <xref:System.ComponentModel.PropertyDescriptor> Class - 類別<br /><br /> <xref:System.ComponentModel.PropertyDescriptorCollection> Class - 類別<br /><br /> <xref:System.ComponentModel.ReferenceConverter> Class - 類別<br /><br /> <xref:System.ComponentModel.RefreshEventArgs> Class - 類別<br /><br /> <xref:System.ComponentModel.RefreshEventHandler> Delegate - 委派<br /><br /> <xref:System.ComponentModel.RunWorkerCompletedEventArgs> Class - 類別<br /><br /> <xref:System.ComponentModel.RunWorkerCompletedEventHandler> Delegate - 委派<br /><br /> <xref:System.ComponentModel.SByteConverter> Class - 類別<br /><br /> <xref:System.ComponentModel.SingleConverter> Class - 類別<br /><br /> <xref:System.ComponentModel.StringConverter> Class - 類別<br /><br /> <xref:System.ComponentModel.SyntaxCheck> Class - 類別<br /><br /> <xref:System.ComponentModel.TimeSpanConverter> Class - 類別<br /><br /> <xref:System.ComponentModel.TypeConverter> Class - 類別<br /><br /> <xref:System.ComponentModel.TypeDescriptionProvider> Class - 類別<br /><br /> <xref:System.ComponentModel.TypeDescriptor> Class - 類別<br /><br /> <xref:System.ComponentModel.TypeListConverter> Class - 類別<br /><br /> <xref:System.ComponentModel.UInt16Converter> Class - 類別<br /><br /> <xref:System.ComponentModel.UInt32Converter> Class - 類別<br /><br /> <xref:System.ComponentModel.UInt64Converter> Class - 類別<br /><br /> <xref:System.ComponentModel.WarningException> Class - 類別<br /><br /> <xref:System.ComponentModel.Win32Exception> Class - 類別|  
|`System.Diagnostics`|<xref:System.Diagnostics.Debug.Listeners%2A?displayProperty=nameWithType> 屬性<br /><br /> <xref:System.Diagnostics.Trace.Listeners%2A?displayProperty=nameWithType> 屬性<br /><br /> <xref:System.Diagnostics.EventLog.SynchronizingObject%2A?displayProperty=nameWithType> 屬性<br /><br /> <xref:System.Diagnostics.ConsoleTraceListener> Class - 類別<br /><br /> <xref:System.Diagnostics.DefaultTraceListener> Class - 類別<br /><br /> <xref:System.Diagnostics.DelimitedListTraceListener> Class - 類別<br /><br /> <xref:System.Diagnostics.EventLogTraceListener> Class - 類別<br /><br /> <xref:System.Diagnostics.PerformanceCounter> Class - 類別<br /><br /> <xref:System.Diagnostics.PerformanceCounterCategory> Class - 類別<br /><br /> <xref:System.Diagnostics.Process> Class - 類別<br /><br /> <xref:System.Diagnostics.ProcessStartInfo> Class - 類別<br /><br /> <xref:System.Diagnostics.TextWriterTraceListener> Class - 類別<br /><br /> <xref:System.Diagnostics.TraceListener> Class - 類別<br /><br /> <xref:System.Diagnostics.XmlWriterTraceListener> Class - 類別<br /><br /> <xref:System.Diagnostics.TraceSource.Listeners%2A?displayProperty=nameWithType> 屬性|  
|`System.IO`|<xref:System.IO.Stream.Synchronized%2A?displayProperty=nameWithType> 方法<br /><br /> <xref:System.IO.TextReader.Synchronized%2A?displayProperty=nameWithType> 方法<br /><br /> <xref:System.IO.TextWriter.Synchronized%2A?displayProperty=nameWithType> 方法|  
|`System.Reflection.Emit`|<xref:System.Reflection.Emit.ConstructorBuilder> Class - 類別<br /><br /> <xref:System.Reflection.Emit.EventBuilder> Class - 類別<br /><br /> <xref:System.Reflection.Emit.FieldBuilder> Class - 類別<br /><br /> <xref:System.Reflection.Emit.MethodBuilder> Class - 類別<br /><br /> <xref:System.Reflection.Emit.CustomAttributeBuilder> Class - 類別<br /><br /> <xref:System.Reflection.Emit.MethodRental> Class - 類別<br /><br /> <xref:System.Reflection.Emit.ModuleBuilder> Class - 類別<br /><br /> <xref:System.Reflection.Emit.PropertyBuilder> Class - 類別<br /><br /> <xref:System.Reflection.Emit.TypeBuilder> Class - 類別<br /><br /> <xref:System.Reflection.Emit.UnmanagedMarshal> Class - 類別|  
|`System.Text`|<xref:System.Text.RegularExpressions.Group.Synchronized%2A?displayProperty=nameWithType> 方法<br /><br /> <xref:System.Text.RegularExpressions.Match.Synchronized%2A?displayProperty=nameWithType> 方法|  
|`System.Threading`|<xref:System.Threading.AutoResetEvent> Class - 類別<br /><br /> <xref:System.Threading.EventWaitHandle> Class - 類別<br /><br /> <xref:System.Threading.ManualResetEvent> Class - 類別<br /><br /> <xref:System.Threading.Monitor> Class - 類別<br /><br /> <xref:System.Threading.Mutex> Class - 類別<br /><br /> <xref:System.Threading.ReaderWriterLock> Class - 類別<br /><br /> <xref:System.Threading.Semaphore> Class - 類別<br /><br /> <xref:System.Threading.Thread.AllocateNamedDataSlot%2A?displayProperty=nameWithType> 方法<br /><br /> <xref:System.Threading.Thread.BeginCriticalRegion%2A?displayProperty=nameWithType> 方法<br /><br /> <xref:System.Threading.Thread.EndCriticalRegion%2A?displayProperty=nameWithType> 方法<br /><br /> <xref:System.Threading.Thread.FreeNamedDataSlot%2A?displayProperty=nameWithType> 方法<br /><br /> <xref:System.Threading.Thread.GetData%2A?displayProperty=nameWithType> 方法<br /><br /> <xref:System.Threading.Thread.Join%2A?displayProperty=nameWithType> 方法<br /><br /> <xref:System.Threading.Thread.SetApartmentState%2A?displayProperty=nameWithType> 方法<br /><br /> <xref:System.Threading.Thread.SetData%2A?displayProperty=nameWithType> 方法<br /><br /> <xref:System.Threading.Thread.SpinWait%2A?displayProperty=nameWithType> 方法<br /><br /> <xref:System.Threading.Thread.Start%2A?displayProperty=nameWithType> 方法<br /><br /> <xref:System.Threading.Thread.TrySetApartmentState%2A?displayProperty=nameWithType> 方法<br /><br /> <xref:System.Threading.ThreadPool> Class - 類別<br /><br /> <xref:System.Threading.Timer> Class - 類別|  
|`System.Timers`|<xref:System.Timers.Timer> Class - 類別|  
|`System.Web.Configuration`|<xref:System.Web.Configuration.MachineKeyValidationConverter> Class - 類別|  
|`System.Windows.Forms`|<xref:System.Windows.Forms.AutoCompleteStringCollection.SyncRoot%2A?displayProperty=nameWithType> 屬性|  
  
## <a name="sql-server-permission-sets"></a>SQL Server 權限集合  
 SQL Server 可讓使用者針對部署到資料庫中的程式碼指定可靠性需求。 當組件上傳至資料庫時，組件作者可以指定三個權限集合的其中一個該組件：SAFE、 EXTERNAL-ACCESS 或 UNSAFE。  
  
|權限集合|SAFE|EXTERNAL-ACCESS|UNSAFE|  
|--------------------|----------|----------------------|------------|  
|程式碼存取安全性|僅限執行|執行 + 存取外部資源|無限制的|  
|程式設計模型限制|是|是|無限制|  
|可驗證性需求|是|是|否|  
|呼叫原生程式碼的能力|否|否|是|  
  
 SAFE 是最可靠且安全的模式，並且在允許的程式設計模型方面有相關限制。 SAFE 程式碼具有高可靠性和安全性功能。 SAFE 組件有足夠的權限來執行、執行計算，以及存取本機資料庫。 SAFE 組件必須是可驗證的型別安全，且不允許呼叫 Unmanaged 程式碼。  
  
 EXTERNAL-ACCESS 提供了中級安全性選項，允許程式碼存取資料庫之外的資源，但仍然保有 SAFE 的可靠性和安全性。  
  
 UNSAFE 適用於只能由資料庫管理員建立的高度信任程式碼。 此受信任的程式碼沒有程式碼存取限制，且可以呼叫 Unmanaged (原生) 程式碼。  
  
 SQL Server 使用主機層級程式碼存取安全性原則層來設定主機原則，根據儲存在 SQL Server 目錄的權限集合，授與三個權限集合的其中一個。 在資料庫內執行的 Managed 程式碼一律會取得這些程式碼存取權限集合的其中一個。  
  
## <a name="programming-model-restrictions"></a>程式設計模型限制  
 SQL Server 中的 Managed 程式碼程式設計模型需要的函式、程序和類型，不需要使用跨多個引動過程保留的狀態，或是在多個使用者工作階段之間共用狀態。 此外，如先前所述，共用狀態的存在可能會導致嚴重的例外狀況，影響應用程式的延展性和可靠性。  
  
 基於這些考量，SQL Server 不允許使用靜態變數和靜態資料成員。 對於 SAFE 及 EXTERNAL-ACCESS 組件，SQL Server 會在 CREATE ASSEMBLY 時，檢查組件的中繼資料，並且如果它找到使用靜態資料成員和變數，便讓這類組件的建立作業失敗。  
  
## <a name="see-also"></a>另請參閱

- <xref:System.Security.Permissions.HostProtectionAttribute>
- <xref:System.Security.Permissions.HostProtectionResource>
