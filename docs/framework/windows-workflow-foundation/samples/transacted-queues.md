---
title: 交易的佇列
ms.date: 03/30/2017
ms.assetid: b1b011dd-5e0b-482c-9bb0-9d8727038f14
ms.openlocfilehash: b125158a113079d87eb6926393d5a2b5fe326824
ms.sourcegitcommit: 3d5d33f384eeba41b2dff79d096f47ccc8d8f03d
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 05/04/2018
ms.locfileid: "33519677"
---
# <a name="transacted-queues"></a><span data-ttu-id="1e62c-102">交易的佇列</span><span class="sxs-lookup"><span data-stu-id="1e62c-102">Transacted Queues</span></span>
<span data-ttu-id="1e62c-103">這個範例示範如何整合佇列和交易中 Windows Workflow Foundation (WF) 來建立可靠和可擴充的服務。</span><span class="sxs-lookup"><span data-stu-id="1e62c-103">This sample shows how to integrate queues and transactions in Windows Workflow Foundation (WF) to create reliable and scalable services.</span></span> <span data-ttu-id="1e62c-104">A <!--zz <xref:System.Activities.TransactionScope>--> `System.Activities.TransactionScope`在用戶端工作流程中用於傳送訊息至佇列，以在交易使用<xref:System.ServiceModel.NetMsmqBinding>。</span><span class="sxs-lookup"><span data-stu-id="1e62c-104">A <!--zz <xref:System.Activities.TransactionScope>--> `System.Activities.TransactionScope` is used in the client workflow to send message to a queue under a transaction using the <xref:System.ServiceModel.NetMsmqBinding>.</span></span> <span data-ttu-id="1e62c-105">在伺服器上使用 <xref:System.ServiceModel.Activities.TransactedReceiveScope>，在相同交易下從佇列接收訊息並更新工作流程狀態。</span><span class="sxs-lookup"><span data-stu-id="1e62c-105">A <xref:System.ServiceModel.Activities.TransactedReceiveScope> is used on the server to receive messages from the queue and update the state of the workflow under the same transaction.</span></span>  
  
## <a name="demonstrates"></a><span data-ttu-id="1e62c-106">示範</span><span class="sxs-lookup"><span data-stu-id="1e62c-106">Demonstrates</span></span>  
 <span data-ttu-id="1e62c-107"><xref:System.Activities.Statements.TransactionScope>、<xref:System.ServiceModel.Activities.TransactedReceiveScope>、<xref:System.ServiceModel.NetMsmqBinding>、<xref:System.ServiceModel.Activities.Receive> 和內容架構的相互關聯</span><span class="sxs-lookup"><span data-stu-id="1e62c-107"><xref:System.Activities.Statements.TransactionScope>, <xref:System.ServiceModel.Activities.TransactedReceiveScope>, <xref:System.ServiceModel.NetMsmqBinding>, <xref:System.ServiceModel.Activities.Receive>, and content-based correlation.</span></span>  
  
## <a name="discussion"></a><span data-ttu-id="1e62c-108">討論</span><span class="sxs-lookup"><span data-stu-id="1e62c-108">Discussion</span></span>  
 <span data-ttu-id="1e62c-109">為了示範這個範例中涵蓋的功能，我們會建立 `RewardsPoints` 工作流程服務，追蹤給定帳戶所得到和使用的點數。</span><span class="sxs-lookup"><span data-stu-id="1e62c-109">To demonstrate the features covered in this sample, a `RewardsPoints` workflow service is created, which keeps track of the points earned and used for a given account.</span></span> <span data-ttu-id="1e62c-110">用戶端使用 <xref:System.Activities.WorkflowInvoker> 模擬公佈至佇列的各種要求。</span><span class="sxs-lookup"><span data-stu-id="1e62c-110">The client uses <xref:System.Activities.WorkflowInvoker> to simulate posting various requests to the queue.</span></span> <span data-ttu-id="1e62c-111">為了在交易下將訊息公佈至佇列，<xref:System.ServiceModel.Activities.Send> 活動可以置於 <xref:System.Activities.Statements.TransactionScope.Body%2A> 的 <xref:System.Activities.Statements.TransactionScope> 之中。</span><span class="sxs-lookup"><span data-stu-id="1e62c-111">To post a message to the queue under a transaction, the <xref:System.ServiceModel.Activities.Send> activity can be placed inside the <xref:System.Activities.Statements.TransactionScope.Body%2A> of a <xref:System.Activities.Statements.TransactionScope>.</span></span> <span data-ttu-id="1e62c-112">在這個範例中，先執行用戶端，接著執行伺服器，以示範佇列訊息如何分化用戶端和伺服器應用程式。</span><span class="sxs-lookup"><span data-stu-id="1e62c-112">In this sample, the client runs first, followed by the server, to demonstrate how queued messages can decouple the client and server applications.</span></span>  
  
 <span data-ttu-id="1e62c-113">一旦用戶端完成，就會設定及裝載服務。</span><span class="sxs-lookup"><span data-stu-id="1e62c-113">Once the client completes, the service is configured and hosted.</span></span> <span data-ttu-id="1e62c-114">一旦服務開啟，就會開始處理已經排入佇列中的訊息。</span><span class="sxs-lookup"><span data-stu-id="1e62c-114">As soon as it opens, it starts processing the messages that have already been placed in the queue.</span></span> <span data-ttu-id="1e62c-115">每個訊息都是在相同伺服器交易下接收及處理的。</span><span class="sxs-lookup"><span data-stu-id="1e62c-115">Each message is received and processed under the same server transaction.</span></span> <span data-ttu-id="1e62c-116">在這個範例中，第一個收到的訊息是 `CreateAccount` 要求，它會建立執行個體，並根據要求訊息中傳遞的帳戶名稱來初始化內容相互關聯。</span><span class="sxs-lookup"><span data-stu-id="1e62c-116">In this sample, the first message received is a `CreateAccount` request that creates the instance and initializes the content correlation based on the account name passed as part of the request message.</span></span> <span data-ttu-id="1e62c-117">以真實世界可預期的服務類型為模型，下列兩個處理 <xref:System.ServiceModel.Activities.TransactedReceiveScope> 和 `AddPoints` 訊息的 `UsePoints` 活動會放在 `while` 迴圈的平行分支中，以任何順序重複處理這些訊息。</span><span class="sxs-lookup"><span data-stu-id="1e62c-117">To model the kind of service you might expect in the real world, the following two <xref:System.ServiceModel.Activities.TransactedReceiveScope> activities that process the `AddPoints` and `UsePoints` messages are placed in parallel branches within a `while` loop so that they can process these messages repeatedly in any order.</span></span>  
  
 <span data-ttu-id="1e62c-118"><xref:System.Activities.Statements.TransactionScope> 和 <xref:System.ServiceModel.Activities.TransactedReceiveScope> 的範圍結尾都有隱含保存點，因此在 [!INCLUDE[wf1](../../../../includes/wf1-md.md)] 中使用這些活動結合佇列是將工作流程從某個一致狀態移至下一個狀態的可靠方式，同時可確保訊息永不遺失。</span><span class="sxs-lookup"><span data-stu-id="1e62c-118"><xref:System.Activities.Statements.TransactionScope> and <xref:System.ServiceModel.Activities.TransactedReceiveScope> each have an implicit persistence point at the end of their scopes, so using these activities in [!INCLUDE[wf1](../../../../includes/wf1-md.md)] combined with queues is a reliable way to move your workflow from one consistent state to the next, while ensuring that messages are never lost.</span></span>  
  
#### <a name="to-set-up-build-and-run-the-sample"></a><span data-ttu-id="1e62c-119">若要安裝、建置及執行範例</span><span class="sxs-lookup"><span data-stu-id="1e62c-119">To set up, build, and run the sample</span></span>  
  
1.  <span data-ttu-id="1e62c-120">安裝及設定 MSMQ。</span><span class="sxs-lookup"><span data-stu-id="1e62c-120">Install and configure MSMQ.</span></span> <span data-ttu-id="1e62c-121">請參閱[安裝訊息佇列](http://go.microsoft.com/fwlink/?LinkId=178526)如需詳細資訊。</span><span class="sxs-lookup"><span data-stu-id="1e62c-121">See [Installing Message Queuing](http://go.microsoft.com/fwlink/?LinkId=178526) for details.</span></span>  
  
2.  <span data-ttu-id="1e62c-122">在命令列中執行下列命令，以確認 MSDTC 正在執行中。</span><span class="sxs-lookup"><span data-stu-id="1e62c-122">Ensure that MSDTC is running by executing the following command on a command line.</span></span> `net start msdtc`  
  
3.  <span data-ttu-id="1e62c-123">編譯專案並開啟可執行檔，或在 [!INCLUDE[vs2010](../../../../includes/vs2010-md.md)] 中開啟專案，然後從偵錯功能表選取啟動選項。</span><span class="sxs-lookup"><span data-stu-id="1e62c-123">Compile the project and open the executable, or open the project in [!INCLUDE[vs2010](../../../../includes/vs2010-md.md)] and select a start option from the debug menu.</span></span> <span data-ttu-id="1e62c-124">首先會建立佇列，接著執行用戶端並將訊息公佈至佇列，最後會啟動服務並處理訊息。</span><span class="sxs-lookup"><span data-stu-id="1e62c-124">First, the queue is created, then the client runs and posts messages to the queue, and finally the service starts and the messages are processed.</span></span> <span data-ttu-id="1e62c-125">若要結束程式，請按 ENTER。</span><span class="sxs-lookup"><span data-stu-id="1e62c-125">To exit the program, press ENTER.</span></span>  
  
> [!IMPORTANT]
>  <span data-ttu-id="1e62c-126">這些範例可能已安裝在您的電腦上。</span><span class="sxs-lookup"><span data-stu-id="1e62c-126">The samples may already be installed on your machine.</span></span> <span data-ttu-id="1e62c-127">請先檢查下列 (預設) 目錄，然後再繼續。</span><span class="sxs-lookup"><span data-stu-id="1e62c-127">Check for the following (default) directory before continuing.</span></span>  
>   
>  `<InstallDrive>:\WF_WCF_Samples`  
>   
>  <span data-ttu-id="1e62c-128">如果此目錄不存在，請移至[Windows Communication Foundation (WCF) 和適用於.NET Framework 4 的 Windows Workflow Foundation (WF) 範例](http://go.microsoft.com/fwlink/?LinkId=150780)下載所有 Windows Communication Foundation (WCF) 和[!INCLUDE[wf1](../../../../includes/wf1-md.md)]範例。</span><span class="sxs-lookup"><span data-stu-id="1e62c-128">If this directory does not exist, go to [Windows Communication Foundation (WCF) and Windows Workflow Foundation (WF) Samples for .NET Framework 4](http://go.microsoft.com/fwlink/?LinkId=150780) to download all Windows Communication Foundation (WCF) and [!INCLUDE[wf1](../../../../includes/wf1-md.md)] samples.</span></span> <span data-ttu-id="1e62c-129">此範例位於下列目錄。</span><span class="sxs-lookup"><span data-stu-id="1e62c-129">This sample is located in the following directory.</span></span>  
>   
>  `<InstallDrive>:\WF_WCF_Samples\WF\Scenario\Transactions\TransactedQueues`
