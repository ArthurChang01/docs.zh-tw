---
title: 從流程中使用 OData 摘要
ms.date: 03/30/2017
ms.assetid: 1b26617c-53e9-476a-81af-675c36d95919
ms.openlocfilehash: a7e2a0658294681b154b11f48563ebc562c47210
ms.sourcegitcommit: 2eceb05f1a5bb261291a1f6a91c5153727ac1c19
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 09/04/2018
ms.locfileid: "43562476"
---
# <a name="consuming-odata-feeds-from-a-workflow"></a><span data-ttu-id="c452e-102">從流程中使用 OData 摘要</span><span class="sxs-lookup"><span data-stu-id="c452e-102">Consuming OData Feeds from a Workflow</span></span>

<span data-ttu-id="c452e-103">WCF 資料服務是 [!INCLUDE[dnprdnshort](../../../includes/dnprdnshort-md.md)] 的一個元件，可讓您建立使用 Open Data Protocol (OData) 的服務，利用具像狀態傳輸 (REST) 的語意透過 Web 或內部網路公開及取用資料。</span><span class="sxs-lookup"><span data-stu-id="c452e-103">WCF Data Services is a component of the [!INCLUDE[dnprdnshort](../../../includes/dnprdnshort-md.md)] that enables you to create services that use the Open Data Protocol (OData) to expose and consume data over the Web or intranet by using the semantics of representational state transfer (REST).</span></span> <span data-ttu-id="c452e-104">OData 會將資料公開為可由 URI 定址的資源。</span><span class="sxs-lookup"><span data-stu-id="c452e-104">OData exposes data as resources that are addressable by URIs.</span></span> <span data-ttu-id="c452e-105">任何可以傳送 HTTP 要求並處理資料服務傳回之 OData 摘要的應用程式，都可以與 OData 型資料服務互動。</span><span class="sxs-lookup"><span data-stu-id="c452e-105">Any application can interact with an OData-based data service if it can send an HTTP request and process the OData feed that a data service returns.</span></span> <span data-ttu-id="c452e-106">此外，WCF 資料服務也包含用戶端程式庫，在您從 [!INCLUDE[dnprdnshort](../../../includes/dnprdnshort-md.md)] 應用程式取用 OData 摘要時，可為您提供更豐富的程式設計體驗。</span><span class="sxs-lookup"><span data-stu-id="c452e-106">In addition, WCF Data Services includes client libraries that provide a richer programming experience when you consume OData feeds from [!INCLUDE[dnprdnshort](../../../includes/dnprdnshort-md.md)] applications.</span></span> <span data-ttu-id="c452e-107">本主題提供在工作流程中取用 OData 摘要的概觀 (不論有沒有使用用戶端程式庫)。</span><span class="sxs-lookup"><span data-stu-id="c452e-107">This topic provides an overview of consuming an OData feed in a workflow with and without using the client libraries.</span></span>

## <a name="using-the-sample-northwind-odata-service"></a><span data-ttu-id="c452e-108">使用範例 Northwind OData 服務</span><span class="sxs-lookup"><span data-stu-id="c452e-108">Using the Sample Northwind OData Service</span></span>

<span data-ttu-id="c452e-109">本主題中的範例使用的範例 Northwind 資料服務位於[ http://services.odata.org/Northwind/Northwind.svc/ ](https://go.microsoft.com/fwlink/?LinkID=187426)。</span><span class="sxs-lookup"><span data-stu-id="c452e-109">The examples in this topic use the sample Northwind data service located at [http://services.odata.org/Northwind/Northwind.svc/](https://go.microsoft.com/fwlink/?LinkID=187426).</span></span> <span data-ttu-id="c452e-110">這項服務提供做為一部分[OData SDK](https://go.microsoft.com/fwlink/?LinkID=185248) ，並提供範例 Northwind 資料庫的唯讀存取。</span><span class="sxs-lookup"><span data-stu-id="c452e-110">This service is provided as part of the [OData SDK](https://go.microsoft.com/fwlink/?LinkID=185248) and provides read-only access to the sample Northwind database.</span></span> <span data-ttu-id="c452e-111">如果寫入存取或者需要本機 WCF 資料服務，您可以遵循的步驟[WCF Data Services 快速入門](https://go.microsoft.com/fwlink/?LinkID=131076)建立本機 OData 服務來提供 Northwind 資料庫的存取權。</span><span class="sxs-lookup"><span data-stu-id="c452e-111">If write access is desired, or if a local WCF Data Service is desired, you can follow the steps of the [WCF Data Services Quickstart](https://go.microsoft.com/fwlink/?LinkID=131076) to create a local OData service that provides access to the Northwind database.</span></span> <span data-ttu-id="c452e-112">如果您遵循快速入門的步驟，請使用本機 URI 來替代本主題的範例程式碼所提供的 URI。</span><span class="sxs-lookup"><span data-stu-id="c452e-112">If you follow the quickstart, substitute the local URI for the one provided in the example code in this topic.</span></span>

## <a name="consuming-an-odata-feed-using-the-client-libraries"></a><span data-ttu-id="c452e-113">使用用戶端程式庫取用 OData 摘要</span><span class="sxs-lookup"><span data-stu-id="c452e-113">Consuming an OData Feed Using the Client Libraries</span></span>

<span data-ttu-id="c452e-114">WCF 資料服務包含用戶端程式庫，可讓您更輕鬆地從 [!INCLUDE[dnprdnshort](../../../includes/dnprdnshort-md.md)] 和用戶端應用程式取用 OData 摘要。</span><span class="sxs-lookup"><span data-stu-id="c452e-114">WCF Data Services includes client libraries that enable you to more easily consume an OData feed from [!INCLUDE[dnprdnshort](../../../includes/dnprdnshort-md.md)] and client applications.</span></span> <span data-ttu-id="c452e-115">這些程式庫會簡化 HTTP 訊息的傳送與接收。</span><span class="sxs-lookup"><span data-stu-id="c452e-115">These libraries simplify sending and receiving HTTP messages.</span></span> <span data-ttu-id="c452e-116">他們也會將訊息承載轉譯為代表實體資料的 CLR 物件。</span><span class="sxs-lookup"><span data-stu-id="c452e-116">They also translate the message payload into CLR objects that represent entity data.</span></span> <span data-ttu-id="c452e-117">用戶端程式庫具有兩個核心類別： <xref:System.Data.Services.Client.DataServiceContext> 和 <xref:System.Data.Services.Client.DataServiceQuery%601>。</span><span class="sxs-lookup"><span data-stu-id="c452e-117">The client libraries feature the two core classes <xref:System.Data.Services.Client.DataServiceContext> and <xref:System.Data.Services.Client.DataServiceQuery%601>.</span></span> <span data-ttu-id="c452e-118">這些類別可讓您查詢資料服務，然後使用傳回的實體資料當做 CLR 物件。</span><span class="sxs-lookup"><span data-stu-id="c452e-118">These classes enable you to query a data service and then work with the returned entity data as CLR objects.</span></span> <span data-ttu-id="c452e-119">本章節包含了建立活動來使用用戶端程式庫的兩個方法。</span><span class="sxs-lookup"><span data-stu-id="c452e-119">This section covers two approaches to creating activities that use the client libraries.</span></span>

### <a name="adding-a-service-reference-to-the-wcf-data-service"></a><span data-ttu-id="c452e-120">加入 WCF 資料服務的服務參考</span><span class="sxs-lookup"><span data-stu-id="c452e-120">Adding a Service Reference to the WCF Data Service</span></span>

<span data-ttu-id="c452e-121">若要產生 Northwind 用戶端程式庫，您可以使用 **中的 [** 加入服務參考 [!INCLUDE[vs_current_long](../../../includes/vs-current-long-md.md)] ] 對話方塊，加入 Northwind OData 服務的參考。</span><span class="sxs-lookup"><span data-stu-id="c452e-121">To generate the Northwind client libraries, you can use the **Add Service Reference** dialog box in [!INCLUDE[vs_current_long](../../../includes/vs-current-long-md.md)] to add a reference to the Northwind OData service.</span></span>

<span data-ttu-id="c452e-122">![加入服務參考](../../../docs/framework/windows-workflow-foundation/media/addservicereferencetonorthwindodataservice.gif "AddServiceReferencetoNorthwindODataService")</span><span class="sxs-lookup"><span data-stu-id="c452e-122">![Add Service Reference](../../../docs/framework/windows-workflow-foundation/media/addservicereferencetonorthwindodataservice.gif "AddServiceReferencetoNorthwindODataService")</span></span>

<span data-ttu-id="c452e-123">請注意，此服務不會公開任何服務作業，而且 [ **服務** ] 清單中有項目代表 Northwind 資料服務所公開的實體。</span><span class="sxs-lookup"><span data-stu-id="c452e-123">Note that there are no service operations exposed by the service, and in the **Services** list there are items representing the entities exposed by the Northwind data service.</span></span> <span data-ttu-id="c452e-124">當加入服務參考時，將會針對這些實體產生類別，而且這些類別可用於用戶端程式碼。</span><span class="sxs-lookup"><span data-stu-id="c452e-124">When the service reference is added, classes will be generated for these entities and they can be used in the client code.</span></span> <span data-ttu-id="c452e-125">本主題的範例會使用這些類別和 `NorthwindEntities` 類別來執行查詢。</span><span class="sxs-lookup"><span data-stu-id="c452e-125">The examples in this topic use these classes and the `NorthwindEntities` class to perform the queries.</span></span>

> [!NOTE]
> <span data-ttu-id="c452e-126">如需詳細資訊，請參閱 <<c0> [ 產生資料服務用戶端程式庫 (WCF Data Services)](https://go.microsoft.com/fwlink/?LinkID=191611)。</span><span class="sxs-lookup"><span data-stu-id="c452e-126">For more information, see [Generating the Data Service Client Library (WCF Data Services)](https://go.microsoft.com/fwlink/?LinkID=191611).</span></span>

### <a name="using-asynchronous-methods"></a><span data-ttu-id="c452e-127">使用非同步方法</span><span class="sxs-lookup"><span data-stu-id="c452e-127">Using Asynchronous Methods</span></span>

<span data-ttu-id="c452e-128">為了對付透過 Web 存取資源時可能發生的延遲問題，我們建議您以非同步方式存取 WCF 資料服務。</span><span class="sxs-lookup"><span data-stu-id="c452e-128">To address possible latency issues that may occur when accessing resources over the Web, we recommend accessing WCF Data Services asynchronously.</span></span> <span data-ttu-id="c452e-129">WCF Data Services 用戶端程式庫包含叫用查詢的非同步方法，並在 Windows Workflow Foundation (WF) 提供<xref:System.Activities.AsyncCodeActivity>類別來撰寫非同步活動。</span><span class="sxs-lookup"><span data-stu-id="c452e-129">The WCF Data Services client libraries include asynchronous methods for invoking queries, and Windows Workflow Foundation (WF) provides the <xref:System.Activities.AsyncCodeActivity> class for authoring asynchronous activities.</span></span> <span data-ttu-id="c452e-130">您可以撰寫<xref:System.Activities.AsyncCodeActivity> 衍生活動，以利用具有非同步方法的 [!INCLUDE[dnprdnshort](../../../includes/dnprdnshort-md.md)] 類別，或者可以將要非同步執行的程式碼放在方法中，然後使用委派來叫用此程式碼。</span><span class="sxs-lookup"><span data-stu-id="c452e-130"><xref:System.Activities.AsyncCodeActivity> derived activities can be written to take advantage of [!INCLUDE[dnprdnshort](../../../includes/dnprdnshort-md.md)] classes that have asynchronous methods, or the code to be executed asynchronously can be put into a method and invoked by using a delegate.</span></span> <span data-ttu-id="c452e-131">本章節提供 <xref:System.Activities.AsyncCodeActivity> 衍生活動的兩個範例，一個範例會使用 WCF 資料服務用戶端程式庫的非同步方法，另一個範例則使用委派。</span><span class="sxs-lookup"><span data-stu-id="c452e-131">This section provides two examples of an <xref:System.Activities.AsyncCodeActivity> derived activity; one that uses the asynchronous methods of the WCF Data Services client libraries and one that uses a delegate.</span></span>

> [!NOTE]
> <span data-ttu-id="c452e-132">如需詳細資訊，請參閱 <<c0> [ 非同步作業 (WCF Data Services)](https://go.microsoft.com/fwlink/?LinkId=193396)並[建立非同步活動](../../../docs/framework/windows-workflow-foundation/creating-asynchronous-activities-in-wf.md)。</span><span class="sxs-lookup"><span data-stu-id="c452e-132">For more information, see [Asynchronous Operations (WCF Data Services)](https://go.microsoft.com/fwlink/?LinkId=193396) and [Creating Asynchronous Activities](../../../docs/framework/windows-workflow-foundation/creating-asynchronous-activities-in-wf.md).</span></span>

### <a name="using-client-library-asynchronous-methods"></a><span data-ttu-id="c452e-133">使用用戶端程式庫非同步方法</span><span class="sxs-lookup"><span data-stu-id="c452e-133">Using Client Library Asynchronous Methods</span></span>

<span data-ttu-id="c452e-134"><xref:System.Data.Services.Client.DataServiceQuery%601> 類別會提供 <xref:System.Data.Services.Client.DataServiceQuery%601.BeginExecute%2A> 和 <xref:System.Data.Services.Client.DataServiceQuery%601.EndExecute%2A> 方法，以非同步方式查詢 OData 服務。</span><span class="sxs-lookup"><span data-stu-id="c452e-134">The <xref:System.Data.Services.Client.DataServiceQuery%601> class provides <xref:System.Data.Services.Client.DataServiceQuery%601.BeginExecute%2A> and <xref:System.Data.Services.Client.DataServiceQuery%601.EndExecute%2A> methods for querying an OData service asynchronously.</span></span> <span data-ttu-id="c452e-135">這些方法可以從 <xref:System.Activities.AsyncCodeActivity.BeginExecute%2A> 衍生類別的 <xref:System.Activities.AsyncCodeActivity.EndExecute%2A> 和 <xref:System.Activities.AsyncCodeActivity> 覆寫來呼叫。</span><span class="sxs-lookup"><span data-stu-id="c452e-135">These methods can be called from the <xref:System.Activities.AsyncCodeActivity.BeginExecute%2A> and <xref:System.Activities.AsyncCodeActivity.EndExecute%2A> overrides of an <xref:System.Activities.AsyncCodeActivity> derived class.</span></span> <span data-ttu-id="c452e-136">當 <xref:System.Activities.AsyncCodeActivity> <xref:System.Activities.AsyncCodeActivity.BeginExecute%2A> 覆寫傳回時，工作流程可以進入閒置狀態 (但不會持久)，而且當非同步工作完成時，執行階段會叫用 <xref:System.Activities.AsyncCodeActivity.EndExecute%2A> 。</span><span class="sxs-lookup"><span data-stu-id="c452e-136">When the <xref:System.Activities.AsyncCodeActivity> <xref:System.Activities.AsyncCodeActivity.BeginExecute%2A> override returns, the workflow can go idle (but not persist), and when the asynchronous work is completed, <xref:System.Activities.AsyncCodeActivity.EndExecute%2A> is invoked by the runtime.</span></span>

<span data-ttu-id="c452e-137">下列範例會定義具有兩個輸入引數的 `OrdersByCustomer` 活動。</span><span class="sxs-lookup"><span data-stu-id="c452e-137">In the following example, an `OrdersByCustomer` activity is defined that has two input arguments.</span></span> <span data-ttu-id="c452e-138">`CustomerId` 引數代表可識別要傳回哪些訂單的客戶，而 `ServiceUri` 引數則代表要查詢之 OData 服務的 URI。</span><span class="sxs-lookup"><span data-stu-id="c452e-138">The `CustomerId` argument represents the customer who identifies which orders to return, and the `ServiceUri` argument represents the URI of the OData service to be queried.</span></span> <span data-ttu-id="c452e-139">因為此活動衍生自 `AsyncCodeActivity<IEnumerable<Order>>` ，所以也會有一個 <xref:System.Activities.Activity%601.Result%2A> 輸出引數用來傳回查詢的結果。</span><span class="sxs-lookup"><span data-stu-id="c452e-139">Because the activity derives from `AsyncCodeActivity<IEnumerable<Order>>` there is also a <xref:System.Activities.Activity%601.Result%2A> output argument that is used to return the results of the query.</span></span> <span data-ttu-id="c452e-140"><xref:System.Activities.AsyncCodeActivity.BeginExecute%2A> 覆寫會建立一個 LINQ 查詢，此查詢會選取指定之客戶的所有訂單。</span><span class="sxs-lookup"><span data-stu-id="c452e-140">The <xref:System.Activities.AsyncCodeActivity.BeginExecute%2A> override creates a LINQ query that selects all orders of the specified customer.</span></span> <span data-ttu-id="c452e-141">這個查詢會指定為傳遞之 <xref:System.Activities.AsyncCodeActivityContext.UserState%2A> 的 <xref:System.Activities.AsyncCodeActivityContext>，然後會呼叫此查詢的 <xref:System.Data.Services.Client.DataServiceQuery%601.BeginExecute%2A> 方法。</span><span class="sxs-lookup"><span data-stu-id="c452e-141">This query is specified as the <xref:System.Activities.AsyncCodeActivityContext.UserState%2A> of the passed <xref:System.Activities.AsyncCodeActivityContext>, and then the query's <xref:System.Data.Services.Client.DataServiceQuery%601.BeginExecute%2A> method is called.</span></span> <span data-ttu-id="c452e-142">請注意，傳入查詢之 <xref:System.Data.Services.Client.DataServiceQuery%601.BeginExecute%2A> 中的回呼和狀態為傳入活動之 <xref:System.Activities.AsyncCodeActivity.BeginExecute%2A> 方法中的回呼和狀態。</span><span class="sxs-lookup"><span data-stu-id="c452e-142">Note that the callback and state that are passed into the query's <xref:System.Data.Services.Client.DataServiceQuery%601.BeginExecute%2A> are the ones that are passed in to the activity's <xref:System.Activities.AsyncCodeActivity.BeginExecute%2A> method.</span></span> <span data-ttu-id="c452e-143">當查詢執行完之後，就會叫用此活動的 <xref:System.Activities.AsyncCodeActivity.EndExecute%2A> 方法。</span><span class="sxs-lookup"><span data-stu-id="c452e-143">When the query has finished executing, the activity's <xref:System.Activities.AsyncCodeActivity.EndExecute%2A> method is invoked.</span></span> <span data-ttu-id="c452e-144">此查詢擷取自 <xref:System.Activities.AsyncCodeActivityContext.UserState%2A>，然後會呼叫此查詢的 <xref:System.Data.Services.Client.DataServiceQuery%601.EndExecute%2A> 方法。</span><span class="sxs-lookup"><span data-stu-id="c452e-144">The query is retrieved from the <xref:System.Activities.AsyncCodeActivityContext.UserState%2A>, and then the query's <xref:System.Data.Services.Client.DataServiceQuery%601.EndExecute%2A> method is called.</span></span> <span data-ttu-id="c452e-145">這個方法會傳回指定之實體型別的 <xref:System.Collections.Generic.IEnumerable%601> ，也就是此案例中的 `Order`。</span><span class="sxs-lookup"><span data-stu-id="c452e-145">This method returns an <xref:System.Collections.Generic.IEnumerable%601> of the specified entity type; in this case `Order`.</span></span> <span data-ttu-id="c452e-146">因為 `IEnumerable<Order>` 是 <xref:System.Activities.AsyncCodeActivity%601>的泛型型別，所以這個 `IEnumerable` 會設定為活動的 <xref:System.Activities.Activity%601.Result%2A> <xref:System.Activities.OutArgument%601> 。</span><span class="sxs-lookup"><span data-stu-id="c452e-146">Since `IEnumerable<Order>` is the generic type of the <xref:System.Activities.AsyncCodeActivity%601>, this `IEnumerable` is set as the <xref:System.Activities.Activity%601.Result%2A> <xref:System.Activities.OutArgument%601> of the activity.</span></span>

[!code-csharp[CFX_WCFDataServicesActivityExample#100](../../../samples/snippets/csharp/VS_Snippets_CFX/CFX_WCFDataServicesActivityExample/cs/Program.cs#100)]

<span data-ttu-id="c452e-147">在下列範例中， `OrdersByCustomer` 活動會擷取指定之客戶的訂單清單，然後 <xref:System.Activities.Statements.ForEach%601> 活動會列舉傳回的訂單，並將每一筆訂單的日期寫入主控台。</span><span class="sxs-lookup"><span data-stu-id="c452e-147">In the following example, the `OrdersByCustomer` activity retrieves a list of orders for the specified customer, and then a <xref:System.Activities.Statements.ForEach%601> activity enumerates the returned orders and writes the date of each order to the console.</span></span>

[!code-csharp[CFX_WCFDataServicesActivityExample#10](../../../samples/snippets/csharp/VS_Snippets_CFX/CFX_WCFDataServicesActivityExample/cs/Program.cs#10)]

<span data-ttu-id="c452e-148">當叫用這個工作流程時，下列資料會寫入主控台：</span><span class="sxs-lookup"><span data-stu-id="c452e-148">When this workflow is invoked, the following data is written to the console:</span></span>

```console
Calling WCF Data Service...
8/25/1997
10/3/1997
10/13/1997
1/15/1998
3/16/1998
4/9/1998
```

> [!NOTE]
> <span data-ttu-id="c452e-149">如果無法建立與 OData 伺服器之間的連接，您將會得到類似以下的例外狀況：</span><span class="sxs-lookup"><span data-stu-id="c452e-149">If a connection to the OData server cannot be established, you will get an exception similar to the following exception:</span></span>
>
> <span data-ttu-id="c452e-150">未處理的例外狀況: System.InvalidOperationException: 處理這個要求時發生錯誤。</span><span class="sxs-lookup"><span data-stu-id="c452e-150">Unhandled Exception: System.InvalidOperationException: An error occurred while processing this request.</span></span> <span data-ttu-id="c452e-151">---> System.Net.WebException: 無法連接至遠端伺服器 ---> System.Net.Sockets.SocketException: 連線嘗試失敗，因為連線對象有一段時間未正確回應，或是已建立的連線失敗，因為已連線的主機未回應。</span><span class="sxs-lookup"><span data-stu-id="c452e-151">---> System.Net.WebException: Unable to connect to the remote server ---> System.Net.Sockets.SocketException: A connection attempt failed because the connected party did not properly respond after a period of time, or established connection failed because connected host has failed to respond.</span></span>

<span data-ttu-id="c452e-152">如果需要額外處理此查詢所傳回的資料，則可以在活動的 <xref:System.Activities.AsyncCodeActivity%601.EndExecute%2A> 覆寫中完成。</span><span class="sxs-lookup"><span data-stu-id="c452e-152">If any additional processing of the data returned by the query is required, it can be done in the activity's <xref:System.Activities.AsyncCodeActivity%601.EndExecute%2A> override.</span></span> <span data-ttu-id="c452e-153"><xref:System.Activities.AsyncCodeActivity%601.BeginExecute%2A> 和 <xref:System.Activities.AsyncCodeActivity%601.EndExecute%2A> 都是使用工作流程執行緒來叫用，而且這些覆寫中的任何程式碼都不會以非同步方式執行。</span><span class="sxs-lookup"><span data-stu-id="c452e-153">Both <xref:System.Activities.AsyncCodeActivity%601.BeginExecute%2A> and <xref:System.Activities.AsyncCodeActivity%601.EndExecute%2A> are invoked by using the workflow thread, and any code in these overrides does not run asynchronously.</span></span> <span data-ttu-id="c452e-154">如果額外處理的工作過於密集或執行時間很長，或者查詢結果需分頁處理，您應該考慮使用下一節所討論的方法，該方法會使用委派來執行查詢，並以非同步方式執行額外處理工作。</span><span class="sxs-lookup"><span data-stu-id="c452e-154">If the additional processing is extensive or long-running, or the query results are paged, you should consider the approach discussed in the next section, which uses a delegate to execute the query and perform additional processing asynchronously.</span></span>

### <a name="using-a-delegate"></a><span data-ttu-id="c452e-155">使用委派</span><span class="sxs-lookup"><span data-stu-id="c452e-155">Using a Delegate</span></span>

<span data-ttu-id="c452e-156">除了叫用 [!INCLUDE[dnprdnshort](../../../includes/dnprdnshort-md.md)] 類別的非同步方法以外，以 <xref:System.Activities.AsyncCodeActivity>為基礎的活動也可以在它的其中一個方法內定義非同步邏輯。</span><span class="sxs-lookup"><span data-stu-id="c452e-156">In addition to invoking the asynchronous method of a [!INCLUDE[dnprdnshort](../../../includes/dnprdnshort-md.md)] class, an <xref:System.Activities.AsyncCodeActivity>-based activity can also define the asynchronous logic in one of its methods.</span></span> <span data-ttu-id="c452e-157">這個方法的指定方式是使用活動之 <xref:System.Activities.AsyncCodeActivity.BeginExecute%2A> 覆寫中的委派。</span><span class="sxs-lookup"><span data-stu-id="c452e-157">This method is specified by using a delegate in the activity's <xref:System.Activities.AsyncCodeActivity.BeginExecute%2A> override.</span></span> <span data-ttu-id="c452e-158">當此方法傳回時，執行階段會叫用此活動的 <xref:System.Activities.AsyncCodeActivity.EndExecute%2A> 覆寫。</span><span class="sxs-lookup"><span data-stu-id="c452e-158">When the method returns, the runtime invokes the activity's <xref:System.Activities.AsyncCodeActivity.EndExecute%2A> override.</span></span> <span data-ttu-id="c452e-159">從工作流程呼叫 OData 服務時，這個方法可用來查詢此服務，並提供任何額外的處理工作。</span><span class="sxs-lookup"><span data-stu-id="c452e-159">When calling an OData service from a workflow, this method can be used to query the service and provide any additional processing.</span></span>

<span data-ttu-id="c452e-160">在下列範例中，會定義 `ListCustomers` 活動。</span><span class="sxs-lookup"><span data-stu-id="c452e-160">In the following example, a `ListCustomers` activity is defined.</span></span> <span data-ttu-id="c452e-161">這個活動會查詢範例 Northwind 資料服務，並傳回 `List<Customer>` ，其中包含了 Northwind 資料庫中的所有客戶。</span><span class="sxs-lookup"><span data-stu-id="c452e-161">This activity queries the sample Northwind data service and returns a `List<Customer>` that contains all of the customers in the Northwind database.</span></span> <span data-ttu-id="c452e-162">非同步工作是由 `GetCustomers` 方法所執行。</span><span class="sxs-lookup"><span data-stu-id="c452e-162">The asynchronous work is performed by the `GetCustomers` method.</span></span> <span data-ttu-id="c452e-163">這個方法會查詢此服務中的所有客戶，然後將這些客戶複製到 `List<Customer>`。</span><span class="sxs-lookup"><span data-stu-id="c452e-163">This method queries the service for all customers, and then copies them into a `List<Customer>`.</span></span> <span data-ttu-id="c452e-164">接著它會檢查結果是否分頁。</span><span class="sxs-lookup"><span data-stu-id="c452e-164">It then checks to see if the results are paged.</span></span> <span data-ttu-id="c452e-165">如果是的話，它會查詢此服務中的下一頁結果、將這些結果加入至清單中，並繼續進行，直到擷取所有客戶資料為止。</span><span class="sxs-lookup"><span data-stu-id="c452e-165">If so, it queries the service for the next page of results, adds them to the list, and continues until all of the customer data has been retrieved.</span></span>

> [!NOTE]
> <span data-ttu-id="c452e-166">如需有關 WCF Data Services 中的分頁的詳細資訊，請參閱。</span><span class="sxs-lookup"><span data-stu-id="c452e-166">For more information about paging in WCF Data Services, see .</span></span> <span data-ttu-id="c452e-167">[如何： 載入分頁結果 (WCF Data Services)](https://go.microsoft.com/fwlink/?LinkId=193452)。</span><span class="sxs-lookup"><span data-stu-id="c452e-167">[How to: Load Paged Results (WCF Data Services)](https://go.microsoft.com/fwlink/?LinkId=193452).</span></span>

<span data-ttu-id="c452e-168">一旦加入所有客戶之後，就會傳回清單。</span><span class="sxs-lookup"><span data-stu-id="c452e-168">Once all customers are added, the list is returned.</span></span> <span data-ttu-id="c452e-169">`GetCustomers` 方法會指定於活動的 <xref:System.Activities.AsyncCodeActivity.BeginExecute%2A> 覆寫中。</span><span class="sxs-lookup"><span data-stu-id="c452e-169">The `GetCustomers` method is specified in the activity's <xref:System.Activities.AsyncCodeActivity.BeginExecute%2A> override.</span></span> <span data-ttu-id="c452e-170">因為此方法具有傳回值，所以會建立 `Func<string, List<Customer>>` 來指定此方法。</span><span class="sxs-lookup"><span data-stu-id="c452e-170">Since the method has a return value, a `Func<string, List<Customer>>` is created to specify the method.</span></span>

> [!NOTE]
> <span data-ttu-id="c452e-171">如果執行非同步工作的方法沒有傳回值，則會使用 <xref:System.Action> 而非 <!--zz <xref:System.Func> --> `System.Func`。</span><span class="sxs-lookup"><span data-stu-id="c452e-171">If the method that performs the asynchronous work does not have a return value, an <xref:System.Action> is used instead of a <!--zz <xref:System.Func> --> `System.Func`.</span></span> <span data-ttu-id="c452e-172">如需建立使用這兩種方法的非同步範例的範例，請參閱[建立非同步活動](../../../docs/framework/windows-workflow-foundation/creating-asynchronous-activities-in-wf.md)。</span><span class="sxs-lookup"><span data-stu-id="c452e-172">For examples of creating an asynchronous example using both approaches, see [Creating Asynchronous Activities](../../../docs/framework/windows-workflow-foundation/creating-asynchronous-activities-in-wf.md).</span></span>

<span data-ttu-id="c452e-173">這個 <!--zz <xref:System.Func> --> `System.Func` 會指派給 <xref:System.Activities.AsyncCodeActivityContext.UserState%2A>，然後呼叫 `BeginInvoke` 。</span><span class="sxs-lookup"><span data-stu-id="c452e-173">This <!--zz <xref:System.Func> --> `System.Func` is assigned to the <xref:System.Activities.AsyncCodeActivityContext.UserState%2A>, and then `BeginInvoke` is called.</span></span> <span data-ttu-id="c452e-174">因為要叫用的方法無法存取此活動的引數環境，所以 `ServiceUri` 引數的值會當做第一個參數來傳遞，連同之前傳入 <xref:System.Activities.AsyncCodeActivity.BeginExecute%2A>中的回呼和狀態。</span><span class="sxs-lookup"><span data-stu-id="c452e-174">Since the method to be invoked does not have access to the activity's environment of arguments, the value of the `ServiceUri` argument is passed as the first parameter, together with the callback and state that were passed into <xref:System.Activities.AsyncCodeActivity.BeginExecute%2A>.</span></span> <span data-ttu-id="c452e-175">當 `GetCustomers` 傳回時，執行階段會叫用 <xref:System.Activities.AsyncCodeActivity.EndExecute%2A>。</span><span class="sxs-lookup"><span data-stu-id="c452e-175">When `GetCustomers` returns, the runtime invokes <xref:System.Activities.AsyncCodeActivity.EndExecute%2A>.</span></span> <span data-ttu-id="c452e-176"><xref:System.Activities.AsyncCodeActivity.EndExecute%2A> 中的程式碼會從 <xref:System.Activities.AsyncCodeActivityContext.UserState%2A>擷取委派、呼叫 `EndInvoke`並傳回結果，也就是從 `GetCustomers` 方法傳回的客戶清單。</span><span class="sxs-lookup"><span data-stu-id="c452e-176">The code in <xref:System.Activities.AsyncCodeActivity.EndExecute%2A> retrieves the delegate from the <xref:System.Activities.AsyncCodeActivityContext.UserState%2A>, calls `EndInvoke`, and returns the result, which is the list of customers returned from the `GetCustomers` method.</span></span>

[!code-csharp[CFX_WCFDataServicesActivityExample#200](../../../samples/snippets/csharp/VS_Snippets_CFX/CFX_WCFDataServicesActivityExample/cs/Program.cs#200)]

<span data-ttu-id="c452e-177">在下列範例中， `ListCustomers` 活動會擷取客戶清單，然後 <xref:System.Activities.Statements.ForEach%601> 活動會列舉這些客戶，並將每一位客戶的公司名稱和連絡人名稱寫入主控台。</span><span class="sxs-lookup"><span data-stu-id="c452e-177">In the following example, the `ListCustomers` activity retrieves a list of customers, and then a <xref:System.Activities.Statements.ForEach%601> activity enumerates them and writes the company name and contact name of each customer to the console.</span></span>

[!code-csharp[CFX_WCFDataServicesActivityExample#20](../../../samples/snippets/csharp/VS_Snippets_CFX/CFX_WCFDataServicesActivityExample/cs/Program.cs#20)]

<span data-ttu-id="c452e-178">當叫用這個工作流程時，下列資料會寫入主控台。</span><span class="sxs-lookup"><span data-stu-id="c452e-178">When this workflow is invoked, the following data is written to the console.</span></span> <span data-ttu-id="c452e-179">這個查詢會傳回許多客戶，所以這裡只顯示一部分的輸出。</span><span class="sxs-lookup"><span data-stu-id="c452e-179">Since this query returns many customers, only part of the output is displayed here.</span></span>

```console
Calling WCF Data Service...
Alfreds Futterkiste, Contact: Maria Anders
Ana Trujillo Emparedados y helados, Contact: Ana Trujillo
Antonio Moreno Taquería, Contact: Antonio Moreno
Around the Horn, Contact: Thomas Hardy
Berglunds snabbköp, Contact: Christina Berglund
...
```

## <a name="consuming-an-odata-feed-without-using-the-client-libraries"></a><span data-ttu-id="c452e-180">取用 OData 摘要而不使用用戶端程式庫</span><span class="sxs-lookup"><span data-stu-id="c452e-180">Consuming an OData Feed Without Using the Client Libraries</span></span>

<span data-ttu-id="c452e-181">OData 會將資料公開為可由 URI 定址的資源。</span><span class="sxs-lookup"><span data-stu-id="c452e-181">OData exposes data as resources that are addressable by URIs.</span></span> <span data-ttu-id="c452e-182">當您使用用戶端程式庫時，將會為您建立這些 URI，但是您不必使用用戶端程式庫。</span><span class="sxs-lookup"><span data-stu-id="c452e-182">When you use the client libraries these URIs are created for you, but you do not have to use the client libraries.</span></span> <span data-ttu-id="c452e-183">您可以視需要直接存取 OData 服務，而不使用用戶端程式庫。</span><span class="sxs-lookup"><span data-stu-id="c452e-183">If desired, OData services can be accessed directly without using the client libraries.</span></span> <span data-ttu-id="c452e-184">當您未使用用戶端程式庫時，此服務的位置和所需的資料會由 URI 所指定，而且會傳回結果來回應 HTTP 要求。</span><span class="sxs-lookup"><span data-stu-id="c452e-184">When not using the client libraries the location of the service and the desired data are specified by the URI and the results are returned in the response to the HTTP request.</span></span> <span data-ttu-id="c452e-185">然後可以依照所需的方式來處理或操作這些未經處理資料。</span><span class="sxs-lookup"><span data-stu-id="c452e-185">This raw data can then be processed or manipulated in the desired manner.</span></span> <span data-ttu-id="c452e-186">擷取 OData 查詢結果的一個方式就是使用 <xref:System.Net.WebClient> 類別。</span><span class="sxs-lookup"><span data-stu-id="c452e-186">One way to retrieve the results of an OData query is by using the <xref:System.Net.WebClient> class.</span></span> <span data-ttu-id="c452e-187">在這個範例中，將會擷取以索引鍵 ALFKI 代表之客戶的連絡人名稱。</span><span class="sxs-lookup"><span data-stu-id="c452e-187">In this example, the contact name for the customer represented by the key ALFKI is retrieved.</span></span>

[!code-csharp[CFX_WCFDataServicesActivityExample#2](../../../samples/snippets/csharp/VS_Snippets_CFX/CFX_WCFDataServicesActivityExample/cs/Program.cs#2)]

<span data-ttu-id="c452e-188">當執行這段程式碼時，主控台會顯示下列輸出：</span><span class="sxs-lookup"><span data-stu-id="c452e-188">When this code is run, the following output is displayed to the console:</span></span>

```console
Raw data returned:
<?xml version="1.0" encoding="utf-8" standalone="yes"?> 
<ContactName xmlns="http://schemas.microsoft.com/ado/2007/08/dataservices">Maria Anders</ContactName>
```

<span data-ttu-id="c452e-189">在工作流程中，這個範例中的程式碼可能會併入 <xref:System.Activities.CodeActivity.Execute%2A> 型自訂活動的 <xref:System.Activities.CodeActivity> 覆寫中，但是也可以使用 <xref:System.Activities.Expressions.InvokeMethod%601> 活動來達到相同的功能。</span><span class="sxs-lookup"><span data-stu-id="c452e-189">In a workflow, the code from this example could be incorporated into the <xref:System.Activities.CodeActivity.Execute%2A> override of a <xref:System.Activities.CodeActivity>-based custom activity, but the same functionality can also be accomplished by using the <xref:System.Activities.Expressions.InvokeMethod%601> activity.</span></span> <span data-ttu-id="c452e-190"><xref:System.Activities.Expressions.InvokeMethod%601> 活動會讓工作流程作者叫用類別的靜態和執行個體方法，也可以選擇非同步叫用指定的方法。</span><span class="sxs-lookup"><span data-stu-id="c452e-190">The <xref:System.Activities.Expressions.InvokeMethod%601> activity enables workflow authors to invoke static and instance methods of a class, and also has an option to invoke the specified method asynchronously.</span></span> <span data-ttu-id="c452e-191">下列範例會設定 <xref:System.Activities.Expressions.InvokeMethod%601> 活動來呼叫 <xref:System.Net.WebClient.DownloadString%2A> 類別的 <xref:System.Net.WebClient> 方法，並傳回客戶清單。</span><span class="sxs-lookup"><span data-stu-id="c452e-191">In the following example, an <xref:System.Activities.Expressions.InvokeMethod%601> activity is configured to call the <xref:System.Net.WebClient.DownloadString%2A> method of the <xref:System.Net.WebClient> class and return a list of customers.</span></span>

[!code-csharp[CFX_WCFDataServicesActivityExample#3](../../../samples/snippets/csharp/VS_Snippets_CFX/CFX_WCFDataServicesActivityExample/cs/Program.cs#3)]

<span data-ttu-id="c452e-192"><xref:System.Activities.Expressions.InvokeMethod%601> 可以同時呼叫某個類別的靜態與執行個體方法。</span><span class="sxs-lookup"><span data-stu-id="c452e-192"><xref:System.Activities.Expressions.InvokeMethod%601> can call both static and instance methods of a class.</span></span> <span data-ttu-id="c452e-193">由於 <xref:System.Net.WebClient.DownloadString%2A> 是 <xref:System.Net.WebClient> 類別的執行個體方法，因此會為 <xref:System.Net.WebClient> 指定 <xref:System.Activities.Expressions.InvokeMethod%601.TargetObject%2A>類別的新執行個體。</span><span class="sxs-lookup"><span data-stu-id="c452e-193">Since <xref:System.Net.WebClient.DownloadString%2A> is an instance method of the <xref:System.Net.WebClient> class, a new instance of the <xref:System.Net.WebClient> class is specified for the <xref:System.Activities.Expressions.InvokeMethod%601.TargetObject%2A>.</span></span> <span data-ttu-id="c452e-194">`DownloadString` 會被指定為 <xref:System.Activities.Expressions.InvokeMethod%601.MethodName%2A>、包含查詢的 URI 指定在 <xref:System.Activities.Expressions.InvokeMethod%601.Parameters%2A> 集合中，而傳回值會指派給 <xref:System.Activities.Activity%601.Result%2A> 值。</span><span class="sxs-lookup"><span data-stu-id="c452e-194">`DownloadString` is specified as the <xref:System.Activities.Expressions.InvokeMethod%601.MethodName%2A>, the URI that contains the query is specified in the <xref:System.Activities.Expressions.InvokeMethod%601.Parameters%2A> collection, and the return value is assigned to the <xref:System.Activities.Activity%601.Result%2A> value.</span></span> <span data-ttu-id="c452e-195"><xref:System.Activities.Expressions.InvokeMethod%601.RunAsynchronously%2A> 值會設定為 `true`，這表示方法引動過程將會以非同步方式執行 (與工作流程有關)。</span><span class="sxs-lookup"><span data-stu-id="c452e-195">The <xref:System.Activities.Expressions.InvokeMethod%601.RunAsynchronously%2A> value is set to `true`, which means that the method invocation will run asynchronously with regard to the workflow.</span></span> <span data-ttu-id="c452e-196">下列範例會建構使用 <xref:System.Activities.Expressions.InvokeMethod%601> 活動的工作流程來查詢範例 Northwind 資料服務，以找出特定客戶的訂單清單，然後將傳回的資料寫入主控台。</span><span class="sxs-lookup"><span data-stu-id="c452e-196">In the following example, a workflow is constructed that uses the <xref:System.Activities.Expressions.InvokeMethod%601> activity to query the sample Northwind data service for a list of orders for a specific customer, and then the returned data is written to the console.</span></span>

[!code-csharp[CFX_WCFDataServicesActivityExample#1](../../../samples/snippets/csharp/VS_Snippets_CFX/CFX_WCFDataServicesActivityExample/cs/Program.cs#1)]

<span data-ttu-id="c452e-197">當叫用這個工作流程時，主控台就會顯示下列輸出。</span><span class="sxs-lookup"><span data-stu-id="c452e-197">When this workflow is invoked, the following output is displayed to the console.</span></span> <span data-ttu-id="c452e-198">這個查詢會傳回多筆訂單，所以這裡只顯示一部分的輸出。</span><span class="sxs-lookup"><span data-stu-id="c452e-198">Since this query returns several orders, only part of the output is displayed here.</span></span>

```console
Calling WCF Data Service...
Raw data returned:

<?xml version="1.0" encoding="utf-8" standalone="yes"?>*
<feed
xml:base="http://services.odata.org/Northwind/Northwind.svc/"
xmlns:d="http://schemas.microsoft.com/ado/2007/08/dataservices"
xmlns:m="http://schemas.microsoft.com/ado/2007/08/dataservices/metadata"
xmlns="http://www.w3.org/2005/Atom">
<title type="text">Orders\</title>
<id>http://services.odata.org/Northwind/Northwind.svc/Customers('ALFKI')/Orders\</id>
<updated>2010-05-19T19:37:07Z\</updated>
<link rel="self" title="Orders" href="Orders" />
<entry>
<id>http://services.odata.org/Northwind/Northwind.svc/Orders(10643)\</id>
<title type="text">\</title>
<updated>2010-05-19T19:37:07Z\</updated>
<author>
<name />
</author>
<link rel="edit" title="Order" href="Orders(10643)" />
<link rel="http://schemas.microsoft.com/ado/2007/08/dataservices/related/Customer" type="application/atom+xml;type=entry" title="Customer" href="Orders(10643)/Customer" />
...
```

<span data-ttu-id="c452e-199">此範例提供一種方法，可讓工作流程應用程式作者耗用從 OData 服務傳回的原始資料。</span><span class="sxs-lookup"><span data-stu-id="c452e-199">This example provides one method that workflow application authors can use to consume the raw data returned from an OData service.</span></span> <span data-ttu-id="c452e-200">如需有關如何使用存取 WCF 資料服務 Uri 的詳細資訊，請參閱 <<c0> [ 存取資料服務資源 (WCF Data Services)](https://go.microsoft.com/fwlink/?LinkId=193397)並[OData: URI 慣例](https://go.microsoft.com/fwlink/?LinkId=185564)。</span><span class="sxs-lookup"><span data-stu-id="c452e-200">For more information about accessing WCF Data Services using URIs, see [Accessing Data Service Resources (WCF Data Services)](https://go.microsoft.com/fwlink/?LinkId=193397) and [OData: URI Conventions](https://go.microsoft.com/fwlink/?LinkId=185564).</span></span>
