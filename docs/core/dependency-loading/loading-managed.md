---
title: Managed 元件載入演算法-.NET Core
description: .NET Core 中 managed 元件載入演算法的詳細資料描述
ms.date: 08/09/2019
author: sdmaclea
ms.author: stmaclea
ms.openlocfilehash: 312a320676be6eb453697e0704ab771a6707618b
ms.sourcegitcommit: f348c84443380a1959294cdf12babcb804cfa987
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 11/12/2019
ms.locfileid: "73973505"
---
# <a name="managed-assembly-loading-algorithm"></a><span data-ttu-id="71d51-103">Managed 元件載入演算法</span><span class="sxs-lookup"><span data-stu-id="71d51-103">Managed assembly loading algorithm</span></span>

<span data-ttu-id="71d51-104">受控元件會以包含各種階段的演算法來找出並載入。</span><span class="sxs-lookup"><span data-stu-id="71d51-104">Managed assemblies are located and loaded with an algorithm involving various stages.</span></span>

<span data-ttu-id="71d51-105">除了附屬元件和 `WinRT` 元件以外的所有 managed 元件都會使用相同的演算法。</span><span class="sxs-lookup"><span data-stu-id="71d51-105">All managed assemblies except satellite assemblies and `WinRT` assemblies use the same algorithm.</span></span>

## <a name="when-are-managed-assemblies-loaded"></a><span data-ttu-id="71d51-106">載入 managed 元件的時間為何？</span><span class="sxs-lookup"><span data-stu-id="71d51-106">When are managed assemblies loaded?</span></span>

<span data-ttu-id="71d51-107">觸發 managed 元件載入最常見的機制是靜態元件參考。</span><span class="sxs-lookup"><span data-stu-id="71d51-107">The most common mechanism to trigger a managed assembly load is a static assembly reference.</span></span> <span data-ttu-id="71d51-108">每當程式碼使用另一個元件中所定義的型別時，編譯器就會插入這些參考。</span><span class="sxs-lookup"><span data-stu-id="71d51-108">These references are inserted by the compiler whenever code uses a type defined in another assembly.</span></span> <span data-ttu-id="71d51-109">這些元件是執行時間所需的載入（`load-by-name`）。</span><span class="sxs-lookup"><span data-stu-id="71d51-109">These assemblies are loaded (`load-by-name`) as needed by the runtime.</span></span>

<span data-ttu-id="71d51-110">直接使用特定 Api 也會觸發負載：</span><span class="sxs-lookup"><span data-stu-id="71d51-110">The direct use of specific APIs will also trigger loads:</span></span>

|<span data-ttu-id="71d51-111">API</span><span class="sxs-lookup"><span data-stu-id="71d51-111">API</span></span>  |<span data-ttu-id="71d51-112">描述</span><span class="sxs-lookup"><span data-stu-id="71d51-112">Description</span></span>  |<span data-ttu-id="71d51-113">`Active` <xref:System.Runtime.Loader.AssemblyLoadContext></span><span class="sxs-lookup"><span data-stu-id="71d51-113">`Active` <xref:System.Runtime.Loader.AssemblyLoadContext></span></span> |
|---------|---------|---------|
|<xref:System.Runtime.Loader.AssemblyLoadContext.LoadFromAssemblyName%2A?displayProperty=nameWithType>|`Load-by-name`|<span data-ttu-id="71d51-114">[這個](../../csharp/language-reference/keywords/this.md)實例。</span><span class="sxs-lookup"><span data-stu-id="71d51-114">The [this](../../csharp/language-reference/keywords/this.md) instance.</span></span>|
|<xref:System.Runtime.Loader.AssemblyLoadContext.LoadFromAssemblyPath%2A?displayProperty=nameWithType><p><xref:System.Runtime.Loader.AssemblyLoadContext.LoadFromNativeImagePath%2A?displayProperty=nameWithType>|<span data-ttu-id="71d51-115">從路徑載入。</span><span class="sxs-lookup"><span data-stu-id="71d51-115">Load from path.</span></span>|<span data-ttu-id="71d51-116">[這個](../../csharp/language-reference/keywords/this.md)實例。</span><span class="sxs-lookup"><span data-stu-id="71d51-116">The [this](../../csharp/language-reference/keywords/this.md) instance.</span></span>|
<xref:System.Runtime.Loader.AssemblyLoadContext.LoadFromStream%2A?displayProperty=nameWithType>|<span data-ttu-id="71d51-117">從物件載入。</span><span class="sxs-lookup"><span data-stu-id="71d51-117">Load from object.</span></span>|<span data-ttu-id="71d51-118">[這個](../../csharp/language-reference/keywords/this.md)實例。</span><span class="sxs-lookup"><span data-stu-id="71d51-118">The [this](../../csharp/language-reference/keywords/this.md) instance.</span></span>|
|<xref:System.Reflection.Assembly.LoadFile%2A?displayProperty=nameWithType>|<span data-ttu-id="71d51-119">從新的 <xref:System.Runtime.Loader.AssemblyLoadContext> 實例中的路徑載入</span><span class="sxs-lookup"><span data-stu-id="71d51-119">Load from path in a new <xref:System.Runtime.Loader.AssemblyLoadContext> instance</span></span>|<span data-ttu-id="71d51-120">新 <xref:System.Runtime.Loader.AssemblyLoadContext> 執行個體。</span><span class="sxs-lookup"><span data-stu-id="71d51-120">The new <xref:System.Runtime.Loader.AssemblyLoadContext> instance.</span></span>|
<xref:System.Reflection.Assembly.LoadFrom%2A?displayProperty=nameWithType>|<span data-ttu-id="71d51-121">從 <xref:System.Runtime.Loader.AssemblyLoadContext.Default%2A?displayProperty=nameWithType> 實例中的路徑載入。</span><span class="sxs-lookup"><span data-stu-id="71d51-121">Load from path in the <xref:System.Runtime.Loader.AssemblyLoadContext.Default%2A?displayProperty=nameWithType> instance.</span></span><p><span data-ttu-id="71d51-122">將 <xref:System.Runtime.Loader.AssemblyLoadContext.Resolving> 處理常式加入 <xref:System.Runtime.Loader.AssemblyLoadContext.Default%2A?displayProperty=nameWithType>。</span><span class="sxs-lookup"><span data-stu-id="71d51-122">Adds a <xref:System.Runtime.Loader.AssemblyLoadContext.Resolving> handler to <xref:System.Runtime.Loader.AssemblyLoadContext.Default%2A?displayProperty=nameWithType>.</span></span> <span data-ttu-id="71d51-123">處理常式會從其目錄載入元件的相依性。</span><span class="sxs-lookup"><span data-stu-id="71d51-123">The handler will load the assembly's dependencies from its directory.</span></span>|<span data-ttu-id="71d51-124"><xref:System.Runtime.Loader.AssemblyLoadContext.Default%2A?displayProperty=nameWithType> 執行個體。</span><span class="sxs-lookup"><span data-stu-id="71d51-124">The <xref:System.Runtime.Loader.AssemblyLoadContext.Default%2A?displayProperty=nameWithType> instance.</span></span>|
|<xref:System.Reflection.Assembly.Load(System.Reflection.AssemblyName)?displayProperty=nameWithType><p><xref:System.Reflection.Assembly.Load(System.String)?displayProperty=nameWithType><p><xref:System.Reflection.Assembly.LoadWithPartialName%2A?displayProperty=nameWithType>|<span data-ttu-id="71d51-125">`Load-by-name`</span><span class="sxs-lookup"><span data-stu-id="71d51-125">`Load-by-name`.</span></span>|<span data-ttu-id="71d51-126">從呼叫者推斷。</span><span class="sxs-lookup"><span data-stu-id="71d51-126">Inferred from caller.</span></span><p><span data-ttu-id="71d51-127">偏好 <xref:System.Runtime.Loader.AssemblyLoadContext> 方法。</span><span class="sxs-lookup"><span data-stu-id="71d51-127">Prefer <xref:System.Runtime.Loader.AssemblyLoadContext> methods.</span></span>|
|<xref:System.Reflection.Assembly.Load(System.Byte[])?displayProperty=nameWithType><p><xref:System.Reflection.Assembly.Load(System.Byte[],System.Byte[])?displayProperty=nameWithType>|<span data-ttu-id="71d51-128">從新的 <xref:System.Runtime.Loader.AssemblyLoadContext> 實例中的物件載入。</span><span class="sxs-lookup"><span data-stu-id="71d51-128">Load from object in a new <xref:System.Runtime.Loader.AssemblyLoadContext> instance.</span></span>|<span data-ttu-id="71d51-129">新 <xref:System.Runtime.Loader.AssemblyLoadContext> 執行個體。</span><span class="sxs-lookup"><span data-stu-id="71d51-129">The new <xref:System.Runtime.Loader.AssemblyLoadContext> instance.</span></span>|
<xref:System.Type.GetType(System.String)?displayProperty=nameWithType><p><xref:System.Type.GetType(System.String,System.Boolean)?displayProperty=nameWithType><p><xref:System.Type.GetType(System.String,System.Boolean,System.Boolean)?displayProperty=nameWithType>|<span data-ttu-id="71d51-130">`Load-by-name`</span><span class="sxs-lookup"><span data-stu-id="71d51-130">`Load-by-name`.</span></span>|<span data-ttu-id="71d51-131">從呼叫者推斷。</span><span class="sxs-lookup"><span data-stu-id="71d51-131">Inferred from caller.</span></span><p><span data-ttu-id="71d51-132">偏好 <xref:System.Type.GetType%2A?displayProperty=nameWithType> 具有 `assemblyResolver` 引數的方法。</span><span class="sxs-lookup"><span data-stu-id="71d51-132">Prefer <xref:System.Type.GetType%2A?displayProperty=nameWithType> methods with an `assemblyResolver` argument.</span></span>|
<xref:System.Reflection.Assembly.GetType%2A?displayProperty=nameWithType>|<span data-ttu-id="71d51-133">如果類型 `name` 描述元件限定的泛型型別，則觸發 `Load-by-name`。</span><span class="sxs-lookup"><span data-stu-id="71d51-133">If type `name` describes an assembly qualified generic type, trigger a `Load-by-name`.</span></span>|<span data-ttu-id="71d51-134">從呼叫者推斷。</span><span class="sxs-lookup"><span data-stu-id="71d51-134">Inferred from caller.</span></span><p><span data-ttu-id="71d51-135">使用元件限定的型別名稱時，偏好 <xref:System.Type.GetType%2A?displayProperty=nameWithType>。</span><span class="sxs-lookup"><span data-stu-id="71d51-135">Prefer <xref:System.Type.GetType%2A?displayProperty=nameWithType> when using assembly qualified type names.</span></span>|
<xref:System.Activator.CreateInstance(System.String,System.String)?displayProperty=nameWithType><p><xref:System.Activator.CreateInstance(System.String,System.String,System.Object[])?displayProperty=nameWithType><p><xref:System.Activator.CreateInstance(System.String,System.String,System.Boolean,System.Reflection.BindingFlags,System.Reflection.Binder,System.Object[],System.Globalization.CultureInfo,System.Object[])?displayProperty=nameWithType>|<span data-ttu-id="71d51-136">`Load-by-name`</span><span class="sxs-lookup"><span data-stu-id="71d51-136">`Load-by-name`.</span></span>|<span data-ttu-id="71d51-137">從呼叫者推斷。</span><span class="sxs-lookup"><span data-stu-id="71d51-137">Inferred from caller.</span></span><p><span data-ttu-id="71d51-138">偏好 <xref:System.Activator.CreateInstance%2A?displayProperty=nameWithType> 採用 <xref:System.Type> 引數的方法。</span><span class="sxs-lookup"><span data-stu-id="71d51-138">Prefer <xref:System.Activator.CreateInstance%2A?displayProperty=nameWithType> methods taking a <xref:System.Type> argument.</span></span>|

## <a name="algorithm"></a><span data-ttu-id="71d51-139">演算法</span><span class="sxs-lookup"><span data-stu-id="71d51-139">Algorithm</span></span>

<span data-ttu-id="71d51-140">下列演算法描述執行時間如何載入 managed 元件。</span><span class="sxs-lookup"><span data-stu-id="71d51-140">The following algorithm describes how the runtime loads a managed assembly.</span></span>

1. <span data-ttu-id="71d51-141">判斷 `active` <xref:System.Runtime.Loader.AssemblyLoadContext>。</span><span class="sxs-lookup"><span data-stu-id="71d51-141">Determine the `active` <xref:System.Runtime.Loader.AssemblyLoadContext>.</span></span>

    - <span data-ttu-id="71d51-142">對於靜態元件參考，`active` <xref:System.Runtime.Loader.AssemblyLoadContext> 是載入參考元件的實例。</span><span class="sxs-lookup"><span data-stu-id="71d51-142">For a static assembly reference, the `active` <xref:System.Runtime.Loader.AssemblyLoadContext> is the instance that loaded the referring assembly.</span></span>
    - <span data-ttu-id="71d51-143">慣用的 Api 可讓 `active` <xref:System.Runtime.Loader.AssemblyLoadContext> 明確。</span><span class="sxs-lookup"><span data-stu-id="71d51-143">Preferred APIs make the `active` <xref:System.Runtime.Loader.AssemblyLoadContext> explicit.</span></span>
    - <span data-ttu-id="71d51-144">其他 Api 會推斷 `active` <xref:System.Runtime.Loader.AssemblyLoadContext>。</span><span class="sxs-lookup"><span data-stu-id="71d51-144">Other APIs infer the `active` <xref:System.Runtime.Loader.AssemblyLoadContext>.</span></span> <span data-ttu-id="71d51-145">針對這些 Api，會使用 <xref:System.Runtime.Loader.AssemblyLoadContext.CurrentContextualReflectionContext?displayProperty=nameWithType> 屬性。</span><span class="sxs-lookup"><span data-stu-id="71d51-145">For these APIs, the <xref:System.Runtime.Loader.AssemblyLoadContext.CurrentContextualReflectionContext?displayProperty=nameWithType> property is used.</span></span> <span data-ttu-id="71d51-146">如果其值為 `null`，則會使用推斷的 <xref:System.Runtime.Loader.AssemblyLoadContext> 實例。</span><span class="sxs-lookup"><span data-stu-id="71d51-146">If its value is `null`, then the inferred <xref:System.Runtime.Loader.AssemblyLoadContext> instance is used.</span></span>
    - <span data-ttu-id="71d51-147">請參閱上表。</span><span class="sxs-lookup"><span data-stu-id="71d51-147">See table above.</span></span>

2. <span data-ttu-id="71d51-148">在 `Load-by-name` 方法中，使用中 <xref:System.Runtime.Loader.AssemblyLoadContext> 會載入元件。</span><span class="sxs-lookup"><span data-stu-id="71d51-148">For the `Load-by-name` methods, the active <xref:System.Runtime.Loader.AssemblyLoadContext> loads the assembly.</span></span> <span data-ttu-id="71d51-149">依優先順序排序依據：</span><span class="sxs-lookup"><span data-stu-id="71d51-149">In priority order by:</span></span>
    - <span data-ttu-id="71d51-150">正在檢查其 `cache-by-name`。</span><span class="sxs-lookup"><span data-stu-id="71d51-150">Checking its `cache-by-name`.</span></span>

    - <span data-ttu-id="71d51-151">呼叫 <xref:System.Runtime.Loader.AssemblyLoadContext.Load%2A?displayProperty=nameWithType> 函式。</span><span class="sxs-lookup"><span data-stu-id="71d51-151">Calling the <xref:System.Runtime.Loader.AssemblyLoadContext.Load%2A?displayProperty=nameWithType> function.</span></span>

    - <span data-ttu-id="71d51-152">檢查 <xref:System.Runtime.Loader.AssemblyLoadContext.Default%2A?displayProperty=nameWithType> 實例的快取，並執行[受管理元件的預設探查](default-probing.md#managed-assembly-default-probing)邏輯。</span><span class="sxs-lookup"><span data-stu-id="71d51-152">Checking the <xref:System.Runtime.Loader.AssemblyLoadContext.Default%2A?displayProperty=nameWithType> instances' cache and running [managed assembly default probing](default-probing.md#managed-assembly-default-probing) logic.</span></span>

    - <span data-ttu-id="71d51-153">引發作用中 AssemblyLoadCoNtext 的 <xref:System.Runtime.Loader.AssemblyLoadContext.Resolving?displayProperty=nameWithType> 事件。</span><span class="sxs-lookup"><span data-stu-id="71d51-153">Raising the <xref:System.Runtime.Loader.AssemblyLoadContext.Resolving?displayProperty=nameWithType> event for the active AssemblyLoadContext.</span></span>

    - <span data-ttu-id="71d51-154">引發 <xref:System.AppDomain.AssemblyResolve?displayProperty=nameWithType> 事件。</span><span class="sxs-lookup"><span data-stu-id="71d51-154">Raising the <xref:System.AppDomain.AssemblyResolve?displayProperty=nameWithType> event.</span></span>

3. <span data-ttu-id="71d51-155">對於其他類型的載入，`active` <xref:System.Runtime.Loader.AssemblyLoadContext> 會載入元件。</span><span class="sxs-lookup"><span data-stu-id="71d51-155">For the other types of loads, the `active` <xref:System.Runtime.Loader.AssemblyLoadContext> loads the assembly.</span></span> <span data-ttu-id="71d51-156">依優先順序排序依據：</span><span class="sxs-lookup"><span data-stu-id="71d51-156">In priority order by:</span></span>
    - <span data-ttu-id="71d51-157">正在檢查其 `cache-by-name`。</span><span class="sxs-lookup"><span data-stu-id="71d51-157">Checking its `cache-by-name`.</span></span>

    - <span data-ttu-id="71d51-158">從指定的路徑或原始元件物件載入。</span><span class="sxs-lookup"><span data-stu-id="71d51-158">Loading from the specified path or raw assembly object.</span></span>

4. <span data-ttu-id="71d51-159">不論是哪一種情況，如果剛載入元件，則：</span><span class="sxs-lookup"><span data-stu-id="71d51-159">In either case, if an assembly is newly loaded, then:</span></span>
   - <span data-ttu-id="71d51-160">便會引發 <xref:System.AppDomain.AssemblyLoad?displayProperty=nameWithType> 事件。</span><span class="sxs-lookup"><span data-stu-id="71d51-160">The <xref:System.AppDomain.AssemblyLoad?displayProperty=nameWithType> event is raised.</span></span>
   - <span data-ttu-id="71d51-161">參考會加入元件的 <xref:System.Runtime.Loader.AssemblyLoadContext> 實例 `cache-by-name`中。</span><span class="sxs-lookup"><span data-stu-id="71d51-161">A reference is added to the assembly's <xref:System.Runtime.Loader.AssemblyLoadContext> instance's `cache-by-name`.</span></span>

5. <span data-ttu-id="71d51-162">如果找到元件，則會視需要將參考加入至 `active` <xref:System.Runtime.Loader.AssemblyLoadContext> 實例的 `cache-by-name`中。</span><span class="sxs-lookup"><span data-stu-id="71d51-162">If the assembly is found, a reference is added as needed to the `active` <xref:System.Runtime.Loader.AssemblyLoadContext> instance's `cache-by-name`.</span></span>
