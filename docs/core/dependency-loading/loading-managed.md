---
title: 託管程式集載入演算法 - .NET 核心
description: .NET Core 中託管程式集載入演算法的詳細資訊說明
ms.date: 08/09/2019
author: sdmaclea
ms.author: stmaclea
ms.openlocfilehash: 312a320676be6eb453697e0704ab771a6707618b
ms.sourcegitcommit: 7588136e355e10cbc2582f389c90c127363c02a5
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 03/14/2020
ms.locfileid: "73973505"
---
# <a name="managed-assembly-loading-algorithm"></a><span data-ttu-id="52999-103">託管程式集載入演算法</span><span class="sxs-lookup"><span data-stu-id="52999-103">Managed assembly loading algorithm</span></span>

<span data-ttu-id="52999-104">託管程式集位於並載入了涉及不同階段的演算法。</span><span class="sxs-lookup"><span data-stu-id="52999-104">Managed assemblies are located and loaded with an algorithm involving various stages.</span></span>

<span data-ttu-id="52999-105">除附屬程式集和`WinRT`程式集之外，所有託管程式集都使用相同的演算法。</span><span class="sxs-lookup"><span data-stu-id="52999-105">All managed assemblies except satellite assemblies and `WinRT` assemblies use the same algorithm.</span></span>

## <a name="when-are-managed-assemblies-loaded"></a><span data-ttu-id="52999-106">何時載入託管程式集？</span><span class="sxs-lookup"><span data-stu-id="52999-106">When are managed assemblies loaded?</span></span>

<span data-ttu-id="52999-107">觸發託管程式集負載的最常見機制是靜態程式集引用。</span><span class="sxs-lookup"><span data-stu-id="52999-107">The most common mechanism to trigger a managed assembly load is a static assembly reference.</span></span> <span data-ttu-id="52999-108">每當代碼使用在另一個程式集中定義的類型時，編譯器都會插入這些引用。</span><span class="sxs-lookup"><span data-stu-id="52999-108">These references are inserted by the compiler whenever code uses a type defined in another assembly.</span></span> <span data-ttu-id="52999-109">這些程式集根據需要載入`load-by-name`（ ）。</span><span class="sxs-lookup"><span data-stu-id="52999-109">These assemblies are loaded (`load-by-name`) as needed by the runtime.</span></span>

<span data-ttu-id="52999-110">直接使用特定 API 也會觸發負載：</span><span class="sxs-lookup"><span data-stu-id="52999-110">The direct use of specific APIs will also trigger loads:</span></span>

|<span data-ttu-id="52999-111">API</span><span class="sxs-lookup"><span data-stu-id="52999-111">API</span></span>  |<span data-ttu-id="52999-112">描述</span><span class="sxs-lookup"><span data-stu-id="52999-112">Description</span></span>  |<span data-ttu-id="52999-113">`Active` <xref:System.Runtime.Loader.AssemblyLoadContext></span><span class="sxs-lookup"><span data-stu-id="52999-113">`Active` <xref:System.Runtime.Loader.AssemblyLoadContext></span></span> |
|---------|---------|---------|
|<xref:System.Runtime.Loader.AssemblyLoadContext.LoadFromAssemblyName%2A?displayProperty=nameWithType>|`Load-by-name`|<span data-ttu-id="52999-114">[此](../../csharp/language-reference/keywords/this.md)實例。</span><span class="sxs-lookup"><span data-stu-id="52999-114">The [this](../../csharp/language-reference/keywords/this.md) instance.</span></span>|
|<xref:System.Runtime.Loader.AssemblyLoadContext.LoadFromAssemblyPath%2A?displayProperty=nameWithType><p><xref:System.Runtime.Loader.AssemblyLoadContext.LoadFromNativeImagePath%2A?displayProperty=nameWithType>|<span data-ttu-id="52999-115">從路徑載入。</span><span class="sxs-lookup"><span data-stu-id="52999-115">Load from path.</span></span>|<span data-ttu-id="52999-116">[此](../../csharp/language-reference/keywords/this.md)實例。</span><span class="sxs-lookup"><span data-stu-id="52999-116">The [this](../../csharp/language-reference/keywords/this.md) instance.</span></span>|
<xref:System.Runtime.Loader.AssemblyLoadContext.LoadFromStream%2A?displayProperty=nameWithType>|<span data-ttu-id="52999-117">從物件載入。</span><span class="sxs-lookup"><span data-stu-id="52999-117">Load from object.</span></span>|<span data-ttu-id="52999-118">[此](../../csharp/language-reference/keywords/this.md)實例。</span><span class="sxs-lookup"><span data-stu-id="52999-118">The [this](../../csharp/language-reference/keywords/this.md) instance.</span></span>|
|<xref:System.Reflection.Assembly.LoadFile%2A?displayProperty=nameWithType>|<span data-ttu-id="52999-119">從新<xref:System.Runtime.Loader.AssemblyLoadContext>實例中的路徑載入</span><span class="sxs-lookup"><span data-stu-id="52999-119">Load from path in a new <xref:System.Runtime.Loader.AssemblyLoadContext> instance</span></span>|<span data-ttu-id="52999-120">新 <xref:System.Runtime.Loader.AssemblyLoadContext> 執行個體。</span><span class="sxs-lookup"><span data-stu-id="52999-120">The new <xref:System.Runtime.Loader.AssemblyLoadContext> instance.</span></span>|
<xref:System.Reflection.Assembly.LoadFrom%2A?displayProperty=nameWithType>|<span data-ttu-id="52999-121">從實例中的<xref:System.Runtime.Loader.AssemblyLoadContext.Default%2A?displayProperty=nameWithType>路徑載入。</span><span class="sxs-lookup"><span data-stu-id="52999-121">Load from path in the <xref:System.Runtime.Loader.AssemblyLoadContext.Default%2A?displayProperty=nameWithType> instance.</span></span><p><span data-ttu-id="52999-122">將<xref:System.Runtime.Loader.AssemblyLoadContext.Resolving>處理常式添加到<xref:System.Runtime.Loader.AssemblyLoadContext.Default%2A?displayProperty=nameWithType>。</span><span class="sxs-lookup"><span data-stu-id="52999-122">Adds a <xref:System.Runtime.Loader.AssemblyLoadContext.Resolving> handler to <xref:System.Runtime.Loader.AssemblyLoadContext.Default%2A?displayProperty=nameWithType>.</span></span> <span data-ttu-id="52999-123">處理常式將從其目錄中載入程式集的依賴項。</span><span class="sxs-lookup"><span data-stu-id="52999-123">The handler will load the assembly's dependencies from its directory.</span></span>|<span data-ttu-id="52999-124"><xref:System.Runtime.Loader.AssemblyLoadContext.Default%2A?displayProperty=nameWithType> 執行個體。</span><span class="sxs-lookup"><span data-stu-id="52999-124">The <xref:System.Runtime.Loader.AssemblyLoadContext.Default%2A?displayProperty=nameWithType> instance.</span></span>|
|<xref:System.Reflection.Assembly.Load(System.Reflection.AssemblyName)?displayProperty=nameWithType><p><xref:System.Reflection.Assembly.Load(System.String)?displayProperty=nameWithType><p><xref:System.Reflection.Assembly.LoadWithPartialName%2A?displayProperty=nameWithType>|<span data-ttu-id="52999-125">`Load-by-name`.</span><span class="sxs-lookup"><span data-stu-id="52999-125">`Load-by-name`.</span></span>|<span data-ttu-id="52999-126">從調用方推斷。</span><span class="sxs-lookup"><span data-stu-id="52999-126">Inferred from caller.</span></span><p><span data-ttu-id="52999-127">首選<xref:System.Runtime.Loader.AssemblyLoadContext>方法。</span><span class="sxs-lookup"><span data-stu-id="52999-127">Prefer <xref:System.Runtime.Loader.AssemblyLoadContext> methods.</span></span>|
|<xref:System.Reflection.Assembly.Load(System.Byte[])?displayProperty=nameWithType><p><xref:System.Reflection.Assembly.Load(System.Byte[],System.Byte[])?displayProperty=nameWithType>|<span data-ttu-id="52999-128">從新<xref:System.Runtime.Loader.AssemblyLoadContext>實例中的物件載入。</span><span class="sxs-lookup"><span data-stu-id="52999-128">Load from object in a new <xref:System.Runtime.Loader.AssemblyLoadContext> instance.</span></span>|<span data-ttu-id="52999-129">新 <xref:System.Runtime.Loader.AssemblyLoadContext> 執行個體。</span><span class="sxs-lookup"><span data-stu-id="52999-129">The new <xref:System.Runtime.Loader.AssemblyLoadContext> instance.</span></span>|
<xref:System.Type.GetType(System.String)?displayProperty=nameWithType><p><xref:System.Type.GetType(System.String,System.Boolean)?displayProperty=nameWithType><p><xref:System.Type.GetType(System.String,System.Boolean,System.Boolean)?displayProperty=nameWithType>|<span data-ttu-id="52999-130">`Load-by-name`.</span><span class="sxs-lookup"><span data-stu-id="52999-130">`Load-by-name`.</span></span>|<span data-ttu-id="52999-131">從調用方推斷。</span><span class="sxs-lookup"><span data-stu-id="52999-131">Inferred from caller.</span></span><p><span data-ttu-id="52999-132">首選<xref:System.Type.GetType%2A?displayProperty=nameWithType>具有`assemblyResolver`參數的方法。</span><span class="sxs-lookup"><span data-stu-id="52999-132">Prefer <xref:System.Type.GetType%2A?displayProperty=nameWithType> methods with an `assemblyResolver` argument.</span></span>|
<xref:System.Reflection.Assembly.GetType%2A?displayProperty=nameWithType>|<span data-ttu-id="52999-133">如果類型`name`描述程式集限定泛型型別，則觸發`Load-by-name`。</span><span class="sxs-lookup"><span data-stu-id="52999-133">If type `name` describes an assembly qualified generic type, trigger a `Load-by-name`.</span></span>|<span data-ttu-id="52999-134">從調用方推斷。</span><span class="sxs-lookup"><span data-stu-id="52999-134">Inferred from caller.</span></span><p><span data-ttu-id="52999-135">使用<xref:System.Type.GetType%2A?displayProperty=nameWithType>程式集限定類型名稱時，首選。</span><span class="sxs-lookup"><span data-stu-id="52999-135">Prefer <xref:System.Type.GetType%2A?displayProperty=nameWithType> when using assembly qualified type names.</span></span>|
<xref:System.Activator.CreateInstance(System.String,System.String)?displayProperty=nameWithType><p><xref:System.Activator.CreateInstance(System.String,System.String,System.Object[])?displayProperty=nameWithType><p><xref:System.Activator.CreateInstance(System.String,System.String,System.Boolean,System.Reflection.BindingFlags,System.Reflection.Binder,System.Object[],System.Globalization.CultureInfo,System.Object[])?displayProperty=nameWithType>|<span data-ttu-id="52999-136">`Load-by-name`.</span><span class="sxs-lookup"><span data-stu-id="52999-136">`Load-by-name`.</span></span>|<span data-ttu-id="52999-137">從調用方推斷。</span><span class="sxs-lookup"><span data-stu-id="52999-137">Inferred from caller.</span></span><p><span data-ttu-id="52999-138">更喜歡<xref:System.Activator.CreateInstance%2A?displayProperty=nameWithType>採用<xref:System.Type>參數的方法。</span><span class="sxs-lookup"><span data-stu-id="52999-138">Prefer <xref:System.Activator.CreateInstance%2A?displayProperty=nameWithType> methods taking a <xref:System.Type> argument.</span></span>|

## <a name="algorithm"></a><span data-ttu-id="52999-139">演算法</span><span class="sxs-lookup"><span data-stu-id="52999-139">Algorithm</span></span>

<span data-ttu-id="52999-140">以下演算法描述運行時如何載入託管程式集。</span><span class="sxs-lookup"><span data-stu-id="52999-140">The following algorithm describes how the runtime loads a managed assembly.</span></span>

1. <span data-ttu-id="52999-141">確定`active`<xref:System.Runtime.Loader.AssemblyLoadContext>。</span><span class="sxs-lookup"><span data-stu-id="52999-141">Determine the `active` <xref:System.Runtime.Loader.AssemblyLoadContext>.</span></span>

    - <span data-ttu-id="52999-142">對於靜態程式集引用，`active`<xref:System.Runtime.Loader.AssemblyLoadContext>是載入引用程式集的實例。</span><span class="sxs-lookup"><span data-stu-id="52999-142">For a static assembly reference, the `active` <xref:System.Runtime.Loader.AssemblyLoadContext> is the instance that loaded the referring assembly.</span></span>
    - <span data-ttu-id="52999-143">首選 API 使`active`<xref:System.Runtime.Loader.AssemblyLoadContext>顯式。</span><span class="sxs-lookup"><span data-stu-id="52999-143">Preferred APIs make the `active` <xref:System.Runtime.Loader.AssemblyLoadContext> explicit.</span></span>
    - <span data-ttu-id="52999-144">其他 API 推斷`active`<xref:System.Runtime.Loader.AssemblyLoadContext>。</span><span class="sxs-lookup"><span data-stu-id="52999-144">Other APIs infer the `active` <xref:System.Runtime.Loader.AssemblyLoadContext>.</span></span> <span data-ttu-id="52999-145">對於這些 API，將使用<xref:System.Runtime.Loader.AssemblyLoadContext.CurrentContextualReflectionContext?displayProperty=nameWithType>該屬性。</span><span class="sxs-lookup"><span data-stu-id="52999-145">For these APIs, the <xref:System.Runtime.Loader.AssemblyLoadContext.CurrentContextualReflectionContext?displayProperty=nameWithType> property is used.</span></span> <span data-ttu-id="52999-146">如果其值為`null`，則使用推斷<xref:System.Runtime.Loader.AssemblyLoadContext>實例。</span><span class="sxs-lookup"><span data-stu-id="52999-146">If its value is `null`, then the inferred <xref:System.Runtime.Loader.AssemblyLoadContext> instance is used.</span></span>
    - <span data-ttu-id="52999-147">見上表。</span><span class="sxs-lookup"><span data-stu-id="52999-147">See table above.</span></span>

2. <span data-ttu-id="52999-148">對於`Load-by-name`方法，活動<xref:System.Runtime.Loader.AssemblyLoadContext>載入程式集。</span><span class="sxs-lookup"><span data-stu-id="52999-148">For the `Load-by-name` methods, the active <xref:System.Runtime.Loader.AssemblyLoadContext> loads the assembly.</span></span> <span data-ttu-id="52999-149">按優先順序順序排列：</span><span class="sxs-lookup"><span data-stu-id="52999-149">In priority order by:</span></span>
    - <span data-ttu-id="52999-150">檢查其`cache-by-name`。</span><span class="sxs-lookup"><span data-stu-id="52999-150">Checking its `cache-by-name`.</span></span>

    - <span data-ttu-id="52999-151">調用函數<xref:System.Runtime.Loader.AssemblyLoadContext.Load%2A?displayProperty=nameWithType>。</span><span class="sxs-lookup"><span data-stu-id="52999-151">Calling the <xref:System.Runtime.Loader.AssemblyLoadContext.Load%2A?displayProperty=nameWithType> function.</span></span>

    - <span data-ttu-id="52999-152">檢查<xref:System.Runtime.Loader.AssemblyLoadContext.Default%2A?displayProperty=nameWithType>實例的緩存並運行[託管程式集預設探測](default-probing.md#managed-assembly-default-probing)邏輯。</span><span class="sxs-lookup"><span data-stu-id="52999-152">Checking the <xref:System.Runtime.Loader.AssemblyLoadContext.Default%2A?displayProperty=nameWithType> instances' cache and running [managed assembly default probing](default-probing.md#managed-assembly-default-probing) logic.</span></span>

    - <span data-ttu-id="52999-153">引發活動<xref:System.Runtime.Loader.AssemblyLoadContext.Resolving?displayProperty=nameWithType>程式集載入上下文的事件。</span><span class="sxs-lookup"><span data-stu-id="52999-153">Raising the <xref:System.Runtime.Loader.AssemblyLoadContext.Resolving?displayProperty=nameWithType> event for the active AssemblyLoadContext.</span></span>

    - <span data-ttu-id="52999-154">引發事件<xref:System.AppDomain.AssemblyResolve?displayProperty=nameWithType>。</span><span class="sxs-lookup"><span data-stu-id="52999-154">Raising the <xref:System.AppDomain.AssemblyResolve?displayProperty=nameWithType> event.</span></span>

3. <span data-ttu-id="52999-155">對於其他類型的負載，載入`active`<xref:System.Runtime.Loader.AssemblyLoadContext>元件。</span><span class="sxs-lookup"><span data-stu-id="52999-155">For the other types of loads, the `active` <xref:System.Runtime.Loader.AssemblyLoadContext> loads the assembly.</span></span> <span data-ttu-id="52999-156">按優先順序順序排列：</span><span class="sxs-lookup"><span data-stu-id="52999-156">In priority order by:</span></span>
    - <span data-ttu-id="52999-157">檢查其`cache-by-name`。</span><span class="sxs-lookup"><span data-stu-id="52999-157">Checking its `cache-by-name`.</span></span>

    - <span data-ttu-id="52999-158">從指定的路徑或原始程式集物件載入。</span><span class="sxs-lookup"><span data-stu-id="52999-158">Loading from the specified path or raw assembly object.</span></span>

4. <span data-ttu-id="52999-159">在這兩種情況下，如果新載入了程式集，則：</span><span class="sxs-lookup"><span data-stu-id="52999-159">In either case, if an assembly is newly loaded, then:</span></span>
   - <span data-ttu-id="52999-160">便會引發 <xref:System.AppDomain.AssemblyLoad?displayProperty=nameWithType> 事件。</span><span class="sxs-lookup"><span data-stu-id="52999-160">The <xref:System.AppDomain.AssemblyLoad?displayProperty=nameWithType> event is raised.</span></span>
   - <span data-ttu-id="52999-161">引用將添加到程式集的<xref:System.Runtime.Loader.AssemblyLoadContext>實例 。 `cache-by-name`</span><span class="sxs-lookup"><span data-stu-id="52999-161">A reference is added to the assembly's <xref:System.Runtime.Loader.AssemblyLoadContext> instance's `cache-by-name`.</span></span>

5. <span data-ttu-id="52999-162">如果找到程式集，則根據需要`active`<xref:System.Runtime.Loader.AssemblyLoadContext>向實例的`cache-by-name`增加參考。</span><span class="sxs-lookup"><span data-stu-id="52999-162">If the assembly is found, a reference is added as needed to the `active` <xref:System.Runtime.Loader.AssemblyLoadContext> instance's `cache-by-name`.</span></span>
