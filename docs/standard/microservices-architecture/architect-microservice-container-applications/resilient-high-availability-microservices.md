---
title: "恢復功能和 microservices 的高可用性"
description: "容器化的.NET 應用程式的.NET Microservices 架構 |恢復功能和 microservices 的高可用性"
keywords: "Docker, 微服務, ASP.NET, 容器"
author: CESARDELATORRE
ms.author: wiwagn
ms.date: 05/26/2017
ms.prod: .net-core
ms.technology: dotnet-docker
ms.topic: article
ms.openlocfilehash: 149e28ac7bd7383e4e960ed8a226943e2b9bdaa1
ms.sourcegitcommit: c2e216692ef7576a213ae16af2377cd98d1a67fa
ms.translationtype: HT
ms.contentlocale: zh-TW
ms.lasthandoff: 10/22/2017
---
# <a name="resiliency-and-high-availability-in-microservices"></a><span data-ttu-id="41749-104">恢復功能和 microservices 的高可用性</span><span class="sxs-lookup"><span data-stu-id="41749-104">Resiliency and high availability in microservices</span></span>

<span data-ttu-id="41749-105">處理未預期的錯誤是其中一個最困難的問題，若要解決，尤其是在分散式系統。</span><span class="sxs-lookup"><span data-stu-id="41749-105">Dealing with unexpected failures is one of the hardest problems to solve, especially in a distributed system.</span></span> <span data-ttu-id="41749-106">大部分的開發人員撰寫的程式碼牽涉到例外狀況處理、 和，這也在測試所花費最多時間。</span><span class="sxs-lookup"><span data-stu-id="41749-106">Much of the code that developers write involves handling exceptions, and this is also where the most time is spent in testing.</span></span> <span data-ttu-id="41749-107">問題會比撰寫程式碼以處理失敗更為複雜。</span><span class="sxs-lookup"><span data-stu-id="41749-107">The problem is more involved than writing code to handle failures.</span></span> <span data-ttu-id="41749-108">微服務執行所在的電腦失敗時，會發生什麼事？</span><span class="sxs-lookup"><span data-stu-id="41749-108">What happens when the machine where the microservice is running fails?</span></span> <span data-ttu-id="41749-109">不只需要偵測此微服務失敗 （本身困難的問題），但您也需要某個動作，重新啟動您的微服務。</span><span class="sxs-lookup"><span data-stu-id="41749-109">Not only do you need to detect this microservice failure (a hard problem on its own), but you also need something to restart your microservice.</span></span>

<span data-ttu-id="41749-110">微服務需要處理失敗的彈性，並要能重新啟動通常可用性的另一部電腦上。</span><span class="sxs-lookup"><span data-stu-id="41749-110">A microservice needs to be resilient to failures and to be able to restart often on another machine for availability.</span></span> <span data-ttu-id="41749-111">此復原也都是在向下微服務可以復原此狀態，以及是否可以成功地重新啟動的微服務微服務，代表儲存的狀態。</span><span class="sxs-lookup"><span data-stu-id="41749-111">This resiliency also comes down to the state that was saved on behalf of the microservice, where the microservice can recover this state from, and whether the microservice can restart successfully.</span></span> <span data-ttu-id="41749-112">換句話說，需要具備中 （在任何時間，可以重新啟動處理程序） 的計算能力的恢復功能以及更有恢復狀態或資料 （無資料遺失和資料則維持一致）。</span><span class="sxs-lookup"><span data-stu-id="41749-112">In other words, there needs to be resiliency in the compute capability (the process can restart at any time) as well as resilience in the state or data (no data loss, and the data remains consistent).</span></span>

<span data-ttu-id="41749-113">恢復功能的問題是複合性的其他案例，例如當應用程式在升級期間發生失敗期間。</span><span class="sxs-lookup"><span data-stu-id="41749-113">The problems of resiliency are compounded during other scenarios, such as when failures occur during an application upgrade.</span></span> <span data-ttu-id="41749-114">微服務，使用與部署系統，您必須判斷是否可以繼續向前移到較新版本，或改為復原回先前的版本，以維護一致的狀態。</span><span class="sxs-lookup"><span data-stu-id="41749-114">The microservice, working with the deployment system, needs to determine whether it can continue to move forward to the newer version or instead roll back to a previous version to maintain a consistent state.</span></span> <span data-ttu-id="41749-115">是否有可向前移動的保留足夠的電腦以及如何復原先前版本的微服務的問題需要考量。</span><span class="sxs-lookup"><span data-stu-id="41749-115">Questions such as whether enough machines are available to keep moving forward and how to recover previous versions of the microservice need to be considered.</span></span> <span data-ttu-id="41749-116">這需要發出健康情況資訊，以便在整體的應用程式與 orchestrator 進行這些決定微服務。</span><span class="sxs-lookup"><span data-stu-id="41749-116">This requires the microservice to emit health information so that the overall application and orchestrator can make these decisions.</span></span>

<span data-ttu-id="41749-117">此外，相關恢復功能如何以雲端為基礎的系統必須行為。</span><span class="sxs-lookup"><span data-stu-id="41749-117">In addition, resiliency is related to how cloud-based systems must behave.</span></span> <span data-ttu-id="41749-118">如前所述，以雲端為基礎的系統也必須不怕失敗，並必須嘗試自動修復它們。</span><span class="sxs-lookup"><span data-stu-id="41749-118">As mentioned, a cloud-based system must embrace failures and must try to automatically recover from them.</span></span> <span data-ttu-id="41749-119">比方說，在網路或容器失敗，用戶端應用程式或用戶端服務必須重試傳送訊息，或重試要求，因為在許多情況下，在雲端中的失敗是部分的策略。</span><span class="sxs-lookup"><span data-stu-id="41749-119">For instance, in case of network or container failures, client apps or client services must have a strategy to retry sending messages or to retry requests, since in many cases failures in the cloud are partial.</span></span> <span data-ttu-id="41749-120">[實作具有恢復功能的應用程式](#implementing_resilient_apps)> 一節中本指南說明如何處理部分失敗。</span><span class="sxs-lookup"><span data-stu-id="41749-120">The [Implementing Resilient Applications](#implementing_resilient_apps) section in this guide addresses how to handle partial failure.</span></span> <span data-ttu-id="41749-121">它說明使用類似的程式庫的技術，如使用指數型輪詢或.NET 核心中的斷路器模式的重試[Polly](https://github.com/App-vNext/Polly)，其中提供各種處理這個主體的原則。</span><span class="sxs-lookup"><span data-stu-id="41749-121">It describes techniques like retries with exponential backoff or the Circuit Breaker pattern in .NET Core by using libraries like [Polly](https://github.com/App-vNext/Polly), which offers a large variety of policies to handle this subject.</span></span>

## <a name="health-management-and-diagnostics-in-microservices"></a><span data-ttu-id="41749-122">健康情況管理和診斷 microservices 中</span><span class="sxs-lookup"><span data-stu-id="41749-122">Health management and diagnostics in microservices</span></span>

<span data-ttu-id="41749-123">很明顯，常被忽略，而微服務必須在其健康情況及診斷報告。</span><span class="sxs-lookup"><span data-stu-id="41749-123">It may seem obvious, and it is often overlooked, but a microservice must report its health and diagnostics.</span></span> <span data-ttu-id="41749-124">否則，會從作業觀點來看很少深入解析。</span><span class="sxs-lookup"><span data-stu-id="41749-124">Otherwise, there is little insight from an operations perspective.</span></span> <span data-ttu-id="41749-125">一組獨立的服務之間的關聯的診斷事件和處理電腦時鐘偏差的事件順序的意義是一項挑戰。</span><span class="sxs-lookup"><span data-stu-id="41749-125">Correlating diagnostic events across a set of independent services and dealing with machine clock skews to make sense of the event order is challenging.</span></span> <span data-ttu-id="41749-126">互動的微服務透過同意通訊協定和資料格式的相同方式，就需要來記錄健全狀況和最終都會進行查詢和檢視事件存放區中的診斷事件的方式標準化。</span><span class="sxs-lookup"><span data-stu-id="41749-126">In the same way that you interact with a microservice over agreed-upon protocols and data formats, there is a need for standardization in how to log health and diagnostic events that ultimately end up in an event store for querying and viewing.</span></span> <span data-ttu-id="41749-127">在 microservices 方法中，它是索引鍵不同小組同意在單一記錄格式。</span><span class="sxs-lookup"><span data-stu-id="41749-127">In a microservices approach, it is key that different teams agree on a single logging format.</span></span> <span data-ttu-id="41749-128">需要一致的方法來檢視應用程式中的診斷事件。</span><span class="sxs-lookup"><span data-stu-id="41749-128">There needs to be a consistent approach to viewing diagnostic events in the application.</span></span>

### <a name="health-checks"></a><span data-ttu-id="41749-129">健康情況檢查</span><span class="sxs-lookup"><span data-stu-id="41749-129">Health checks</span></span>

<span data-ttu-id="41749-130">健全狀況是不同的診斷。</span><span class="sxs-lookup"><span data-stu-id="41749-130">Health is different from diagnostics.</span></span> <span data-ttu-id="41749-131">健全狀況是關於報告其目前的狀態，以採取適當的動作微服務。</span><span class="sxs-lookup"><span data-stu-id="41749-131">Health is about the microservice reporting its current state to take appropriate actions.</span></span> <span data-ttu-id="41749-132">使用良好的範例，當做維護可用性的升級與部署機制。</span><span class="sxs-lookup"><span data-stu-id="41749-132">A good example is working with upgrade and deployment mechanisms to maintain availability.</span></span> <span data-ttu-id="41749-133">雖然服務目前可能處於狀況不良的狀態，因為處理序當機或電腦重新開機，服務可能依然可運作。</span><span class="sxs-lookup"><span data-stu-id="41749-133">Although a service might currently be unhealthy due to a process crash or machine reboot, the service might still be operational.</span></span> <span data-ttu-id="41749-134">最後您需要為這個較差執行升級。</span><span class="sxs-lookup"><span data-stu-id="41749-134">The last thing you need is to make this worse by performing an upgrade.</span></span> <span data-ttu-id="41749-135">最好的方法是先進行調查或允許提供時間讓復原微服務。</span><span class="sxs-lookup"><span data-stu-id="41749-135">The best approach is to do an investigation first or allow time for the microservice to recover.</span></span> <span data-ttu-id="41749-136">從微服務的健全狀況事件，幫助我們做出明智的決策和作用中，幫助您建立自我修復服務。</span><span class="sxs-lookup"><span data-stu-id="41749-136">Health events from a microservice help us make informed decisions and, in effect, help create self-healing services.</span></span>

<span data-ttu-id="41749-137">中實作健康情況檢查在 ASP.NET Core services 區段的本指南中，我們將說明如何使用新的 ASP.NET HealthChecks 文件庫中您 microservices，好讓它們可以報告其狀態至監視的服務，以採取適當的動作。</span><span class="sxs-lookup"><span data-stu-id="41749-137">In the Implementing health checks in ASP.NET Core services section of this guide, we explain how to use a new ASP.NET HealthChecks library in your microservices so they can report their state to a monitoring service to take appropriate actions.</span></span>

### <a name="using-diagnostics-and-logs-event-streams"></a><span data-ttu-id="41749-138">使用診斷和記錄檔的事件資料流</span><span class="sxs-lookup"><span data-stu-id="41749-138">Using diagnostics and logs event streams</span></span>

<span data-ttu-id="41749-139">記錄檔會提供如何應用程式或服務正在執行，包括例外狀況、 警告和簡單的參考用訊息的相關資訊。</span><span class="sxs-lookup"><span data-stu-id="41749-139">Logs provide information about how an application or service is running, including exceptions, warnings, and simple informational messages.</span></span> <span data-ttu-id="41749-140">通常，每個記錄檔為文字格式，其中每個事件，一行雖然例外狀況通常也會顯示堆疊追蹤跨多行。</span><span class="sxs-lookup"><span data-stu-id="41749-140">Usually, each log is in a text format with one line per event, although exceptions also often show the stack trace across multiple lines.</span></span>

<span data-ttu-id="41749-141">整合伺服器型應用程式中，可以只是將記錄寫入磁碟 （記錄檔） 上的檔案，並使用任何工具分析。</span><span class="sxs-lookup"><span data-stu-id="41749-141">In monolithic server-based applications, you can simply write logs to a file on disk (a logfile) and then analyze it with any tool.</span></span> <span data-ttu-id="41749-142">因為應用程式執行時限制為固定的伺服器或 VM，通常不太複雜，無法分析的事件流程。</span><span class="sxs-lookup"><span data-stu-id="41749-142">Since application execution is limited to a fixed server or VM, it generally is not too complex to analyze the flow of events.</span></span> <span data-ttu-id="41749-143">不過，在 orchestrator 叢集中許多節點之間執行多個服務的分散式應用程式，能夠將分散式的事件相互關聯是一項挑戰。</span><span class="sxs-lookup"><span data-stu-id="41749-143">However, in a distributed application where multiple services are executed across many nodes in an orchestrator cluster, being able to correlate distributed events is a challenge.</span></span>

<span data-ttu-id="41749-144">微服務為基礎的應用程式應該不會嘗試儲存記錄檔或事件的輸出資料流本身，並管理路由至中央位置的事件甚至不能再一次。</span><span class="sxs-lookup"><span data-stu-id="41749-144">A microservice-based application should not try to store the output stream of events or logfiles by itself, and not even try to manage the routing of the events to a central place.</span></span> <span data-ttu-id="41749-145">它應該是透明的這表示每個處理序，應該只要撰寫其事件資料流至標準輸出的下方將會收集執行環境的基礎結構會由其執行位置。</span><span class="sxs-lookup"><span data-stu-id="41749-145">It should be transparent, meaning that each process should just write its event stream to a standard output that underneath will be collected by the execution environment infrastructure where it is running.</span></span> <span data-ttu-id="41749-146">舉例來說，這些事件資料流路由器是[Microsoft.Diagnostic.EventFlow](https://github.com/Azure/diagnostics-eventflow)，其中多個來源收集事件資料流，並將其輸出系統發佈。</span><span class="sxs-lookup"><span data-stu-id="41749-146">An example of these event stream routers is [Microsoft.Diagnostic.EventFlow](https://github.com/Azure/diagnostics-eventflow), which collects event streams from multiple sources and publishes it to output systems.</span></span> <span data-ttu-id="41749-147">這些可以包括簡單的標準輸出的開發環境，或是想要的雲端系統[Application Insights](https://azure.microsoft.com/services/application-insights/)， [OMS](https://github.com/Azure/diagnostics-eventflow#oms-operations-management-suite) （適用於內部部署應用程式），和[Azure 診斷](https://docs.microsoft.com/azure/monitoring-and-diagnostics/azure-diagnostics).</span><span class="sxs-lookup"><span data-stu-id="41749-147">These can include simple standard output for a development environment or cloud systems like [Application Insights](https://azure.microsoft.com/services/application-insights/), [OMS](https://github.com/Azure/diagnostics-eventflow#oms-operations-management-suite) (for on-premises applications), and [Azure Diagnostics](https://docs.microsoft.com/azure/monitoring-and-diagnostics/azure-diagnostics).</span></span> <span data-ttu-id="41749-148">也有良好的協力廠商記錄分析平台和工具，可以搜尋警示、 報表和監視記錄檔，即使在即時喜歡[Splunk](http://www.splunk.com/goto/Splunk_Log_Management?ac=ga_usa_log_analysis_phrase_Mar17&_kk=logs%20analysis&gclid=CNzkzIrex9MCFYGHfgodW5YOtA)。</span><span class="sxs-lookup"><span data-stu-id="41749-148">There are also good third-party log analysis platforms and tools that can search, alert, report, and monitor logs, even in real time, like [Splunk](http://www.splunk.com/goto/Splunk_Log_Management?ac=ga_usa_log_analysis_phrase_Mar17&_kk=logs%20analysis&gclid=CNzkzIrex9MCFYGHfgodW5YOtA).</span></span>

### <a name="orchestrators-managing-health-and-diagnostics-information"></a><span data-ttu-id="41749-149">Orchestrators 管理健康情況和診斷資訊</span><span class="sxs-lookup"><span data-stu-id="41749-149">Orchestrators managing health and diagnostics information</span></span>

<span data-ttu-id="41749-150">當您建立微服務為基礎的應用程式時，您需要處理複雜度。</span><span class="sxs-lookup"><span data-stu-id="41749-150">When you create a microservice-based application, you need to deal with complexity.</span></span> <span data-ttu-id="41749-151">當然，單一的微服務相當簡單，處理，但是數十份或數百個型別和無數 microservices 的執行個體是複雜的問題。</span><span class="sxs-lookup"><span data-stu-id="41749-151">Of course, a single microservice is simple to deal with, but dozens or hundreds of types and thousands of instances of microservices is a complex problem.</span></span> <span data-ttu-id="41749-152">它就不會只建置您的微服務架構，您也需要高可用性、 可定址性、 復原、 健全狀況及診斷如果您想要擁有穩定且一致的系統。</span><span class="sxs-lookup"><span data-stu-id="41749-152">It is not just about building your microservice architecture—you also need high availability, addressability, resiliency, health, and diagnostics if you intend to have a stable and cohesive system.</span></span>

![](./media/image22.png)

<span data-ttu-id="41749-153">**圖 4-22**。</span><span class="sxs-lookup"><span data-stu-id="41749-153">**Figure 4-22**.</span></span> <span data-ttu-id="41749-154">微服務平台為基礎的應用程式的健康情況管理</span><span class="sxs-lookup"><span data-stu-id="41749-154">A Microservice Platform is fundamental for an application’s health management</span></span>

<span data-ttu-id="41749-155">顯示在圖 4-22 中複雜的問題是很難將自行解決。</span><span class="sxs-lookup"><span data-stu-id="41749-155">The complex problems shown in Figure 4-22 are very hard to solve by yourself.</span></span> <span data-ttu-id="41749-156">開發團隊應該專注於解決商務問題及建置自訂的應用程式的微服務為基礎的方法。</span><span class="sxs-lookup"><span data-stu-id="41749-156">Development teams should focus on solving business problems and building custom applications with microservice-based approaches.</span></span> <span data-ttu-id="41749-157">它們不應該專注於解決複雜的基礎結構發生問題;如果有，任何微服務為基礎的應用程式的成本是很大。</span><span class="sxs-lookup"><span data-stu-id="41749-157">They should not focus on solving complex infrastructure problems; if they did, the cost of any microservice-based application would be huge.</span></span> <span data-ttu-id="41749-158">因此，有微服務導向的平台，稱為 orchestrators 」 或 「 微服務叢集，嘗試解決艱難問題的建置和執行服務和有效率地使用基礎結構資源。</span><span class="sxs-lookup"><span data-stu-id="41749-158">Therefore, there are microservice-oriented platforms, referred to as orchestrators or microservice clusters, that try to solve the hard problems of building and running a service and using infrastructure resources efficiently.</span></span> <span data-ttu-id="41749-159">這會減少建立使用 microservices 方法的應用程式的複雜性。</span><span class="sxs-lookup"><span data-stu-id="41749-159">This reduces the complexities of building applications that use a microservices approach.</span></span>

<span data-ttu-id="41749-160">不同 orchestrators 聽起來可能類似，不同的診斷和每個所提供的健康情況檢查功能和到期日，有時會根據作業系統平台的狀態下一節中所述。</span><span class="sxs-lookup"><span data-stu-id="41749-160">Different orchestrators might sound similar, but the diagnostics and health checks offered by each of them differ in features and state of maturity, sometimes depending on the OS platform, as explained in the next section.</span></span>

## <a name="additional-resources"></a><span data-ttu-id="41749-161">其他資源</span><span class="sxs-lookup"><span data-stu-id="41749-161">Additional resources</span></span>

-   <span data-ttu-id="41749-162">**12 個因素應用程式。XI。記錄檔： 將記錄視為事件資料流**
    [*https://12factor.net/logs*](https://12factor.net/logs)</span><span class="sxs-lookup"><span data-stu-id="41749-162">**The Twelve-Factor App. XI. Logs: Treat logs as event streams**
[*https://12factor.net/logs*](https://12factor.net/logs)</span></span>

-   <span data-ttu-id="41749-163">**Microsoft 診斷 EventFlow 程式庫。**</span><span class="sxs-lookup"><span data-stu-id="41749-163">**Microsoft Diagnostic EventFlow Library.**</span></span> <span data-ttu-id="41749-164">GitHub 儲存機制。</span><span class="sxs-lookup"><span data-stu-id="41749-164">GitHub repo.</span></span>

    [<span data-ttu-id="41749-165">*https://github.com/Azure/diagnostics-eventflow*</span><span class="sxs-lookup"><span data-stu-id="41749-165">*https://github.com/Azure/diagnostics-eventflow*</span></span>](https://github.com/Azure/diagnostics-eventflow)

-   <span data-ttu-id="41749-166">**什麼是 Azure 診斷**
    [*https://docs.microsoft.com/azure/azure-diagnostics*](https://docs.microsoft.com/azure/azure-diagnostics)</span><span class="sxs-lookup"><span data-stu-id="41749-166">**What is Azure Diagnostics**
[*https://docs.microsoft.com/azure/azure-diagnostics*](https://docs.microsoft.com/azure/azure-diagnostics)</span></span>

-   <span data-ttu-id="41749-167">**Windows 電腦連線到 Azure 中的記錄分析服務**
    [*https://docs.microsoft.com/azure/log-analytics/log-analytics-windows-agents*](https://docs.microsoft.com/azure/log-analytics/log-analytics-windows-agents)</span><span class="sxs-lookup"><span data-stu-id="41749-167">**Connect Windows computers to the Log Analytics service in Azure**
[*https://docs.microsoft.com/azure/log-analytics/log-analytics-windows-agents*](https://docs.microsoft.com/azure/log-analytics/log-analytics-windows-agents)</span></span>

-   <span data-ttu-id="41749-168">**記錄您平均： 使用語意記錄應用程式區塊**
    [*https://msdn.microsoft.com/library/dn440729 (v=pandp.60).aspx*](https://msdn.microsoft.com/library/dn440729(v=pandp.60).aspx)</span><span class="sxs-lookup"><span data-stu-id="41749-168">**Logging What You Mean: Using the Semantic Logging Application Block**
[*https://msdn.microsoft.com/library/dn440729(v=pandp.60).aspx*](https://msdn.microsoft.com/library/dn440729(v=pandp.60).aspx)</span></span>

-   <span data-ttu-id="41749-169">**Splunk。**</span><span class="sxs-lookup"><span data-stu-id="41749-169">**Splunk.**</span></span> <span data-ttu-id="41749-170">官方網站。</span><span class="sxs-lookup"><span data-stu-id="41749-170">Official site.</span></span>
    [<span data-ttu-id="41749-171">*http://www.splunk.com*</span><span class="sxs-lookup"><span data-stu-id="41749-171">*http://www.splunk.com*</span></span>](http://www.splunk.com)

-   <span data-ttu-id="41749-172">**EventSource 類別**。</span><span class="sxs-lookup"><span data-stu-id="41749-172">**EventSource Class**.</span></span> <span data-ttu-id="41749-173">追蹤 Windows (ETW) 事件的應用程式開發介面[ *https://docs.microsoft.com/dotnet/api/system.diagnostics.tracing.eventsource*](https://docs.microsoft.com/dotnet/api/system.diagnostics.tracing.eventsource)</span><span class="sxs-lookup"><span data-stu-id="41749-173">API for events tracing for Windows (ETW) [*https://docs.microsoft.com/dotnet/api/system.diagnostics.tracing.eventsource*](https://docs.microsoft.com/dotnet/api/system.diagnostics.tracing.eventsource)</span></span>




>[!div class="step-by-step"]
<span data-ttu-id="41749-174">[上一個](microservice-based-composite-ui-shape-layout.md) [下一步] (scalable-available-multi-container-microservice-applications.md)</span><span class="sxs-lookup"><span data-stu-id="41749-174">[Previous] (microservice-based-composite-ui-shape-layout.md) [Next] (scalable-available-multi-container-microservice-applications.md)</span></span>
