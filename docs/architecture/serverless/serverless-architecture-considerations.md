---
title: 無伺服器體系結構注意事項 - 無伺服器應用
description: 瞭解構建無伺服器應用程式的挑戰，從狀態管理和持久存儲到擴展、日誌記錄、跟蹤和診斷。
author: JEREMYLIKNESS
ms.author: jeliknes
ms.date: 06/26/2018
ms.openlocfilehash: c856683cf6910be98661e634246cd003b93a6d76
ms.sourcegitcommit: 7588136e355e10cbc2582f389c90c127363c02a5
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 03/14/2020
ms.locfileid: "72522434"
---
# <a name="serverless-architecture-considerations"></a>無伺服器架構考量

採用無伺服器體系結構確實帶來了某些挑戰。 本節將探討需要注意的一些更常見的注意事項。 所有這些挑戰都有解決辦法。 與所有體系結構選擇一樣，只有在仔細考慮利弊後，才能做出無伺服器決策。 根據應用程式的需求，您可能會確定無伺服器實現不是某些元件的正確解決方案。

## <a name="managing-state"></a>管理狀態

預設情況下，無伺服器函數（與一般微服務一樣）是無狀態的。 避免狀態使無伺服器狀態短暫、橫向擴展和提供彈性，而不會出現核心故障點。 在某些情況下，業務流程需要狀態。 如果進程需要狀態，則有兩個選項。 您可以採用非伺服器模型，或與提供狀態的單獨服務進行交互。 添加狀態會使解決方案複雜化，並加大擴展的難度，並可能創建單個故障點。 仔細考慮您的功能是否絕對需要狀態。 如果答案是"是"，則確定使用無伺服器實現它是否有意義。

有幾種解決方案可以採用狀態，而不會影響無伺服器的好處。 一些較流行的解決方案包括：

- 使用臨時資料存儲或分散式緩存，如 Redis
- 將狀態存儲在資料庫中，如 SQL 或 CosmosDB
- 通過工作流引擎處理狀態，如持久功能

底線是，您應該意識到需要考慮在進程內使用無伺服器實現的任何狀態管理的必要性。

## <a name="long-running-processes"></a>長時間運行的進程

無伺服器的許多優點依賴于臨時化進程。 短時間使無伺服器提供程式更容易釋放資源，因為函數在主機之間結束和共用函數。 大多數雲供應商將函數運行的總時間限制為 10 分鐘左右。 如果過程可能需要更長的時間，則可以考慮另一種實現。

有幾個例外和解決方案。 一種解決方案可能是將流程分解為更小的元件，而這些元件的執行時間卻更少。 如果進程由於依賴關係而運行很長時間，還可以考慮使用持久函數等解決方案的非同步工作流。 持久功能在等待外部進程完成時暫停並維護進程的狀態。 非同步處理減少了實際進程運行的時間。

## <a name="startup-time"></a>啟動時間

無伺服器實現的潛在問題之一是啟動時間。 為了節約資源，許多無伺服器供應商"按需"創建基礎結構。 在一段時間後觸發無伺服器函數時，可能需要創建或重新開機承載該函數的資源。 在某些情況下，冷起動可能導致幾秒鐘的延遲。 啟動時間因供應商和服務等級而異。 如果為應用的成功最小化很重要，則有幾種方法可以解決啟動時間。

- 某些供應商允許使用者為保證基礎結構"始終處於"的服務等級付費。
- 實現保持活動機制（ping終結點以保持其"喚醒"）。
- 使用業務流程，如 Kubernetes 與容器化函數方法（主機已在運行，因此旋轉新實例非常快）。

## <a name="database-updates-and-migrations"></a>資料庫更新和遷移

無伺服器代碼的一個優點是，您可以發佈新功能，而無需重新部署整個應用程式。 當涉及關係資料庫時，這種優勢可能會成為劣勢。 對資料庫架構的更改很難與無伺服器更新同步。 當出現問題，並且必須回滾更改時，將構成其他挑戰。 資料完整性是微服務和無伺服器函數的最佳做法之一，即它們擁有自己的資料。 可以將更改部署為單個計算和資料單元。 現實情況是，許多遺留系統具有大型後端資料庫，必須與無伺服器體系結構協調。

解決架構版本控制的流行方法是從不修改現有屬性和列，而是添加新資訊。 例如，請考慮將更改從待辦事項清單的布林"已完成"標誌移動到"已完成日期"。 資料庫更改將：：

1. 添加新的"完成日期"欄位。
1. 將"已完成"布林欄位轉換為計算函數，該函數評估完成日期是否在當前日期之後。
1. 添加觸發器，將已完成日期設置為已完成的布林設置為 true 時的當前日期。

更改序列可確保舊代碼繼續"按現在"運行，而較新的無伺服器函數可以利用新欄位。

有關無伺服器體系結構中資料的詳細資訊，請參閱[分散式資料管理的挑戰和解決方案](../microservices/architect-microservice-container-applications/distributed-data-management.md)。

## <a name="scaling"></a>調整大小

一種常見的誤解是，無伺服器意味著"無伺服器"。 事實上，它是"更少的伺服器"。 在擴展方面，存在支援基礎結構非常重要。 大多數無伺服器平臺提供一組控制項，用於處理當事件密度增加時基礎結構應如何擴展。 您可以從各種選項中進行選擇，但策略可能因功能而異。 此外，函數通常在相關主機下運行，以便同一主機上的函數具有相同的比例選項。 因此，有必要根據規模要求組織並制定哪些函數一起託管。

規則通常指定如何根據不同的參數進行擴展（增加主機資源）和橫向擴展（增加主機實例數）。 比例的觸發器可能包括計畫、請求速率、CPU 利用率和記憶體使用方式。 更高的性能通常要花費更大的成本。 當請求率突然增加時，成本較低的基於消費的方法可能不會迅速擴展。 在提前支付"保險成本"與嚴格"隨走"和因需求突然增加而面臨反應遲緩的風險之間，有一個權衡。

## <a name="monitoring-tracing-and-logging"></a>監視、跟蹤和日誌記錄

DevOps 的一個經常被忽視的方面是監視部署後的應用程式。 制定監視無伺服器功能的策略非常重要。 最大的挑戰通常是相關性，或者識別當使用者調用多個函數作為同一交互的一部分時。 大多數無伺服器平臺允許主控台日誌記錄，可以導入到協力廠商工具中。 還有一些選項可以自動收集遙測資料、生成和跟蹤相關 I 並監視特定操作以提供詳細的見解。 Azure 提供了用於監視和分析的高級[應用程式見解平臺](https://docs.microsoft.com/azure/azure-functions/functions-monitoring)。

## <a name="inter-service-dependencies"></a>服務間依賴項

無伺服器體系結構可能包括依賴于其他函數的功能。 事實上，在無伺服器體系結構中，將多個服務作為交互或分散式交易的一部分相互調用的情況並不少見。 為了避免強耦合，建議服務不要直接引用對方。 當服務的終結點需要更改時，直接引用可能會導致重大重構。 建議的解決方案是提供服務發現機制（如註冊表），該機制為請求類型提供適當的終結點。 另一個解決方案是利用消息傳遞服務（如佇列或主題）來在服務之間進行通信。

## <a name="managing-failure-and-providing-resiliency"></a>管理故障並提供彈性

考慮*斷路器模式*也很重要：如果由於某種原因，服務繼續出現故障，則不建議重複調用該服務。 相反，調用替代服務或返回消息，直到重新建立從屬服務的運行狀況。 無伺服器體系結構需要考慮解決和管理服務間依賴關係的策略。

要繼續斷路器模式，服務需要容錯和彈性。 容錯是指應用程式即使在遇到意外異常或無效狀態後仍繼續運行的能力。 容錯通常是代碼本身的函數，以及編寫如何處理異常的方式。 恢復能力是指應用從故障中恢復的能力。 恢復能力通常由無伺服器平臺管理。 當現有無伺服器函數實例發生故障時，平臺應該能夠啟動新的無伺服器函數實例。 平臺還應足夠智慧，在每個新實例失敗時停止旋轉新實例。

有關詳細資訊，請參閱[實現斷路器模式](../microservices/implement-resilient-applications/implement-circuit-breaker-pattern.md)。

## <a name="versioning-and-greenblue-deployments"></a>版本和綠色/藍色部署

無伺服器的一個主要好處是能夠升級特定功能，而無需重新部署整個應用程式。 要成功升級，必須對函數進行版本控制，以便調用它們的服務路由到正確的代碼版本。 部署新版本的策略也很重要。 常用方法是使用"綠色/藍色部署"。 綠色部署是當前功能。 新的"藍色"版本部署到生產和測試。 測試通過後，將交換綠色和藍色版本，以便新版本上線。 如果遇到任何問題，可以重新交換它們。 支援版本控制和綠色/藍色部署需要組合創作函數以適應版本更改，以及使用無伺服器平臺來處理部署。 一種可能的方法是使用代理，這在[Azure 無伺服器平臺](azure-functions.md#proxies)章節仲介紹。

>[!div class="step-by-step"]
>[上一個](serverless-architecture.md)
>[下一個](serverless-design-examples.md)
