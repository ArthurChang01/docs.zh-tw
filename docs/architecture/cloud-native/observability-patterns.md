---
title: 可檢視性模式
description: 雲端原生應用程式的可檢視性模式
ms.date: 09/23/2019
ms.openlocfilehash: 23320144c03278d631b8a1fcc1d1c0954e907296
ms.sourcegitcommit: 55f438d4d00a34b9aca9eedaac3f85590bb11565
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 09/23/2019
ms.locfileid: "71184873"
---
# <a name="observability-patterns"></a>可檢視性模式

[!INCLUDE [book-preview](../../../includes/book-preview.md)]

就像是為了協助應用程式中的程式碼配置而開發的模式一樣，應用程式的模式也是以可靠的方式運作。 維護應用程式有三個有用的模式：記錄、監視和警示。

## <a name="when-to-use-logging"></a>使用記錄的時機

不管我們的重要性，應用程式在生產環境中幾乎一律以非預期的方式表現。 當使用者回報應用程式的問題時，在問題發生時，可以查看應用程式的情況會非常有用。 在執行應用程式時，最常嘗試和真正的方法之一，就是讓應用程式寫下它的運作。 此程式稱為記錄。 在生產環境中發生任何失敗或問題時，目標應該是在非生產環境中重現發生失敗的條件。 備妥良好的記錄功能，可讓開發人員遵循此藍圖，以在可以測試和實驗的環境中重複問題。

### <a name="logging-in-cloud-native-applications"></a>雲端原生應用程式中的記錄

每種程式設計語言都有允許寫入記錄的工具，而且通常寫入這些記錄檔的額外負荷很低。 許多記錄程式庫都提供記錄不同種類的嚴重性，可在執行時間進行調整。 例如，Serilog 程式庫是適用于 .NET 的熱門結構化記錄程式庫，提供下列記錄層級

* 詳細資訊
* 偵錯
* 資訊
* 警告
* 錯誤
* 嚴重

這些不同的記錄層級會在記錄中提供細微性。 當應用程式在生產環境中正常運作時，可能會將它設定為只記錄重要的訊息。 當應用程式行為不佳時，可以增加記錄層級，以收集更詳細的記錄。 這會平衡效能，使其易於進行調試。

記錄工具的高效能和詳細資訊的 tunability 應該鼓勵開發人員經常記錄。 許多偏好記錄每個方法的專案和結束的模式。 這種方法聽起來可能像大材小用，但是開發人員不常想要進行較少的記錄。 事實上，針對在有問題的方法加入記錄的唯一目的來執行部署並不常見。 在記錄太多的那一邊錯誤，而不是太少。 請注意，有些工具可以用來自動提供這種記錄。

在傳統的應用程式中，記錄檔通常會儲存在本機電腦上。 事實上，在 Unix 之類的作業系統上，有一個資料夾結構定義為保存任何記錄檔，通常是在 `/var/log`之下。 在單一電腦上記錄到一般檔案的實用性，在雲端環境中大幅降低。 產生記錄檔的應用程式可能無法存取本機磁片，或本機磁片可能是高度暫時性的，因為容器會在實體機器上隨機移動。

使用微服務架構開發的雲端原生應用程式也會對以檔案為基礎的記錄器造成一些挑戰。 使用者要求現在可能會跨越在不同電腦上執行的多個服務，而且可能包含無伺服器功能，完全不需要本機檔案系統的存取權。 將來自使用者或會話的記錄與這些服務和電腦之間的相互關聯是非常困難的。

最後，某些雲端原生應用程式中的使用者數目很高。 假設每個使用者登入應用程式時，都會產生一百行的記錄訊息。 在隔離中，這是可管理的，但超過100000的使用者和記錄量會變大。

幸好，有一些絕佳的替代方法可以使用以檔案系統為基礎的記錄。 所有記錄傳送到其中的集中式記錄伺服器，會修正所有這些問題。 記錄是由應用程式所收集，並隨附于中央記錄應用程式來編制索引並儲存記錄。 這個類別的系統每天可以內嵌數十 gb 的記錄檔。

在建立橫跨許多服務的記錄時，遵循一些標準做法也會很有説明。 比方說，在冗長的互動開始時產生相互[關聯識別碼](https://blog.rapid7.com/2016/12/23/the-value-of-correlation-ids/)，然後在與該互動相關的每個訊息中進行記錄，可讓您更輕鬆地搜尋所有相關的訊息。 其中一個只需要尋找單一訊息，並將相互關聯識別碼解壓縮，以尋找所有相關訊息。 另一個範例是確保每個服務（其所使用的語言或記錄程式庫）的記錄格式都相同。 這種標準化可以讓讀取記錄檔更容易。 圖7-1 示範微服務架構如何運用集中式記錄做為其工作流程的一部分。

來自各種來源的 ![記錄會內嵌到集中式記錄存放區。](./media/centralized-logging.png)
**圖 7-1**。 來自各種來源的記錄會內嵌到集中式記錄存放區。

## <a name="when-to-use-monitoring"></a>使用監視的時機

有些應用程式不是要徑任務。 也許它們只會在內部使用，當問題發生時，使用者可以聯絡負責的小組，應用程式也可以重新開機。 不過，客戶對於取用的應用程式通常會有更高的期望。 如果您需要知道應用程式在使用者執行之前，或在使用者通知您*之前*發生問題，您需要監視其目前狀態。 妥善實行，監視可以讓您知道將會導致問題的狀況，讓您能夠在產生任何使用者影響之前，先解決基礎條件。

## <a name="monitoring-considerations"></a>監視考慮

有些集中式記錄系統會以額外的角色來收集純粹記錄以外的遙測資料。 他們可以收集計量，例如執行資料庫查詢的時間、web 伺服器的平均回應時間，甚至是作業系統所報告的 CPU 負載平均和記憶體壓力。 這些系統與記錄結合，可讓您全面瞭解系統和應用程式整體的節點健全狀況。

監視工具的計量收集功能也可以從應用程式中手動進行。 特別感興趣的商務流程，例如註冊或加入訂單的新使用者，可能會進行檢測，使其在中央監視系統中遞增計數器。 這可將監視工具解除鎖定，而不只是監視應用程式的健康情況，也能監控企業的健全狀況。

查詢可以在記錄匯總工具中進行構建，以尋找特定的統計資料或模式，然後在自訂儀表板上以圖形形式顯示。 小組經常會投資大量的牆上裝載顯示器，以旋轉與應用程式相關的統計資料。 如此一來，在發生問題時很容易就能看到它們。

## <a name="when-to-use-alerts"></a>使用警示的時機

如果您需要對應用程式的問題做出反應，您需要某種方式來提醒適當的人員。 這是第三個雲端原生應用程式可檢視性模式，取決於記錄和監視。 您的應用程式必須準備好進行記錄，以允許診斷問題，而在某些情況下則會饋送到監視工具。 它需要監視，以便在一個位置匯總應用程式計量和健康情況資料。 一旦建立此規則，就可以建立可在特定計量超出可接受層級時觸發警示的規則。

## <a name="alerts"></a>警示

您可以針對監視工具製作查詢，以尋找已知的失敗狀況。 例如，查詢可以搜尋傳入記錄檔，以取得 HTTP 狀態碼500的指示，這表示 web 伺服器發生問題。 一旦偵測到其中一項，就會將電子郵件或 SMS 傳送給起始服務的擁有者，而該使用者可以開始進行調查。

不過，單一500錯誤通常不足以判斷是否發生問題。 這可能表示使用者鍵入的密碼不正確，或輸入了一些格式不正確的資料。 只有在偵測到大於平均500錯誤數目的情況時，才會引發警示查詢。

警示中最具損毀的模式之一就是引發太多警示，供人們進行調查。 服務擁有者很快就會降低了戒心先前已調查併發現良性的錯誤。 當真正的錯誤發生時，就會在數百個誤報的雜訊中遺失。 [完成 Wolf 的男孩](https://en.wikipedia.org/wiki/The_Boy_Who_Cried_Wolf)parable 經常會被告知孩子，以警告他們這項風險。 請務必確定引發的警示是真正的問題。

>[!div class="step-by-step"]
>[上一頁](monitoring-health.md)
>[下一頁](logging-with-elastic-stack.md)
