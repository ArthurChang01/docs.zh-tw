---
title: Azure 平臺復原
description: 架構適用于 Azure 的雲端原生 .NET 應用程式 |使用 Azure 的雲端基礎結構復原
ms.date: 06/30/2019
ms.openlocfilehash: 02d661952c860da25442b0fa9fed0d5f93abe023
ms.sourcegitcommit: 4f4a32a5c16a75724920fa9627c59985c41e173c
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 10/17/2019
ms.locfileid: "72520768"
---
# <a name="azure-platform-resiliency"></a><span data-ttu-id="6b4a2-103">Azure 平臺復原</span><span class="sxs-lookup"><span data-stu-id="6b4a2-103">Azure platform resiliency</span></span>

[!INCLUDE [book-preview](../../../includes/book-preview.md)]

<span data-ttu-id="6b4a2-104">在雲端中建立可靠的應用程式與傳統的內部部署應用程式開發不同。</span><span class="sxs-lookup"><span data-stu-id="6b4a2-104">Building a reliable application in the cloud is different from traditional on-premises application development.</span></span> <span data-ttu-id="6b4a2-105">雖然您在過去已購買更高階的硬體來相應增加，但在雲端環境中您會向外擴充。與其嘗試避免失敗，其目標是要將其效果降到最低，並讓系統穩定。</span><span class="sxs-lookup"><span data-stu-id="6b4a2-105">While historically you purchased higher-end hardware to scale up, in a cloud environment you scale out. Instead of trying to prevent failures, the goal is to minimize their effects and keep the system stable.</span></span>

<span data-ttu-id="6b4a2-106">也就是說，可靠的雲端應用程式會顯示不同的特性：</span><span class="sxs-lookup"><span data-stu-id="6b4a2-106">That said, reliable cloud applications display distinct characteristics:</span></span>

- <span data-ttu-id="6b4a2-107">它們具有彈性、可從問題中順利復原，並繼續運作。</span><span class="sxs-lookup"><span data-stu-id="6b4a2-107">They're resilient, recover gracefully from problems, and continue to function.</span></span>
- <span data-ttu-id="6b4a2-108">它們是高可用性（HA），並以良好狀態設計，且不會有顯著的停機時間。</span><span class="sxs-lookup"><span data-stu-id="6b4a2-108">They're highly available (HA) and run as designed in a healthy state with no significant downtime.</span></span>

<span data-ttu-id="6b4a2-109">若要建立可靠的雲端原生應用程式，請務必瞭解這些特性如何搭配使用，以及它們如何影響成本。</span><span class="sxs-lookup"><span data-stu-id="6b4a2-109">Understanding how these characteristics work together - and how they affect cost - is essential to building a reliable cloud-native application.</span></span> <span data-ttu-id="6b4a2-110">接下來，我們將探討您可以利用 Azure 雲端的功能，在雲端原生應用程式中建立復原和可用性的方式。</span><span class="sxs-lookup"><span data-stu-id="6b4a2-110">We'll next look at ways that you can build resiliency and availability into your cloud-native applications leveraging features from the Azure cloud.</span></span>

## <a name="design-with-redundancy"></a><span data-ttu-id="6b4a2-111">使用冗余設計</span><span class="sxs-lookup"><span data-stu-id="6b4a2-111">Design with redundancy</span></span>

<span data-ttu-id="6b4a2-112">失敗的影響範圍會有所不同。</span><span class="sxs-lookup"><span data-stu-id="6b4a2-112">Failures vary in scope of impact.</span></span> <span data-ttu-id="6b4a2-113">硬體失敗（例如失敗的磁片）可能會影響叢集中的單一節點。</span><span class="sxs-lookup"><span data-stu-id="6b4a2-113">A hardware failure, such as a failed disk, can affect a single node in a cluster.</span></span> <span data-ttu-id="6b4a2-114">失敗的網路交換器可能會影響整個伺服器機架。</span><span class="sxs-lookup"><span data-stu-id="6b4a2-114">A failed network switch could affect an entire server rack.</span></span> <span data-ttu-id="6b4a2-115">較不常見的失敗（例如斷電）可能會中斷整個資料中心。</span><span class="sxs-lookup"><span data-stu-id="6b4a2-115">Less common failures, such as loss of power, could disrupt a whole datacenter.</span></span> <span data-ttu-id="6b4a2-116">整個區域很少會變得無法使用。</span><span class="sxs-lookup"><span data-stu-id="6b4a2-116">Rarely, an entire region becomes unavailable.</span></span>

<span data-ttu-id="6b4a2-117">[冗余](https://docs.microsoft.com/azure/architecture/guide/design-principles/redundancy)是提供應用程式恢復功能的一種方式。</span><span class="sxs-lookup"><span data-stu-id="6b4a2-117">[Redundancy](https://docs.microsoft.com/azure/architecture/guide/design-principles/redundancy) is one way to provide application resilience.</span></span> <span data-ttu-id="6b4a2-118">所需的確切冗余層級取決於您的業務需求，並會影響系統的成本和複雜度。</span><span class="sxs-lookup"><span data-stu-id="6b4a2-118">The exact level of redundancy needed depends on your business requirements and will affect both cost and complexity of your system.</span></span> <span data-ttu-id="6b4a2-119">例如，多區域部署比單一區域部署更耗費資源，而且管理起來更複雜。</span><span class="sxs-lookup"><span data-stu-id="6b4a2-119">For example, a multi-region deployment is more expensive and more complex to manage than a single-region deployment.</span></span> <span data-ttu-id="6b4a2-120">您將需要操作程式來管理容錯移轉和容錯回復。</span><span class="sxs-lookup"><span data-stu-id="6b4a2-120">You'll need operational procedures to manage failover and failback.</span></span> <span data-ttu-id="6b4a2-121">在某些商務案例中，可能會有額外的成本和複雜度，而不是其他部分。</span><span class="sxs-lookup"><span data-stu-id="6b4a2-121">The additional cost and complexity might be justified for some business scenarios and not others.</span></span>

<span data-ttu-id="6b4a2-122">若要架構的冗余，您需要識別應用程式中的關鍵路徑，然後判斷路徑中的每個點是否有多餘的複本？</span><span class="sxs-lookup"><span data-stu-id="6b4a2-122">To architect redundancy, you need to identify the critical paths in your application, and then determine if there's redundancy at each point in the path?</span></span> <span data-ttu-id="6b4a2-123">如果子系統應該失敗，應用程式會故障切換到其他專案嗎？</span><span class="sxs-lookup"><span data-stu-id="6b4a2-123">If a subsystem should fail, will the application fail over to something else?</span></span> <span data-ttu-id="6b4a2-124">最後，您需要清楚瞭解 Azure 雲端平臺內建的功能，讓您可以利用它來滿足您的冗余需求。</span><span class="sxs-lookup"><span data-stu-id="6b4a2-124">Finally, you need a clear understanding of those features built into the Azure cloud platform that you can leverage to meet your redundancy requirements.</span></span> <span data-ttu-id="6b4a2-125">以下是架構冗余的建議：</span><span class="sxs-lookup"><span data-stu-id="6b4a2-125">Here are recommendations for architecting redundancy:</span></span>

- <span data-ttu-id="6b4a2-126">*部署多個服務實例。*</span><span class="sxs-lookup"><span data-stu-id="6b4a2-126">*Deploy multiple instances of services.*</span></span> <span data-ttu-id="6b4a2-127">如果您的應用程式相依于服務的單一實例，它會建立單一失敗點。</span><span class="sxs-lookup"><span data-stu-id="6b4a2-127">If your application depends on a single instance of a service, it creates a single point of failure.</span></span> <span data-ttu-id="6b4a2-128">布建多個實例可改善復原和擴充性。</span><span class="sxs-lookup"><span data-stu-id="6b4a2-128">Provisioning multiple instances improves both resiliency and scalability.</span></span> <span data-ttu-id="6b4a2-129">在 Azure Kubernetes Service 中裝載時，您可以在 Kubernetes 資訊清單檔中以宣告方式設定多餘的實例（複本集）。</span><span class="sxs-lookup"><span data-stu-id="6b4a2-129">When hosting in Azure Kubernetes Service, you can declaratively configure redundant instances (replica sets) in the Kubernetes manifest file.</span></span> <span data-ttu-id="6b4a2-130">您可以在入口網站中或透過自動調整功能（稍後會討論），以程式設計方式管理複本計數值。</span><span class="sxs-lookup"><span data-stu-id="6b4a2-130">The replica count value can be managed programmatically, in the portal or through autoscaling features, which will be discussed later on.</span></span>

- <span data-ttu-id="6b4a2-131">*利用負載平衡器。*</span><span class="sxs-lookup"><span data-stu-id="6b4a2-131">*Leveraging a load balancer.*</span></span> <span data-ttu-id="6b4a2-132">負載平衡會將應用程式的要求散發到狀況良好的服務實例，並自動從迴圈中移除狀況不良的實例。</span><span class="sxs-lookup"><span data-stu-id="6b4a2-132">Load-balancing distributes your application's requests to healthy service instances and automatically removes unhealthy instances from rotation.</span></span> <span data-ttu-id="6b4a2-133">部署至 Kubernetes 時，可以在 [服務] 區段的 Kubernetes 資訊清單檔中指定負載平衡。</span><span class="sxs-lookup"><span data-stu-id="6b4a2-133">When deploying to Kubernetes, load balancing can be specified in the Kubernetes manifest file in the Services section.</span></span>

- <span data-ttu-id="6b4a2-134">*規劃多區域部署。*</span><span class="sxs-lookup"><span data-stu-id="6b4a2-134">*Plan for multiregion deployment.*</span></span> <span data-ttu-id="6b4a2-135">如果您的應用程式部署到單一區域，且該區域變成無法使用，您的應用程式也會變成無法使用。</span><span class="sxs-lookup"><span data-stu-id="6b4a2-135">If your application is deployed to a single region, and the region becomes unavailable, your application will also become unavailable.</span></span> <span data-ttu-id="6b4a2-136">這在您的應用程式服務等級協定的條款下可能無法接受。</span><span class="sxs-lookup"><span data-stu-id="6b4a2-136">This may be unacceptable under the terms of your application's service level agreements.</span></span> <span data-ttu-id="6b4a2-137">相反地，請考慮將您的應用程式及其服務部署到多個區域。</span><span class="sxs-lookup"><span data-stu-id="6b4a2-137">Instead, consider deploying your application and its services across multiple regions.</span></span> <span data-ttu-id="6b4a2-138">例如，Azure Kubernetes Service （AKS）叢集會部署到單一區域。</span><span class="sxs-lookup"><span data-stu-id="6b4a2-138">For example, an Azure Kubernetes Service (AKS) cluster is deployed to a single region.</span></span> <span data-ttu-id="6b4a2-139">若要保護您的系統不受區域失敗的影響，您可以將應用程式部署到不同區域的多個 AKS 叢集，並使用[配對區域](https://buildazure.com/2017/01/06/azure-region-pairs-explained/)功能來協調平臺更新並排定復原工作的優先順序。</span><span class="sxs-lookup"><span data-stu-id="6b4a2-139">To protect your system from a regional failure, you might deploy your application to multiple AKS clusters across different regions and use the [Paired Regions](https://buildazure.com/2017/01/06/azure-region-pairs-explained/) feature to coordinate platform updates and prioritize recovery efforts.</span></span>

- <span data-ttu-id="6b4a2-140">*啟用[異地](https://docs.microsoft.com/azure/sql-database/sql-database-active-geo-replication)複寫。*</span><span class="sxs-lookup"><span data-stu-id="6b4a2-140">*Enable [geo-replication](https://docs.microsoft.com/azure/sql-database/sql-database-active-geo-replication).*</span></span> <span data-ttu-id="6b4a2-141">Azure SQL Database 和 Cosmos DB 等服務的異地複寫將會跨多個區域建立資料的次要複本。</span><span class="sxs-lookup"><span data-stu-id="6b4a2-141">Geo-replication for services such as Azure SQL Database and Cosmos DB will create secondary replicas of your data across multiple regions.</span></span> <span data-ttu-id="6b4a2-142">雖然這兩個服務都會自動複寫相同區域內的資料，但異地複寫可讓您故障切換到次要區域，以防止區域性中斷。</span><span class="sxs-lookup"><span data-stu-id="6b4a2-142">While both services will automatically replicate data within the same region, geo-replication protects you against a regional outage by enabling you to fail over to a secondary region.</span></span> <span data-ttu-id="6b4a2-143">異地複寫的另一個最佳作法是以儲存容器映射為中心。</span><span class="sxs-lookup"><span data-stu-id="6b4a2-143">Another best practice for geo-replication centers around storing container images.</span></span> <span data-ttu-id="6b4a2-144">若要在 AKS 中部署服務，您需要儲存並從存放庫提取映射。</span><span class="sxs-lookup"><span data-stu-id="6b4a2-144">To deploy a service in AKS, you need to store and pull the image from a repository.</span></span> <span data-ttu-id="6b4a2-145">Azure Container Registry 與 AKS 整合，而且可以安全地儲存容器映射。</span><span class="sxs-lookup"><span data-stu-id="6b4a2-145">Azure Container Registry integrates with AKS and can securely store container images.</span></span> <span data-ttu-id="6b4a2-146">若要改善效能和可用性，請考慮將映射異地複寫至您擁有 AKS 叢集的每個區域中的登錄。</span><span class="sxs-lookup"><span data-stu-id="6b4a2-146">To improve performance and availability, consider geo-replicating your images to a registry in each region where you have an AKS cluster.</span></span> <span data-ttu-id="6b4a2-147">每個 AKS 叢集接著會從其區域中的本機容器登錄提取容器映射，如圖6-6 所示：</span><span class="sxs-lookup"><span data-stu-id="6b4a2-147">Each AKS cluster then pulls container images from the local container registry in its region as shown in Figure 6-6:</span></span>

![跨區域複寫的資源](./media/replicated-resources.png)

<span data-ttu-id="6b4a2-149">**圖 6-6**。</span><span class="sxs-lookup"><span data-stu-id="6b4a2-149">**Figure 6-6**.</span></span> <span data-ttu-id="6b4a2-150">跨區域複寫的資源</span><span class="sxs-lookup"><span data-stu-id="6b4a2-150">Replicated resources across regions</span></span>

- <span data-ttu-id="6b4a2-151">*執行 DNS 流量負載平衡器。*</span><span class="sxs-lookup"><span data-stu-id="6b4a2-151">*Implement a DNS traffic load balancer.*</span></span> <span data-ttu-id="6b4a2-152">[Azure 流量管理員](https://docs.microsoft.com/azure/traffic-manager/traffic-manager-overview)透過在 DNS 層級的負載平衡，為重要的應用程式提供高可用性。</span><span class="sxs-lookup"><span data-stu-id="6b4a2-152">[Azure Traffic Manager](https://docs.microsoft.com/azure/traffic-manager/traffic-manager-overview) provides high-availability for critical applications by load-balancing at the DNS level.</span></span> <span data-ttu-id="6b4a2-153">它可以根據地理位置、叢集回應時間，甚至是應用程式端點健全狀況，將流量路由傳送至不同的區域。</span><span class="sxs-lookup"><span data-stu-id="6b4a2-153">It can route traffic to different regions based on geography, cluster response time, and even application endpoint health.</span></span> <span data-ttu-id="6b4a2-154">例如，Azure 流量管理員可以將客戶導向至最接近的 AKS 叢集和應用程式實例。</span><span class="sxs-lookup"><span data-stu-id="6b4a2-154">For example, Azure Traffic Manager can direct customers to the closest AKS cluster and application instance.</span></span> <span data-ttu-id="6b4a2-155">如果您在不同的區域中有多個 AKS 叢集，請使用流量管理員來控制流量如何流向在每個叢集中執行的應用程式。</span><span class="sxs-lookup"><span data-stu-id="6b4a2-155">If you have multiple AKS clusters in different regions, use Traffic Manager to control how traffic flows to the applications that run in each cluster.</span></span> <span data-ttu-id="6b4a2-156">圖6-7 顯示這種情況。</span><span class="sxs-lookup"><span data-stu-id="6b4a2-156">Figure 6-7 shows this scenario.</span></span>

![AKS 和 Azure 流量管理員](./media/aks-traffic-manager.png)

<span data-ttu-id="6b4a2-158">**圖 6-7**。</span><span class="sxs-lookup"><span data-stu-id="6b4a2-158">**Figure 6-7**.</span></span> <span data-ttu-id="6b4a2-159">AKS 和 Azure 流量管理員</span><span class="sxs-lookup"><span data-stu-id="6b4a2-159">AKS and Azure Traffic Manager</span></span>

## <a name="design-for-scalability"></a><span data-ttu-id="6b4a2-160">擴充性設計</span><span class="sxs-lookup"><span data-stu-id="6b4a2-160">Design for scalability</span></span>

<span data-ttu-id="6b4a2-161">調整規模的雲端計畫才能生生不息。</span><span class="sxs-lookup"><span data-stu-id="6b4a2-161">The cloud thrives on scaling.</span></span> <span data-ttu-id="6b4a2-162">增加/減少系統資源以解決增加/減少系統負載的能力，是 Azure 雲端的關鍵原則。</span><span class="sxs-lookup"><span data-stu-id="6b4a2-162">The ability to increase/decrease system resources to address increasing/decreasing system load is a key tenet of the Azure cloud.</span></span> <span data-ttu-id="6b4a2-163">但是，若要有效地調整應用程式，您必須瞭解您在應用程式中包含的每個 Azure 服務的調整功能。</span><span class="sxs-lookup"><span data-stu-id="6b4a2-163">But, to effectively scale an application, you need an understanding of the scaling features of each Azure service that you include in your application.</span></span>  <span data-ttu-id="6b4a2-164">以下是在您的系統中有效執行調整的建議。</span><span class="sxs-lookup"><span data-stu-id="6b4a2-164">Here are recommendations for effectively implementing scaling in your system.</span></span>

- <span data-ttu-id="6b4a2-165">*調整的設計。*</span><span class="sxs-lookup"><span data-stu-id="6b4a2-165">*Design for scaling.*</span></span> <span data-ttu-id="6b4a2-166">應用程式必須設計成可進行調整。</span><span class="sxs-lookup"><span data-stu-id="6b4a2-166">An application must be designed for scaling.</span></span> <span data-ttu-id="6b4a2-167">若要開始，服務應該是無狀態的，因此可以將要求路由傳送至任何實例。</span><span class="sxs-lookup"><span data-stu-id="6b4a2-167">To start, services should be stateless so that requests can be routed to any instance.</span></span> <span data-ttu-id="6b4a2-168">具有無狀態服務也表示新增或移除實例並不會對目前的使用者造成不良的影響。</span><span class="sxs-lookup"><span data-stu-id="6b4a2-168">Having stateless services also means that adding or removing an instance doesn't adversely impact current users.</span></span>

- <span data-ttu-id="6b4a2-169">*分割工作負載*。</span><span class="sxs-lookup"><span data-stu-id="6b4a2-169">*Partition workloads*.</span></span> <span data-ttu-id="6b4a2-170">將網域分解到獨立的獨立式微服務，可讓每個服務獨立擴充。</span><span class="sxs-lookup"><span data-stu-id="6b4a2-170">Decomposing domains into independent, self-contained microservices enable each service to scale independently of others.</span></span> <span data-ttu-id="6b4a2-171">服務通常會有不同的擴充性需求和需求。</span><span class="sxs-lookup"><span data-stu-id="6b4a2-171">Typically, services will have different scalability needs and requirements.</span></span> <span data-ttu-id="6b4a2-172">資料分割可讓您只調整需要調整的內容，而不需調整整個應用程式的不必要成本。</span><span class="sxs-lookup"><span data-stu-id="6b4a2-172">Partitioning enables you to scale only what needs to be scaled without the unnecessary cost of scaling an entire application.</span></span>

- <span data-ttu-id="6b4a2-173">偏好*相應放大。* 雲端式應用程式偏好向外延展資源，而非相應增加規模。</span><span class="sxs-lookup"><span data-stu-id="6b4a2-173">*Favor scale-out.* Cloud-based applications favor scaling out resources as opposed to scaling up.</span></span> <span data-ttu-id="6b4a2-174">相應放大（也稱為水準調整）包含將更多服務資源新增至現有系統，以符合並共用所需的效能層級。</span><span class="sxs-lookup"><span data-stu-id="6b4a2-174">Scaling out (also known as horizontal scaling) involves adding more service resources to an existing system to meet and share a desired level of performance.</span></span> <span data-ttu-id="6b4a2-175">相應增加（也稱為垂直調整）包含以更強大的硬體（更多磁片、記憶體和處理核心）取代現有的資源。</span><span class="sxs-lookup"><span data-stu-id="6b4a2-175">Scaling up (also known as vertical scaling) involves replacing existing resources with more powerful hardware (more disk, memory, and processing cores).</span></span> <span data-ttu-id="6b4a2-176">向外延展可以使用一些 Azure 雲端資源中提供的自動調整功能來自動叫用。</span><span class="sxs-lookup"><span data-stu-id="6b4a2-176">Scaling out can be invoked automatically with the autoscaling features available in some Azure cloud resources.</span></span> <span data-ttu-id="6b4a2-177">跨多個資源相應放大也會增加整體系統的冗余。</span><span class="sxs-lookup"><span data-stu-id="6b4a2-177">Scaling out across multiple resources also adds redundancy to the overall system.</span></span> <span data-ttu-id="6b4a2-178">最後，相應增加單一資源的成本通常比在許多較小的資源中相應放大更昂貴。</span><span class="sxs-lookup"><span data-stu-id="6b4a2-178">Finally scaling up a single resource is typically more expensive than scaling out across many smaller resources.</span></span> <span data-ttu-id="6b4a2-179">圖6-8 顯示兩種方法：</span><span class="sxs-lookup"><span data-stu-id="6b4a2-179">Figure 6-8 shows the two approaches:</span></span>

![向上擴充與相應放大](./media/scale-up-scale-out.png)

<span data-ttu-id="6b4a2-181">**圖6-8。**</span><span class="sxs-lookup"><span data-stu-id="6b4a2-181">**Figure 6-8.**</span></span> <span data-ttu-id="6b4a2-182">向上擴充與相應放大</span><span class="sxs-lookup"><span data-stu-id="6b4a2-182">Scale up versus scale out</span></span>

- <span data-ttu-id="6b4a2-183">*按星號調整。*</span><span class="sxs-lookup"><span data-stu-id="6b4a2-183">*Scale proportionally.*</span></span> <span data-ttu-id="6b4a2-184">調整服務時，請考慮使用*資源集*。</span><span class="sxs-lookup"><span data-stu-id="6b4a2-184">When scaling a service, think in terms of *resource sets*.</span></span> <span data-ttu-id="6b4a2-185">如果您要大幅擴充特定服務，對後端資料存放區、快取和相依服務有何影響？</span><span class="sxs-lookup"><span data-stu-id="6b4a2-185">If you were to dramatically scale out a specific service, what impact would that have on back-end data stores, caches and dependent services?</span></span> <span data-ttu-id="6b4a2-186">有些資源（例如 Cosmos DB）可以按比例相應放大，而其他則不能。</span><span class="sxs-lookup"><span data-stu-id="6b4a2-186">Some resources such as Cosmos DB can scale out proportionally, while many others can't.</span></span> <span data-ttu-id="6b4a2-187">您想要確保不會將資源向外延展到它將會耗盡其他相關資源的點。</span><span class="sxs-lookup"><span data-stu-id="6b4a2-187">You want to ensure that you don't scale out a resource to a point where it will exhaust other associated resources.</span></span>

- <span data-ttu-id="6b4a2-188">*避免親和性。*</span><span class="sxs-lookup"><span data-stu-id="6b4a2-188">*Avoid affinity.*</span></span> <span data-ttu-id="6b4a2-189">最佳做法是確保節點不需要本機親和性，通常稱為「*粘滯會話*」。</span><span class="sxs-lookup"><span data-stu-id="6b4a2-189">A best practice is to ensure a node doesn't require local affinity, often referred to as a *sticky session*.</span></span> <span data-ttu-id="6b4a2-190">要求應該能夠路由傳送至任何實例。</span><span class="sxs-lookup"><span data-stu-id="6b4a2-190">A request should be able to route to any instance.</span></span> <span data-ttu-id="6b4a2-191">如果您需要保存狀態，應該將其儲存至分散式快取，例如[Azure Redis cache](https://azure.microsoft.com/services/cache/)。</span><span class="sxs-lookup"><span data-stu-id="6b4a2-191">If you need to persist state, it should be saved to a distributed cache, such as [Azure Redis cache](https://azure.microsoft.com/services/cache/).</span></span>

- <span data-ttu-id="6b4a2-192">*利用平臺自動調整功能。*</span><span class="sxs-lookup"><span data-stu-id="6b4a2-192">*Take advantage of platform autoscaling features.*</span></span> <span data-ttu-id="6b4a2-193">盡可能使用內建的自動調整功能，而不是自訂或協力廠商機制。</span><span class="sxs-lookup"><span data-stu-id="6b4a2-193">Use built-in autoscaling features whenever possible, rather than custom or third-party mechanisms.</span></span> <span data-ttu-id="6b4a2-194">可能的話，請使用排程的調整規則，以確保資源在沒有啟動延遲的情況下可供使用，但會視需要將回應自動調整新增至規則，以因應非預期的變更。</span><span class="sxs-lookup"><span data-stu-id="6b4a2-194">Where possible, use scheduled scaling rules to ensure that resources are available without a startup delay, but add reactive autoscaling to the rules as appropriate, to cope with unexpected changes in demand.</span></span> <span data-ttu-id="6b4a2-195">如需詳細資訊，請參閱自動調整[指引](https://docs.microsoft.com/azure/architecture/best-practices/auto-scaling)。</span><span class="sxs-lookup"><span data-stu-id="6b4a2-195">For more information, see [Autoscaling guidance](https://docs.microsoft.com/azure/architecture/best-practices/auto-scaling).</span></span>

- <span data-ttu-id="6b4a2-196">*積極地相應放大。*</span><span class="sxs-lookup"><span data-stu-id="6b4a2-196">*Scale-out aggressively.*</span></span> <span data-ttu-id="6b4a2-197">最後一種作法是積極地相應放大，讓您可以快速地滿足流量的立即尖峰，而不會失去業務。</span><span class="sxs-lookup"><span data-stu-id="6b4a2-197">A final practice would be to scale out aggressively so that you can quickly meet immediate spikes in traffic without losing business.</span></span> <span data-ttu-id="6b4a2-198">然後，謹慎地相應縮小（也就是移除不必要的實例），以保持系統穩定。</span><span class="sxs-lookup"><span data-stu-id="6b4a2-198">And, then scale in (that is, remove unneeded instances) conservatively to keep the system stable.</span></span> <span data-ttu-id="6b4a2-199">執行此作業的簡單方法是設定「冷卻」期間，也就是在調整作業之間等待的時間，這是新增資源的五分鐘，最長可達15分鐘的移除實例。</span><span class="sxs-lookup"><span data-stu-id="6b4a2-199">A simple way to implement this is to set the cool down period, which is the time to wait between scaling operations, to five minutes for adding resources and up to 15 minutes for removing instances.</span></span>

## <a name="built-in-retry-in-services"></a><span data-ttu-id="6b4a2-200">服務中的內建重試</span><span class="sxs-lookup"><span data-stu-id="6b4a2-200">Built-in retry in services</span></span>

<span data-ttu-id="6b4a2-201">我們建議您在稍早的章節中執行程式設計重試作業的最佳作法。</span><span class="sxs-lookup"><span data-stu-id="6b4a2-201">We encouraged the best practice of implementing programmatic retry operations in an earlier section.</span></span> <span data-ttu-id="6b4a2-202">請記住，許多 Azure 服務及其對應的用戶端 Sdk 也包含重試機制。</span><span class="sxs-lookup"><span data-stu-id="6b4a2-202">Keep in mind that many Azure services and their corresponding client SDKs also include retry mechanisms.</span></span> <span data-ttu-id="6b4a2-203">下列清單摘要說明本書中所討論的許多 Azure 服務的重試功能：</span><span class="sxs-lookup"><span data-stu-id="6b4a2-203">The following list summarizes retry features in the many of the Azure services that are discussed in this book:</span></span>

- <span data-ttu-id="6b4a2-204">*Azure Cosmos DB。*</span><span class="sxs-lookup"><span data-stu-id="6b4a2-204">*Azure Cosmos DB.*</span></span> <span data-ttu-id="6b4a2-205">來自用戶端 API 的 <xref:Microsoft.Azure.Documents.Client.DocumentClient> 類別會自動淘汰失敗的嘗試。</span><span class="sxs-lookup"><span data-stu-id="6b4a2-205">The <xref:Microsoft.Azure.Documents.Client.DocumentClient> class from the client API automatically retires failed attempts.</span></span> <span data-ttu-id="6b4a2-206">重試次數和等候時間上限是可設定的。</span><span class="sxs-lookup"><span data-stu-id="6b4a2-206">The number of retries and maximum wait time are configurable.</span></span> <span data-ttu-id="6b4a2-207">用戶端 API 擲回的例外狀況可能是超過重試原則或非暫時性錯誤的要求。</span><span class="sxs-lookup"><span data-stu-id="6b4a2-207">Exceptions thrown by the client API are either requests that exceed the retry policy or non-transient errors.</span></span>

- <span data-ttu-id="6b4a2-208">*Azure Redis 快取。*</span><span class="sxs-lookup"><span data-stu-id="6b4a2-208">*Azure Redis Cache.*</span></span> <span data-ttu-id="6b4a2-209">Redis Stackexchange.redis 用戶端會使用連線管理員類別，其中包含嘗試失敗時的重試。</span><span class="sxs-lookup"><span data-stu-id="6b4a2-209">The Redis StackExchange client uses a connection manager class that includes retries on failed attempts.</span></span> <span data-ttu-id="6b4a2-210">重試次數、特定的重試原則和等候時間都可設定。</span><span class="sxs-lookup"><span data-stu-id="6b4a2-210">The number of retries, specific retry policy and wait time are all configurable.</span></span>

- <span data-ttu-id="6b4a2-211">*Azure 服務匯流排。*</span><span class="sxs-lookup"><span data-stu-id="6b4a2-211">*Azure Service Bus.*</span></span> <span data-ttu-id="6b4a2-212">服務匯流排用戶端會公開一個[RetryPolicy 類別](xref:Microsoft.ServiceBus.RetryPolicy)，可使用 [輪詢間隔]、[重試計數] 和 [<xref:Microsoft.ServiceBus.RetryExponential.TerminationTimeBuffer>] 來設定，以指定作業可以採取的最長時間。</span><span class="sxs-lookup"><span data-stu-id="6b4a2-212">The Service Bus client exposes a [RetryPolicy class](xref:Microsoft.ServiceBus.RetryPolicy) that can be configured with a back-off interval, retry count, and <xref:Microsoft.ServiceBus.RetryExponential.TerminationTimeBuffer>, which specifies the maximum time an operation can take.</span></span> <span data-ttu-id="6b4a2-213">預設原則是在每次嘗試之間有30秒的輪詢週期，這是九次重試次數上限。</span><span class="sxs-lookup"><span data-stu-id="6b4a2-213">The default policy is nine maximum retry attempts with a 30-second backoff period between attempts.</span></span>

- <span data-ttu-id="6b4a2-214">*Azure SQL Database。*</span><span class="sxs-lookup"><span data-stu-id="6b4a2-214">*Azure SQL Database.*</span></span> <span data-ttu-id="6b4a2-215">使用[Entity Framework Core](https://docs.microsoft.com/ef/core/miscellaneous/connection-resiliency)程式庫時，會提供重試支援。</span><span class="sxs-lookup"><span data-stu-id="6b4a2-215">Retry support is provided when using the [Entity Framework Core](https://docs.microsoft.com/ef/core/miscellaneous/connection-resiliency) library.</span></span>

- <span data-ttu-id="6b4a2-216">*Azure 儲存體。*</span><span class="sxs-lookup"><span data-stu-id="6b4a2-216">*Azure Storage.*</span></span> <span data-ttu-id="6b4a2-217">儲存體用戶端程式庫支援重試作業。</span><span class="sxs-lookup"><span data-stu-id="6b4a2-217">The storage client library support retry operations.</span></span> <span data-ttu-id="6b4a2-218">這些策略會因 Azure 儲存體資料表、blob 和佇列而有所不同。</span><span class="sxs-lookup"><span data-stu-id="6b4a2-218">The strategies vary across Azure storage tables, blobs, and queues.</span></span> <span data-ttu-id="6b4a2-219">同樣地，當啟用異地冗余功能時，替代重試會在主要和次要儲存體服務位置之間切換。</span><span class="sxs-lookup"><span data-stu-id="6b4a2-219">As well, alternate retries switch between primary and secondary storage services locations when the geo-redundancy feature is enabled.</span></span>

- <span data-ttu-id="6b4a2-220">*Azure 事件中樞。*</span><span class="sxs-lookup"><span data-stu-id="6b4a2-220">*Azure Event Hubs.*</span></span> <span data-ttu-id="6b4a2-221">事件中樞用戶端程式庫具有 RetryPolicy 屬性，其中包含可設定的指數輪詢功能。</span><span class="sxs-lookup"><span data-stu-id="6b4a2-221">The Event Hub client library features a RetryPolicy property, which includes a configurable exponential backoff feature.</span></span>

>[!div class="step-by-step"]
><span data-ttu-id="6b4a2-222">[上一頁](application-resiliency-patterns.md)
>[下一頁](resilient-communications.md)</span><span class="sxs-lookup"><span data-stu-id="6b4a2-222">[Previous](application-resiliency-patterns.md)
[Next](resilient-communications.md)</span></span>
